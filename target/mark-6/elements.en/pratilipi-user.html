<dom-module id="pratilipi-facebook-login">

	<style>
		:host {
			display: block;
			text-align: center;
		}
		button.fb-button {
			margin: 0 auto;
			margin-bottom: 12px;
			background-color: #3b5998;
			color: #FFFFFF;
			border: none;
			border-radius: 2px;
			white-space: nowrap;
			outline: none;
			padding: 2px;
			width: 320px;
		}
		button.fb-button span.icon {
			display: inline-block;
			background-image: url('https://0.ptlp.co/resource-all/icon/png/fb-logo-64.png');
			background-size: contain;
			vertical-align: middle;
			width: 36px;
			height: 36px;
			float: left;
		}
		button.fb-button span.button-text {
			display: inline-block;
			vertical-align: middle;
			text-align: center;
			font-size: 14px;
			font-weight: bold;
			line-height: 36px;
		}
	</style>

	<template>
		<button class="fb-button" on-click="fb_login">
			<span class="icon"></span>
			<span class="button-text">Sign In with Facebook</span>
		</button>
		
		<iron-ajax
					id="AjaxPost"
					url="/api/user/login/facebook"
					method="POST"
					content-type="application/x-www-form-urlencoded"
					handle-as="json"
					on-response="_handleAjaxPostResponse"
					on-error="_handleAjaxPostError"
					></iron-ajax>
	</template>

	<script>
		Polymer ({
			
			is: 'pratilipi-facebook-login',
			
			properties: {
				requestOnFlight: { type: Boolean, value: false }
			},
			
			sendData: function( authResponse ) {
				if( this.requestOnFlight )
					return;
				if( authResponse != null ) {
					this.requestOnFlight = true; 
					this.$.AjaxPost.body = ( "fbUserAccessToken=" + authResponse.accessToken );
					this.$.AjaxPost.generateRequest();
				}
			},
			
			fb_login: function() {
				
				FB.init({
					appId: 293990794105516,
					cookie : true,
					xfbml: true,
					version: 'v2.6'
				});
				
				FB.login( function( response ) {
					document.querySelector( 'pratilipi-facebook-login' ).sendData( response.authResponse );
				}, { scope: 'public_profile,email,user_birthday' } );
				
			},
			
			attached: function() {
				this.async( function() {
					if( typeof(FB) == 'undefined' ) {
						(function(d, s, id) {
							var js, fjs = d.getElementsByTagName(s)[0];
							if (d.getElementById(id)) return;
							js = d.createElement(s); js.id = id;
							js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.6";
							fjs.parentNode.insertBefore(js, fjs);
						}(document, 'script', 'facebook-jssdk'));
					}
				});
			},
			
			_handleAjaxPostResponse: function( event ) {
				this.requestOnFlight = false;
				document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				document.querySelector( 'pratilipi-user' ).closeAllElements();
			},
			
			_handleAjaxPostError: function( event ) {
				this.requestOnFlight = false;
				alert( event.detail.request.xhr.response.message );
			}, 
		});
	</script>
</dom-module><dom-module id="pratilipi-google-login">

	<style>		
		:host {
			display: block;
			text-align: center;
		}
		button.google-button {
			margin: 0 auto;
			margin-bottom: 12px;
			background-color: #4285F4;
			color: #FFFFFF;
			border: none;
			border-radius: 2px;
			white-space: nowrap;
			outline: none;
			padding: 2px;
			width: 320px;
		}
		button.google-button span.icon {
			display: inline-block;
			background-image: url('https://0.ptlp.co/resource-all/icon/png/g-logo.png');
			background-size: contain;
			vertical-align: middle;
			width: 36px;
			height: 36px;
			float: left;
		}
		button.google-button span.button-text {
			display: inline-block;
			vertical-align: middle;
			text-align: center;
			font-size: 14px;
			font-weight: bold;
			line-height: 36px;
		}
	</style>

	<template>
		<button id="googleLoginButton" class="google-button">
			<span class="icon"></span>
			<span class="button-text">Sign In with Google</span>
		</button>

		<iron-ajax
					id="AjaxPost"
					url="/api/user/login/google"
					method="POST"
					content-type="application/x-www-form-urlencoded"
					handle-as="json"
					on-response="_handleAjaxPostResponse"
					on-error="_handleAjaxPostError"
					></iron-ajax>
	</template>

	<script>
		function sendData( googleIdToken ) {
			document.querySelector( 'pratilipi-google-login' ).sendData( googleIdToken );
		}

		Polymer ({

			is: 'pratilipi-google-login',

			properties: {
				requestOnFlight: { type: Boolean, value: false }
			},

			attached: function() {

				var element = this.querySelector( '#googleLoginButton' );

				gapi.load( 'auth2', function() {

					auth2 = gapi.auth2.init({
						client_id: '659873510744-kfim969enh181h4gbctffrjg5j47tfuq.apps.googleusercontent.com',
						cookiepolicy: 'single_host_origin',
					});

					auth2.attachClickHandler( element, {},
						function( googleUser ) {
							this.requestOnFlight = true;
							sendData( googleUser.getAuthResponse().id_token );
						}, function( error ) {
							console.log( JSON.stringify( error, undefined, 2 ) );
						});

				});

			},

			sendData: function( googleIdToken ) {
				if( this.requestOnFlight || googleIdToken == null )
					return;
				this.requestOnFlight = true;
				this.$.AjaxPost.body = ( "googleIdToken=" + googleIdToken );
				this.$.AjaxPost.generateRequest();
			},

			_handleAjaxPostResponse: function( event ) {
				this.requestOnFlight = false;
				document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				document.querySelector( 'pratilipi-user' ).closeAllElements();
			},

			_handleAjaxPostError: function( event ) {
				this.requestOnFlight = false;
				alert( event.detail.request.xhr.response.googleIdToken != null ? event.detail.request.xhr.response.googleIdToken : event.detail.request.xhr.response.message );
			}

		});
	</script>
</dom-module><dom-module id="pratilipi-user-login">

	<style>
		.modal-fullscreen {
			padding: 0;
		}
		.modal-fullscreen .modal-dialog {
			height: 100%;
		}
		.modal-fullscreen .modal-dialog .modal-content {
			padding-top: 1px;
			padding-bottom: 24px;
			max-width: 400px;
		}
		.forgot-password {
			display: block;
			text-align: center;
			margin-top: 24px; 
		}
		.register {
			margin-top: 6px;
			text-align: center;
		}
		.custom-message {
			font-size: 15px;
			margin-bottom: 20px; 
			line-height: 24px;
		}
	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiUserLogin" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content" on-keyup="onSubmit">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="Pratilipi" alt="Pratilipi" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png" />
					<template is="dom-if" if="{{ requireAccess }}">
						<h6 class="text-center custom-message">{{ customMessage }}</h6>
					</template>
					<pratilipi-facebook-login></pratilipi-facebook-login>
					<pratilipi-google-login></pratilipi-google-login>
					<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 12px;"></div>
					<h6 class="modal-fullscreen-heading">Sign in to Pratilipi</h6>
					<pratilipi-input label="Email" value="{{ email::input }}" icon="icons:mail" type="email"></pratilipi-input>
					<pratilipi-input label="Password" value="{{ password::input }}" icon="icons:lock" type="password"></pratilipi-input>
					<div class="display-message-div">
						<p>{{ message }}</p>
					</div>
					<button id="loginButton" class="pratilipi-blue-button" on-click="onSubmit">Sign In</button>
					<a class="pratilipi-red forgot-password" on-click="resetPassword">Forgot Password ?</a>
					<div class="text-muted register">New?&nbsp;&nbsp;<a class="pratilipi-blue" on-click="register">Sign Up for Pratilipi</a></div>
					
				</div>
			</div>
		</div>
	
		<iron-ajax
				id="AjaxPost"
				url="/api/user/login"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	
	<script>

		Polymer({

 			is: 'pratilipi-user-login',

			properties: {
				email: { type: String, value: null },
				password: { type: String, value: null },
				message: { type: String, value: null }
			},
			
			register: function() {
				document.querySelector( 'pratilipi-user' ).register();
			},
			
			resetPassword: function() {
				document.querySelector( 'pratilipi-user' ).resetPassword();
			},
			
			open: function( requireAccess, customMessage ) {
				this.set( 'requireAccess', requireAccess );
				this.set( 'customMessage', customMessage != null ? customMessage : "You need to log in to perform this action!" );
				this.async( function() {
					jQuery( "#pratilipiUserLogin" ).modal( {backdrop: 'static'} );
				});
			},
			
			close: function() {
				jQuery( "#pratilipiUserLogin" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {

				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 || jQuery( '#loginButton' ).prop( 'disabled' ) )
					return;
				
				this.message = null;

				if( this.email == null || this.password == null || this.email.trim() == "" || this.password == "" ) {
					this.message = "Please fill in the details";
					return;
				}
				
				this.message = "Working ...";
				jQuery( '#loginButton' ).prop( 'disabled', true );
				
				var body = { email: this.email, password: this.password };
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				this.message = null;
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "Success !";
					this.async( function() {
						this.email = null;
						this.password = null;
						this.message = null;
						jQuery( '#loginButton' ).prop( 'disabled', false );
						this.close();
					}, 1000 );
					
					document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				}
			},

			_handleAjaxPostError: function( event ) {
				this.message = null;
				jQuery( '#loginButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 || event.detail.request.xhr.status == 401 || event.detail.request.xhr.status == 500 ) {
					if( event.detail.request.xhr.response.email != null )
						this.message = event.detail.request.xhr.response.email;
					else if( event.detail.request.xhr.response.password != null )
						this.message = event.detail.request.xhr.response.password;
					else if( event.detail.request.xhr.response.message != null )
						this.message = event.detail.request.xhr.response.message;
					else
						this.message = "Invalid Credentials!";
				} else {
					if( event.detail.request.xhr.response != null )
						this.message = event.detail.request.xhr.response.message;
					else
						this.message = "Some exception occurred at the server, please try again!";
				}
			},
			
		});

	</script>
	
</dom-module><dom-module id="pratilipi-user-register">

	<style>
		.modal-fullscreen {
			padding: 0;
		}
		.modal-fullscreen .modal-dialog {
			height: 100%;
		}
		.modal-fullscreen .modal-dialog .modal-content {
			padding-top: 4px;
			padding-bottom: 24px;
			max-width: 400px;
		}
	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiUserRegister" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content" on-keyup="onSubmit">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="Pratilipi" alt="Pratilipi" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png" />
					<pratilipi-facebook-login></pratilipi-facebook-login>
					<pratilipi-google-login></pratilipi-google-login>
					<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 12px;"></div>
					<h6 class="modal-fullscreen-heading">Sign Up for Pratilipi</h6>
					<pratilipi-input label="Full Name" value="{{ name::input }}" icon="icons:account-box"></pratilipi-input>
					<pratilipi-input label="Email" type="email" value="{{ email::input }}" icon="icons:mail"></pratilipi-input>
					<pratilipi-input label="Password" type="password" value="{{ password::input }}" icon="icons:lock"></pratilipi-input>
					<div class="display-message-div">
						<p>{{ message }}</p>
					</div>
					<div style="padding: 12px 0px;">
						<input style="position: absolute; margin-top: 8px;" type="checkbox" name="acceptTerms" id="acceptTerms">
						<p style="text-align: center; display: inline-block; margin-left: 16px;">
							By registering, you agree to the
							<a class="pratilipi-blue" style="white-space: nowrap;" href="/privacy-policy">Privacy Policy</a>
							&nbsp;and&nbsp;
							<a class="pratilipi-blue" style="white-space: nowrap;" href="/terms-of-service">Terms</a>
							&nbsp;.
						</p>
					</div>
					<button id="registerButton" class="pratilipi-blue-button" on-click="onSubmit">Sign Up !</button>
					<div class="text-center" style="margin-top: 24px;">
						<span class="text-muted">Already a Member?&nbsp;</span>
						<a class="pratilipi-blue" on-click="logIn">To Sign In</a>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/register"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		
	</template>
	
	
	<script>
	
		Polymer({

			is: 'pratilipi-user-register',

			properties: {
				name: { type: String },
				email: { type: String },
				password: { type: String },
				language: { type: String, value: "ENGLISH" },
				message: { type: String, value: null }
			},
			
			logIn: function() {
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			defaultMessages: function() {
				this.message = null;
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserRegister" ).modal( {backdrop: 'static'} );
				});
			},
			
			close: function() {
				jQuery( "#pratilipiUserRegister" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 || jQuery( '#registerButton' ).prop( 'disabled' ) )
					return;

				this.message = null;
				
				if( this.name == null || this.email == null || this.password == null || this.name.trim() == "" || this.email.trim() == "" ) {
					this.message = "Please fill in the details!";
					return;
				}

				if( !document.getElementById( "acceptTerms" ).checked ) {
					this.message = "Please accept to our terms!";
					return;
				}
				
				this.message = "Working ...";
				jQuery( '#registerButton' ).prop( 'disabled', true );
				
				var body = {
					name: this.name,
					email: this.email,
					password: this.password,
					language: this.language
				};
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "Success !";
					this.async( function() {
						this.message = null;
						this.name = null;
						this.email = null;
						this.password = null;
						jQuery( '#registerButton' ).prop( 'disabled', false );
 						this.close();
					}, 1000 );
					document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				}
			},

			_handleAjaxPostError: function( event ) {
				this.message = null;
				jQuery( '#registerButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.email != null ) {
						this.message = event.detail.request.xhr.response.email;
						return;
					}
					this.message = event.detail.request.xhr.response.password != null ? event.detail.request.xhr.response.password : "Invalid Data!";
				}
				else
					this.message = event.detail.request.xhr.response.message;
			},

		});
		
	</script>
	
</dom-module><dom-module id="pratilipi-user-password-reset">
	
	<style>
		.modal-fullscreen {
			padding: 0;
		}
		.modal-fullscreen .modal-dialog {
			height: 100%;
		}
		.modal-fullscreen .modal-dialog .modal-content {
			padding-top: 64px;
			padding-bottom: 24px;
			max-width: 450px;
		}		
	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiUserPasswordReset" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content" on-keyup="onSubmit">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="Pratilipi" alt="Pratilipi" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png" />
					<h6 class="modal-fullscreen-heading">Forgot Password ?</h6>
					<p style="text-align: justify; margin-top: 15px;">
						Please enter the email address you signed up with. We will send you a link to reset your password.
					</p>
					<pratilipi-input type="email" label="Email" value="{{ email::input }}" icon="icons:mail"></pratilipi-input>
					<div class="display-message-div">
						<p>{{ message }}</p>
					</div>
					<button id="passwordResetButton" class="pratilipi-blue-button" on-click="onSubmit">Reset Password</button>
					<div class="text-center" style="margin-top: 24px;">
						<a class="pratilipi-blue" on-click="logIn">To Sign In</a>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
            id="AjaxPost"
            url="/api/user/email"
            method="POST"
			content-type="application/x-www-form-urlencoded"
			handle-as="json"
            on-response="_handleAjaxPostResponse"
            on-error="_handleAjaxPostError"
            ></iron-ajax>
				
	</template>

   
	<script>
		Polymer({

			is: 'pratilipi-user-password-reset',

			properties: {
				email: { type: String, value: null },
				message: { type: String, value: null }
			},
			
			logIn: function() {
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserPasswordReset" ).modal( {backdrop: 'static'} );
				});
			},
			
			close: function() {
				jQuery( "#pratilipiUserPasswordReset" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 || jQuery( '#passwordResetButton' ).prop( 'disabled' ) )
					return;

				this.message = null;
				
				if( this.email == null || this.email.trim() == "" ) {
					this.message = "Please enter your email";
					return;
				}
					
				
				this.message = "Working ...";
				jQuery( '#passwordResetButton' ).prop( 'disabled', true );
				
				var ajaxPost = this.$.AjaxPost;
				ajaxPost.body = jQuery.param( { "email": this.email, "sendPasswordResetMail": true } );
				ajaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				this.message = null;
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message= "A mail has been sent to your email Id!";
					this.async( function() {
						this.email = null;
						this.message = null;
						this.close();
					}, 3000 );
					jQuery( '#passwordResetButton' ).prop( 'disabled', false );
				}
			},
			
			_handleAjaxPostError: function( event ) {
				this.message = null;
				jQuery( '#passwordResetButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.response.email != null )
					this.message = event.detail.request.xhr.response.email;
				else
					this.message = event.detail.request.xhr.response.message;
			},
		});
		
	</script>

</dom-module><dom-module id="pratilipi-user-password-update">

	<style>
		.modal-fullscreen {
			padding: 0;
		}
		.modal-fullscreen .modal-dialog {
			height: 100%;
		}
		.modal-fullscreen .modal-dialog .modal-content {
			padding-top: 64px;
			padding-bottom: 24px;
			max-width: 400px;
		}
	</style>

	<template>
		
		<div class="modal modal-fullscreen fade" id="pratilipiUserPasswordUpdate" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content" on-keyup="onSubmit">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="Pratilipi" alt="Pratilipi" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png" />
					<h6 class="modal-fullscreen-heading">Reset Password</h6>
					<template is="dom-if" if="{{ showCurrentPassword }}">
						<pratilipi-input label="Current Password" type="password" value="{{ password::input }}" icon="icons:lock-open"></pratilipi-input>
					</template>
					<pratilipi-input label="New Password" type="password" value="{{ newPassword::input }}" icon="icons:lock-outline"></pratilipi-input>
					<pratilipi-input label="Confirm Password" type="password" value="{{ newPassword2::input }}" icon="icons:lock"></pratilipi-input>
					<div class="display-message-div">
						<p>{{ message }}</p>
					</div>
					<button id="passwordUpdateButton" class="pratilipi-blue-button" on-click="onSubmit">Update</button>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/passwordupdate"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
				
	</template>

   
	<script>
	
		Polymer({
			
			is: 'pratilipi-user-password-update',
			
			properties: {
				email: { type: String, value: null },
				verificationToken: { type: String, value: null },
				password: { type: String, value: null },
				newPassword: { type: String, value: null },
				newPassword2: { type: String, value: null },
				showCurrentPassword: { type: Boolean, value: true },
				message: { type: String, value: null },
			},
			
			openPasswordUpdate: function( email, token ) {
				this.email = email;
				this.verificationToken = token;
				this.showCurrentPassword = false;
				this.open();
			},
			
			clearMessages: function() {
				this.message = null;
				this.password = null;
				this.newPassword = null;
				this.newPassword2 = null;
				this.email = null;
				this.verificationToken = null;
				this.showCurrentPassword = true;
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserPasswordUpdate" ).modal( {backdrop: 'static'} );
				});
			},
			
			close: function() {
				this.clearMessages();
				jQuery( "#pratilipiUserPasswordUpdate" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 || jQuery( '#passwordUpdateButton' ).prop( 'disabled' ) )
					return;

				this.message = null;
				
				if( this.showCurrentPassword && this.password == null ) {
					this.message = "Please enter your current password!";
					return;
				}
				
				if( this.newPassword == null ) {
					this.message = "Please enter the password!";
					return;
				}
				
				if( this.newPassword2 == null ) {
					this.message = "Please re-enter the password!";
					return;
				}
				
				if( this.newPassword != this.newPassword2 ) {
					this.message = "Passwords doesn't match!";
					return;
				}
				
				this.message = "Working ...";
				jQuery( '#passwordUpdateButton' ).prop( 'disabled', true );
				
				var ajaxBody = {};
				
				if( this.email != null && this.verificationToken != null )
					ajaxBody = { "email" : this.email, "verificationToken" : this.verificationToken };
				else if( this.password != null )
					ajaxBody = { "password" : this.password };
				
				ajaxBody[ "newPassword" ] = this.newPassword;
				
				this.$.AjaxPost.body = jQuery.param( ajaxBody );
				this.$.AjaxPost.generateRequest();
				ga_CA( 'User', 'SubmitPassword' );
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message= "Password has been changed Successfully!";
					this.async( function() {
						this.clearMessages();
 						jQuery( '#passwordUpdateButton' ).prop( 'disabled', false );
						this.close();
					}, 2000 );
				}
				document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
			},
			
			_handleAjaxPostError: function( event ) {
				jQuery( '#passwordUpdateButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.password != null )
						this.message = event.detail.request.xhr.response.password;
					else if( event.detail.request.xhr.response.newPassword != null )
						this.message = event.detail.request.xhr.response.newPassword;
					else if( event.detail.request.xhr.response.token != null )
						this.message = event.detail.request.xhr.response.token;
					else if( event.detail.request.xhr.response.errMessage != null )
						this.message = event.detail.request.xhr.response.errMessage;
					else
						this.message = "Invalid Input";
				} else {
					this.message = event.detail.request.xhr.response.message;
				}
			},
		});
		
	</script>

</dom-module><dom-module id="pratilipi-user-verification">

	<template>
		
		<div class="modal modal-fullscreen fade" id=pratilipiUserVerification role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="Pratilipi" alt="Pratilipi" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png" />
					<h6 class="modal-fullscreen-heading">Email Verification</h6>
					<div class="display-message-div">
						<p style="margin-top: 50px; font-size: 20px;">{{ message }}</p>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="verifyEmail"
				url="/api/user/verification"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleVerifyEmailPostResponse"
				on-error="_handleVerifyEmailPostError"
				></iron-ajax>
				
		<iron-ajax
				id="sendVerificationEmail"
				url="/api/user/email"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleSendVerificationPostResponse"
				on-error="_handleSendVerificationPostError"
				></iron-ajax>
		
	</template>
	
	
	<script>

		Polymer({

 			is: 'pratilipi-user-verification',
 			
			properties: {
				message: { type: String }
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserVerification" ).modal( {backdrop: 'static'} );
				});
			},
			
			close: function() {
				jQuery( "#pratilipiUserVerification" ).modal( 'hide' );
			},
			
			clearMessages: function() {
				this.message = null;
			},
			
			sendVerificationMail: function( email ) {
				this.open();
				this.message = "Working ...";
				this.$.sendVerificationEmail.body = jQuery.param( { "email": email, "sendEmailVerificationMail": true } );
				this.$.sendVerificationEmail.generateRequest();
			},
			
			verifyUser: function( email, verificationToken ) {
				this.open();
				this.message = "Working ...";
				var body = { email: email, verificationToken: verificationToken };
				this.$.verifyEmail.body = jQuery.param( body );
				this.$.verifyEmail.generateRequest();
			},
			
			_handleVerifyEmailPostResponse: function( event ) {
				this.clearMessages();
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "Verified Successfully !";
					this.async( function() {
 						this.clearMessages();
						this.close();
						document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
						window.location = "https://" + window.location.host;
					}, 2000 );
				}
			},
			
			_handleVerifyEmailPostError: function( event ) {
				this.clearMessages();
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.message != null )
						this.message = event.detail.request.xhr.response.message;
					else
						this.message = "Invalid Input!";
				} else {
					this.message = event.detail.request.xhr.response.message;
				}
			},
			
			_handleSendVerificationPostResponse: function( event ) {
				this.clearMessages();
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "Email Sent Successfully !";
					this.async( function() {
 						this.clearMessages();
						this.close();
					}, 2000 );
				}
			},
			
			_handleSendVerificationPostError: function( event ) {
				this.clearMessages();
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.message != null )
						this.message = event.detail.request.xhr.response.message;
					else
						this.message = "Invalid Input!";
				} else {
					this.message = event.detail.request.xhr.response.message;
				}
			}

		});

	</script>
	
</dom-module>
<dom-module id="pratilipi-user">

	<template>
		<pratilipi-user-password-update></pratilipi-user-password-update>
		<pratilipi-user-verification></pratilipi-user-verification>
		<pratilipi-user-login></pratilipi-user-login>
		<pratilipi-user-register></pratilipi-user-register>
		<pratilipi-user-password-reset></pratilipi-user-password-reset>
		
		<iron-ajax
				id="AjaxGet"
				url="/api/user/logout"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>
	</template>
	
	<script>

		Polymer({
			
	 		is: 'pratilipi-user',

	 		properties: {
				user: { type: Object, notify: true, observer: "_userChanged" },
				userData: { type: Object }
			},

			_userChanged: function() {
				userChanged( this.user );
			},

			getCurrentUser: function() {
				return this.user;
			},
			
			updateUser: function( user ) {
				this.set( 'user', user );
			},
			
			closeAllElements: function() {
				jQuery( '.modal' ).modal( 'hide' );
			},

			logIn: function( requireAccess, customMessage ) {
				this.closeAllElements();
				this.querySelector( 'pratilipi-user-login' ).open( requireAccess, customMessage );
			},
			
			register: function() {
				this.closeAllElements();
				this.querySelector( 'pratilipi-user-register' ).open();
			},

			startWriting: function() {
				this.closeAllElements();
				document.querySelector( 'pratilipi-header' ).write();
			},
			
			resetPassword: function() {
				this.closeAllElements();
				this.querySelector( 'pratilipi-user-password-reset' ).open();
			},
			
			changePassword: function() {
				this.closeAllElements();
				this.querySelector( 'pratilipi-user-password-update' ).open();
			},
			
			sendVerificationMail: function() {
				this.closeAllElements();
				this.querySelector( 'pratilipi-user-verification' ).sendVerificationMail( this.user.email );
			},
			
			logOut: function() {
				this.$.AjaxGet.generateRequest();
			},
			
			_handleAjaxGetResponse: function(  request ) {
				if( ! request.detail.response ) {
					// TODO: show error
					this._handleAjaxGetError();
					return;
				}
				
				this.updateUser( request.detail.response );
			},

			_handleAjaxGetError: function() {
				// TODO: show error
				alert( "Logout failed! Please try again!" );
			},

			attached: function() {
				
				this.updateUser( this.userData );

				if( getUrlParameter( 'action' ) != null ) {
					if( getUrlParameter( 'action' ) == "login" && this.user.isGuest )
						this.logIn();
					else if( getUrlParameter( 'action' ) == "register" && this.user.isGuest )
						this.register();
					else if( getUrlParameter( 'action' ) == "start_writing" )
						this.startWriting();
					return;
				}

				if( getUrlParameter( 'email' ) != null && getUrlParameter( 'token' ) != null ) {

					this.closeAllElements();

					if( getUrlParameter( 'verifyUser' ) == "true" ) {
						this.querySelector( 'pratilipi-user-verification' ).verifyUser( getUrlParameter( 'email' ), getUrlParameter( 'token' ) );
					}
					else if( getUrlParameter( 'passwordReset' ) == "true" ) {
						this.querySelector( 'pratilipi-user-password-update' ).openPasswordUpdate( getUrlParameter( 'email' ), getUrlParameter( 'token' ) );
					}
				}

			}

		});

	</script>
	
</dom-module>