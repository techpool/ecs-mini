<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta name="description" content="A platform to discover, read and share your favorite stories, poems and books in a language, device and format of your choice."> <!-- ko foreach: { data: appViewModel.metaTags() } --> <meta data-bind="attr: { 'property': $data.property, 'content': $data.content }" /> <!--/ko--> <meta name="apple-mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black"> <meta name="apple-mobile-web-app-title" content="Pratilipi | Pratilipi"> <meta name="msapplication-TileImage" content="/logo.png"> <meta name="msapplication-TileColor" content="#D0021B"> <link rel="apple-touch-icon" href="/favicon.png"> <link rel="manifest" href="/pwa-manifest-GAMMA_ALL_LANGUAGE_GR.json"> <title data-bind="text: pageTitle"></title> <script language="javascript"> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-53742841-2', 'pratilipi.com'); ga('require', 'displayfeatures'); </script> <script> window.fbAsyncInit = function() { FB.init({ appId : '293990794105516', xfbml : true, version : 'v2.9' }); FB.AppEvents.logPageView(); }; (function(d, s, id){ var js, fjs = d.getElementsByTagName(s)[0]; if (d.getElementById(id)) {return;} js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk')); </script> <style> @import url(https://www.ptlp.co/resource-all/font/font-en.css); *:not(.material-icons) { font-family: "Montserrat", "Helvetica", "Arial", sans-serif !important; letter-spacing: 0 !important; } .material-heading { line-height: 34px !important; font-size: 24px !important; } .material-title { line-height: 30px !important; font-size: 20px !important; } .material-subtitle-1 { line-height: 26px !important; font-size: 16px !important; } .material-subtitle-2 { line-height: 30px !important; font-size: 16px !important; } .material-body-1 { line-height: 23px !important; font-size: 14px !important; } .material-body-2 { line-height: 26px !important; font-size: 14px !important; } .material-caption { line-height: 20px !important; font-size: 12px !important; } .material-button { line-height: 23px !important; font-size: 14px !important; } @media only screen and (max-width: 767px) { .material-heading { font-size: 24px !important; } .material-title { font-size: 20px !important; } .material-subtitle-1 { font-size: 16px !important; } .material-subtitle-2 { font-size: 16px !important; } .material-body-1 { font-size: 14px !important; } .material-body-2 { font-size: 14px !important; } .material-caption { font-size: 12px !important; } .material-button { font-size: 14px !important; } } .font-xs { font-size: 12px !important; } .font-s { font-size: 14px !important; } .font-m { font-size: 16px !important; } .font-l { font-size: 20px !important; } .font-xl { font-size: 24px !important; } @media only screen and (max-width: 767px) { .font-xs { font-size: 12px !important; } .font-s { font-size: 14px !important; } .font-m { font-size: 16px !important; } .font-l { font-size: 20px !important; } .font-xl { font-size: 24px !important; } } </style> </head> <body> <!-- ko if: ! appViewModel.hideAppShell() --> <div data-bind="component: { name: 'pratilipi-main-layout' }"></div> <!-- /ko --> <!-- ko if: appViewModel.hideAppShell() --> <div data-bind="component: { name: appViewModel.currentView() }"></div> <!-- /ko --> </body> <script src="https://www.ptlp.co/resource-all/pwa/js/jkkrrsh.js"></script> <script> ko.components.register( 'pratilipi-register-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = ko.observable( false ); this.userName = ko.observable(); this.userEmail = ko.observable(); this.userPassword = ko.observable(); this.agreedTerms = ko.observable( false ); this.register = function() { if( self.requestOnFlight() ) return; if( self.userName() == null || self.userName().trim() == "" ) { ToastUtil.toast( "Please Enter your Name" ); return; } if( self.userEmail() == null || self.userEmail().trim() == "" ) { ToastUtil.toast( "Please Enter your Email." ); return; } if( self.userPassword() == null || self.userPassword().trim() == "" ) { ToastUtil.toast( "Please Enter your Password" ); return; } if( ! validateEmail( self.userEmail() ) ) { ToastUtil.toast( "Please Enter a valid Email" ); return; } if( ! self.agreedTerms() ) { ToastUtil.toast( "Please accept to our terms!" ); return; } self.requestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.registerUser( self.userName(), self.userEmail(), self.userPassword(), function( user ) { ToastUtil.toast( "Success !" ); window.location.href = user[ "profilePageUrl" ]; }, function( error ) { self.requestOnFlight( false ); var message = "Some error Occurred! Please try again!"; if( error[ "name" ] != null ) message = error[ "name" ]; else if( error[ "email" ] != null ) message = error[ "email" ]; else if( error[ "password" ] != null ) message = error[ "password" ]; else if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }; this.registerButtonEnabled = ko.computed( function() { return self.userName() != null && self.userName().trim() != "" && self.userEmail() != null && self.userEmail().trim() != "" && self.userPassword() != null && self.userPassword().trim() != "" && self.agreedTerms() && ! self.requestOnFlight(); }, self ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.REGISTER.ko_element ) { /* Clear All Fields */ self.userName( null ); self.userEmail( null ); self.userPassword( null ); self.agreedTerms( false ); /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); }, this ); } , template: `<div class="pratilipi-register-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">Sign Up for Pratilipi</div><div class="pratilipi-content-container"><!-- ko component: {name: "pratilipi-facebook-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: true }} --><!-- /ko --><!-- ko component: {name: "pratilipi-google-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: true }} --><!-- /ko --></div><p class="login-or margin-zero">or</p><form id="register_form" class="pratilipi-content-container margin-zero"><input type="text" data-bind="mdlFloatingInput: { label: 'Full Name', value: userName, id: 'pratilipi_register_page_user_name' }, valueUpdate: ['input']" /><input type="email" data-bind="mdlFloatingInput: { label: 'Email', value: userEmail, id: 'pratilipi_register_page_user_email' }, valueUpdate: ['input']" /><input type="password" data-bind="mdlFloatingInput: { label: 'Password', value: userPassword, id: 'pratilipi_register_page_user_password' }, valueUpdate: ['input']" /><div class="clearfix"></div><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect terms-conditions" for="agree-terms-conditions"><input data-bind="checked: agreedTerms" type="checkbox" id="agree-terms-conditions" class="mdl-checkbox__input" /><span class="mdl-checkbox__label material-body-2">By registering, you agree to the <a href="/privacy-policy" target="_blank">Privacy Policy</a> and <a href="/terms-of-service" target="_blank">Terms</a> .</span></label><button onclick="ga_CA( 'Signup', 'Email-signup' )"data-bind="{ click: register, enable: registerButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">Sign Up !</button><div class="member-login material-body-2"><span class="text-muted">Already a Member?&nbsp;</span><a data-bind="attr: {href: '/login?retUrl=' + getRetUrl() }" class="pratilipi-blue">To Sign In</a></div></form></div></div>` }); </script> <script> ko.components.register( 'pratilipi-search-trends', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.keywordList = ko.observableArray(); this.isLoading = ko.observable( false ); this.keywordClicked = function( vm, e ) { var keyword = $( e.currentTarget ).attr( 'data-val' ); var index = $( e.currentTarget ).attr( 'data-index' ); ga_CAV( "Search", "TrendingSearch", index ); appViewModel.searchQuery( keyword ); }; this.fetchSearchTrends = function() { Array.prototype.clean = function( deleteValue ) { for( var i = 0; i < this.length; i++ ) { if( this[i] == deleteValue ) { this.splice(i, 1); i--; } } return this; }; self.isLoading( true ); dataAccessor.getTrendingSearchKeywords( function( response ) { if( response == null || isEmpty( response ) ) { return; } var keywordList = response.trending_keywords.clean( undefined ); self.keywordList( keywordList ); self.isLoading( false ); }); }; this.fetchSearchTrends(); } , template: `<div class="pratilipi-search-trends"><div class="pratilipi-red material-subtitle-1">Top Searches in the past day</div><div data-bind="visible: isLoading()"style="margin: 12px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div class="hashtags" data-bind="visible: ! isLoading() && keywordList().length > 0, foreach: { data: keywordList, as: 'keyword' }"><a href="#" class="hashtag" data-bind="{ text: '#' + keyword,click: $parent.keywordClicked,attr: { 'id': 'js-search-trend-' + $index(), 'data-val': keyword, 'data-index': $index() } }"></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-navigation-aside', { viewModel: function() { var self = this; this.highLightNavigationEntry = function() { $( ".js-navigation-aside a" ).each( function( index, element ) { $( element ).css( "font-weight", "400" ); if( window.location.pathname == "/search" ) { if( $( element ).attr( 'href' ) == "/search?q=" + appViewModel.searchQuery() ) $( element ).css( "font-weight", "700" ); } else if( $( element ).attr( 'href' ) == window.location.pathname ) { $( element ).css( "font-weight", "700" ); } }); }; this.navigationObserver = ko.computed( function() { appViewModel.searchQuery(); appViewModel.currentLocation(); setTimeout( function() { self.highLightNavigationEntry(); }, 0 ); }, this ); } , template: `<div class="pratilipi-navigation-aside js-navigation-aside"><h6 class="pratilipi-red font-l">Navigation</h6><h6 class="pratilipi-red font-l">/books Books</h6><h6 class="pratilipi-red font-l">/stories Stories</h6><h6 class="pratilipi-red font-l">/poems Poems</h6><h6 class="pratilipi-red font-l">/articles Articles</h6><h6 class="pratilipi-red font-l">/magazines Magazines</h6></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-card', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.pratilipi = params.pratilipi; this.hideLibraryButton = params.hideLibraryButton != null ? params.hideLibraryButton : false; this.canRemoveFromLibrary = params.canRemoveFromLibrary != null ? params.canRemoveFromLibrary : true; /* Default set to true */ this.redirectToReaderOnClick = params.redirectToReaderOnClick != null ? params.redirectToReaderOnClick : false; this.showCategoryButton = params.showCategoryButton != null ? params.showCategoryButton : false; /* Default set to false */ this.libraryButtonVisible = ko.observable( false ); this.shareButtonVisible = ko.observable( false ); this.libraryRequestOnFlight = ko.observable( false ); this.updatePratilipi = function( pratilipi ) { ko.mapping.fromJS( pratilipi, {}, self.pratilipi ); }; this.titleDisplay = ko.computed( function() { return self.pratilipi.displayTitle ? self.pratilipi.displayTitle() : self.pratilipi.title(); }, this ); this.nameDisplay = ko.computed( function() { return self.pratilipi.author.displayName ? self.pratilipi.author.displayName() : self.pratilipi.author.name(); }, this ); this.switchLibraryState = function() { if( ! self.canRemoveFromLibrary && self.pratilipi.addedToLib() ) return; self.libraryRequestOnFlight( true ); var getAddedToLibMessage = function( addedToLib ) { var text = addedToLib ? "You have added $pratilipiTitle to your library." : "You have removed $pratilipiTitle from your library."; var title = self.titleDisplay().substring( 0, 10 ) + ( self.titleDisplay().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; var addedToLib = ! self.pratilipi.addedToLib(); if( addedToLib ) /* Toast only for remove action */ ToastUtil.toast( getAddedToLibMessage( addedToLib ), 3000 ); else ToastUtil.toastCallBack( getAddedToLibMessage( addedToLib ), 4000, "UNDO", self.switchLibraryState ); self.updatePratilipi( { "addedToLib": addedToLib } ); dataAccessor.addOrRemoveFromLibrary( self.pratilipi.pratilipiId(), addedToLib, function( userPratilipi ) { self.libraryRequestOnFlight( false ); }, function( error ) { self.libraryRequestOnFlight( false ); self.updatePratilipi( { "addedToLib": ! addedToLib } ); var message = "Some error Occurred! Please try again!"; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }; this.addToOrRemoveFromLibrary = function( vm, evt ) { evt.stopPropagation(); if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "LIBRARY" } ); return; } self.switchLibraryState(); }; this.sharePratilipi = function( vm, evt ) { evt.stopPropagation(); ShareUtil.sharePratilipi( ko.mapping.toJS( self.pratilipi ) ); }; this.userObserver = ko.computed( function() { self.libraryButtonVisible( appViewModel.user.author.authorId() != self.pratilipi.author.authorId() ); }, this ); this.pratilipiMetaObserver = ko.computed( function() { self.shareButtonVisible( self.pratilipi.state == null || self.pratilipi.state() == "PUBLISHED" ); }, this ); this.showCategoryModal = function() { $( '#addCategory-'+self.pratilipi.pratilipiId() ).modal(); }; setTimeout( function() { if( typeof( componentHandler ) !== 'undefined' ) componentHandler.upgradeDom(); }, 0 ); } , template: `<a onclick="ga_CA( 'Pratilipi', 'Open' )"class="pratilipi-pratilipi-card mdl-card mdl-card-border"data-bind="attr: { href: redirectToReaderOnClick ? pratilipi.readPageUrl() : pratilipi.pageUrl() }"><span class="pratilipi-cover-image-holder"><pratilipi-image params="{ src: pratilipi.coverImageUrl,width: 100,height: 150,alt: titleDisplay(),mobWidth: 70,mobHeight: 105 }"></pratilipi-image></span><span class="pratilipi-meta-holder"><!-- Author Rahul : Single line title when category button is visible --><span class="pratilipi-title mdl-card__title" data-bind="visible: showCategoryButton && pratilipi.hasAccessToUpdate()"><span class="font-l single-line" data-bind="text: titleDisplay()"></span></span><span class="pratilipi-title mdl-card__title " data-bind="visible: !(showCategoryButton && pratilipi.hasAccessToUpdate())"><span class="font-l" data-bind="text: titleDisplay()"></span></span><!-- End --><span class="author-name mdl-card__title"><span class="material-subtitle-2" data-bind="text: nameDisplay()"></span></span><span class="pratilipi-card-meta-reads-rating-holder"><span class="meta-holder reads-holder" data-bind="visible: pratilipi.readCount() > 0"><span class="material-body-1" data-bind="text: abbrNum( pratilipi.readCount(), 0 )"></span><i class="material-icons material-body-1">remove_red_eye</i></span><span class="meta-holder rating-holder" data-bind="visible: pratilipi.averageRating() > 0"><span class="material-body-1" data-bind="text: roundOffToOneDecimal( pratilipi.averageRating() )"></span><i class="material-icons material-body-1">star_rate</i></span></span><span class="pratilipi-card-footer-icons-holder"><!-- ko if: appViewModel.isTestEnvironment && showCategoryButton && pratilipi.hasAccessToUpdate() --><button data-bind="visible: pratilipi.tags() != null || pratilipi.suggestedTags() != null, click: showCategoryModal"class="edit-category-button">Edit Category</button><button data-bind="visible: pratilipi.tags() == null && pratilipi.suggestedTags() == null, click: showCategoryModal"class="add-category-button">Add category</button><!-- /ko --><button onclick="ga_CA( 'Pratilipi', 'Share' )"data-bind="click: sharePratilipi, visible: shareButtonVisible()"class="library-button mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">share</i></button><!-- ko if: ! hideLibraryButton --><button onclick="ga_CA( 'Pratilipi', 'Add To Library' )"data-bind="{ disable: libraryRequestOnFlight(), click: addToOrRemoveFromLibrary, visible: libraryButtonVisible() }"class="share-button mdl-button mdl-js-button mdl-button--icon"><i class="material-icons" data-bind="{ text: pratilipi.addedToLib() ? 'bookmark' : 'bookmark_border',css: { 'pratilipi-red': pratilipi.addedToLib() } }"></i></button><!-- /ko --></span></span></a><!-- ko if: appViewModel.isTestEnvironment && showCategoryButton && pratilipi.hasAccessToUpdate() --><div class="modal fade" role="dialog"data-bind="attr: {'id':'addCategory-'+pratilipi.pratilipiId()}"><div class="modal-dialog pratilipi-add-category" role="document"><div class="modal-content"><div class="modal-body"><!-- ko component: {name: "pratilipi-tags",params: {pratilipi: pratilipi, isShownInModal: true}} --><!-- /ko --></div></div></div></div><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-notification-settings', { viewModel: function( params ) { var self = this; var getEmailFrequencyVernacular = function( emailFrequency ) { switch( emailFrequency ) { case "IMMEDIATELY": return "Immediately"; case "DAILY": return "Daily"; case "WEEKLY": return "Weekly"; case "MONTHLY": return "Monthly"; case "NEVER": return "Never"; } }; this.updateNotificationPreferences = function() { var userPreferences = {}; userPreferences[ "emailFrequency" ] = document.querySelector( "#pratilipiNotificationSettings #emailFrequency" ).getAttribute( "data-val" ); userPreferences[ "notificationSubscriptions" ] = {}; $( '#pratilipiNotificationSettings .mdl-js-checkbox' ).each( function( index, element ) { userPreferences[ "notificationSubscriptions" ][ element.firstChild.value ] = element.firstChild.checked; }); setUserPreferences( userPreferences ); ToastUtil.toast( "Success!" ); $( "#pratilipiNotificationSettings" ).modal( 'hide' ); }; this.firebaseCallback = ko.computed( function() { var userPreferences = appViewModel.userPreferences(); var emailFrequency = userPreferences[ "emailFrequency" ] != null ? userPreferences[ "emailFrequency" ] : "IMMEDIATELY"; var notificationSubscriptions = userPreferences[ "notificationSubscriptions" ] != null ? userPreferences[ "notificationSubscriptions" ] : {}; $( "#pratilipiNotificationSettings #emailFrequency" ).attr( 'data-val', emailFrequency ); $( "#pratilipiNotificationSettings #emailFrequency" ).attr( 'value', getEmailFrequencyVernacular( emailFrequency ) ); $( '#pratilipiNotificationSettings .mdl-js-checkbox' ).each( function( index, element ) { if( element.MaterialCheckbox == null ) return; var val = element.firstChild.value; if( notificationSubscriptions[ val ] != null && ! notificationSubscriptions[ val ] ) element.MaterialCheckbox.uncheck(); else element.MaterialCheckbox.check(); }); }, this ); } , template: `<div class="modal common-modal fade" id="pratilipiNotificationSettings" role="dialog" tabindex="-1"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 class="modal-title">Notification Settings</h6></div><div class="modal-body"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="emailFrequency"data-val="IMMEDIATELY"value="Immediately"type="text" tabIndex="-1" /><label class="mdl-textfield__label" for="emailFrequency">Email Frequency</label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu" for="emailFrequency"><li class="mdl-menu__item" data-val="IMMEDIATELY">Immediately</li><li class="mdl-menu__item" data-val="DAILY">Daily</li><li class="mdl-menu__item" data-val="WEEKLY">Weekly</li><li class="mdl-menu__item" data-val="MONTHLY">Monthly</li><li class="mdl-menu__item" data-val="NEVER">Never</li></ul><div class="settings-group"><h6>Content</h6><div class="mdl-grid"><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_review"><input value="USER_PRATILIPI_REVIEW" type="checkbox" id="notif_option_new_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Review</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_comment"><input value="COMMENT_REVIEW_REVIEWER" type="checkbox" id="notif_option_new_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Comment</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_review"><input value="VOTE_REVIEW_REVIEWER" type="checkbox" id="notif_option_like_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">Like on review</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_comment"><input value="VOTE_COMMENT_REVIEW_COMMENTOR" type="checkbox" id="notif_option_like_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Like on Comment</span></label></div></div></div><div class="settings-group"><h6>Network</h6><div class="mdl-grid"><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_follower"><input value="AUTHOR_FOLLOW" type="checkbox" id="notif_option_new_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Follower</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_published_follower"><input value="PRATILIPI_PUBLISHED_FOLLOWER" type="checkbox" id="notif_option_pratilipi_published_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Content by people you follow</span></label></div><div class="mdl-cell mdl-cell--6-col mdl-cell--12-col-phone"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_updates"><input value="GENERIC" type="checkbox" id="notif_option_pratilipi_updates" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">Pratilipi Updates and Offers</span></label></div></div></div></div></div><div class="modal-footer"><button onclick="ga_CA( 'Notification', 'Update' )"data-bind="click: updateNotificationPreferences"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"type="button">Save Changes</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-info', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* Setting Local Variables */ this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.updatePratilipi = params.updatePratilipi; this.updateUserPratilipi = params.updateUserPratilipi; var defaultAuthor = { "authorId": null, "name": null, "nameEn": null, "pageUrl": null, "profileImageUrl": null, "summary": null }; var defaultUserAuthor = { "following": false }; this.author = ko.mapping.fromJS( defaultAuthor, {}, self.author ); this.userAuthor = ko.mapping.fromJS( defaultUserAuthor, {}, self.userAuthor ); this.authorLoaded = ko.observable( false ); this.canAddToLibrary = ko.observable( false ); this.canShare = ko.observable( false ); this.canDelete = ko.observable( false ); this.pratilipiRequestOnFlight = ko.observable( false ); this.userPratilipiRequestOnFlight = ko.observable( false ); this.userAuthorRequestOnFlight = ko.observable( false ); this.authorIsUser = ko.observable( false ); /* Summary Input */ this.summaryInputValue = ko.observable(); this.summaryInputActive = ko.observable( false ); this.summaryInputRequestOnFlight = ko.observable( false ); this.openSummaryInput = function() { self.summaryInputValue( self.pratilipi.summary() ); self.summaryInputActive( true ); }; this.closeSummaryInput = function() { self.summaryInputActive( false ); }; this.toggleSummaryInput = function() { if( self.summaryInputActive() ) self.closeSummaryInput(); else self.openSummaryInput(); }; this.submitSummaryInput = function() { ToastUtil.toastUp( "Working ..." ); var pratilipi = { "pratilipiId": self.pratilipi.pratilipiId(), "summary": self.summaryInputValue() }; self.summaryInputRequestOnFlight( true ); var dataAccessor = new DataAccessor(); dataAccessor.createOrUpdatePratilipi( pratilipi, function( pratilipi ) { self.updatePratilipi( pratilipi ); self.summaryInputRequestOnFlight( false ); ToastUtil.toast( "Success !", 3000 ); self.closeSummaryInput(); }, function( error ) { self.summaryInputRequestOnFlight( false ); var message = "Some error Occurred! Please try again!"; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000 ); } ); }; /* Author */ this.updateAuthor = function( author ) { ko.mapping.fromJS( author, {}, self.author ); }; this.updateUserAuthor = function( userAuthor ) { ko.mapping.fromJS( userAuthor, {}, self.userAuthor ); }; this.fetchAuthorAndUserAuthor = function() { self.authorLoaded( false ); dataAccessor.getAuthorById( self.pratilipi.author.authorId() , true, function( author, userAuthor ) { self.updateAuthor( author ); self.updateUserAuthor( userAuthor ); self.authorLoaded( true ); }); }; /* Add to Library */ this.addToLibrary = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "LIBRARY" } ); return; } var getAddedToLibMessage = function( addedToLib ) { var text = addedToLib ? "You have added $pratilipiTitle to your library." : "You have removed $pratilipiTitle from your library."; var title = self.pratilipi.title().substring( 0, 10 ) + ( self.pratilipi.title().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; var addedToLib = ! self.userPratilipi.addedToLib(); if( addedToLib ) /* Toast only for remove action */ ToastUtil.toast( getAddedToLibMessage( addedToLib ), 3000 ); else ToastUtil.toastCallBack( getAddedToLibMessage( addedToLib ), 4000, "UNDO", self.addToLibrary ); self.updateUserPratilipi( { "addedToLib": addedToLib } ); self.userPratilipiRequestOnFlight( true ); dataAccessor.addOrRemoveFromLibrary( self.pratilipi.pratilipiId(), addedToLib, function( userPratilipi ) { self.userPratilipiRequestOnFlight( false ); }, function( error ) { self.userPratilipiRequestOnFlight( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "Some error Occurred! Please try again!" ); self.updateUserPratilipi( { "addedToLib": ! addedToLib } ); }); }; /* Follow Author */ this.followAuthor = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "FOLLOW" } ); return; } var getFollowingMessage = function( following ) { var text = following ? "You are following $authorName." : "You have unfollowed $authorName."; return text.replace( "$authorName", self.pratilipi.author.name() ); }; var following = ! self.userAuthor.following(); if( following ) /* Toast only for unfollow action */ ToastUtil.toast( getFollowingMessage( following ), 3000 ); else ToastUtil.toastCallBack( getFollowingMessage( following ), 4000, "UNDO", self.followAuthor ); self.updateUserAuthor( { "following": following } ); self.userAuthorRequestOnFlight( true ); dataAccessor.followOrUnfollowAuthor( self.author.authorId(), following, function( userAuthor ) { self.userAuthorRequestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); }, function( error ) { self.userAuthorRequestOnFlight( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "Some error Occurred! Please try again!" ); self.updateUserAuthor( { "following": ! following } ); }); }; /* Publish or Unpublish */ this.togglePratilipiState = function() { var currentState = self.pratilipi.state(); var newState = self.pratilipi.state() != "PUBLISHED" ? "PUBLISHED" : "DRAFTED"; var getPublishedMessage = function( newState ) { var text = newState == "PUBLISHED" ? "You have published $pratilipiTitle" : "You have unpublished $pratilipiTitle"; var title = self.pratilipi.title().substring( 0, 10 ) + ( self.pratilipi.title().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; if( newState == "DRAFTED" ) /* Toast only for Add to Drafts action */ ToastUtil.toastCallBack( getPublishedMessage( newState ), 4000, "UNDO", self.togglePratilipiState ); else ToastUtil.toast( getPublishedMessage( newState ), 3000 ); self.updatePratilipi( { "state": newState } ); self.pratilipiRequestOnFlight( true ); dataAccessor.createOrUpdatePratilipi( { "pratilipiId": self.pratilipi.pratilipiId(), "state": newState }, function( pratilipi ) { self.pratilipiRequestOnFlight( false ); }, function( error ) { self.pratilipiRequestOnFlight( false ); self.updatePratilipi( { "state": currentState } ); ToastUtil.toast( error.message, 3000 ); }); }; /* Share */ this.share = function() { var utmParameter = "utm_source=pratilipi_website&utm_medium=main_share_popup&utm_campaign=content_share"; ShareUtil.sharePratilipi( ko.mapping.toJS( self.pratilipi ), utmParameter ); }; /* Image Upload */ this.imageUploaded = ko.observable( false ); this.chooseImageFile = function() { document.getElementById( 'uploadPratilipiImageInput' ).value= null; document.getElementById( "uploadPratilipiImageInput" ).click(); }; this.uploadPratilipiImage = function( vm, evt ) { var files = evt.target.files; var file = files[0]; self.imageUploaded( true ); document.getElementById( "uploadPratilipiImageForm" ).submit(); }; this.iframeLoaded = function( vm, evt ) { if( ! self.imageUploaded() ) return; var response = JSON.parse( evt.currentTarget.contentDocument.body.innerText ); if( response[ "coverImageUrl" ] != null ) { /* Success Callback */ var coverImageUrl = response[ "coverImageUrl" ]; self.updatePratilipi( { "coverImageUrl": coverImageUrl } ); ToastUtil.toast( "Success!", 3000 ); } else if( response[ "message" ] != null ) { ToastUtil.toast( response[ "message" ], 3000 ); } self.imageUploaded( false ); }; /* Delete Pratilipi */ this.openDeletePratilipiDialog = function() { $( "#pratilipi-info-delete-confirmation-dialog" ).modal(); }; this.deletePratilipi = function() { var currentState = self.pratilipi.state(); var pratilipi = { "pratilipiId": self.pratilipi.pratilipiId(), "state": "DELETED" }; self.pratilipiRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.createOrUpdatePratilipi( pratilipi, function( pratilipi ) { ToastUtil.toast( "The content has been deleted successfully!", 3000 ); window.location.href = self.author.pageUrl(); }, function( error ) { self.pratilipiRequestOnFlight( false ); self.updatePratilipi( { "state": currentState } ); ToastUtil.toast( error.message, 3000 ); }); }; /* Computed observables - separate observers for ID and meta - performance optimization */ this.authorIdObserver = ko.computed( function() { /* Check for the exact data. * ko mapping updates properties in a different fashion * First it updates only the 'pratilipi' object * Then it updates the 'author' object inside 'pratilipi' object * As a result, the function will be called 2 times if we check for pratilipiId */ if( self.pratilipi.author.authorId() == null ) return; self.fetchAuthorAndUserAuthor(); }, this ); this.pratilipiMetaObserver = ko.computed( function() { self.canAddToLibrary( self.pratilipi.state() == "PUBLISHED" && ( appViewModel.user.isGuest() || self.pratilipi.author.authorId() != appViewModel.user.author.authorId() ) ); self.canShare( self.pratilipi.state() == "PUBLISHED" ); self.canDelete( self.pratilipi.state() == "DRAFTED" && self.pratilipi.hasAccessToUpdate() ); self.authorIsUser( self.pratilipi.author.authorId() == appViewModel.user.author.authorId() ); }, this ); } , template: `<div class="pratilipi-pratilipi-info"><!-- ko component: "pratilipi-author-leaderboard" --><!-- /ko --><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="mdl-grid" style="padding: 1px; width: 100%;"><div class="pratilipi-cover-image-container"><pratilipi-image data-bind="visible: !imageUploaded()"params="{ src: pratilipi.coverImageUrl,width: 200,height: 300,mobWidth: 150,mobHeight: 225,alt: pratilipi.title }"></pratilipi-image><div data-bind="visible: imageUploaded()" class="pratilipi-cover-image image-uploaded-div"><div class="pratilipi-cover-image spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div><button class="upload-image-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseImageFile,visible: pratilipi.hasAccessToUpdate() && ! imageUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadPratilipiImageForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/pratilipi/cover?pratilipiId=' + pratilipi.pratilipiId() }, uniqueName: true }"target="pratilipi_upload_target"><input id="uploadPratilipiImageInput"data-bind="{ event: { change: uploadPratilipiImage }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="pratilipi_upload_target"name="pratilipi_upload_target"style="display: none;"data-bind="event: { load: iframeLoaded }"></iframe></div><div class="mdl-grid mdl-grid--no-spacing pratilipi-info-variable-width" style="flex-grow: 1; margin: 8px;"><div class="mdl-cell mdl-cell--12-col mdl-cell--order-1 mdl-cell--order-1-phone"><div class="mdl-card__title"><div class="material-heading pratilipi-title" data-bind="text: pratilipi.title()"></div><button data-bind="visible: pratilipi.hasAccessToUpdate()"class="mdl-button mdl-js-button mdl-button--icon"data-toggle="modal" data-target="#pratilipi_edit_pratilipi"><i class="material-icons">create</i></button></div><div class="mdl-card__title"><a class="material-title author-name"onclick="ga_CA( 'Author', 'Open' )"data-bind="attr: { href: pratilipi.author.pageUrl() },text: pratilipi.author.name()"></a></div><div class="mdl-card__supporting-text"><p class="material-subtitle-1 margin-bottom-8" data-bind="visible: pratilipi.averageRating() > 0"><!--ko text: roundOffToOneDecimal( pratilipi.averageRating() ) --><!--/ko--><i class="material-icons material-icons-16 vertical-middle icon-center">star</i>&nbsp;&nbsp;(<!--ko text: pratilipi.ratingCount() --><!--/ko--><i class="material-icons material-icons-16 vertical-middle icon-center">person</i>)</p><p class="font-16 margin-bottom-8"> READS:&nbsp;<!--ko text: formatReadCount( pratilipi.readCount() ) --><!--/ko--></p></div></div><div class="mdl-cell mdl-cell--12-col mdl-cell--order-3 mdl-cell--order-2-phone button-holders"><div class="mdl-card__actions" style="padding: 0;"><a onclick="ga_CA( 'Pratilipi', 'Read' )"data-bind="{ attr: { href: pratilipi.readPageUrl() },text: pratilipi.state() == 'PUBLISHED' ? 'Read' : 'Preview' }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></a><button onclick="ga_CA( 'Pratilipi', 'Add To Library' )"data-bind="{ text: ( userPratilipi.addedToLib() ? '-' : '+' ) + ' ' + 'Library',click: addToLibrary,disable: userPratilipiRequestOnFlight,visible: canAddToLibrary() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></button><button data-bind="{ visible: pratilipi.hasAccessToUpdate(),text: ( pratilipi.state() == 'PUBLISHED' ? 'Move to Drafts' : 'Publish' ),click: togglePratilipiState,disable: pratilipiRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin"></button><a data-bind="{ visible: pratilipi.hasAccessToUpdate() && ! isMobile(), attr: { 'href': pratilipi.writePageUrl() } }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">create</i></a><button data-bind="{ visible: canDelete(),click: openDeletePratilipiDialog,disable: pratilipiRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin">Delete</button><button onclick="ga_CA( 'Pratilipi', 'Share' )"data-bind="{ visible: canShare(), click: share }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">share</i></button></div></div><div class="mdl-cell mdl-cell--12-col mdl-cell--order-2 mdl-cell--order-3-phone"><div class="mdl-card__supporting-text"><p class="margin-bottom-8">Listing Date:&nbsp;<!--ko text: convertDate( pratilipi.listingDateMillis() ) --><!--/ko--></p><p class="font-16 margin-bottom-8" data-bind="text: getPratilipiTypeVernacular( pratilipi.type() )"></p></div></div></div><!-- ko if: pratilipi.hasAccessToUpdate() --><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><!-- ko component: {name: "pratilipi-tags",params: {pratilipi: pratilipi}} --><!-- /ko --><!-- /ko --><!-- ko if: pratilipi.summary() || pratilipi.hasAccessToUpdate() --><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><h3 class="mdl-cell mdl-cell--12-col material-title" style="margin: 8px 16px;">Summary<button data-bind="{ visible: pratilipi.hasAccessToUpdate(), click: toggleSummaryInput }" class="mdl-button mdl-js-button mdl-button--icon" style="margin-left: 4px;"><i style="font-size: 20px" class="material-icons">create</i></button></h3><div class="mdl-cell mdl-cell--12-col mdl-card__supporting-text" style="margin: 8px 16px;"><pratilipi-see-more data-bind="visible: ! summaryInputActive() && pratilipi.summary() != null" params="{ originalText: pratilipi.summary(), uniqueName: 'pratilipi-summary' }"></pratilipi-see-more><button style="outline: none; background: none; border: none; padding: 0; margin: 0; color: inherit; cursor: pointer;"class="material-subtitle-1"data-bind="visible: pratilipi.summary() == null && ! summaryInputActive(), click: openSummaryInput">Please click here to add summary</button><div data-bind="visible: summaryInputActive()" class="summary-input-div"><textarea data-bind="{ mdlFloatingInput: { label: '', value: summaryInputValue, id: 'pratilipi_pratilipi_info_summary_input' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea><div class="summary-input-footer" style="text-align: right;"><button data-bind="click: closeSummaryInput, disable: summaryInputRequestOnFlight()" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin">Cancel</button><button data-bind="click: submitSummaryInput, disable: summaryInputRequestOnFlight()" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin">Save Changes</button></div></div></div><!-- /ko --><!-- ko if: ! authorIsUser() --><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><h3 class="mdl-cell mdl-cell--12-col material-title"style="margin: 8px 16px;"data-bind="text: author.summary() != null ? 'About' : 'Author'"></h3><div data-bind="visible: ! authorLoaded()"style="margin: 25px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div class="mdl-cell mdl-cell--12-col"style="display: flex; align-items: center; justify-content: space-between; margin: 8px 16px;"data-bind="visible: authorLoaded()"><div class="author-meta-holder"><img data-bind="attr: { src: getImageUrl( author.profileImageUrl(), 48 ) }" class="mdl-list__item-avatar"><a onclick="ga_CA( 'Author', 'Open' )" class="author-name font-m" data-bind="attr: { href: pratilipi.author.pageUrl() }, text: pratilipi.author.name()"></a><button data-bind="{ click: followAuthor,text: userAuthor.following() ? 'Following': 'Follow',disable: userAuthorRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--primary mdl-layout--large-screen-only"style="margin-left: auto;"></button><button data-bind="{ click: followAuthor,disable: userAuthorRequestOnFlight }"class="mdl-button mdl-js-button mdl-button--icon mdl-button--colored mdl-layout--small-screen-only"style="margin-left: auto;"><i class="material-icons" data-bind="text: ( userAuthor.following() ? 'done' : 'person_add' )"></i></button></div></div><div class="mdl-cell mdl-cell--12-col padding-zero author-summary"style="margin: 4px 16px 8px 16px;"data-bind="visible: author.summary() != null"><pratilipi-see-more params="{ originalText: author.summary(), uniqueName: 'author-summary' }"></pratilipi-see-more></div><!-- /ko --></div></div></div><!-- Delete Pratilipi Modal --><div class="modal common-modal fade" id="pratilipi-info-delete-confirmation-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-info-delete-confirmation-dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">Delete Review</h6></div><div class="modal-body"><div class="material-subtitle-2">Do you want to delete the content?</div></div><div class="modal-footer"><button data-bind="click: deletePratilipi" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">Okay</button><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">Cancel</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-navigation-drawer', { viewModel: function() { var self = this; this.highLightNavigationEntry = function() { $( ".js-navigation-drawer a" ).each( function( index, element ) { $( element ).css( "font-weight", "400" ); if( window.location.pathname == "/search" ) { if( $( element ).attr( 'href' ) == "/search?q=" + appViewModel.searchQuery() ) $( element ).css( "font-weight", "700" ); } else if( $( element ).attr( 'href' ) == window.location.pathname ) { $( element ).css( "font-weight", "700" ); } }); }; this.navigationObserver = ko.computed( function() { appViewModel.searchQuery(); appViewModel.currentLocation(); setTimeout( function() { self.highLightNavigationEntry(); }, 0 ); }, this ); $( ".js-navigation-drawer a" ).click( function() { document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }); } , template: `<div class="mdl-layout__drawer mdl-layout--small-screen-only js-navigation-drawer"><nav class="mdl-navigation pratilipi-navigation-drawer"><h6 class="font-l">Navigation</h6><h6 class="font-l">/books Books</h6><h6 class="font-l">/stories Stories</h6><h6 class="font-l">/poems Poems</h6><h6 class="font-l">/articles Articles</h6><h6 class="font-l">/magazines Magazines</h6></nav></div>` }); </script> <script> ko.components.register( 'pratilipi-rating', { viewModel: function( params ) { /* Pass rating in parameter as an ko.observable */ this.rating = params.rating != null ? params.rating : ko.observable( 0 ); } , template: `<!-- ko if: rating() > 0 --><!-- ko foreach: ko.utils.range( 1, rating() ) --><i class="material-icons material-icons-16">star</i><!-- /ko --><!-- ko foreach: ko.utils.range( 1, 5 - rating() ) --><i class="material-icons material-icons-16">star_border</i><!-- /ko --><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-event-list-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.eventList = ko.observableArray(); this.isLoading = ko.observable(); this.fetchEventList = function() { self.isLoading( true ); dataAccessor.getEventList( function( eventListResponse ) { if( eventListResponse == null ) { self.isLoading( false ); return; } self.eventList( eventListResponse.eventList ); self.isLoading( false ); }); }; this.fetchEventList(); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-event-list-page generic-list-page"><div class="load-more-container mdl-card-border material-heading"style="margin-top: 0;">Events</div><div data-bind="foreach: { data: eventList, as: 'event' }, visible: eventList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><div class="event-container"><a class="event-cover-image"onclick="ga_CA( 'Event', 'Open' )"data-bind="attr: { 'alt': event.name, href: event.pageUrl },style: { backgroundImage: 'url(' + getImageUrl( event.bannerImageUrl, 500 ) + ')' }"></a><div class="event-meta-container"><a class="material-title event-title"onclick="ga_CA( 'Event', 'Open' )"data-bind="text: event.name, attr: { 'alt': event.name, href: event.pageUrl }"></a><a data-bind="{ attr: { 'href': event.pageUrl } }"onclick="ga_CA( 'Event', 'Open' )"target="_blank"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect small-button pull-right"><i class="material-icons" style="font-size: 20px;">open_in_new</i></a></div></div></div></div><div class="load-more-container mdl-card-border text-center" data-bind="visible: isLoading()"><span data-bind="visible: eventList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: eventList().length == 0"></pratilipi-loading-state></div></div>` }); </script> <script> ko.components.register( 'pratilipi-rating-input', { viewModel: function( params ) { var self = this; /* Pass rating in parameter as an ko.observable */ this.rating = params.rating; this.setRating = function( rating ) { if( rating == null ) self.rating( 0 ); if( rating < 0 ) self.rating( 0 ); if( rating > 5 ) self.rating( 5 ); self.rating( rating ); ga_CA( 'Review', 'Star Rating' ); } } , template: `<!-- ko foreach: ko.utils.range( 1, rating() ) --><i class="material-icons material-icons-36 pratilipi-red clickable-element" data-bind="click: $parent.setRating.bind($data, $data)">star</i><!-- /ko --><!-- ko foreach: ko.utils.range( 1, 5 - rating() ) --><i class="material-icons material-icons-36 clickable-element" data-bind="click: $parent.setRating.bind($data, $data + $parent.rating() )">star_border</i><!-- /ko -->` }); </script> <script> ko.components.register( 'pratilipi-write', { viewModel: function( params ) { var self = this; this.title = ko.observable( '' ); this.titleEn = ko.observable( '' ); this.type = ko.observable( null ); this.agreedTerms = ko.observable( false ); this.requestOnFlight = ko.observable( false ); this.submit = function() { if( self.requestOnFlight() ) return; if( self.title().trim() == "" ) { ToastUtil.toast( "Please enter a title" ); return; } if( self.type() == null || self.type().trim() == "" ) { ToastUtil.toast( "Please select a category" ); return; } if( ! self.agreedTerms() ) { ToastUtil.toast( "Please accept Copyright Policy and Terms of Services" ); return; } var successCallBack = function( pratilipi ) { ToastUtil.toastUp( "Success!" ); window.location.href = pratilipi.writePageUrl; }; var errorCallBack = function( error, status ) { ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); self.requestOnFlight( false ); }; ToastUtil.toastUp( "Working ..." ); self.requestOnFlight( true ); var pratilipi = { "title": self.title(), "titleEn": self.titleEn(), "language": "ENGLISH", "type": self.type(), "state": "DRAFTED" }; if( appViewModel.pratilipiWriteAuthorId() != null ) pratilipi[ "authorId" ] = appViewModel.pratilipiWriteAuthorId(); var dataAccessor = new DataAccessor(); dataAccessor.createOrUpdatePratilipi( pratilipi, successCallBack, errorCallBack ); }; this.updateType = function() { self.type( document.querySelector( '#pratilipiWrite #pratilipi_write_type' ).getAttribute( "data-val" ) ); }; this.canCreatePratilipi = ko.computed( function() { return self.title() != null && self.title() != "" && self.agreedTerms() && self.type() != null && ! self.requestOnFlight(); }, this ); $( "#pratilipiWrite" ).on( 'hidden.bs.modal', function(e) { appViewModel.pratilipiWriteAuthorId( null ); self.title( null ); self.titleEn( null ); self.type( null ); self.agreedTerms( false ); $( '#pratilipiWrite #agree-terms-conditions' ).parent().removeClass( "is-checked" ); $( '#pratilipiWrite #pratilipi_write_type' ).attr( "data-val", null ); $( '#pratilipiWrite #pratilipi_write_type' ).attr( "value", null ); $( '#pratilipiWrite #pratilipi_write_type' ).val( null ); $( '#pratilipiWrite #pratilipi_write_type' ).parent().removeClass("is-dirty"); getmdlSelect.init( ".getmdl-select" ); }); } , template: `<div class="modal fade pratilipi-write" id="pratilipiWrite" tabindex="-1" role="dialog" aria-labelledby="pratilipi-write"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span data-dismiss="modal" aria-label="Close" class="material-icons close">close</span><h6 class="material-title">Add Title</h6></div><div class="modal-body"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="pratilipi_write_language"data-val="ENGLISH"value="English"type="text" readonly tabIndex="-1" /><label class="mdl-textfield__label" for="pratilipi_write_language">Language<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi_write_language"><a class="mdl-menu__item" href="https://hindi.pratilipi.com/?action=write">हिंदी</a><a class="mdl-menu__item" href="https://gujarati.pratilipi.com/?action=write">ગુજરાતી</a><a class="mdl-menu__item" href="https://tamil.pratilipi.com/?action=write">தமிழ்</a><a class="mdl-menu__item" href="https://marathi.pratilipi.com/?action=write">मराठी</a><a class="mdl-menu__item" href="https://malayalam.pratilipi.com/?action=write">മലയാളം</a><a class="mdl-menu__item" href="https://bengali.pratilipi.com/?action=write">বাংলা</a><a class="mdl-menu__item" href="https://telugu.pratilipi.com/?action=write">తెలుగు</a><a class="mdl-menu__item" href="https://kannada.pratilipi.com/?action=write">ಕನ್ನಡ</a></ul></div><input data-bind="{ mdlFloatingInput: { label: 'Enter Title Here *', value: title, id: 'pratilipi_write_title_input' }, valueUpdate: ['input'], transliterate: true }" /><div class="clearfix"></div><input data-bind="mdlFloatingInput: { label: 'Re-enter Title in English', value: titleEn, id: 'pratilipi_write_title_en_input' }" /><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input data-bind="event: { change: updateType }"class="mdl-textfield__input"id="pratilipi_write_type"type="text" readonly /><label class="mdl-textfield__label" for="pratilipi_write_type">Select Type *<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi_write_type"><li class="mdl-menu__item" data-val="POEM">Poem</li><li class="mdl-menu__item" data-val="STORY">Story</li><li class="mdl-menu__item" data-val="ARTICLE">Article</li></ul></div><div class="accept-terms"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect terms-conditions" for="agree-terms-conditions"><input data-bind="checked: agreedTerms" type="checkbox" id="agree-terms-conditions" class="mdl-checkbox__input" /><span class="mdl-checkbox__label font-s">I accept Copyright Policy and Terms of Services</span></label><a class="font-s" target="_blank" href="/terms-of-service">Read copyright policy here</a></div></div><div class="modal-footer"><button onclick="ga_CA( 'Pratilipi', 'Create' )"data-bind="{ click: submit, enable: canCreatePratilipi }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect font-m"type="button">Next</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-footer', { viewModel: function( params ) {} , template: `<footer class="mdl-mega-footer font-s"><div class="mdl-mega-footer__middle-section"><div onclick="ga_CA( 'Footer', 'GPS App' )"class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" unchecked><h1 class="mdl-mega-footer__heading">Mobile App</h1><ul class="mdl-mega-footer__link-list"><li><a href="https://play.google.com/store/apps/details?id=com.pratilipi.mobile.android&utm_source=web_footer&utm_campaign=app_download"><div class="sprites-icon google-play-icon"></div></a></li></ul></div><div class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" unchecked><h1 class="mdl-mega-footer__heading">Contact Us</h1><ul class="mdl-mega-footer__link-list" style="vertical-align: middle;"><li><a href="tel:08041710149"><i class="material-icons material-icons-16 vertical-middle">phone</i>080 41710149</a></li><li><a href="mailto:contact@pratilipi.com"><i class="material-icons material-icons-16 vertical-middle">mail</i> contact@pratilipi.com</a></li></ul></div><div onclick="ga_CA( 'Footer', 'About Us' )"class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" checked><h1 class="mdl-mega-footer__heading">About Us</h1><ul class="mdl-mega-footer__link-list"><li><a href="/about/pratilipi">About Us</a></li><li><a href="/work-with-us">Work With Us</a></li><li><a href="/privacy-policy">Privacy Policy</a></li><li><a href="/terms-of-service">Terms</a></li></ul></div><div onclick="ga_CA( 'Footer', 'Company Social Media' )"class="mdl-mega-footer__drop-down-section"><input class="mdl-mega-footer__heading-checkbox" type="checkbox" checked><h1 class="mdl-mega-footer__heading">Follow us on Social Media</h1><ul class="mdl-mega-footer__link-list"><li><div class="sprites-icon footer-social-icons facebook-icon"></div><a href="https://www.facebook.com/Pratilipidotcom">Facebook</a></li><li><div class="sprites-icon footer-social-icons twitter-icon"></div><a href="https://twitter.com/TeamPratilipi">Twitter</a></li><li><div class="sprites-icon footer-social-icons google-plus-icon"></div><a href="https://plus.google.com/+PratilipiTeam">Google Plus</a></li><li><div class="sprites-icon footer-social-icons linkedin-icon"></div><a href="https://www.linkedin.com/company/pratilipi">Linkedin</a></li></ul></div></div><div class="mdl-mega-footer__bottom-section"><div class="mdl-logo" data-bind="html: '&copy; ' + new Date().getFullYear() + ' Nasadiya Tech. Pvt. Ltd.'"></div></div></footer>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi2016-page', { viewModel: function() { var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; this.image = "http://public.pratilipi.com/year-in-review-2016/" + ( windowsize < 768 ? "low-res" : "high-res" ) + "/YearInReview-en.jpg"; } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card mdl-card-border"><img data-bind="attr: { src: image }" style="width: 100%; max-width: 100%;" /></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-navigation', { viewModel: function( params ) { var self = this; this.index = params.index; this.chapterNo = params.chapterNo; this.setChapterNo = params.setChapterNo; this.changeChapter = function( vm, e ) { self.setChapterNo( vm.chapterNo ); }; } , template: `<div class="pratilipi-reader-navigation"><!-- ko foreach: { data: index() } --><a class="index-entry"onclick="ga_CA( 'Pratilipi', 'ChangeChapter' );"data-bind="{ text: $data.title, css: { 'highlight': $data.chapterNo == $parent.chapterNo() }, click: $parent.changeChapter }"></a><!--/ko--></div>` }); </script> <script> ko.components.register( 'pratilipi-review-comment', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.comment = params.comment; this.deleteComment = params.deleteComment; this.toggleCommentInput = params.toggleCommentInput; this.isLiked = ko.observable( self.comment.isLiked ? self.comment.isLiked() : false ); this.likeCount = ko.observable( self.comment.likeCount ? self.comment.likeCount() : 0 ); /* Like / Dislike Comment */ this.voteRequestOnFlight = ko.observable( false ); this.likeOrDislikeComment = function() { if( appViewModel.user.isGuest() ) { goToLoginPage(); return; } if( self.voteRequestOnFlight() ) return; self.voteRequestOnFlight( true ); var toggleIsLiked = function() { self.likeCount( self.isLiked() ? self.likeCount() - 1 : self.likeCount() + 1 ); self.isLiked( ! self.isLiked() ); }; toggleIsLiked(); dataAccessor.likeOrDislikeComment( self.comment.commentId(), self.isLiked(), function( vote ) { self.voteRequestOnFlight( false ); }, function( error ) { toggleIsLiked(); self.voteRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); }); }; /* Edit Comment - Input */ this.editCommentInput = ko.observable(); this.editCommentVisible = ko.observable( false ); this.openEditComment = function() { self.editCommentInput( self.comment.content() ); self.editCommentVisible( true ); }; this.closeEditComment = function() { self.editCommentVisible( false ); }; /* Edit Comment - Submit */ this.editCommentRequestOnFlight = ko.observable( false ); this.submitEditComment = function() { if( self.editCommentRequestOnFlight() ) return; self.editCommentRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.createOrUpdateReviewComment( null, self.comment.commentId(), self.editCommentInput(), function( comment ) { self.comment.content( comment.content ); self.closeEditComment(); self.editCommentRequestOnFlight( false ); ToastUtil.toast( "Success!" ); }, function( error ) { self.editCommentRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); }); }; /* Computed observables */ this.canSubmitEditComment = ko.computed( function() { return self.editCommentVisible() && self.editCommentInput() != null && self.editCommentInput().trim() != "" && ! self.editCommentRequestOnFlight(); }, this ); } , template: `<div class="pratilipi-review-comment"><div class="comment-header"><div class="user-info"><img data-bind="attr: { src: getImageUrl( comment.user.profileImageUrl(), 48 ) }" class="mdl-list__item-avatar"><div style="padding: 0 8px;"><a class="commentor-name material-subtitle-1" data-bind="attr: { href: comment.user.profilePageUrl() }, text: comment.user.displayName()"></a><br/><span class="font-xs comment-date" data-bind="text: convertDate( comment.creationDateMillis() )"></span></div></div></div><div data-bind="visible: ! editCommentVisible()"><div class="comment-container material-subtitle-1" data-bind="text: comment.content()"></div><div class="comment-footer"><span class="like-holder"><span class="font-s" data-bind="visible: likeCount() > 0, text: likeCount()"></span><button data-bind="click: likeOrDislikeComment, disable: voteRequestOnFlight" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16" data-bind="css: { 'mdl-color-text--primary': isLiked() }">thumb_up</i></button></span><span class="separator"></span><span class="comment-holder"><button data-bind="click: toggleCommentInput" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16">message</i></button></span><div data-bind="visible: comment.hasAccessToUpdate()" class="dropup pull-right"><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="attr: { 'id': 'pratilipi-review-comment-' + comment.commentId() }"><i class="material-icons">more_vert</i></button><ul class="mdl-menu mdl-menu--top-right mdl-js-menu mdl-js-ripple-effect"data-bind="attr: { 'data-mdl-for': 'pratilipi-review-comment-' + comment.commentId() }"><li data-bind="click: openEditComment" class="mdl-menu__item">Edit Comment</li><li data-toggle="modal"data-bind="attr: { 'data-target': '#pratilipi-comment-delete-confirmation-' + comment.commentId() }"class="mdl-menu__item">Delete Comment</li></ul></div></div></div><div class="comment-container" data-bind="visible: editCommentVisible()"><textarea data-bind="{ mdlFloatingInput: { label: 'Type here to reply',value: editCommentInput, id: 'pratilipi-review-comment-input-' + comment.commentId() },valueUpdate: ['input'],transliterate: true }"></textarea><div style="height: 36px;"><div class="pull-right"><button data-bind="click: closeEditComment" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">Cancel</button><button data-bind="enable: canSubmitEditComment, click: submitEditComment" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">Submit</button></div></div></div></div><div class="modal common-modal fade" tabindex="-1" role="dialog" data-bind="attr: { 'id': 'pratilipi-comment-delete-confirmation-' + comment.commentId() }"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-dismiss="modal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">Delete Comment</h6></div><div class="modal-body"><div class="material-subtitle-2">Are you sure to delete this comment?</div></div><div class="modal-footer"><button data-bind="click: deleteComment" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">Yes</button><button class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised" data-dismiss="modal">No</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-info', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* Setting Local Variables */ this.author = params.author; this.userAuthor = params.userAuthor; this.updateAuthor = params.updateAuthor; this.updateUserAuthor = params.updateUserAuthor; this.authorDisplayName = ko.computed( function() { return self.author.fullName() != null ? self.author.fullName() : self.author.fullNameEn(); }, this ); /* Follow/Unfollow Author */ this.followRequestOnFlight = ko.observable( false ); this.followOrUnfollowAuthor = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "FOLLOW" } ); return; } if( self.followRequestOnFlight() ) return; self.followRequestOnFlight( true ); ToastUtil.toast( "Success!" ); var switchState = function() { self.updateAuthor( { "followCount": self.userAuthor.following() ? self.author.followCount() - 1 : self.author.followCount() + 1 } ); self.updateUserAuthor( { "following": ! self.userAuthor.following() } ); }; switchState(); dataAccessor.followOrUnfollowAuthor( self.author.authorId(), self.userAuthor.following(), function( userAuthor ) { self.followRequestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); }, function( error ) { self.followRequestOnFlight( false ); switchState(); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "Some error Occurred! Please try again!", 3000, true ); }); }; /* Can Follow and Settings Link */ this.canFollow = ko.observable( false ); this.settingsLink = ko.observable( "/settings" ); this.authorObserver = ko.computed( function() { if( self.author.authorId() == null && self.author.user.userId() == null ) return; /* self.author.user.userId() => null for fictional Authors */ self.canFollow( appViewModel.user.userId() != self.author.user.userId() ); if( self.author.hasAccessToUpdate() && appViewModel.user.userId() != self.author.user.userId() ) /* AEEs */ self.settingsLink( "/settings?authorId=" + self.author.authorId() + "&userId=" + self.author.user.userId() ); else self.settingsLink( "/settings" ); }, this ); /* Share Author */ this.shareAuthor = function() { ShareUtil.shareAuthor( ko.mapping.toJS( self.author ) ); ga_CA( appViewModel.isUserPage() ? 'User' : 'Author', 'Share' ); }; /* Image Upload */ this.imageUploaded = ko.observable( false ); this.chooseImageFile = function() { document.getElementById( 'uploadAuthorImageInput' ).value= null; document.getElementById( "uploadAuthorImageInput" ).click(); }; this.uploadAuthorImage = function( vm, evt ) { var files = evt.target.files; var file = files[0]; self.imageUploaded( true ); document.getElementById( "uploadAuthorImageForm" ).submit(); }; this.iframeLoaded = function( vm, evt ) { if( ! self.imageUploaded() ) return; var response = JSON.parse( evt.currentTarget.contentDocument.body.innerText ); if( response[ "coverImageUrl" ] != null ) { /* Success Callback */ self.updateAuthor( { "profileImageUrl": response[ "coverImageUrl" ] } ); ToastUtil.toast( "Success!", 3000 ); } else if( response[ "message" ] != null ) { ToastUtil.toast( response[ "message" ], 3000 ); } self.imageUploaded( false ); }; /* Cover Upload */ this.coverUploaded = ko.observable( false ); this.chooseCoverFile = function() { document.getElementById( 'uploadAuthorCoverInput' ).value= null; document.getElementById( "uploadAuthorCoverInput" ).click(); }; this.uploadAuthorCover = function( vm, evt ) { var files = evt.target.files; var file = files[0]; self.coverUploaded( true ); document.getElementById( "uploadAuthorCoverForm" ).submit(); }; this.coverIframeLoaded = function( vm, evt ) { if( ! self.coverUploaded() ) return; var response = JSON.parse( evt.currentTarget.contentDocument.body.innerText ); if( response[ "coverImageUrl" ] != null ) { /* Success Callback */ self.updateAuthor( { "coverImageUrl": response[ "coverImageUrl" ] } ); ToastUtil.toast( "Success!", 3000 ); } else if( response[ "message" ] != null ) { ToastUtil.toast( response[ "message" ], 3000 ); } self.coverUploaded( false ); }; this.getReadCountText = ko.computed( function() { return "Read by $read_count people".replace( "$read_count", formatReadCount( self.author.totalReadCount() ) ); }, this ); /* UI Helpers */ this.focusPublishedContentSection = function() { var targetDiv = $( '.js-pratilipi-author-info' ); appViewModel.scrollToTop( $( ".js-author-published-contents" ).position().top + $( ".js-pratilipi-header" ).height() ); }; } , template: `<div class="pratilipi-author-info js-pratilipi-author-info mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="author-cover-image-holder"><div class="author-cover-image"data-bind="attr: { 'alt': authorDisplayName() },css: { 'image-loading': coverUploaded() },style: { backgroundImage: 'url(' + author.coverImageUrl() + ')' }"></div><div data-bind="visible: coverUploaded()" class="cover-spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><button onclick="ga_CA( 'User', 'UserCoverImageChange' )"class="upload-cover-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseCoverFile,visible: author.hasAccessToUpdate() && ! coverUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadAuthorCoverForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/author/cover?authorId=' + author.authorId() }, uniqueName: true }"target="author_cover_upload_target"><input id="uploadAuthorCoverInput"data-bind="{ event: { change: uploadAuthorCover }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="author_cover_upload_target"name="author_cover_upload_target"style="display: none;"data-bind="event: { load: coverIframeLoaded }"></iframe></div><div class="author-meta-holder"><div class="author-profile-image-holder"><img class="author-profile-image"data-bind="attr: { 'src': getImageUrl( author.profileImageUrl(), 200 ), 'alt': authorDisplayName() },css: { 'image-loading': imageUploaded() }" /><div data-bind="visible: imageUploaded()" class="spinner-container"><span class="image-uploaded-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><button onclick="ga_CA( 'User', 'UserProfileImageChange' )"class="upload-image-button mdl-button mdl-js-button mdl-button--fab"data-bind="{ click: chooseImageFile,visible: author.hasAccessToUpdate() && ! imageUploaded() }"><i class="material-icons">camera_alt</i></button><form id="uploadAuthorImageForm"style="position: absolute; top: -1000px;"method="post"enctype="multipart/form-data"data-bind="{ attr: { 'action': '/api/author/image?authorId=' + author.authorId() }, uniqueName: true }"target="author_upload_target"><input id="uploadAuthorImageInput"data-bind="{ event: { change: uploadAuthorImage }, uniqueName: true }"type="file"accept="image/*"></form><iframe id="author_upload_target"name="author_upload_target"style="display: none;"data-bind="event: { load: iframeLoaded }"></iframe></div><div class="author-meta"><div class="first-line"><div class="author-name-desktop material-heading" data-bind="text: authorDisplayName()"></div><div class="pull-right"><button data-bind="{ text: userAuthor.following() ? 'Following' : 'Follow',click: followOrUnfollowAuthor,visible: canFollow(),disable: followRequestOnFlight() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin font-m"></button><a onclick="ga_CA( 'User', 'Settings' )"data-bind="visible: author.hasAccessToUpdate(), attr: { 'href': settingsLink() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">settings</i></a><!-- GA events sent from Js for sharing --><button data-bind="click: shareAuthor"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button"><i class="material-icons material-icons-16">share</i></button></div></div><div class="author-summary-desktop"><div class="author-read-count material-subtitle-1"data-bind="{ visible: author.totalReadCount() > 0, text: getReadCountText(), css: { 'pratilipi-red': appViewModel.user.author.authorId() == author.authorId() } }"></div><div class="author-summary material-subtitle-1" onclick="ga_CA( 'Author', 'LoadMore' )" data-bind="seeMoreText: { value: author.summary(), lines: 1 }"></div></div></div></div><div class="author-meta-holder-mobile"><div class="author-name-mobile material-heading" data-bind="text: authorDisplayName()"></div><div class="author-read-count material-subtitle-1"data-bind="{ visible: author.totalReadCount() > 0, text: getReadCountText(), css: { 'pratilipi-red': appViewModel.user.author.authorId() == author.authorId() } }"></div><div class="author-summary material-subtitle-1" onclick="ga_CA( 'Author', 'LoadMore' )" data-bind="seeMoreText: { value: author.summary(), lines: 1 }"></div></div><div class="mdl-cell mdl-cell--12-col padding-zero"><hr class="margin-zero"></div><div class="author-stats-holder"><div class="mdl-cell mdl-cell--4-col"data-bind="css: { 'clickable-element': author.contentPublished() > 0 }, click: focusPublishedContentSection"><div class="material-subtitle-1" data-bind="text: author.contentPublished()"></div><div class="material-body-1">Contents</div></div><div class="mdl-cell mdl-cell--4-col"data-bind="attr: { 'data-toggle': author.followCount() > 0 ? 'modal' : '' }, css: { 'clickable-element': author.followCount() > 0 }"data-target="#pratilipi-author-follows-followers"><div class="material-subtitle-1" data-bind="text: author.followCount()"></div><div class="material-body-1">Followers</div></div><div class="mdl-cell mdl-cell--4-col clickable-element"data-bind="attr: { 'data-toggle': author.user.followCount() > 0 ? 'modal' : '' }, css: { 'clickable-element': author.user.followCount() > 0 }"data-target="#pratilipi-author-follows-following"><div class="material-subtitle-1" data-bind="text: author.user.followCount()"></div><div class="material-body-1">Following</div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-edit-pratilipi', { viewModel: function( params ) { var self = this; var editPratilipiDialog = $( "#pratilipi_edit_pratilipi" ); var dropdown = $( "#pratilipi_edit_pratilipi #pratilipi_edit_pratilipi_type" ); this.pratilipi = params.pratilipi; this.updatePratilipi = params.updatePratilipi; this.pratilipiId = ko.observable( null ); this.title = ko.observable(); this.titleEn = ko.observable(); /* this.type = ko.observable(); */ this.setToDefault = function() { self.pratilipiId( self.pratilipi.pratilipiId() ); self.title( self.pratilipi.title() ); self.titleEn( self.pratilipi.titleEn() ); /* self.type( self.pratilipi.type() ); dropdown.attr( 'data-val', self.pratilipi.type() ); dropdown.attr( 'value', getPratilipiTypeVernacular( self.pratilipi.type() ) ); dropdown.val( getPratilipiTypeVernacular( self.pratilipi.type() ) ); */ getmdlSelect.init( ".getmdl-select" ); }; this.pratilipiObserver = ko.computed( function() { if( self.pratilipi.pratilipiId() == null ) return; setTimeout( function() { self.setToDefault(); }, 0 ); }, this ); this.requestOnFlight = ko.observable( false ); this.submit = function() { if( self.requestOnFlight() ) return; if( self.title().trim() == "" ) { ToastUtil.toast( "Please enter a title" ); return; } /* if( self.type() == null || self.type().trim() == "" ) { ToastUtil.toast( "Please select a category" ); return; } */ var successCallBack = function( pratilipi ) { ToastUtil.toast( "Success!" ); self.updatePratilipi( pratilipi ); self.requestOnFlight( false ); self.closeEditPratilipi(); }; var errorCallBack = function( error, status ) { ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!", 3000 ); self.requestOnFlight( false ); }; ToastUtil.toastUp( "Working ..." ); var pratilipi = { "pratilipiId": self.pratilipiId(), "title": self.title(), "titleEn": self.titleEn() /* "type": self.type() */ }; self.requestOnFlight( true ); var dataAccessor = new DataAccessor(); dataAccessor.createOrUpdatePratilipi( pratilipi, successCallBack, errorCallBack ); }; /* this.updateType = function() { self.type( dropdown.attr( "data-val" ) ); }; */ this.canEditPratilipi = ko.computed( function() { return self.title() != null && self.title() != "" && ! self.requestOnFlight(); }, this ); this.closeEditPratilipi = function() { editPratilipiDialog.modal( "hide" ); setTimeout( function() { self.setToDefault(); }, 0); }; editPratilipiDialog.on( 'hidden.bs.modal', function(e) { self.closeEditPratilipi(); }); } , template: `<div class="modal fade pratilipi-edit-pratilipi" id="pratilipi_edit_pratilipi" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span data-bind="click: closeEditPratilipi" class="material-icons close clickable-element">close</span><h6 class="modal-title">Edit Info</h6></div><div class="modal-body"><input data-bind="{ mdlFloatingInput: { label: 'Enter Title Here *', value: title, id: 'pratilipi_edit_pratilipi_title_input' }, valueUpdate: ['input'], transliterate: true }" /><input data-bind="{ mdlFloatingInput: { label: 'Re-enter Title in English', value: titleEn, id: 'pratilipi_edit_pratilipi_title_en_input' }, valueUpdate: ['input'] }" /></div><div class="modal-footer"><button data-bind="{ click: submit, enable: canEditPratilipi() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"type="button">Save Changes</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-page', { viewModel: function() { var self = this; var defaultAuthor = { "authorId": null, "user": { "userId": null, "followCount": 0 }, "firstName": null, "firstNameEn": null, "lastName": null, "lastNameEn": null, "name": null, "nameEn": null, "fullName": null, "fullNameEn": null, "gender": null, "dateOfBirth": null, "language": null, "location": null, "summary": null, "pageUrl": null, "imageUrl": null, "hasCoverImage": false, "coverImageUrl": null, "hasProfileImage": false, "profileImageUrl": null, "registrationDateMillis": null, "followCount": 0, "contentDrafted": 0, "contentPublished": 0, "totalReadCount": 0, "totalFbLikeShareCount": 0, "following": false, "hasAccessToUpdate": false }; var defaultUserAuthor = { "authorId": null, "following": false }; this.author = ko.mapping.fromJS( defaultAuthor, {}, self.author ); this.userAuthor = ko.mapping.fromJS( defaultUserAuthor, {}, self.userAuthor ); this.updateAuthor = function( author, initialiseObject ) { var updatedAuthor = JSON.parse( JSON.stringify( initialiseObject ? defaultAuthor : author ) ); if( initialiseObject && author != null ) { if( author.summary != null && author.summary.trim() == "" ) author.summary = null; for( var key in author ) if( author.hasOwnProperty( key ) ) updatedAuthor[ key ] = author[ key ]; if( author.user != null ) { for( var key in author.user ) if( author.user.hasOwnProperty( key ) ) updatedAuthor.user[ key ] = author.user[ key ]; } } ko.mapping.fromJS( updatedAuthor, {}, self.author ); MetaTagUtil.setMetaTagsForAuthor( ko.mapping.toJS( self.author ) ); appViewModel.isUserPage( self.author.authorId() == appViewModel.user.author.authorId() ); }; this.updateUserAuthor = function( userAuthor, initialiseObject ) { var updatedUserAuthor = JSON.parse( JSON.stringify( initialiseObject ? defaultUserAuthor : userAuthor ) ); if( initialiseObject && userAuthor != null ) { for( var key in userAuthor ) if( userAuthor.hasOwnProperty( key ) ) updatedUserAuthor[ key ] = userAuthor[ key ]; } ko.mapping.fromJS( updatedUserAuthor, {}, self.userAuthor ); }; this.initialDataLoaded = ko.observable( false ); this.fetchAuthorAndUserAuthor = function() { var dataAccessor = new DataAccessor(); dataAccessor.getAuthorByUri( window.location.pathname, true, function( author, userAuthor ) { if( author == null ) { /* Invalid Uri */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND[ "ko_element" ] ); return; } self.updateAuthor( author, true ); self.updateUserAuthor( userAuthor, true ); if( ! self.initialDataLoaded() ) self.initialDataLoaded( true ); }); }; /* Landing from Search page */ var searchQuery = getUrlParameter( "searchQuery" ) != null ? decodeURIComponent( getUrlParameter( "searchQuery" ) ) : null; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.AUTHOR.ko_element ) { if( appViewModel.currentView() == LOCATION.SEARCH_V2.ko_element && searchQuery != null ) { setTimeout( function() { appViewModel.searchQuery( searchQuery ); }, 50 ); } /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchAuthorAndUserAuthor(); $( ".modal" ).modal( "hide" ); /* Follows Modal */ }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><!-- ko component: {name: "pratilipi-author-follows",params: { author: author }} --><!-- /ko --><!-- ko component: {name: "pratilipi-author-info",params: { author: author,updateAuthor: $data.updateAuthor,userAuthor: userAuthor,updateUserAuthor: $data.updateUserAuthor }} --><!-- /ko --><!-- ko component: {name: "pratilipi-author-contents",params: { author: author }} --><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-static-page', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.initialDataLoaded = ko.observable( false ); this.title = ko.observable(); this.content = ko.observable(); this.fetchStaticContent = function() { dataAccessor.getPageContent( window.location.pathname.substring(1).replace( "/", "_" ), function( pageContent ) { self.title( pageContent.title ); self.content( pageContent.content ); self.initialDataLoaded( true ); }); }; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.STATIC.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchStaticContent(); }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><span class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div style="margin-top: 0; " class="load-more-container material-heading" data-bind="text: title()"></div><div style="border-top: 1px solid lightgrey; padding: 16px;" class="material-subtitle-1 load-more-container" data-bind="html: content()"></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-footer', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.openSettings = params.openSettings; this.switchLibraryState = params.switchLibraryState; this.sharePratilipi = params.sharePratilipi; this.canOpenNavigationModal = params.canOpenNavigationModal; this.openNavigationModal = params.openNavigationModal; } , template: `<div class="pratilipi-reader-footer"><div class="menu-option-holder"><div class="menu-option"><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: openNavigationModal, enable: canOpenNavigationModal"><i class="material-icons">list</i></button></div><div class="menu-option"><button onclick="ga_CA( 'Pratilipi', 'Settings' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: openSettings"><i class="material-icons">settings</i></button></div><div class="menu-option"><button onclick="ga_CA( 'Pratilipi', 'AddToLibrary' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: switchLibraryState,disable: pratilipi.state() != 'PUBLISHED' || pratilipi.author.authorId() == appViewModel.user.author.authorId()"><i data-bind="css: { 'pratilipi-red': userPratilipi.addedToLib() }" class="material-icons">bookmark</i></button></div><div class="menu-option"><button onclick="ga_CA( 'Pratilipi', 'Share' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: sharePratilipi"><i class="material-icons">share</i></button></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-page', { viewModel: function() { var self = this; var defaultPratilipi = { "pratilipiId": null, "title": null, "titleEn": null, "language": null, "author": { "authorId": null,"name": null, "pageUrl": null }, "summary": null, "pageUrl": null, "coverImageUrl": null, "readPageUrl": null, "writePageUrl": null, "type": null, "state": null, "listingDateMillis": null, "wordCount": null, "reviewCount": null, "ratingCount": null, "averageRating": null, "readCount": null, "fbLikeShareCount": null, "hasAccessToUpdate": false, "tags": null, "suggestedTags": null }; var defaultUserPratilipi = { "userPratilipiId": null, "userId": null, "pratilipiId": null, "userName": null, "userImageUrl": null, "userProfilePageUrl": null, "rating": 0, "review": null, "reviewState": null, "addedToLib": false, "hasAccessToReview": true, "isLiked": false, }; this.pratilipi = ko.mapping.fromJS( defaultPratilipi, {}, self.pratilipi ); this.userPratilipi = ko.mapping.fromJS( defaultUserPratilipi, {}, self.userPratilipi ); /* START Developer : RAHUL RANJAN Function : Show share pop up when pratilipi.title() != null */ this.pratilipiTitle = ko.observable(); ko.computed( function() { if (this.pratilipi.title() == null) return; this.pratilipiTitle(this.pratilipi.title() + " "); /* Show popup for hindi and self published contents only */ var url = document.URL; if (sessionStorage.publishType && sessionStorage.publishType == "self" && appViewModel.language == "HINDI") { $("#shareModal").modal("show"); $("#shareModal").on('shown.bs.modal', function() { self.FBEvent("LANDED_SHARE_CONTENT", null); sessionStorage.publishType = null; }); } }, this); /* END */ this.updatePratilipi = function( pratilipi, initialiseObject ) { var updatedPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultPratilipi : pratilipi ) ); if( initialiseObject && pratilipi != null ) { if( pratilipi.summary != null && pratilipi.summary.trim() == "" ) pratilipi.summary = null; for( var key in pratilipi ) if( pratilipi.hasOwnProperty( key ) ) updatedPratilipi[ key ] = pratilipi[ key ]; if( pratilipi.author != null ) { for( var key in pratilipi.author ) if( pratilipi.author.hasOwnProperty( key ) ) updatedPratilipi.author[ key ] = pratilipi.author[ key ]; } } ko.mapping.fromJS( updatedPratilipi, {}, self.pratilipi ); MetaTagUtil.setMetaTagsForPratilipi( ko.mapping.toJS( self.pratilipi ) ); }; this.updateUserPratilipi = function( userPratilipi, initialiseObject ) { var updatedUserPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultUserPratilipi : userPratilipi ) ); if( initialiseObject && userPratilipi != null ) { if( userPratilipi.rating == null ) userPratilipi.rating = 0; if( userPratilipi.review != null && userPratilipi.review.trim() == "" ) userPratilipi.review = null; if( userPratilipi.reviewState != null && userPratilipi.reviewState != "PUBLISHED" ) userPratilipi.review = null; for( var key in userPratilipi ) if( userPratilipi.hasOwnProperty( key ) ) updatedUserPratilipi[ key ] = userPratilipi[ key ]; } ko.mapping.fromJS( updatedUserPratilipi, {}, self.userPratilipi ); }; this.initialDataLoaded = ko.observable( false ); this.fetchPratilipiAndUserPratilipi = function() { var dataAccessor = new DataAccessor(); dataAccessor.getPratilipiByUri( window.location.pathname, true, function( pratilipi, userPratilipi ) { if( pratilipi == null ) { /* Invalid Uri */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND[ "ko_element" ] ); return; } self.updatePratilipi( pratilipi, true ); self.updateUserPratilipi( userPratilipi, true ); if( ! self.initialDataLoaded() ) self.initialDataLoaded( true ); }); }; /* START Developer : Rahul Ranjan Function : click event of FB Share button shown after publishing content. */ this.fbShare = function() { var shareUrl = window.location.origin + this.pratilipi.pageUrl(); var utmParameter = "?utm_source=pratilipi_website&utm_medium=post_publish_popup&utm_campaign=content_share"; $("#shareModal").modal("hide"); window.open( "http://www.facebook.com/sharer.php?u=" + shareUrl + utmParameter, "share", "width=1100,height=500,left=70px,top=60px" ); this.FBEvent('SHARE_CONTENT', 'FB'); }; this.FBEvent = function(event_name, entity_value) { var params = {}; params['ENVIRONMENT'] = 'GROWTH'; params['CONTENT_LANGUAGE'] = this.pratilipi.language(); params['SCREEN_NAME'] = 'PRATILIPI_PAGE'; params['LOCATION'] = 'POST_PUBLISH_POPUP'; params['USERID'] = appViewModel.user.userId(); params['PRATILIPI_TYPE'] = this.pratilipi.type(); params['CONTENT_ID'] = this.pratilipi.pratilipiId(); params['AUTHOR_ID'] = this.pratilipi.author.authorId(); params['ACCESS_LEVEL'] = appViewModel.user.author.authorId() == this.pratilipi.author.authorId() ? 'SELF' : 'OTHER'; if (entity_value != null) params['ENTITY_VALUE'] = entity_value; FB.AppEvents.logEvent(event_name, null, params); }; /* END */ /* Landing from Search page */ var searchQuery = getUrlParameter( "searchQuery" ) != null ? decodeURIComponent( getUrlParameter( "searchQuery" ) ) : null; this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.PRATILIPI.ko_element ) { if( appViewModel.currentView() == LOCATION.SEARCH_V2.ko_element && searchQuery != null ) { setTimeout( function() { appViewModel.searchQuery( searchQuery ); }, 50 ); } /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialDataLoaded( false ); self.fetchPratilipiAndUserPratilipi(); /* Hack remove delete modal forcibly */ $( '.modal' ).modal( 'hide' ); $( 'body' ).removeClass( 'modal-open' ); $( '.modal-backdrop' ).remove(); }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><!-- ko component: {name: "pratilipi-edit-pratilipi",params: { pratilipi: pratilipi,updatePratilipi: $data.updatePratilipi }} --><!-- /ko --><!-- ko component: {name: "pratilipi-pratilipi-info",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,updatePratilipi: $data.updatePratilipi,updateUserPratilipi: $data.updateUserPratilipi }} --><!-- /ko --><!-- ko component: {name: "pratilipi-review-list",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,updatePratilipi: $data.updatePratilipi,updateUserPratilipi: $data.updateUserPratilipi }} --><!-- /ko --><!-- ko if: pratilipi.state() == 'PUBLISHED' --><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><!-- ko component: {name: "pratilipi-recommendation-carousel",params: { pratilipiId: pratilipi.pratilipiId, context: 'summaryPage' }} --><!-- /ko --></div><!-- /ko --></div><!-- START :: Developer : Rahul Ranjan :: Function : Share after publish modal --><div class="modal fade pratilipi-write" id="shareModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><span data-dismiss="modal" aria-label="Close" class="material-icons close">close</span><h6 class="material-title" style="font-size:24px !important; text-align:center">Awesome Work!!!</h6></div><div class="modal-body"><table style="width:100%"><tr><td style="width:100px;"><img data-bind="attr:{ src: getImageUrl( pratilipi.coverImageUrl(), 100, false ), alt: pratilipi.title }"style="vertical-align: middle;width: 100; height: 150; mobWidth: 150; mobHeight: 225" /></td><td><div style="margin: 10px; height:130px; position: relative;"><span style="line-height: 20px; font-size:18px;"><span style="font-style: italic;" data-bind="text: pratilipiTitle()"></span>has been published</span><span style="position:absolute; bottom:0px; left:0px; font-size:22px;line-height:26px">Share your story and get popular</span></div></td></tr><tr><td colspan="2" style="padding-top:20px;"><div class="mdl-list__item-primary-content" data-bind="click: fbShare"style="background: #3b5998;line-height: 50px;border-radius:2px; text-align:center; cursor:pointer;"><span class="sprites-icon mdl-list__item-icon"style="background-position:-72px -24px; padding-right:10px;"></span><span style="color: #fff;vertical-align: middle;padding:10px;font-size:24px;">Share on Facebook</span></div></td></tr></table></div></div></div></div><!-- END :: Developer : Rahul Ranjan :: Function : Share after publish modal -->` }); </script> <script> ko.components.register( 'pratilipi-verify-user-page', { viewModel: function() { var dataAccessor = new DataAccessor(); this.requestOnFlight = ko.observable( true ); dataAccessor.verifyUser( getUrlParameter( "e" ), getUrlParameter( "t" ), function() { self.requestOnFlight( false ); ToastUtil.toastUp( "Success!" ); setTimeout( function() { window.location.href = "/"; }, 4000 ); }, function() { var message = "Some error Occurred! Please try again!"; if( error.message != null ) message = error.message; ToastUtil.toastUp( message, 4000 ); self.requestOnFlight( false ); }); } , template: `<div class="pratilipi-login-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">Email Verification</div><div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active" data-bind="visible: requestOnFlight()"></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-loading-state', { viewModel: function( params ) { this.customText = params != null && params.customText != null ? params.customText : null; } , template: `<div class="pratilipi-loading-state"><div class="loading-state-container"><div class="pratilipi-icon-spinner"><span class="sprites-icon pratilipi-logo-icon"></span><div class="spinner"><div class="double-bounce1"></div><div class="double-bounce2"></div></div></div><div class="quote-container" data-bind="visible: customText == null"><span class="quote-content material-subtitle-1" data-bind="text: appViewModel.randomQuote().content"></span><br><span class="quote-name material-body-1" data-bind="visible: appViewModel.randomQuote().name != null, text: '- ' + appViewModel.randomQuote().name"></span></div><div class="custom-text-container" data-bind="visible: customText != null"><span class="custom-text" data-bind="text: customText"></span></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-notification-list', { viewModel: function( params ) { var self = this; var resultCount = params.resultCount; this.notificationsPageBehaviour = params.notificationsPageBehaviour != null ? params.notificationsPageBehaviour : false; var listenToFirebase = params.listenToFirebase != null ? params.listenToFirebase : false; var dataAccessor = new DataAccessor(); var cursor = null; /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); this.notificationList = ko.observableArray(); this.hasMoreContents = ko.observable( false ); this.setNotificationList = function( notificationList ) { self.notificationList( [] ); self.updateNotificationList( notificationList ); }; this.updateNotificationList = function( notificationList ) { for( var i = 0; i < notificationList.length; i++ ) self.notificationList.push( ko.mapping.fromJS( notificationList[i] ) ); }; this.fetchNotificationList = function() { if( self.loadingState() == "LOADING" ) return; self.loadingState( "LOADING" ); dataAccessor.getNotificationList( cursor, resultCount, function( notificationListResponse ) { if( notificationListResponse == null ) { self.loadingState( "FAILED" ); return; } var notificationList = notificationListResponse[ "notificationList" ]; self.loadingState( self.notificationList().length > 0 || notificationList.length > 0 ? "LOADED" : "LOADED_EMPTY" ); if( ! self.notificationsPageBehaviour ) { self.setNotificationList( notificationList ); return; } cursor = notificationListResponse.cursor; self.updateNotificationList( notificationList ); self.hasMoreContents( notificationList.length == resultCount && self.notificationsPageBehaviour ); }); }; this.resetNotificationList = function() { self.fetchNotificationList( true ); }; this.markNotificationRead = function( vm, e ) { var notifId = vm.notificationId; for( var i = 0; i < self.notificationList().length; i++ ) { if( notifId == self.notificationList()[i].notificationId ) { self.notificationList()[i].state( "READ" ); break; } } return true; }; this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() ) { setTimeout( self.fetchNotificationList, 0 ); } }, this ); this.notificationCountObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() && appViewModel.notificationCount() != 0 && listenToFirebase ) { setTimeout( self.resetNotificationList, 0 ); } }, this ); } , template: `<ul class="pratilipi-notification-list"><!-- ko foreach: { data: notificationList, as: 'notification' } --><!--ko if: notification.message && notification.message() --><li class="mdl-menu__item"data-bind="css: { 'notif-unread': ( notification.state() == 'UNREAD' ) }"><span class="notification-message"><a onclick="ga_CA( 'Notification', 'Open' )"data-bind="attr: { 'href': notification.sourceUrl() }, click: $parent.markNotificationRead"><span style="display: flex;"><span class="notification-display-image"><img class="img-circle" data-bind="attr: { src: getImageUrl( notification.displayImageUrl(), 48 ) }" /></span><span class="notification-message-holder"><span class="font-s" data-bind="html: notification.message()"></span><br/><span class="notification-meta"><span class="text-muted font-xs" data-bind="text: convertDate( notification.lastUpdatedMillis() )"></span></span></span><span class="notification-source-image" data-bind="if: notification.sourceImageUrl && notification.sourceImageUrl()"><img data-bind="attr: { src: getImageUrl( notification.sourceImageUrl(), 48 ) }" /></span></span></a></span></li><!--/ko--><!--/ko--><li class="mdl-menu__item show-more" data-bind="visible: hasMoreContents() && loadingState() != 'LOADING'"><button onclick="ga_CA( 'Notification', 'Load More' )"data-bind="click: fetchNotificationList"class="mdl-button mdl-js-button">View More</button></li></ul><div data-bind="visible: loadingState() == 'LOADING'"class="spinner-holder"><span data-bind="visible: notificationList().length > 0 || ! notificationsPageBehaviour"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: notificationList().length == 0 && notificationsPageBehaviour"></pratilipi-loading-state></div><div style="margin: 25px 15px;" class="text-center" data-bind="visible: loadingState() == 'LOADED_EMPTY'"><div data-bind="visible: notificationsPageBehaviour" style="width: 200px; height: 200px; margin: auto;" class="empty-notifications-icon"></div>It seems that you've not followed any author yet. Follow your favorite authors and stay updated about their latest works.</div><div style="margin: 25px 15px;" data-bind="visible: loadingState() == 'FAILED'"><a style="cursor: pointer; color: #555;" data-bind="click: fetchNotificationList">Notifications failed to load. Please click here to re-load the notifications.</a></div>` }); </script> <script> ko.components.register( 'pratilipi-header', { viewModel: function( params ) { var self = this; var openWriteDialog = function() { $( "#pratilipiWrite" ).modal(); }; this.search = function( formElement ) { if( appViewModel.searchQuery() && appViewModel.searchQuery().trim().length && window.location.pathname != "/search" ) redirect( "/search?q=" + appViewModel.searchQuery() ); }; this.redirectToSearch = function() { redirect( "/search?retUrl=" + encodeURIComponent( window.location.pathname ) ); }; this.openMenuNavigationDrawer = function() { if( !( typeof( componentHandler ) == 'undefined' ) ) { componentHandler.upgradeAllRegistered(); } document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }; this.write = function() { if( isMobile() ) { ToastUtil.toast( "Please login to write content on desktop website!", 5000 ); return; } if( appViewModel.user.isGuest() ) { goToLoginPage( { "action": "write" }, { "message": "WRITE" } ); } else { openWriteDialog(); } }; /* Loading Notifications */ var notificationContainer = $( ".js-pratilipi-header #notificationContainer" ); var notificationTitle = $( ".js-pratilipi-header #notificationTitle" ); var notificationsBody = $( ".js-pratilipi-header #notificationsBody" ); var notificationLink = $( ".js-pratilipi-header #notificationLink" ); var notificationFooter = $( ".js-pratilipi-header #notificationFooter" ); var viewMoreNotificationLink = $( ".js-pratilipi-header #notificationFooter a" ); notificationLink.click( function() { resetFbNotificationCount(); var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; if( windowsize < 768 ) { redirect( "/notifications" ); } else { notificationContainer.fadeToggle(50); } return false; }); $( document ).click( function() { notificationContainer.hide(); } ); /* notificationContainer.click( function(e) { e.stopPropagation(); } ); */ notificationTitle.click( function(e) { e.stopPropagation(); } ); notificationsBody.click( function(e) { notificationContainer.hide(); } ); viewMoreNotificationLink.click( function(e) { notificationContainer.hide(); } ); this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() ) { if( getUrlParameter( 'action' ) == "write" ) openWriteDialog(); if( getUrlParameter( 'action' ) == "notifications" ) notificationLink.click(); } }, this ); } , template: `<header class="pratilipi-header js-pratilipi-header mdl-layout__header mdl-layout__header--scroll"><div class="mdl-layout__header-row parent-container row-one"><a href="/"><span class="sprites-icon pratilipi-logo-icon"></span></a><button onclick="ga_CA( 'Header', 'Get Languages' )"id="pratilipi-header-pratilipi-dropdown" class="pratilipi-text hidden-xs"><span class="font-m">Pratilipi</span><i class="material-icons">arrow_drop_down</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect language-ul" for="pratilipi-header-pratilipi-dropdown"><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://hindi.pratilipi.com'; return false;">हिंदी</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://gujarati.pratilipi.com'; return false;">ગુજરાતી</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://tamil.pratilipi.com'; return false;">தமிழ்</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://marathi.pratilipi.com'; return false;">मराठी</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://malayalam.pratilipi.com'; return false;">മലയാളം</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://bengali.pratilipi.com'; return false;">বাংলা</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://telugu.pratilipi.com'; return false;">తెలుగు</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://kannada.pratilipi.com'; return false;">ಕನ್ನಡ</li></ul><div class="header-icons-holder menu-icon-holder"><button data-bind="event: { click: openMenuNavigationDrawer }" class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">menu</i></button></div><div class="search-bar-holder hidden-xs"><form action="javascript:void(0);" data-bind="submit: search"><div class="mdl-textfield mdl-js-textfield"><input placeholder="Search for books, stories, poems and more ..." class="mdl-textfield__input font-s" type="text" id="pratilipi-header-search" data-bind="value: appViewModel.searchQuery, event: { click: redirectToSearch }" /><i data-bind="event: { click: search }" class="material-icons search">search</i></div></form></div><div class="header-icons-holder"><button onclick="ga_CA( 'Header', 'Write' )"data-bind="click: write"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">create</i></button></div><div class="header-icons-holder"><a onclick="ga_CA( 'Header', 'Library' )"data-bind="attr: { 'href': appViewModel.user.isGuest() ? '/login?retUrl=%2Flibrary&message=LIBRARY' : '/library' }"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">library_books</i></a></div><div class="header-icons-holder"><a onclick="ga_CA( 'Header', 'Notification' )"data-bind="visible: appViewModel.user.isGuest()"href="/login?retUrl=%2Fnotifications&message=NOTIFICATIONS"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">notifications</i></a><span onclick="ga_CA( 'Header', 'Notification' )"id="notificationLink"style="position: absolute; margin-left: -12px; margin-top: -12px;"class="material-icons mdl-badge--overlap mdl-badge--no-background"data-bind="{ attr: { 'data-badge': ( appViewModel.notificationCount() > 99 ? '99+' : appViewModel.notificationCount() ) },css: { 'mdl-badge': ( appViewModel.notificationCount() > 0 ) },visible: ! appViewModel.user.isGuest() }"><i class="material-icons">notifications</i></span><div id="notificationContainer"><div id="notificationTitle">Notifications</div><div id="notificationsBody" class="notifications"><!-- ko component: {name: "pratilipi-notification-list",params: { resultCount: 10,notificationsPageBehaviour: false,listenToFirebase: true }} --><!-- /ko --></div><div id="notificationFooter"><a style="display: block; margin: 10px;" href="/notifications">View More...</a></div></div></div><div class="desktop-signin-button-holder hidden-xs"><div data-bind="visible: appViewModel.user.userId() == null" style="margin: auto; padding-left: 8px;"><!-- <span class="user-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span> --><div class="user-loading-spinner"></div></div><a onclick="ga_CA( 'Header', 'Login' )"data-bind="{ attr: { 'href': '/login?retUrl=' + encodeURIComponent( window.location.pathname ) },visible: appViewModel.user.userId() != null && appViewModel.user.isGuest() }"class="sign-in-button mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect hidden-xs"><i class="material-icons">account_circle</i><span class="font-s">Sign In</span></a><a onclick="ga_CA( 'Header', 'User' )"data-bind="{ visible: appViewModel.user.userId() != null && !appViewModel.user.isGuest(),attr: { 'href': appViewModel.user.profilePageUrl() } }"class="user-profile hidden-xs"><img class="img-circle user-dp"data-bind="attr: { 'src': getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" /><span class="font-s" data-bind="text: appViewModel.user.displayName()"></span></a></div><div class="header-icons-holder visible-xs"><div data-bind="visible: appViewModel.user.userId() == null" style="margin: auto; padding-left: 8px;"><span class="user-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><a onclick="ga_CA( 'Header', 'Login' )"data-bind="{ visible: appViewModel.user.userId() != null && appViewModel.user.isGuest(),attr: { 'href': '/login?retUrl=' + encodeURIComponent( window.location.pathname ) } }"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">account_circle</i></a><a onclick="ga_CA( 'Header', 'User' )"data-bind="{ visible: appViewModel.user.userId() != null && !appViewModel.user.isGuest(),attr: { 'href': appViewModel.user.profilePageUrl() } }"class="mdl-button mdl-js-button mdl-button--icon"><img class="img-circle user-dp" data-bind="attr: { 'src': getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" /></a></div></div><div class="mdl-layout__header-row parent-container row-two hidden-sm hidden-md hidden-lg"><button onclick="ga_CA( 'Header', 'Get Languages' )"id="pratilipi-header-pratilipi-dropdown-mobile"class="pratilipi-text"><span class="font-m">Pratilipi</span><i class="material-icons">arrow_drop_down</i></button><ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect language-ul" for="pratilipi-header-pratilipi-dropdown-mobile"><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://hindi.pratilipi.com'; return false;">हिंदी</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://gujarati.pratilipi.com'; return false;">ગુજરાતી</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://tamil.pratilipi.com'; return false;">தமிழ்</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://marathi.pratilipi.com'; return false;">मराठी</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://malayalam.pratilipi.com'; return false;">മലയാളം</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://bengali.pratilipi.com'; return false;">বাংলা</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://telugu.pratilipi.com'; return false;">తెలుగు</li><li class="mdl-menu__item" onclick="ga_CA( 'Header', 'Change Language' ); window.location = 'https://kannada.pratilipi.com'; return false;">ಕನ್ನಡ</li></ul><form action="javascript:void(0);" data-bind="submit: search"><div class="mdl-textfield mdl-js-textfield"><input placeholder="Search" class="mdl-textfield__input font-s" type="text" id="pratilipi-header-search-mobile" data-bind="value: appViewModel.searchQuery, event: { click: redirectToSearch }" /><i data-bind="event: { click: search }" class="material-icons search">search</i></div></form></div></header>` }); </script> <script> ko.components.register( 'pratilipi-android-strip', { viewModel: function( params ) { var self = this; var showBanner = getCookie( "USER_NOTIFIED_APP_LAUNCHED" ) == null || getCookie( "USER_NOTIFIED_APP_LAUNCHED" ) == "true"; var click_count = getCookie( "APP_LAUNCHED_CLICKED" ) == null ? 0 : parseInt( getCookie( "APP_LAUNCHED_CLICKED" ) ); var cross_count = getCookie( "APP_LAUNCHED_CROSSED" ) == null ? 0 : parseInt( getCookie( "APP_LAUNCHED_CROSSED" ) ); this.stripVisible = ko.observable( showBanner ); if( self.stripVisible() ) ga_CA( 'app_download_strip', 'app_strip_show' ); this.execLogic = function() { if( click_count >= 3 ) { setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 365, "/" ); return; } if( click_count > 0 && click_count < 3 ) { if( cross_count > 2 ) cross_count = 0; if( cross_count == 0 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 3, "/" ); if( cross_count == 1 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 7, "/" ); if( cross_count == 2 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 30, "/" ); } else { if( cross_count < 3 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, null, "/" ); if( cross_count >= 3 && cross_count < 6) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 2, "/" ); if( cross_count >= 6 ) setCookie( "USER_NOTIFIED_APP_LAUNCHED", false, 7, "/" ); } setCookie( "APP_LAUNCHED_CLICKED", click_count, 365, "/" ); setCookie( "APP_LAUNCHED_CROSSED", cross_count, 365, "/" ); }; this.androidBannerCrossed = function() { cross_count++; self.execLogic(); ga_CA( 'app_download_strip', 'app_strip_close' ); self.stripVisible( false ); return false; }; this.androidBannerClicked = function() { click_count++; self.execLogic(); self.stripVisible( false ); ga_CA( 'app_download_strip', 'app_strip_click' ); var newtab = window.open( '', '_blank' ); newtab.location = "https://play.google.com/store/apps/details?id=com.pratilipi.mobile.android&referrer=utm_source%3Dpratilipi_main_web%26utm_medium%3Dweb_bottom_strip%26utm_campaign%3Dapp_download"; return false; }; this.stripVisibleObserver = ko.computed( function() { self.stripVisible(); setTimeout( function() { var pratilipiHeader = $( ".js-pratilipi-header" ); if( pratilipiHeader == null ) return; if( ! self.stripVisible() ) { pratilipiHeader.css( "margin-top", 0 ); return; } var androidStrip = $( ".js-pratilipi-android-strip" ); pratilipiHeader.css( "margin-top", ( androidStrip.height() + parseInt( androidStrip.css( "padding-top" ) ) + parseInt( androidStrip.css( "padding-bottom" ) ) ) + "px" ); }, 0); }, this ); } , template: `<div class="pratilipi-android-strip js-pratilipi-android-strip" data-bind="visible: stripVisible()"><i data-bind="click: androidBannerCrossed" class="material-icons pull-right clickable-element">close</i><div class="flex-container"><a data-bind="click: androidBannerClicked"><span class="sprites-icon pratilipi-logo-icon"></span></a><span class="app-info"><a data-bind="click: androidBannerClicked" class="app-heading"><span class="material-title">Pratilipi Android Application</span></a><img class="rating-image"src="http://public.pratilipi.com/images/Stars-for-App-Install-Strip.png"></span></div><div class="material-body-2 supporting-text">Read your favorite stories without the internet</div><a data-bind="click: androidBannerClicked" class="download-button font-m">Download</a></div>` }); </script> <script> ko.components.register( 'pratilipi-blog-post-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultBlogPost = { blogId: null, blogPostId: null, content: null, creationDateMillis: null, pageUrl: null, title: null, titleEn: null }; this.blogPost = ko.mapping.fromJS( defaultBlogPost, {}, self.blogPost ); this.updateBlogPost = function( blogPost ) { if( blogPost == null ) blogPost = defaultBlogPost; ko.mapping.fromJS( blogPost, {}, self.blogPost ); }; this.initialDataLoaded = ko.observable( false ); this.fetchBlogPost = function() { dataAccessor.getBlogPostByUri( window.location.pathname, function( blogPost ) { if( blogPost == null ) { /* Invalid Uri */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND[ "ko_element" ] ); return; blogPost} self.updateBlogPost( blogPost ); if( ! self.initialDataLoaded() ) self.initialDataLoaded( true ); }); }; this.fetchBlogPost(); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div class="pratilipi-blog-post-page" data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="material-heading blog-post-title" data-bind="text: blogPost.title()"></div><div class="material-body-2 pratilipi-red blog-post-date" data-bind="text: convertDate( blogPost.creationDateMillis() )"></div><div class="material-subtitle-1 blog-post-content" data-bind="html: blogPost.content()"></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-myprofile-page', { viewModel: function() { var self = this; this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; setTimeout( function() { if( appViewModel.user.userId() != 0 ) redirect( appViewModel.user.profilePageUrl(), true ); else goToLoginPage( getUrlParameters() ); }, 0 ); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.MY_PROFILE.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.userObserver.dispose(); return; } appViewModel.currentLocation(); }, this ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-blog-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var cursor = null; var resultCount = 10; this.title = window.location.pathname == "/blog" ? "Blog and Editorial" : "Interviews with Popular Writers"; this.sendGAEvent = function() { ga_CA( window.location.pathname == '/blog' ? 'Blog' : 'AuthorInterview', 'Open' ); return true; }; this.blogPostList = ko.observableArray(); this.updateBlogPostList = function( blogPostList ) { for( var i = 0; i < blogPostList.length; i++ ) self.blogPostList.push( blogPostList[i] ); }; this.isLoading = ko.observable(); this.hasMoreContents = ko.observable( true ); this.fetchBlogPostList = function() { if( self.isLoading() || ! self.hasMoreContents() ) return; self.isLoading( true ); dataAccessor.getBlogPostListByUri( window.location.pathname, "PUBLISHED", cursor, resultCount, function( blogPostListResponse ) { if( blogPostListResponse == null ) { self.isLoading( false ); return; } var blogPostList = blogPostListResponse.blogPostList; self.updateBlogPostList( blogPostList ); cursor = blogPostListResponse.cursor; self.isLoading( false ); self.hasMoreContents( blogPostList.length == resultCount && cursor != null ); }); }; this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-blog-post-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchBlogPostList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.BLOG.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.fetchBlogPostList(); }, 0 ); }, this ); var container = $( ".pratilipi-blog-page .js-blog-post-content" ); var lineHeight = parseInt( container.css( "line-height" ) ); container.css( "max-height", (lineHeight*3) + 'px' ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-blog-page generic-list-page"><div class="load-more-container mdl-card-border material-heading"data-bind="text: title"style="margin-top: 0;"></div><div data-bind="foreach: { data: blogPostList, as: 'blogPost' }, visible: blogPostList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-blog-post-grid mobile-card"><a class="blog-post-container" data-bind="{ attr: { 'href': blogPost.pageUrl }, click: $parent.sendGAEvent }"><div class="blog-post-snippet"><div class="material-title blog-post-title pratilipi-red" data-bind="text: blogPost.title"></div><div class="material-subtitle-2 blog-post-content js-blog-post-content" data-bind="text: blogPost.content"></div><div class="material-subtitle-2 see-more">show more</div></div></a></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: ! isLoading(), click: fetchBlogPostList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><div data-bind="visible: isLoading()" class="text-center"><span data-bind="visible: blogPostList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: blogPostList().length == 0"></pratilipi-loading-state></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-notifications-page', { viewModel: function( params ) { var self = this; this.userObserver = ko.computed( function() { if( appViewModel.user.isGuest() && appViewModel.user.userId() == 0 ) { goToLoginPage( getUrlParameter( 'action' ) == "settings" ? { "action": "settings" } : null, { "message": "NOTIFICATIONS" } ); return; } if( getUrlParameter( 'action' ) == "settings" ) { setTimeout( function() { $( "#pratilipiNotificationSettings" ).modal(); }, 0 ); } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.NOTIFICATIONS.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.userObserver.dispose(); return; } appViewModel.currentLocation(); }, this ); } , template: `<!-- ko component: "pratilipi-notification-settings"--><!-- /ko --><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div class="mdl-card mdl-card-border mobile-card pratilipi-notifications-page"><div class="notifications-header"><span class="font-xl notification-heading">Notifications</span><button onclick="ga_CA( 'Notification', 'Settings' )"class="mdl-button mdl-js-button mdl-button--icon pull-right" data-toggle="modal" data-target="#pratilipiNotificationSettings"><i class="material-icons">settings</i></button></div><!-- ko component: {name: "pratilipi-notification-list",params: { resultCount: 20,notificationsPageBehaviour: true }} --><!-- /ko --></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-leaderboard', { viewModel: function(params) { var self = this; var dataAccessor = new DataAccessor(); var RESULT_COUNT = 20; self.yesterdayTopAuthors = ko.observableArray([]); self.isLoaded = ko.observable(false); self.subHeading = ko.observable(); self.listItemClicked = function(data, event) { console.log(data); window.open(data.pageUrl(),'_blank'); self.FBEvent('CLICK_AUTHOR', data.authorId(), appViewModel.user.author.authorId() == data.authorId ? 'SELF' : 'OTHER'); }; self.sharePratilipi = function( data, event ) { console.log("Share button clicked"); event.stopPropagation(); var eventParams = {}; eventParams['ENVIRONMENT'] = 'GROWTH'; eventParams['PARENT'] = 'TOP AUTHOR'; eventParams['LOCATION'] = 'DESKTOP_RIGHTBAR'; eventParams['EXPERIMENT_ID'] = 'DIA070617A'; var utmParameter = "utm_source=pratilipi_website&utm_medium=top_authors&utm_campaign=author_share"; ShareUtil.shareAuthor( ko.mapping.toJS(data), utmParameter, eventParams ); }; self.FBEvent = function(event_name, author_id, access_level) { var eventParams = {}; eventParams['ENVIRONMENT'] = 'GROWTH'; eventParams['PARENT'] = 'TOP AUTHOR'; eventParams['CONTENT_LANGUAGE'] = appViewModel.language; eventParams['LOCATION'] = 'DESKTOP_RIGHTBAR'; eventParams['EXPERIMENT_ID'] = 'DIA070617A'; eventParams['SCREEN_NAME'] = getLocation().fb_value; eventParams['USERID'] = appViewModel.user.userId(); if (author_id) eventParams['AUTHOR_ID'] = author_id; if (access_level) eventParams['ACCESS_LEVEL'] = access_level; FB.AppEvents.logEvent(event_name, null, eventParams); }; self.onSuccess = function(data) { /* setting author list. */ ko.mapping.fromJS(data.authorDataList, {}, self.yesterdayTopAuthors); if (self.yesterdayTopAuthors().length > 0) { console.log(self.yesterdayTopAuthors().length); self.isLoaded(true); self.subHeading("( " + data.date + " based on read count on" + " *)"); self.FBEvent('LANDED_PARENT'); } }; if (appViewModel.language == 'HINDI') { /* fetching yesterday's top 10 authors */ dataAccessor.getYesterdayTopAuthors( appViewModel.language, RESULT_COUNT, function(response) { if (response != null) { self.onSuccess(response); } } ); } } , template: `<div class="mdl-card mdl-card-border mdl-cell mdl-cell--4-col-tablet mdl-cell--3-col pratilipi-author-leaderboard"data-bind="visible: isLoaded"><h6 class="material-title" style="font-size:24px !important; text-align:center; margin-bottom:0px">Top Author</h6><span data-bind="text:subHeading()" style="font-size:12px; text-align:center;"></span><div class="padding-zero" style="margin:8px 0px !important"><hr class="margin-zero"></div><ul class="mdl-list author-leaderboard-ul" data-bind="foreach:yesterdayTopAuthors"><li class="mdl-list__item" data-bind="attr: { 'href': pageUrl}, click: $parent.listItemClicked"style="position:relative;"><span data-bind="text: ($index()+1)+'.'" style="padding: 5px;"> </span><div><img class="mdl-list__item-avatar"data-bind="attr: { 'src': imageUrl, 'alt': name}"/></div><div style="padding: 0px 10px; width:45%"><div class="font-m author-name" data-bind="text: name"></div><!--<div>--><!--<span class="meta-holder reads-holder">--><!--<span class="material-body-1" data-bind="text: readCount"></span>--><!--<i class="material-icons material-body-1">remove_red_eye</i>--><!--</span>--><!--</div>--></div><button data-bind="click: $parent.sharePratilipi"class="mdl-button mdl-js-button mdl-button-margin small-button share-button"><i class="material-icons">share</i></button></li></ul><span style="font-size:14px; padding:5px">*Share your content to increase read count</span></div>` }); </script> <script> ko.components.register( 'pratilipi-facebook-login', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = params.requestOnFlight; this.isRegister = params.isRegister; this.facebookLogin = function() { if( self.requestOnFlight() ) return; FB.login( function( fbResponse ) { if( fbResponse == null || fbResponse.authResponse == null ) { self.requestOnFlight( false ); return; } self.requestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.loginFacebookUser( fbResponse.authResponse.accessToken, function( user ) { ToastUtil.toast( "Success !" ); window.location.href = self.isRegister ? user[ "profilePageUrl" ] : getRetUrl( true ); }, function( error ) { self.requestOnFlight( false ); var message = "Some error Occurred! Please try again!"; if( error[ "fbUserAccessToken" ] != null ) message = error[ "fbUserAccessToken" ]; else if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }, { scope: 'public_profile,email,user_birthday' } ); }; /* Initialise Facebook Client App */ window.fbAsyncInit = function() { FB.init({ appId: '293990794105516', cookie : true, xfbml: true, version: 'v2.6' }); }; (function(d, s, id) { var js, fjs = d.getElementsByTagName(s)[0]; if(d.getElementById(id)) {return;} js = d.createElement(s); js.id = id; js.src = "//connect.facebook.net/en_US/sdk.js"; fjs.parentNode.insertBefore(js, fjs); }(document, 'script', 'facebook-jssdk')); } , template: `<button onclick="ga_CA( 'Login', 'FB-Login' )"data-bind="{ click: facebookLogin, disable: requestOnFlight }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-fb-blue-button login-button"><div class="sprites-icon login-sprite-icon-24 facebook-login-icon"></div>Sign In with Facebook</button>` }); </script> <script> ko.components.register( 'pratilipi-main-layout', { viewModel: function() {} , template: `<div class="mdl-layout mdl-js-layout" data-bind="event: { scroll: appViewModel.notifyOfScrollEvent }"><!-- ko component: "pratilipi-navigation-drawer" --><!-- /ko --><!-- ko if: isAndroid() --><!-- ko component: "pratilipi-android-strip" --><!-- /ko --><!-- /ko --><!-- ko component: "pratilipi-header" --><!-- /ko --><!-- ko component: "pratilipi-write" --><!-- /ko --><main class="mdl-layout__content" data-bind="event: { scroll: appViewModel.notifyOfScrollEvent }"><div class="body-layout-row"><div class="body-layout-nav"><!-- ko component: "pratilipi-navigation-aside" --><!-- /ko --></div><div class="body-layout-content"><div class="mdl-grid mobile-grid"style="flex-grow: 1;"data-bind="component: { name: appViewModel.currentView() }"></div></div></div><!-- ko component: "pratilipi-footer" --><!-- /ko --></main></div>` }); </script> <script> ko.components.register( 'pratilipi-review-list', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); /* Params */ this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.updatePratilipi = params.updatePratilipi; this.updateUserPratilipi = params.updateUserPratilipi; /* Constants */ var firstLoadReviewCount = 5; var subsequentLoadReviewCount = 10; /* ReviewList and LoadingState */ this.reviewList = ko.observableArray(); this.totalReviewCount = ko.observable(); var cursor = null; /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); /* Booleans */ this.addOrDeleteReviewRequestOnFlight = ko.observable( false ); /* User Inputs */ this.ratingInput = ko.observable(); this.reviewInput = ko.observable(); /* Functions */ /* Review List */ this.addToReviewList = function( review ) { /* Updating review doesn't change the reviewDate. Going date-wise chronological order, update the same review if already present */ var hasUpdatedReview = review.userPratilipiId == self.userPratilipi.userPratilipiId() && self.userPratilipi.review() != null; if( hasUpdatedReview ) { for( var i = 0; i < self.reviewList().length; i++ ) { if( review.userPratilipiId == self.reviewList()[i].userPratilipiId() ) { self.reviewList()[i].rating( review.rating ); self.reviewList()[i].review( review.review ); break; } } } else if( review.review != null ) { self.reviewList.unshift( ko.mapping.fromJS( review ) ); self.totalReviewCount( self.totalReviewCount() + 1 ); } }; this.deleteFromReviewList = function( review ) { self.reviewList.remove( function( item ) { return item.userPratilipiId() == self.userPratilipi.userPratilipiId(); }); self.totalReviewCount( self.totalReviewCount() - 1 ); }; this.pushToReviewList = function( revList ) { for( var i = 0; i < revList.length; i++ ) self.reviewList.push( ko.mapping.fromJS( revList[i] ) ); }; this._fetchReviewList = function( reviewCount ) { if( self.loadingState() == "LOADING" ) return; self.loadingState( "LOADING" ); dataAccessor.getReviewList( self.pratilipi.pratilipiId(), cursor, null, reviewCount, function( reviewListResponse ) { if( reviewListResponse == null ) { self.loadingState( "FAILED" ); return; } var reviewList = reviewListResponse[ "reviewList" ]; cursor = reviewListResponse[ "cursor" ]; self.pushToReviewList( reviewList ); self.loadingState( self.reviewList().length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.totalReviewCount( reviewListResponse[ "numberFound" ] ); }); }; this.loadInitialReviews = function() { self.reviewList( [] ); cursor = null; self.loadingState( null ); self.totalReviewCount( 0 ); self._fetchReviewList( firstLoadReviewCount ); }; this.loadMoreReviews = function() { self._fetchReviewList( subsequentLoadReviewCount ); }; /* Add/Edit Review Modal */ var reviewInputDialog = $( '#pratilipi-review-input-dialog' ); this.openReviewModal = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( { "action": "openReviewModal", "ratingInput": self.ratingInput() } ); return; } reviewInputDialog.modal( 'show' ); }; this.closeReviewModal = function() { reviewInputDialog.modal( 'hide' ); self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }; /* Clicking anywhere outside the screen */ reviewInputDialog.on( 'hidden.bs.modal', function(e) { self.closeReviewModal(); }); /* Delete Review Modal */ var deleteReviewConfirmationDialog = $( '#pratilipi-review-delete-confirmation-dialog' ); this.openDeleteReviewModal = function() { self.closeReviewModal(); deleteReviewConfirmationDialog.modal( 'show' ); }; this.closeDeleteReviewModal = function() { deleteReviewConfirmationDialog.modal( 'hide' ); self.openReviewModal(); }; /* Clicking anywhere outside the screen */ deleteReviewConfirmationDialog.on( 'hidden.bs.modal', function(e) { self.closeDeleteReviewModal(); }); /* Update Pratilipi Objects */ this.updatePratilipiObject = function( userPratilipi ) { /* check if its a new rating or updated rating, and calculate average rating accordingly and update values.*/ var pratilipi = {}; var oldRating = self.userPratilipi.rating(); var newRating = userPratilipi.rating; var ratingCount = self.pratilipi.ratingCount() != null ? self.pratilipi.ratingCount() : 0; var averageRating = self.pratilipi.averageRating() != null ? self.pratilipi.averageRating() : 0; var totalRating = ratingCount * averageRating; if( self.userPratilipi.rating() == 0 ) { /* Added a rating */ pratilipi[ "ratingCount" ] = ++ratingCount; } pratilipi[ "averageRating" ] = ( totalRating - oldRating + newRating ) / ratingCount; self.updatePratilipi( pratilipi ); }; /* Create/Update Review */ this.createOrUpdateReview = function() { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.createOrUpdateReview( self.pratilipi.pratilipiId(), self.ratingInput(), self.reviewInput(), function( review ) { if( review.rating == null ) review.rating = 0; if( review.reviewState != "PUBLISHED" || review.review == null || review.review.trim() == "" ) review.review = null; /* Update reviewList Array first and then userPratilipi Object * We need to know whether user has added/edited his/her review * */ self.addToReviewList( review ); /* Update Pratilipi Object first and then userPratilipi Object * We need old rating to update in Pratilipi object * */ self.updatePratilipiObject( review ); self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); self.closeReviewModal(); ToastUtil.toast( "Success !" ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "Some error Occurred! Please try again!" ); }); }; /* Delete Review */ this.deleteReview = function( review ) { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.deleteReview( self.pratilipi.pratilipiId(), function( review ) { self.deleteFromReviewList( review ); self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); deleteReviewConfirmationDialog.modal( 'hide' ); ToastUtil.toast( "Success!" ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "Some error Occurred! Please try again!" ); } ); }; this.submitReview = function() { /* Not Updated rating, just cleared the review */ if( self.ratingInput() == self.userPratilipi.rating() && self.userPratilipi.review() != null && self.userPratilipi.review().trim() != "" && self.reviewInput() != null && self.reviewInput().trim() == "" ) self.deleteReview(); else self.createOrUpdateReview(); }; /* Computed Observables */ this.hasMoreReviews = ko.computed( function() { return self.reviewList().length < self.totalReviewCount() && self.loadingState() == "LOADED"; }, this ); this.hasAccessToReview = ko.computed( function() { return appViewModel.user.isGuest() || self.userPratilipi.hasAccessToReview(); }, this ); this.canSubmitReview = ko.computed( function() { return self.ratingInput() != 0 && ! self.addOrDeleteReviewRequestOnFlight(); }, this ); this.pratilipiIdObserver = ko.computed( function() { if( self.pratilipi.pratilipiId() == null ) return; setTimeout( function() { self.loadInitialReviews(); }, 0 ); }, this ); this.userPratilipiMetaObserver = ko.computed( function() { self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }, this ); this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() && getUrlParameter( 'action' ) == "openReviewModal" ) { if( getUrlParameter( "ratingInput" ) != null && getUrlParameter( "ratingInput" ) > 0 ) { self.ratingInput( parseInt( getUrlParameter( "ratingInput" ) ) ); } self.openReviewModal(); } }, this ); } , template: `<div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card pratilipi-review-list"><div class="mdl-grid" style="margin: 0;"><h3 class="mdl-cell mdl-cell--12-col material-title">Reviews</h3><div data-bind="visible: hasAccessToReview()" class="mdl-cell mdl-cell--12-col mdl-card__supporting-text padding-zero"><div class="mdl-grid padding-zero mdl-grid--no-spacing"><div class="mdl-cell--6-col mdl-cell--4-col-tablet padding-zero"><pratilipi-rating-input onclick="ga_CA( 'Review', 'Rating Init' )" params="{ rating: ratingInput }" data-bind="click: openReviewModal"></pratilipi-rating-input></div><div class="mdl-cell--6-col mdl-cell--4-col-tablet padding-zero"><button data-bind="{ click: openReviewModal,text: userPratilipi.review() != null ? 'Edit Review' : 'Write a Review' }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect pull-right write-review-button"></button></div></div></div><div class="mdl-cell mdl-cell--12-col mdl-card__supporting-text padding-zero "><ul class="demo-list-three mdl-list" style="margin: 0;" data-bind="visible: reviewList().length > 0"><!-- ko foreach: reviewList --><li data-bind="component: {name: 'pratilipi-review',params: { review: $data, pratilipiId: $parent.pratilipi.pratilipiId() } }"class="mdl-list__item padding-zero display-block"></li><!-- /ko --><li data-bind="visible: hasMoreReviews()"><div class="show-more"><button onclick="ga_CA( 'Review', 'Load Reviews' )"data-bind="click: loadMoreReviews"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">show more</button></div></li></ul><div data-bind="visible: loadingState() == 'LOADING'" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="mdl-cell mdl-cell--12-col mdl-card__supporting-text padding-zero material-subtitle-2"data-bind="visible: loadingState() == 'LOADED_EMPTY' && reviewList().length == 0,text: hasAccessToReview() ? 'Be the first one to rate it!' : 'Sorry! No Reviews found for this content!'"></div></div></div></div><div class="modal common-modal fade" id="pratilipi-review-input-dialog" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-bind="click: closeReviewModal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">Rate and review</h6></div><div class="modal-body"><pratilipi-rating-input style="color: rgba(0,0,0,0.54);" params="{ rating: ratingInput }"></pratilipi-rating-input><textarea data-bind="{ mdlFloatingInput: { label: 'Write a Review', value: reviewInput, id: 'pratilipi_review_list_review_input' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea></div><div class="modal-footer"><button data-bind="click: openDeleteReviewModal, visible: userPratilipi.review() != null && userPratilipi.reviewState() != 'DELETED'"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left"><i style="font-size: 20px; margin-right: 4px;" class="material-icons">delete</i><span class="material-button">Delete Review</span></button><button onclick="ga_CA( 'Review', 'Cancel Rating' )"data-bind="click: closeReviewModal"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">Cancel</button><button onclick="ga_CA( 'Review', 'Add Rating' )"data-bind="click: submitReview, enable: canSubmitReview"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">SUBMIT</button></div></div></div></div><div class="modal common-modal fade" id="pratilipi-review-delete-confirmation-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-review-delete-confirmation-dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-bind="click: closeDeleteReviewModal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">Delete Review</h6></div><div class="modal-body"><div class="material-subtitle-2">Are you sure to delete your review?</div></div><div class="modal-footer"><button data-bind="click: deleteReview" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin pull-left">Yes, Delete review!</button><button data-bind="click: closeDeleteReviewModal" class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">No, Don't!</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-current-event', { viewModel: function() { /* TODO: Remove hardcoding */ var self = this; var dataAccessor = new DataAccessor(); var defaultEvent = { "eventId": null, "name": null, "nameEn": null, "language": null, "pageUrl": null, "bannerImageUrl": null, }; this.event = ko.mapping.fromJS( defaultEvent, {}, self.event ); this.isLoading = ko.observable(); this.updateEvent = function( event ) { if( event == null ) event = defaultEvent; ko.mapping.fromJS( event, {}, self.event ); MetaTagUtil.setMetaTagsForEvent( ko.mapping.toJS( self.event ) ); }; this.fetchEvent = function() { self.isLoading( true ); dataAccessor.getEventById( "", function( event ) { if( event == null ) return; self.isLoading( false ); self.updateEvent( event ); }); }; this.fetchEvent(); } , template: `<div class="pratilipi-current-event"><div class="pratilipi-red material-subtitle-1">Event</div><div data-bind="visible: isLoading()"style="margin: 12px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div data-bind="visible: ! isLoading()"><a data-bind="attr: { href: event.pageUrl() }" onclick="ga_CA( 'Event', 'Open' );"><img data-bind="attr: { src: getImageUrl( event.bannerImageUrl(), 400 ) }" /></a><a data-bind="attr: { href: event.pageUrl() }" onclick="ga_CA( 'Event', 'Open' );"><div class="material-body-1" data-bind="text: event.name()"></div></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-settings-page', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.isAdmin = getUrlParameter( "authorId" ) != null && getUrlParameter( "userId" ) != null; /* PROFILE SETTINGS */ this.firstName = ko.observable(); this.lastName = ko.observable(); this.firstNameEn = ko.observable(); this.lastNameEn = ko.observable(); this.penName = ko.observable(); this.language = ko.observable(); this.summary = ko.observable(); this.email = ko.observable(); this.phone = ko.observable(); this.gender = ko.observable(); this.dateOfBirth = ko.observable(); this.isLoading = ko.observable(); this.authorPageUrl = null; /* Original Data - Disable the button if user hadn't changed any setting */ var originalAuthor = null; var originalUser = {}; this.updateLanguage = function() { self.language( document.querySelector( '#pratilipi-settings-language' ).getAttribute( "data-val" ) ); }; this.updateGender = function() { self.gender( document.querySelector( '#pratilipi-settings-gender' ).getAttribute( "data-val" ) ); }; var getAuthorId = function() { return getUrlParameter( "authorId" ) != null ? getUrlParameter( "authorId" ) : appViewModel.user.author.authorId(); }; var getUserId = function() { return getUrlParameter( "userId" ) != null ? getUrlParameter( "userId" ) : appViewModel.user.userId(); }; var formatDateOfBirth = function( inputDate ) { if( inputDate == null ) return null; var d = new Date( inputDate ), month = '' + ( d.getMonth() + 1 ), day = '' + d.getDate(), year = d.getFullYear(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; return [ day, month, year ].join( '-' ); }; this.loadUserAndAuthor = function() { if( self.isLoading() ) return; self.isLoading( true ); dataAccessor.getAuthorById( getAuthorId(), false, function( author ) { originalAuthor = author; self.firstName( author.firstName ); self.lastName( author.lastName ); self.firstNameEn( author.firstNameEn ); self.lastNameEn( author.lastNameEn ); self.penName( author.penName ); self.language( author.language ); $( "#pratilipi-settings-language" ).attr( 'data-val', author.language ); $( "#pratilipi-settings-language" ).attr( 'value', getLanguageVernacular( author.language ) ); self.summary( author.summary ); var getGenderValue = function( gender ) { if( gender == "MALE" ) return "Male"; if( gender == "FEMALE" ) return "Female"; if( gender == "OTHER" ) return "Other"; }; self.gender( author.gender ); if( author.gender != null ) { $( "#pratilipi-settings-gender" ).attr( 'data-val', author.gender ); $( "#pratilipi-settings-gender" ).attr( 'value', getGenderValue( author.gender ) ); } var getDateOfBirthValue = function( date ) { if( date == null ) return null; var d = new Date( date.replace( /(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3") ), month = '' + ( d.getMonth() + 1 ), day = '' + d.getDate(), year = d.getFullYear(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; return [ year, month, day ].join( '-' ); }; self.dateOfBirth( getDateOfBirthValue( author.dateOfBirth ) ); self.authorPageUrl = author.pageUrl; /* Loading User Info */ if( self.isAdmin ) { dataAccessor.getUserById( author.user.userId, function( user ) { originalUser = user; self.email( user.email ); self.phone( user.phone ); }); } else { originalUser = { "email": appViewModel.user.email(), "phone": appViewModel.user.phone() }; self.email( appViewModel.user.email() ); self.phone( appViewModel.user.phone() ); } self.isLoading( false ); }); }; this.updateProfileSettings = function() { /* Validity Checks */ if( self.email() != null && self.email().trim() > 0 && ! validateEmail( self.email() ) ) { ToastUtil.toast( "Email ID has been entered incorrectly" ); return; } if( self.phone() != null && self.phone().trim() > 0 && ! validatePhone( self.phone() ) ) { ToastUtil.toast( "Mobile number has been entered incorrectly" ); return; } var _getVal = function( val ) { if( val == null || val.trim() == "" ) return ""; return val; }; var author = { "authorId": getAuthorId(), "firstName": self.firstName(), "language": self.language() }; author[ "lastName" ] = _getVal( self.lastName() ); author[ "firstNameEn" ] = _getVal( self.firstNameEn() ); author[ "lastNameEn" ] = _getVal( self.lastNameEn() ); author[ "penName" ] = _getVal( self.penName() ); author[ "summary" ] = _getVal( self.summary() ); author[ "gender" ] = _getVal( self.gender() ); if( self.dateOfBirth() ) author[ "dateOfBirth" ] = formatDateOfBirth( self.dateOfBirth() ); /* 4 states: INITIAL, LOADING, SUCCESS, FAIL */ self.userApiCallState = ko.observable( "INITIAL" ); self.authorApiCallState = ko.observable( "INITIAL" ); var errorMessage = null; /* In case UserApi Or AuthorApi failed. */ self.callbackObserver = ko.computed( function() { if( self.userApiCallState() == "SUCCESS" && self.authorApiCallState() == "SUCCESS" ) { ToastUtil.toast( "Success!" ); self.isLoading( false ); self.userApiCallState( "INITIAL" ); self.authorApiCallState( "INITIAL" ); if( self.isAdmin ) { /* Redirect to the author page */ redirect( self.authorPageUrl ); } } else if( self.userApiCallState() == "LOADING" || self.authorApiCallState() == "LOADING" ) { return; } else if( self.userApiCallState() == "FAILED" || self.authorApiCallState() == "FAILED" ) { if( self.userApiCallState() == "FAILED" ) ToastUtil.toast( errorMessage ); /* Ensure errorMessage field is set */ errorMessage = null; self.isLoading( false ); } }, self ); self.isLoading( true ); ToastUtil.toastUp( "Working ..." ); self.userApiCallState( "LOADING" ); dataAccessor.createOrUpdateUser( getUserId(), self.email(), self.phone(), function( user ) { self.userApiCallState( "SUCCESS" ); }, function( error ) { var message = "Some error Occurred! Please try again!"; if( error[ "email" ] != null ) message = error[ "email" ]; if( error[ "phone" ] != null ) message = error[ "phone" ]; if( error[ "message" ] != null ) message = error[ "message" ]; errorMessage = message; self.userApiCallState( "FAILED" ); }); self.authorApiCallState( "LOADING" ); dataAccessor.createOrUpdateAuthor( author, function( aAuthor ) { self.authorPageUrl = aAuthor.pageUrl; self.authorApiCallState( "SUCCESS" ); }, function( error ) { var message = "Some error Occurred! Please try again!"; if( error[ "language" ] != null ) message = error[ "language" ]; if( error[ "message" ] != null ) message = error[ "message" ]; errorMessage = message; self.authorApiCallState( "FAILED" ); }); }; this.canSaveProfileSettings = ko.computed( function() { return self.firstName() != null && self.firstName().trim() != "" && self.language() != null && self.language().trim() != "" && ! self.isLoading() && ( self.firstName() != originalAuthor.firstName || self.lastName() != originalAuthor.lastName || self.firstNameEn() != originalAuthor.firstNameEn || self.lastNameEn() != originalAuthor.lastNameEn || self.penName() != originalAuthor.penName || self.language() != originalAuthor.language || self.summary() != originalAuthor.summary || self.email() != originalUser.email || self.phone() != originalUser.phone || self.gender() != originalAuthor.gender || formatDateOfBirth( self.dateOfBirth() ) != originalAuthor.dateOfBirth ); }, this ); this.userObserver = ko.computed( function() { if( appViewModel.user.userId() == null ) return; if( appViewModel.user.isGuest() && appViewModel.user.userId() == 0 ) goToLoginPage(); setTimeout( function() { self.loadUserAndAuthor(); }, 0 ); }, this ); /* NOTIFICATION SETTINGS */ var originalEmailFrequency = null; var originalNotificationSubscriptions = null; this.emailFrequency = ko.observable(); var getEmailFrequencyVernacular = function( emailFrequency ) { switch( emailFrequency ) { case "IMMEDIATELY": return "Immediately"; case "DAILY": return "Daily"; case "WEEKLY": return "Weekly"; case "MONTHLY": return "Monthly"; case "NEVER": return "Never"; } }; this.updateNotificationPreferences = function() { var userPreferences = {}; userPreferences[ "emailFrequency" ] = document.querySelector( "#pratilipi-settings-email-frequency" ).getAttribute( "data-val" ); userPreferences[ "notificationSubscriptions" ] = {}; $( '#notification-settings .mdl-js-checkbox' ).each( function( index, element ) { userPreferences[ "notificationSubscriptions" ][ element.firstChild.value ] = element.firstChild.checked; }); setUserPreferences( userPreferences ); ToastUtil.toast( "Success!" ); }; this.firebaseCallback = ko.computed( function() { var userPreferences = appViewModel.userPreferences(); setTimeout( function() { self.emailFrequency( userPreferences[ "emailFrequency" ] != null ? userPreferences[ "emailFrequency" ] : "IMMEDIATELY" ); $( "#pratilipi-settings-email-frequency" ).attr( 'data-val', self.emailFrequency() ); $( "#pratilipi-settings-email-frequency" ).attr( 'value', getEmailFrequencyVernacular( self.emailFrequency() ) ); originalEmailFrequency = self.emailFrequency(); var notificationSubscriptions = userPreferences[ "notificationSubscriptions" ] != null ? userPreferences[ "notificationSubscriptions" ] : {}; $( '#notification-settings .mdl-js-checkbox' ).each( function( index, element ) { if( element.MaterialCheckbox == null ) return; var val = element.firstChild.value; if( notificationSubscriptions[ val ] == null ) notificationSubscriptions[ val ] = true; notificationSubscriptions[ val ] ? element.MaterialCheckbox.check() : element.MaterialCheckbox.uncheck(); }); originalNotificationSubscriptions = notificationSubscriptions; }, 0 ); }, this ); this.randomVariable = ko.observable( 0 ); /* Hack: To execute computed */ $( '#notification-settings .mdl-js-checkbox' ).click( function() { self.randomVariable( self.randomVariable() + 1 ); } ); this.canSaveNotificationSettings = ko.computed( function() { self.randomVariable(); self.emailFrequency(); if( originalNotificationSubscriptions == null ) return; var canSave = false; $( '#notification-settings .mdl-js-checkbox' ).each( function( index, element ) { if( originalNotificationSubscriptions[ element.firstChild.value ] != element.firstChild.checked ) { canSave = true; return; } }); return canSave || self.emailFrequency() != originalEmailFrequency; }, this ); this.updateEmailFrequency = function() { self.emailFrequency( $( "#pratilipi-settings-email-frequency" ).attr( "data-val" ) ); }; /* PASSWORD SETTINGS */ this.currentPassword = ko.observable(); this.newPassword = ko.observable(); this.confirmPassword = ko.observable(); this.updatePassword = function() { if( self.newPassword() != self.confirmPassword() ) { ToastUtil.toast( "Passwords doesn't match!" ); return; } if( self.isLoading() ) return; self.isLoading( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.updateUserPassword( self.currentPassword(), self.newPassword(), function( user ) { self.currentPassword( null ); self.newPassword( null ); self.confirmPassword( null ); self.isLoading( false ); ToastUtil.toast( "Success!" ); }, function( error ) { self.isLoading( false ); var message = "Some error Occurred! Please try again!"; if( error[ "password" ] != null ) message = error[ "password" ]; if( error[ "newPassword" ] != null ) message = error[ "newPassword" ]; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message ); }); }; this.canUpdatePassword = ko.computed( function() { return self.currentPassword() != null && self.currentPassword() != "" && self.newPassword() != null && self.newPassword() != "" && self.confirmPassword() != null && self.confirmPassword() != "" && ! self.isLoading(); }, this ); /* LOGOUT */ this.logoutUser = function() { if( self.isLoading() ) return; self.isLoading( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.logoutUser( function( user ) { ToastUtil.toastUp( "Success!" ); window.location.href = "/"; }, function( error ) { self.isLoading( false ); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "Some error Occurred! Please try again!" ); }); }; /* Helpers */ var alignRightPane = function() { var element = $( ".js-tabs-right-pane" ); var width = element.width() - parseInt( element.css( "margin-left" ) ) - parseInt( element.css( "margin-right" ) ); $( '.js-width-50' ).css( 'width', ( width / 2 ) > 300 ? '50%' : '100%' ); }; $( window ).resize( function() { alignRightPane(); }); this.tabTitle = ko.observable(); var setTabTitle = function() { setTimeout( function() { $( ".mdl-tabs__panel" ).each( function( index, element ) { if( $( element ).hasClass( "is-active" ) ) self.tabTitle( $( element ).attr( 'data-name' ) ); }); }, 0 ); }; $( ".mdl-tabs__tab" ).on( 'click', function() { setTabTitle(); }); $( document ).ready( function() { alignRightPane(); setTabTitle(); }); /* Location Observer */ this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.SETTINGS.ko_element ) { /* Dispose all observers */ self.canSaveProfileSettings.dispose(); self.userObserver.dispose(); self.firebaseCallback.dispose(); self.canSaveNotificationSettings.dispose(); self.canUpdatePassword.dispose(); self.locationObserver.dispose(); return; } setTimeout( function() { getmdlSelect.init( ".getmdl-select" ); }, 0 ); }, this ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col pratilipi-settings-page"><div class="mdl-tabs vertical-mdl-tabs mdl-js-tabs mdl-js-ripple-effect mdl-card-border"><div class="tabs-mobile-bar"><span class="material-subtitle-1" data-bind="text: tabTitle()"></span><div class="pull-right"><button id="pratilipi-settings-mobile-icon"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">menu</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"for="pratilipi-settings-mobile-icon"><li class="mdl-menu__item"><a onclick="ga_CA( 'User', 'Profile' )"href="#profile-settings" class="mdl-tabs__tab is-active"><span>Profile Settings</span></a></li><li class="mdl-menu__item" data-bind="visible: !isAdmin"><a onclick="ga_CA( 'User', 'Notification' )"href="#notification-settings" class="mdl-tabs__tab"><span>Notification Settings</span></a></li><li class="mdl-menu__item" data-bind="visible: !isAdmin"><a onclick="ga_CA( 'User', 'Password' )"href="#password-settings" class="mdl-tabs__tab"><span>Update Password</span></a></li><li class="mdl-menu__item" data-bind="visible: !isAdmin"><a onclick="ga_CA( 'User', 'Logout' )"data-bind="click: logoutUser" class="mdl-tabs__tab clickable-element"><span>Sign Out</span></a></li></ul></div></div><div class="mdl-grid mdl-grid--no-spacing settings-grid"><div class="tabs-left-pane"><div class="mdl-tabs__tab-bar"><a onclick="ga_CA( 'User', 'Profile' )"href="#profile-settings" class="mdl-tabs__tab is-active"><span>Profile Settings</span></a><a onclick="ga_CA( 'User', 'Notification' )"href="#notification-settings" class="mdl-tabs__tab" data-bind="visible: !isAdmin"><span>Notification Settings</span></a><a onclick="ga_CA( 'User', 'Password' )"href="#password-settings" class="mdl-tabs__tab" data-bind="visible: !isAdmin"><span>Update Password</span></a><a onclick="ga_CA( 'User', 'Logout' )"data-bind="click: logoutUser, visible: !isAdmin" class="mdl-tabs__tab clickable-element"><span>Sign Out</span></a></div></div><div class="tabs-right-pane js-tabs-right-pane"><div class="mdl-tabs__panel is-active" data-name="Profile Settings" id="profile-settings"><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'First Name( Vernacular ) *', value: firstName, id: 'pratilipi-settings-first-name' }, valueUpdate: ['input'], transliterate: true }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'Last Name( Vernacular )', value: lastName, id: 'pratilipi-settings-last-name' }, valueUpdate: ['input'], transliterate: true }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'First Name( English )', value: firstNameEn, id: 'pratilipi-settings-first-name-en' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'Last Name( English )', value: lastNameEn, id: 'pratilipi-settings-last-name-en' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><input data-bind="{ mdlFloatingInput: { label: 'Pen Name ( Vernacular )', value: penName, id: 'pratilipi-settings-pen-name' }, valueUpdate: ['input'], transliterate: true }" /></div><div class="width-50 js-width-50 text-center"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input data-bind="event: { change: updateLanguage }"class="mdl-textfield__input"id="pratilipi-settings-language"type="text" readonly /><label style="top: 4px; font-size: 12px; visibility: visible;"class="mdl-textfield__label" for="pratilipi-settings-language">Choose Language *<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-language"><li class="mdl-menu__item" data-val="HINDI">हिंदी</li><li class="mdl-menu__item" data-val="GUJARATI">ગુજરાતી</li><li class="mdl-menu__item" data-val="TAMIL">தமிழ்</li><li class="mdl-menu__item" data-val="MARATHI">मराठी</li><li class="mdl-menu__item" data-val="MALAYALAM">മലയാളം</li><li class="mdl-menu__item" data-val="BENGALI">বাংলা</li><li class="mdl-menu__item" data-val="TELUGU">తెలుగు</li><li class="mdl-menu__item" data-val="KANNADA">ಕನ್ನಡ</li></ul></div></div><div class="summary-holder"><textarea data-bind="{ mdlFloatingInput: { label: 'Summary ( Optional )', value: summary, id: 'pratilipi-settings-summary' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea></div><div class="private-information"><div class="material-title">Private Information</div><div class="width-50 js-width-50 text-center"><input type="email" data-bind="{ mdlFloatingInput: { label: 'Email', value: email, id: 'pratilipi-settings-email' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><input type="number" data-bind="{ mdlFloatingInput: { label: 'Phone', value: phone, id: 'pratilipi-settings-phone' }, valueUpdate: ['input'] }" /></div><div class="width-50 js-width-50 text-center"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input data-bind="event: { change: updateGender }"class="mdl-textfield__input"id="pratilipi-settings-gender"type="text" readonly /><label style="top: 4px; font-size: 12px; visibility: visible;"class="mdl-textfield__label" for="pratilipi-settings-gender">Gender<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-gender"><li class="mdl-menu__item" data-val="MALE">Male</li><li class="mdl-menu__item" data-val="FEMALE">Female</li><li class="mdl-menu__item" data-val="OTHER">Other</li></ul></div></div><div class="width-50 js-width-50 text-center"><div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label"><input data-bind="value: dateOfBirth, valueUpdate: ['input']"type="date"class="mdl-textfield__input"id="pratilipi-settings-dateOfBirth"><label style="top: 4px; font-size: 12px; visibility: visible;"class="mdl-textfield__label" for="pratilipi-settings-dateOfBirth">Date Of Birth</label></div></div></div><div class="save-button-holder"><button onclick="ga_CA( 'User', 'SubmitProfile' )"data-bind="enable: canSaveProfileSettings(), click: updateProfileSettings"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">Save Changes</button></div></div><div class="mdl-tabs__panel" data-name="Notification Settings" id="notification-settings"><div class="mdl-textfield mdl-js-textfield getmdl-select getmdl-select__fullwidth getmdl-select__fix-height mdl-textfield--floating-label"><input class="mdl-textfield__input"id="pratilipi-settings-email-frequency"data-bind="event: { change: updateEmailFrequency }"data-val="IMMEDIATELY"value="Immediately"type="text" tabIndex="-1" /><label class="mdl-textfield__label" for="pratilipi-settings-email-frequency">Email Frequency<i class="material-icons dropdown-icon">arrow_drop_down</i></label><ul class="mdl-menu mdl-menu--bottom-left mdl-js-menu dropdown-ul" for="pratilipi-settings-email-frequency"><li class="mdl-menu__item" data-val="IMMEDIATELY">Immediately</li><li class="mdl-menu__item" data-val="DAILY">Daily</li><li class="mdl-menu__item" data-val="WEEKLY">Weekly</li><li class="mdl-menu__item" data-val="MONTHLY">Monthly</li><li class="mdl-menu__item" data-val="NEVER">Never</li></ul></div><div class="settings-group"><div class="material-title group-title">Content</div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_review"><input value="USER_PRATILIPI_REVIEW" type="checkbox" id="notif_option_new_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Review</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_comment"><input value="COMMENT_REVIEW_REVIEWER" type="checkbox" id="notif_option_new_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Comment</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_review"><input value="VOTE_REVIEW_REVIEWER" type="checkbox" id="notif_option_like_review" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">Like on review</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_like_comment"><input value="VOTE_COMMENT_REVIEW_COMMENTOR" type="checkbox" id="notif_option_like_comment" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Like on Comment</span></label></div></div><div class="settings-group"><div class="material-title group-title">Network</div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_new_follower"><input value="AUTHOR_FOLLOW" type="checkbox" id="notif_option_new_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Follower</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_published_follower"><input value="PRATILIPI_PUBLISHED_FOLLOWER" type="checkbox" id="notif_option_pratilipi_published_follower" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">New Content by people you follow</span></label></div><div class="width-50 js-width-50"><label class="mdl-checkbox mdl-js-checkbox mdl-js-ripple-effect" for="notif_option_pratilipi_updates"><input value="GENERIC" type="checkbox" id="notif_option_pratilipi_updates" class="mdl-checkbox__input" /><span class="mdl-checkbox__label">Pratilipi Updates and Offers</span></label></div></div><div class="save-button-holder"><button onclick="ga_CA( 'User', 'SubmitNotification' )"data-bind="click: updateNotificationPreferences, enable: canSaveNotificationSettings()"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">Save Changes</button></div></div><div class="mdl-tabs__panel" data-name="Update Password" id="password-settings"><div class="mdl-cell mdl-cell--12-col"><input type="password" data-bind="{ mdlFloatingInput: { label: 'Current Password *', value: currentPassword, id: 'pratilipi-settings-current-password' }, valueUpdate: ['input'] }" /></div><div class="mdl-cell mdl-cell--12-col"><input type="password" data-bind="{ mdlFloatingInput: { label: 'New Password *', value: newPassword, id: 'pratilipi-settings-new-password' }, valueUpdate: ['input'] }" /></div><div class="mdl-cell mdl-cell--12-col"><input type="password" data-bind="{ mdlFloatingInput: { label: 'Confirm Password *', value: confirmPassword, id: 'pratilipi-settings-confirm-password' }, valueUpdate: ['input'] }" /></div><div class="save-button-holder"><button onclick="ga_CA( 'User', 'SubmitPassword' )"data-bind="enable: canUpdatePassword(), click: updatePassword"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect">Save Changes</button></div></div></div></div></div><div data-bind="visible: isLoading()"class="page-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-header', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.userPratilipi = params.userPratilipi; this.openSettings = params.openSettings; this.switchLibraryState = params.switchLibraryState; this.sharePratilipi = params.sharePratilipi; this.reportContent = params.reportContent; this.openNavigationModal = params.openNavigationModal; this.index = params.index; this.chapterNo = params.chapterNo; this.setChapterNo = params.setChapterNo; this.changeChapter = function( vm, e ) { self.setChapterNo( vm.chapterNo ); document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }; this.pratilipiObserver = ko.computed( function() { if( self.pratilipi.title() == null ) return; setTimeout( function() { var divWidth = $( ".pratilipi-reader .pratilipi-reader-header .js-pratilipi-title-holder" ).width(); var text = $( ".pratilipi-reader .pratilipi-reader-header .js-pratilipi-title-holder .js-pratilipi-title" ); var fontSize = 20.5; do { text.css( "font-size", fontSize -= 0.5 ); } while( text.width() > divWidth && fontSize > 12 ); }, 0 ); }, this ); } , template: `<div class="pratilipi-reader-header"><div class="exit-reader"><a onclick="ga_CA( 'Pratilipi', 'ActionBack' );" class="mdl-button mdl-js-button mdl-button--icon" data-bind="attr: { href: pratilipi.pageUrl() }"><i class="material-icons">arrow_back</i></a><button class="mdl-button mdl-js-button mdl-button--icon show-tablet" data-bind="click: openNavigationModal"><i class="material-icons">list</i></button></div><div class="pratilipi-title-holder js-pratilipi-title-holder"><div class="pratilipi-title js-pratilipi-title" data-bind="text: pratilipi.title()"></div></div><div class="menu-option-holder"><button onclick="ga_CA( 'Pratilipi', 'Settings' );" class="mdl-button mdl-js-button mdl-button--icon hide-mobile" data-bind="click: openSettings"><i class="material-icons">settings</i></button><button onclick="ga_CA( 'Pratilipi', 'AddToLibrary' );" class="mdl-button mdl-js-button mdl-button--icon hide-mobile" data-bind="click: switchLibraryState,disable: pratilipi.state() != 'PUBLISHED' || pratilipi.author.authorId() == appViewModel.user.author.authorId()"><i data-bind="css: { 'pratilipi-red': userPratilipi.addedToLib() }" class="material-icons">bookmark</i></button><button onclick="ga_CA( 'Pratilipi', 'Share' );" class="mdl-button mdl-js-button mdl-button--icon hide-mobile" data-bind="click: sharePratilipi"><i class="material-icons">share</i></button><button id="reader-report-content"onclick="ga_CA( 'Pratilipi', 'MoreOptions' );"class="mdl-button mdl-js-button mdl-button--icon"><i class="material-icons">more_vert</i></button><ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect"for="reader-report-content"><a class="mdl-menu__item clickable-element"data-bind="click: reportContent, visible: pratilipi.state() == 'PUBLISHED' && pratilipi.author.authorId() != appViewModel.user.author.authorId()">Report Content</a><a class="mdl-menu__item clickable-element"target="_blank"data-bind="attr: { href: pratilipi.writePageUrl() }, visible: pratilipi.hasAccessToUpdate()">Edit Content</a></ul></div></div><div class="mdl-layout__drawer"><nav class="mdl-navigation"><!-- ko foreach: { data: index() } --><a class="index-entry" onclick="ga_CA( 'Pratilipi', 'ChangeChapter' );" data-bind="{ text: $data.title, css: { 'highlight': $data.chapterNo == $parent.chapterNo() }, click: $parent.changeChapter }"></a><!--/ko--></nav></div>` }); </script> <script> ko.components.register( 'pratilipi-search-page-v2', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); var pratilipiCursor = null; var authorCursor = null; var pratilipiResultCount = 20; var authorResultCount = 10; var pratilipiNumberFound = null; var authorNumberFound = null; this.pratilipiList = ko.observableArray(); this.authorList = ko.observableArray(); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { if( pratilipiList[i].author.name == null ) pratilipiList[i].author.name = " "; pratilipiList[i].pageUrl += ( pratilipiList[i].pageUrl.indexOf( "?" ) == -1 ? "?" : "&" ) + "searchQuery=" + encodeURIComponent( self.updatedSearchQuery() ); self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); } }; this.updateAuthorList = function( authorList ) { for( var i = 0; i < authorList.length; i++ ) { authorList[i].pageUrl += ( authorList[i].pageUrl.indexOf( "?" ) == -1 ? "?" : "&" ) + "searchQuery=" + encodeURIComponent( self.updatedSearchQuery() ); self.authorList.push( ko.mapping.fromJS( authorList[i] ) ); } }; this.hasMorePratilipiContents = ko.observable( true ); this.hasMoreAuthorContents = ko.observable( true ); /* Loaded state */ /* * 4 Possible values for 'loadedState' * INITIAL * LOADED_EMPTY * LOADED * FAILED * * */ this.loadedState = ko.observable( "INITIAL" ); this.isLoading = ko.observable( false ); /* Initial Query loading state */ this.isLoadingPratilipi = ko.observable( false ); this.isLoadingAuthor = ko.observable( false ); this.updatedSearchQuery = ko.observable(); /* For displaying to User */ this.inputFocused = ko.observable( true ); /* 2 way binding */ this.searchQueryObserver = ko.computed( function() { appViewModel.searchQuery(); setTimeout( function() { if( appViewModel.searchQuery() == null || appViewModel.searchQuery().trim() == "" ) { self.loadedState( "INITIAL" ); self.clearAllValues(); } else { self.fetchInitialList(); } }, 0 ); }, this ); this.clearAllValues = function() { self.pratilipiList( [] ); self.authorList( [] ); pratilipiCursor = null; authorCursor = null; pratilipiNumberFound = null; authorNumberFound = null; self.hasMorePratilipiContents( true ); self.hasMoreAuthorContents( true ); }; this.fetchInitialList = function() { self.isLoadingPratilipi( false ); self.isLoadingAuthor( false ); self.isLoading( true ); dataAccessor.getInitialSearchResults( appViewModel.searchQuery(), function( searchResponse ) { self.isLoading( false ); self.updatedSearchQuery( appViewModel.searchQuery() ); if( searchResponse == null ) { self.loadedState( "FAILED" ); return; } var pratilipi = searchResponse.pratilipi != null && !isEmpty( searchResponse.pratilipi ) ? searchResponse.pratilipi : { "pratilipiList": [], "pratilipiCursor": null, "pratilipiNumberFound": 0 }; var author = searchResponse.author != null && !isEmpty( searchResponse.author ) ? searchResponse.author : { "authorList": [], "authorCursor": null, "authorNumberFound": 0 }; var pratilipiList = pratilipi.pratilipiList; var authorList = author.authorList; if( pratilipiList.length == 0 && authorList == 0 ) { self.loadedState( "LOADED_EMPTY" ); self.clearAllValues(); return; } self.pratilipiList( [] ); self.authorList( [] ); self.updatePratilipiList( pratilipiList ); self.updateAuthorList( authorList ); pratilipiCursor = pratilipi.pratilipiCursor; authorCursor = author.authorCursor; pratilipiNumberFound = pratilipi.numberFound; authorNumberFound = author.numberFound; self.hasMorePratilipiContents( pratilipiNumberFound != 0 && self.pratilipiList().length < pratilipiNumberFound ); self.hasMoreAuthorContents( authorNumberFound != 0 && self.authorList().length < authorNumberFound ); self.loadedState( "LOADED" ); }); }; this.fetchSubsequentPratilipiList = function() { if( self.isLoadingPratilipi() ) return; self.isLoadingPratilipi( true ); ga_CA( "Pratilipi", "LoadMore" ); dataAccessor.getPratilipiSearchResults( appViewModel.searchQuery(), pratilipiCursor, pratilipiResultCount, function( searchResponse ) { if( searchResponse == null ) { self.isLoadingPratilipi( false ); return; } var pratilipi = searchResponse.pratilipi != null && !isEmpty( searchResponse.pratilipi ) ? searchResponse.pratilipi : { "pratilipiList": {}, "pratilipiCursor": null, "pratilipiNumberFound": 0 }; var pratilipiList = pratilipi.pratilipiList; self.updatePratilipiList( pratilipiList ); pratilipiCursor = pratilipi.pratilipiCursor; pratilipiNumberFound = pratilipi.numberFound; self.hasMorePratilipiContents( pratilipiNumberFound != 0 && self.pratilipiList().length < pratilipiNumberFound ); self.isLoadingPratilipi( false ); }); }; this.fetchSubsequentAuthorList = function() { self.isLoadingAuthor( true ); ga_CA( "Author", "LoadMore" ); dataAccessor.getAuthorSearchResults( appViewModel.searchQuery(), authorCursor, authorResultCount, function( searchResponse ) { if( searchResponse == null ) { self.isLoadingAuthor( false ); return; } var author = searchResponse.author != null && !isEmpty( searchResponse.author ) ? searchResponse.author : { "authorList": {}, "authorCursor": null, "authorNumberFound": 0 }; var authorList = author.authorList; self.updateAuthorList( authorList ); authorCursor = author.authorCursor; authorNumberFound = author.numberFound; self.hasMoreAuthorContents( authorNumberFound != 0 && self.authorList().length < authorNumberFound ); self.isLoadingAuthor( false ); }); }; this.exitSearch = function() { if( appViewModel.searchQuery() != null ) appViewModel.searchQuery( null ); else redirect( getUrlParameter( "retUrl" ) != null ? decodeURIComponent( getUrlParameter( "retUrl" ) ) : "/" ); }; this.placeholderText = ko.computed( function() { var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth; return windowsize > 768 ? "Search for books, stories, poems and more ..." : "Search"; }, this ); this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchSubsequentPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.SEARCH_V2.ko_element ) { /* Dispose all observers */ self.pageScrollObserver.dispose(); self.placeholderText.dispose(); self.searchQueryObserver.dispose(); self.locationObserver.dispose(); return; } }, this ); } , template: `<div class="mdl-layout mdl-js-layout pratilipi-search-page"><div class="pratilipi-search-header mdl-card-border"><div class="header"><button data-bind="click: exitSearch"onclick="ga_CA( 'Search', 'Back' )"class="mdl-button mdl-js-button mdl-button--icon exit-search-button"><i class="material-icons">arrow_back</i></button><input type="text" data-bind="{ value: appViewModel.searchQuery, hasFocus: inputFocused, attr: { placeholder: placeholderText } }" /><button class="search-button"onclick="ga_CA( 'Search', 'SearchIconClick' )"data-bind="visible: ! isLoading()"><i class="material-icons">search</i></button><span data-bind="visible: isLoading()"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active search-loading-spinner"></span></div></div><div class="mdl-layout__content" data-bind="event: { scroll: appViewModel.notifyOfScrollEvent }"><div class="body mdl-card-border"><div class="mdl-grid default-result" data-bind="visible: loadedState() == 'INITIAL'"><div class="mdl-cell mdl-cell--6-col"><!-- ko component: "pratilipi-search-trends" --><!-- /ko --></div><div class="mdl-cell mdl-cell--6-col mdl-layout--large-screen-only"><!-- ko component: "pratilipi-current-event" --><!-- /ko --></div></div><!--<div class="mdl-grid search-results-incomplete"><div class="mdl-cell mdl-cell--6-col"><div class="material-subtitle-1 result-title">Author Matches</div><div class="result-entries"><a class="result-link material-body-1" href="#">Jaganath Sharma</a><a class="result-link material-body-1" href="#">Jaganath Mishra</a><a class="result-link material-body-1" href="#">Jagal</a></div></div><div class="mdl-cell mdl-cell--6-col"><div class="material-subtitle-1 result-title">Content Matches</div><div class="result-entries"><a class="result-link material-body-1" href="#">Jaganath Sharma</a><a class="result-link material-body-1" href="#">Jaganath Mishra</a><a class="result-link material-body-1" href="#">Jagal</a></div></div></div>--><div class="search-results-complete" data-bind="visible: loadedState() == 'LOADED'"><div class="mdl-grid" style="padding-top: 0; padding-bottom: 0;"><div class="mdl-cell mdl-cell--12-col search-results-heading"data-bind="text: 'Search Results for $query'.replace( '$query', updatedSearchQuery() )"></div></div><!-- ko if: authorList().length > 0 --><div class="mdl-grid author-results"><div class="mdl-cell mdl-cell--12-col"><div class="material-subtitle-1">Authors</div></div><div class="pratilipi-carousel" data-bind="carousel: true"><div class="carousel-wrapper"><div class="carousel"><ul data-bind="foreach: { data: authorList, as: 'author' }, visible: authorList().length > 0"><li data-bind="component: {name: 'pratilipi-author-card',params: { author: author }}"></li></ul></div></div><button action="prev" onclick="ga_CA( 'Author', 'ShowLess' )"><i class="material-icons">keyboard_arrow_left</i></button><button action="next" onclick="ga_CA( 'Author', 'ShowMore' )"><i class="material-icons">keyboard_arrow_right</i></button></div></div><!-- /ko --><!-- ko if: pratilipiList().length > 0 --><div class="pratilipi-results"><div class="mdl-grid" style="padding-top: 0; padding-bottom: 0;"><div class="mdl-cell mdl-cell--12-col"><div class="material-subtitle-1">Contents</div></div></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi, hideLibraryButton: true }} --><!-- /ko --></div></div><div class="load-more-container" data-bind="visible: hasMorePratilipiContents() && pratilipiList().length > 0"><button data-bind="{ click: fetchSubsequentPratilipiList, visible: ! isLoadingPratilipi() }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><span data-bind="visible: isLoadingPratilipi()" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div><!-- /ko --></div><div class="mdl-grid search-loaded-empty" data-bind="visible: loadedState() == 'LOADED_EMPTY'"><div class="mdl-cell mdl-cell--12-col material-subtitle-1">Sorry! No Search Results found for your search query. Try searching for different search query!</div></div><div class="mdl-grid search-load-failed" data-bind="visible: loadedState() == 'FAILED'"><div class="mdl-cell mdl-cell--12-col material-subtitle-1">Failed to load search results! Please click here to try again!</div></div><div class="mdl-grid explore-categories" data-bind="visible: loadedState() == 'INITIAL' || loadedState() == 'LOADED_EMPTY' || loadedState() == 'FAILED'"><div class="mdl-cell mdl-cell--12-col pratilipi-red material-subtitle-1" data-bind="text: loadedState() == 'INITIAL' ? 'Explore Categories' : 'Try Exploring these Categories'"></div></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-pagenotfound-page', { viewModel: function() {} , template: `<div class="page-notfound-page mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div class="left-col"><div style="width: 200px; height: 200px; margin: auto;" class="page-not-found-icon"></div></div><div class="right-col"><div class="material-title">Page Not Found!</div><br/><a href="/" class="material-subtitle-1" style="margin: 16px 0; color: inherit;">Oops, you've landed on a wrong page! Why don't you find your favourite stories by clicking here.</a><br/><br/><a class="material-subtitle-1" href="/"><i class="material-icons" style="float: left;">home</i><span>Home</span></a></div></div>` }); </script> <script> ko.components.register( 'pratilipi-tags', { viewModel: function(params) { /*Google analytic event Labels*/ var CATEGORY_TAGS_LABEL = "Category Tags"; /* when tags are clicked */ var CATEGORY_SUBMIT_LABEL = "Category Submit"; /* when submit button is clicked */ var CONTENT_CATEGORY_LABEL = "PP - Content Category"; /* when pratilipi type is changed on pratilipi page(PP) */ var TOOLTIP_LABEL = "g_category_tip"; /*Google analytic event actions*/ var SELECT_CATEGORY_ACTION = "Select Category"; /* when predefined tag is selected */ var DESELECT_CATEGORY_ACTION = "DeSelect Category"; /* when predefined tag is unselected */ var SELECT_USER_TAG_ACTION = "Select User Tag"; /* when user suggested tag is selected (Add button is clicked) */ var DESELECT_USER_TAG_ACTION = "DeSelect User Tag"; /* when user suggested tag is unselected */ var ASSIGN_CATEGORIES_TAGS_ACTION = "Assign Categories - Tags"; /* when both predefined tags and user tags are added(for 1st time) */ var ASSIGN_CATEGORIES_ACTION = "Assign Categories Only"; /* when predefined tags are added(for 1st time) */ var ASSIGN_TAGS_ACTION = "Assign Tags Only"; /* when user tags are added(for 1st time) */ var UPDATE_CATEGORIES_TAGS_ACTION = "Update Categories - Tags"; /* when both predefined tags and user tags are updated */ var UPDATE_CATEGORIES_ACTION = "Update Categories Only"; /* when predefined tags are updated */ var UPDATE_TAGS_ACTION = "Update Tags Only"; /* when user tags are updated */ var UPDATE_PRATILIPI_TYPE = "Update Pratilipi Type"; /* when pratilipi type */ var TOOLTIP_SHOW_ACTION = "g_tip_show"; /* when tooltip shown */ var TOOLTIP_LOCATION = "g_pratilipi_page"; /* when tooltip shown */ /* FB analytic parameter name */ var ENVIRONMENT = "ENVIRONMENT"; var CONTENT_LANGUAGE = "CONTENT_LANGUAGE"; var SCREEN_NAME = "SCREEN_NAME"; var USERID = "USERID"; var ENTITY_STATE = "ENTITY_STATE"; var ENTITY_VALUE = "ENTITY_VALUE"; var CATEGORY_COUNT = "CATEGORY_COUNT"; var CATEGORY_STRING = "CATEGORY_STRING"; var TAG_COUNT = "TAG_COUNT"; var TAG_STRING = "TAG_STRING"; var PRATILIPI_TYPE = "PRATILIPI_TYPE"; var CONTENT_ID = "CONTENT_ID"; var AUTHOR_ID = "AUTHOR_ID"; var ACCESS_LEVEL = "ACCESS_LEVEL"; var SUCCESS = "SUCCESS"; /* FB analytic parameter value */ var ENV_PROD = "PROD"; var ACCESS_LEVEL_ADMIN = "ADMIN"; var ACCESS_LEVEL_SELF = "SELF"; var PRATILIPI_PAGE = "PRATILIPI_PAGE"; var AUTHOR_PAGE = "AUTHOR_PAGE"; var OLD = "OLD"; /* FB Analytics Event Name */ var SELECT_CATEGORY = "SELECT_CATEGORY"; var DESELECT_CATEGORY = "DESELECT_CATEGORY"; var SELECT_TAG = "SELECT_TAG"; var DESELECT_TAG = "DESELECT_TAG"; var SUBMIT_CATEGORY = "SUBMIT_CATEGORY"; var CATEGORY_TAG = "CATEGORY_TAG"; var CATEGORY = "CATEGORY"; var TAG = "TAG"; var NEW = "NEW"; var UPDATE = "UPDATE"; var SELECT_PRATILIPI_TYPE = "SELECT_PRATILIPI_TYPE"; selectedTagIds = []; suggestedTags = []; pratilipiTagIds = []; var dataAccessor = new DataAccessor(); var self = this; self.isShownInModal = params.isShownInModal != null ? params.isShownInModal : false; /* Default set to false */ self.pratilipi = params.pratilipi; self.tags = ko.observableArray([]); self.categories = ko.observableArray([]); self.userSuggestedTags = ko.observableArray([]); self.type = ko.observable(); self.tagsLoaded = ko.observable(true); self.pratilipiTypeSelected = ko.observable(false); self.categoryInputActive = ko.observable(true); self.toolTipShown = ko.observable(true); var modal = document.getElementById("addCategory-" + self.pratilipi.pratilipiId()); var radios; if (self.isShownInModal) radios = modal.querySelectorAll('input[type=radio][name="pratilipi-type"]'); else radios = document.querySelectorAll('input[type=radio][name="pratilipi-type"]'); function changeHandler(event) { self.type(this.value); self.pratilipiTypeSelected(true); /* GA - PRATILIPI TYPE UPDATED EVENT */ if (self.type() != self.pratilipi.type()) { /* clearing selected tags of previous Pratilipi type */ selectedTagIds = []; ga_CAL(CONTENT_CATEGORY_LABEL, UPDATE_PRATILIPI_TYPE, self.type() + "-" + self.pratilipi.type()); FBEvent(SELECT_PRATILIPI_TYPE, OLD, self.type(), null, null, null, null, null); } else { if (pratilipiTagIds) selectedTagIds = pratilipiTagIds.slice(); } } Array.prototype.forEach.call(radios, function(radio) { radio.addEventListener('change', changeHandler); }); /* pratilipiTagIds : contains ids of tags already assigned to Pratilipi */ ko.computed( function() { if(self.pratilipi.tags() == null) return null; self.pratilipi.tags().forEach(function(tag) { if (pratilipiTagIds.indexOf(tag.id()) == -1) { /* add if not present already. */ pratilipiTagIds.push(tag.id()); selectedTagIds.push(tag.id()); self.categories.push({ "name": tag.name(), "type": 0 }); } }); self.categoryInputActive(false); self.toolTipShown = ko.observable(false); }, this ); ko.computed(function() { /* Default value for pratilipi type dropdown */ if (self.pratilipi.type() && (self.pratilipi.type() == "ARTICLE" || self.pratilipi.type() == "POEM" || self.pratilipi.type() == "STORY")) { self.type(self.pratilipi.type()); Array.prototype.forEach.call(radios, function(radio) { if (radio.value == self.pratilipi.type()) { radio.checked = true; } }); self.pratilipiTypeSelected(true); } return null; }); ko.computed(function() { /* Initializing suggestedTags */ if(self.pratilipi.suggestedTags() == null) return; self.userSuggestedTags(self.pratilipi.suggestedTags().slice()); suggestedTags = self.pratilipi.suggestedTags().slice(); self.pratilipi.suggestedTags().forEach(function(tagName) { self.categories.push({ "name": tagName, "type": 1 }); }); self.categoryInputActive(false); self.toolTipShown = ko.observable(false); }, this); /* fetching tags based on selected pratilipi type */ ko.computed(function() { if (self.type() == null) return; /* Show loading icon */ self.tagsLoaded(false); /* FETCHING TAGS EVERYTIME self.type CHANGES */ dataAccessor.getTags(self.pratilipi.language(), self.type(), function(response) { if (response == null) { /* Server call fails */ console.log('Tags not working'); /* hide loading icon */ self.tagsLoaded(true); } else { self.onSuccess(response); } }); }); self.onSuccess = function(data) { self.tagsLoaded(true); ko.mapping.fromJS(data.response[0].tags, {}, self.tags); /* marking already selected tags. */ if(pratilipiTagIds != null) { pratilipiTagIds.forEach(function(tagId) { $('#' + tagId).addClass('checked'); $('#' + tagId).attr("data-select", "1"); }); } }; /* click event for help icon */ self.helpClicked = function(data, event) { if (self.toolTipShown()) { self.toolTipShown(false); } else { event.stopPropagation(); self.toolTipShown(true); /* Auto hide after 3 seconds */ setTimeout(function() { self.toolTipShown(false); }, 3000); /* Google Analytics event */ ga_CAL(TOOLTIP_LABEL, TOOLTIP_SHOW_ACTION, TOOLTIP_LOCATION); } }; /* Toggle category input view visibility */ self.toggleCatergoryInput = function() { if (self.categoryInputActive()) self.categoryInputActive(false); else self.categoryInputActive(true); }; /* when pratilipi type is updated */ self.updateType = function() { console.log('#pratilipi_tags_type-'+self.pratilipi.pratilipiId()); self.type( $( '#pratilipi_tags_type-'+self.pratilipi.pratilipiId() ).attr( "data-val" ) ); self.pratilipiTypeSelected(true); /* GA - PRATILIPI TYPE UPDATED EVENT */ if (self.type() != self.pratilipi.type()) { /* clearing selected tags of previous Pratilipi type */ selectedTagIds = []; ga_CAL(CONTENT_CATEGORY_LABEL, UPDATE_PRATILIPI_TYPE, self.type() + "-" + self.pratilipi.type()); FBEvent(SELECT_PRATILIPI_TYPE, OLD, self.type(), null, null, null, null, null); } else { if (pratilipiTagIds) selectedTagIds = pratilipiTagIds().slice(); } }; /* When cancel button is clicked */ self.closeCategoryInput = function() { self.categoryInputActive(false); /* Close modal if present in modal */ if (self.isShownInModal) $("#addCategory-" + self.pratilipi.pratilipiId()).modal('hide'); }; self.tagClick = function(data, event) { var id = data.id(); var element = $("#" + id); element.toggleClass("checked"); if (element.hasClass("checked")) { selectedTagIds.push(id); /* GA - CATEGORY SELECT EVENT */ var selectCount = Number(element.attr("data-select"))+1; element.attr("data-select",selectCount); if (selectCount == 1) { /* send GA event only first time */ ga_CA(CATEGORY_TAGS_LABEL, SELECT_CATEGORY_ACTION); FBEvent(SELECT_CATEGORY, null, id.toString(), null, null, null, null, null); } } else { index = selectedTagIds.indexOf(id); if (index != -1) selectedTagIds.splice(index, 1); /* GA - CATEGORY DESELECT EVENT */ var deselectCount = Number(element.attr("data-deselect"))+1; element.attr("data-deselect",deselectCount); if (deselectCount == 1) { /* send GA and FB event only first time */ ga_CA(CATEGORY_TAGS_LABEL, DESELECT_CATEGORY_ACTION); if (pratilipiTagIds.indexOf(Number(id)) != -1) /* send only if it is existing category */ FBEvent(DESELECT_CATEGORY, null, id.toString(), null, null, null, null, null); } } }; self.suggestedTagClick = function(data, event) { var element = $(event.target); var userTag = element.text(); element.toggleClass("checked"); if (element.hasClass("checked")) { suggestedTags.push(userTag); } else { index = suggestedTags.indexOf(userTag); if (index != -1) suggestedTags.splice(index, 1); /* GA - USER TAG DESELECT EVENT */ var deselectCount = Number(element.attr("data-deselect"))+1; element.attr("data-deselect",deselectCount); if (deselectCount == 1) { /* send GA and FB event only first time */ ga_CA(CATEGORY_TAGS_LABEL, DESELECT_USER_TAG_ACTION); if (self.pratilipi.suggestedTags().indexOf(userTag) != -1) /* send only if it is existing user tag */ FBEvent(DESELECT_TAG, null, userTag, null, null, null, null, null); } } }; self.addTag = function() { var inputBox = $("#pratilipi_suggested_tags_input-"+self.pratilipi.pratilipiId()); var userTag = $.trim(inputBox.val()); if (!userTag) return; /* clear input box. Add tag to the suggested list and to suggested selected list */ inputBox.val(""); inputBox.focus(); self.userSuggestedTags.push(userTag); suggestedTags.push(userTag); /* GA - USER TAG SELECT EVENT */ ga_CA(CATEGORY_TAGS_LABEL, SELECT_USER_TAG_ACTION); /* FB - USER TAG SELECT EVENT */ FBEvent(SELECT_TAG, null, userTag, null, null, null, null, null); }; self.saveTags = function() { var isTypeUpdated = false; var isCategoriesUpdated = false; var isUserTagsUpdated = false; /* Compare pratilipitype */ if (self.pratilipi.type() != self.type()) isTypeUpdated = true; /* Compare selectedTagIds with pratilipiTags */ if (pratilipiTagIds && pratilipiTagIds.length) { /* self.pratilipi.tags is not null and not empty */ if (selectedTagIds.toString() != pratilipiTagIds.toString()) { isCategoriesUpdated = true; } } else { /* self.pratilipi.tags is null or empty */ if (selectedTagIds.length > 0) /* selectedTagIds length is greater than 0 */ isCategoriesUpdated = true; } /* existing suggested tags is not null and not equal to updated value */ if (self.pratilipi.suggestedTags()) { /* self.pratilipi.suggestedTags is not null */ if (suggestedTags.toString() != self.pratilipi.suggestedTags().toString()) { isUserTagsUpdated = true; } } else { /* self.pratilipi.suggestedTags is null */ if (suggestedTags.length > 0) /* suggestedTags length is greater than 0 */ isUserTagsUpdated = true; } if (isTypeUpdated || isCategoriesUpdated || isUserTagsUpdated) { /* Google and FB Analytics */ var gaAction, fbEventType, fbEventValue, isSuccess; if (isCategoriesUpdated && isUserTagsUpdated) { fbEventValue = CATEGORY_TAG; if ((pratilipiTagIds && pratilipiTagIds.length) || self.pratilipi.suggestedTags()) { gaAction = UPDATE_CATEGORIES_TAGS_ACTION; fbEventType = UPDATE; } else { gaAction = ASSIGN_CATEGORIES_TAGS_ACTION; fbEventType = NEW; } } else if (isCategoriesUpdated) { fbEventValue = CATEGORY; if (pratilipiTagIds && pratilipiTagIds.length) { gaAction = UPDATE_CATEGORIES_ACTION; fbEventType = UPDATE; } else { gaAction = ASSIGN_CATEGORIES_ACTION; fbEventType = NEW; } } else if (isUserTagsUpdated) { fbEventValue = TAG; if (self.pratilipi.suggestedTags() && self.pratilipi.suggestedTags().length) { gaAction = UPDATE_TAGS_ACTION; fbEventType = UPDATE; } else { gaAction = ASSIGN_TAGS_ACTION; fbEventType = NEW; } } /* disable submit button */ $("#saveTags-" + self.pratilipi.pratilipiId()).prop('disabled', true); $("#closeCategoryInputView-" + self.pratilipi.pratilipiId()).prop('disabled', true); /* Make server call to update tags. */ ToastUtil.toastUp( "Working ..." ); dataAccessor.updatePratilipiTags( self.pratilipi.pratilipiId(), self.type(), selectedTagIds, suggestedTags, function(data) { $("#saveTags-" + self.pratilipi.pratilipiId()).prop('disabled', false); $("#closeCategoryInputView-" + self.pratilipi.pratilipiId()).prop('disabled', false); self.categoryInputActive(false); self.pratilipi.suggestedTags(suggestedTags.slice()); pratilipiTagIds = selectedTagIds.slice(); /* Close modal if present in modal */ if (self.isShownInModal) $("#addCategory-" + self.pratilipi.pratilipiId()).modal('hide'); if (self.type() && self.type() != self.pratilipi.type()) { self.pratilipi.type(self.type()); } updateCategoies(selectedTagIds, suggestedTags); /* Send FB Event */ FBEvent( SUBMIT_CATEGORY, fbEventType, fbEventValue, selectedTagIds ? selectedTagIds.length : 0, selectedTagIds ? selectedTagIds.toString() : null, suggestedTags ? suggestedTags.length : 0, suggestedTags ? suggestedTags.toString() : null, 1 /* Successful request */ ); ToastUtil.toast( "Success !", 3000 ); }, function(data) { $("#saveTags-" + self.pratilipi.pratilipiId()).prop('disabled', false); $("#closeCategoryInputView-" + self.pratilipi.pratilipiId()).prop('disabled', false); var message = "Some error Occurred! Please try again!"; if( data[ "message" ] != null ) message = data[ "message" ]; ToastUtil.toast( message, 3000 ); /* Send FB Event */ FBEvent( SUBMIT_CATEGORY, fbEventType, fbEventValue, selectedTagIds ? selectedTagIds.length : 0, selectedTagIds ? selectedTagIds.toString() : null, suggestedTags ? suggestedTags.length : 0, suggestedTags ? suggestedTags.toString() : null, 0 /* failed request */ ); } ); /* GA - ADD OR UPDATE CATEGORY OR/AND TAG EVENT */ if (gaAction) { /* gaAction is null if only pratilipi type is updated */ ga_CAV(CATEGORY_SUBMIT_LABEL, gaAction, Number(calculateGAValue(isCategoriesUpdated, isUserTagsUpdated))); } } else { /* close input view without making server call */ self.categoryInputActive(false); } }; updateCategoies = function(selectedTagIds, suggestedTags) { /* remove existing entries */ self.categories([]); var list = self.tags(); if (selectedTagIds) { selectedTagIds.forEach(function(id) { list.forEach(function(tag) { if (id == tag.id()) { self.categories.push({ "name": tag.name(), "type": 0 }); } }); }); } if (suggestedTags) { suggestedTags.forEach(function(tagName) { self.categories.push({ "name": tagName, "type": 1 }); }); } }; calculateGAValue = function(isCategoriesUpdated, isUserTagsUpdated) { var selectedTagIdsLength = selectedTagIds.length; var suggestedTagsLength = suggestedTags.length; if (selectedTagIdsLength == 0 || !isCategoriesUpdated) return suggestedTagsLength; if (suggestedTagsLength == 0 || !isUserTagsUpdated) return selectedTagIdsLength; if (suggestedTagsLength < 10) suggestedTagsLength = "0" + suggestedTagsLength; return selectedTagIdsLength + suggestedTagsLength; }; FBEvent = function(event_name, entity_state, entity_value, category_count, category_string, tag_count, tag_string, success) { var params = {}; params[ENVIRONMENT] = ENV_PROD; params[CONTENT_LANGUAGE] = self.pratilipi.language(); params[SCREEN_NAME] = self.isShownInModal ? AUTHOR_PAGE : PRATILIPI_PAGE; params[USERID] = appViewModel.user.userId(); if (entity_state) params[ENTITY_STATE] = entity_state; if (entity_value) params[ENTITY_VALUE] = entity_value; if (category_count) params[CATEGORY_COUNT] = category_count; if (category_string) params[CATEGORY_STRING] = category_string; if (tag_count) params[TAG_COUNT] = tag_count; if (tag_string) params[TAG_STRING] = tag_string; params[PRATILIPI_TYPE] = self.pratilipi.type(); params[CONTENT_ID] = self.pratilipi.pratilipiId(); params[AUTHOR_ID] = self.pratilipi.author.authorId(); params[ACCESS_LEVEL] = appViewModel.user.author.authorId() == self.pratilipi.author.authorId() ? ACCESS_LEVEL_SELF : ACCESS_LEVEL_ADMIN; if (success != null) /* because success == 0 for failed request */ params[SUCCESS] = success; FB.AppEvents.logEvent(event_name, null, params); }; /* Send tooltip event if it is visible by default. */ if (self.toolTipShown()) { ga_CAL(TOOLTIP_LABEL, TOOLTIP_SHOW_ACTION, TOOLTIP_LOCATION); } /* Hide category tooltip when clicked anywhere */ $(document).click(function() { self.toolTipShown(false); }); } , template: `<div class="pratilipi-tags" style="margin: 0px; width: 100%;"><h3 class="material-title" style="margin: 8px 16px;">Categories<button data-bind="{click: toggleCatergoryInput, visible: !isShownInModal}"class="mdl-button mdl-js-button mdl-button--icon"style="margin-left: 4px;"><i style="font-size: 20px" class="material-icons">create</i></button><button data-bind="click: helpClicked, visible: !isShownInModal"class="mdl-button mdl-js-button mdl-button--icon"style="float: right; overflow:visible"><i class="material-icons" style="color:#D0021B">help<span class="tooltip" data-bind="visible: toolTipShown" style="color:#000">Assign pre-defined and add custom categories to your content.</span></i></button></h3><div class="pratilipi-tag-container"data-bind="visible: !categoryInputActive() && !isShownInModal, foreach: categories"style="margin: 8px 16px;"><span class="pratilipi-tag-element disabled font-16"data-bind="text:name, style: { background: type ? 'white' : '#D3D3D3' }"></span></div><div data-bind="visible: categoryInputActive() || isShownInModal" style="margin: 8px 16px;"><h6 class="material-subtitle-1">Select Pratilipi type</h6><form><label style="margin:10px;"><input type="radio"name="pratilipi-type"value="POEM"><i>Poem</i></label><label style="margin:10px;"><input type="radio"name="pratilipi-type"value="STORY"><i>Story</i></label><label style="margin:10px;"><input type="radio"name="pratilipi-type"value="ARTICLE"><i>Article</i></label></form><div data-bind="visible: pratilipiTypeSelected()"><h6 class="material-subtitle-1">Select Category<span class="subtitle-span">( Click to select )</span></h6><div data-bind="visible: ! tagsLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><span class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="pratilipi-tag-container" data-bind="foreach: tags, visible: tagsLoaded()"><div class="pratilipi-tag-element font-16"data-bind="text:name, attr: {id:id}, click: $parent.tagClick"data-select="0"data-deselect="0"></div></div><div data-bind="visible: tagsLoaded()"><h6 class="material-subtitle-1">Add your own category</h6><div class="pratilipi-tag-container" data-bind="foreach: userSuggestedTags"><div class="pratilipi-tag-element font-16 checked"data-bind="text:$data, click: $parent.suggestedTagClick"data-deselect="0"></div></div><div class="mdl-cell mdl-cell--12-col padding-zero"><div class="mdl-grid padding-zero mdl-grid--no-spacing"><input placeholder="Type here"data-bind="attr: { 'id':'pratilipi_suggested_tags_input-'+pratilipi.pratilipiId() }, transliterate: true"style="border: 1px solid #D3D3D3; padding:5px;"/><button data-bind="click: addTag"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margi"style="margin-left:10px;">Add</button></div></div></div><div style="text-align: right; padding-top:10px"><button data-bind="click: closeCategoryInput, attr: {'id': 'closeCategoryInputView-' + pratilipi.pratilipiId() }"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin">Cancel</button><button data-bind="click: saveTags, attr: {'id': 'saveTags-' + pratilipi.pratilipiId() }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin">Save</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader-content', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.pratilipi = params.pratilipi; this.updatePratilipi = params.updatePratilipi; this.userPratilipi = params.userPratilipi; this.updateUserPratilipi = params.updateUserPratilipi; this.chapterNo = params.chapterNo; this.chapterCount = params.chapterCount; this.fontSize = params.fontSize; this.imageSize = params.imageSize; this.setImageSize = params.setImageSize; this.lineHeight = params.lineHeight; this.setChapterNo = params.setChapterNo; this.content = ko.observable(); this.isLoading = ko.observable( true ); var contentMap = {}; this._getImageUrl = function( chapterNo ) { if( chapterNo == null ) return; return "<img style='width: " + self.imageSize() + "px' class='image-content js-image-content' src='/api/pratilipi/content/image?pratilipiId=" + self.pratilipi.pratilipiId() + "&" + "name=" + contentMap[ chapterNo ] + "' />"; }, this._precache = function( chapterNo ) { setTimeout( function() { if( self.pratilipi.contentType() == "PRATILIPI" ) { if( self.chapterNo() > 1 ) self._loadContent( self.chapterNo() - 1 ); if( self.chapterNo() < self.chapterCount() ) self._loadContent( self.chapterNo() + 1 ); } else if( self.pratilipi.contentType() == "IMAGE" ) { if( self.chapterNo() > 1 ) $( self._getImageUrl( self.chapterNo() - 1 ) ).trigger( 'load' ); if( self.chapterNo() < self.chapterCount() ) $( self._getImageUrl( self.chapterNo() + 1 ) ).trigger( 'load' ); } }, 0 ); }; this._loadContent = function( chapterNo ) { if( contentMap[ chapterNo ] !== undefined ) /* Either marked null or has content */ return; contentMap[ chapterNo ] = null; dataAccessor.getPratilipiContent( self.pratilipi.pratilipiId(), chapterNo, self.pratilipi.oldContent(), function( contentResponse ) { if( contentResponse == null ) contentResponse = { "content": "", "chapterNo": chapterNo }; var content = contentResponse.content != null ? contentResponse.content.replace( /&nbsp;/g, " " ) : ""; if( contentResponse.chapterTitle != null ) content = "<h1 class='chapter-title'>" + contentResponse.chapterTitle + "</h1>" + content; var cNo = contentResponse.chapterNo; contentMap[ cNo ] = content; if( self.chapterNo() == cNo ) { self.content( content ); self.isLoading( false ); self._precache(); /* Not making calls to x+1 and x-1 chapter if chapter is not available. Giving utmost importance to the current page. */ } }); }; this._initialiseImageContentReader = function() { dataAccessor.getPratilipiContent( self.pratilipi.pratilipiId(), null, true, function( contentResponse ) { var chapters = contentResponse.content.chapters; var c = 1; for( var i = 0; i < chapters.length; i++ ) { var pages = chapters[i].pages; for( var j = 0; j < pages.length; j++ ) contentMap[ c++ ] = pages[j].pagelets[0].data.name; } /* First Load */ self.isLoading( false ); self.content( self._getImageUrl( self.chapterNo() ) ); self.setImageSizeDOM(); self._precache(); }); }; this.chapterNoObserver = ko.computed( function() { if( self.chapterNo() == null ) return; setTimeout( function() { if( self.pratilipi.contentType() == "PRATILIPI" ) { if( contentMap[ self.chapterNo() ] === undefined ) { self.isLoading( true ); self._loadContent( self.chapterNo() ); } else if( contentMap[ self.chapterNo() ] == null ) { self.isLoading( true ); } else if( contentMap[ self.chapterNo() ] != null ) { self.content( contentMap[ self.chapterNo() ] ); self.isLoading( false ); self._precache(); /* Since the page is already available, precaching other pages */ } } else if( self.pratilipi.contentType() == "IMAGE" ) { if( isEmpty( contentMap ) ) { self.isLoading( true ); self._initialiseImageContentReader(); } else { self.content( self._getImageUrl( self.chapterNo() ) ); self._precache(); } } }, 0 ); }, this ); this.readerContentClassObserver = ko.computed( function() { var getLineHeightClass = function( lineHeight ) { if( lineHeight == 'SMALL' ) return 'lh-sm'; if( lineHeight == 'MEDIUM' ) return 'lh-md'; if( lineHeight == 'LARGE' ) return 'lh-lg'; }; var getFontClass = function( fontSize ) { return "content-font-" + fontSize; }; return getLineHeightClass( self.lineHeight() ) + " " + getFontClass( self.fontSize() ); }, this ); this.setImageSizeDOM = function() { var contentDiv = $( ".pratilipi-reader .pratilipi-reader-content .js-content" ); if( self.imageSize() == -1 ) { /* undetermined */ if( contentDiv.width() == 0 ) return; self.setImageSize( contentDiv.width() ); } jQuery( "img.js-image-content" ).css( 'width', self.imageSize() + 'px', 'important' ); }; this.imageSizeObserver = ko.computed( function() { self.imageSize(); setTimeout( function() { self.setImageSizeDOM(); }, 0 ); }, this ); this.goToNextChapter = function() { self.setChapterNo( self.chapterNo() + 1 ); }; /* Rating and review */ this.ratingInput = ko.observable(0); this.reviewInput = ko.observable(); this.addOrDeleteReviewRequestOnFlight = ko.observable( false ); var reviewInputDialog = $( '#pratilipi-reader-review-input-dialog' ); this.openReviewModal = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( { "id": self.pratilipi.pratilipiId(), "action": "openReviewModal", "ratingInput": self.ratingInput() } ); return; } reviewInputDialog.modal( 'show' ); }; this.closeReviewModal = function() { reviewInputDialog.modal( 'hide' ); self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }; /* Clicking anywhere outside the screen */ reviewInputDialog.on( 'hidden.bs.modal', function(e) { self.closeReviewModal(); }); /* Create/Update Review */ this.createOrUpdateReview = function() { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.createOrUpdateReview( self.pratilipi.pratilipiId(), self.ratingInput(), self.reviewInput(), function( review ) { if( review.rating == null ) review.rating = 0; if( review.reviewState != "PUBLISHED" || review.review == null || review.review.trim() == "" ) review.review = null; self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); self.closeReviewModal(); ToastUtil.toast( "Success !" ); redirect( self.pratilipi.pageUrl() ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "Some error Occurred! Please try again!" ); }); }; /* Delete Review */ this.deleteReview = function( review ) { if( self.addOrDeleteReviewRequestOnFlight() ) return; self.addOrDeleteReviewRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.deleteReview( self.pratilipi.pratilipiId(), function( review ) { self.updateUserPratilipi( review ); self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "Success!" ); }, function( error ) { self.addOrDeleteReviewRequestOnFlight( false ); ToastUtil.toast( "Some error Occurred! Please try again!" ); } ); }; this.submitReview = function() { /* Not Updated rating, just cleared the review */ if( self.ratingInput() == self.userPratilipi.rating() && self.userPratilipi.review() != null && self.userPratilipi.review().trim() != "" && self.reviewInput() != null && self.reviewInput().trim() == "" ) self.deleteReview(); else self.createOrUpdateReview(); }; this.canSubmitReview = ko.computed( function() { return self.ratingInput() != 0 && ! self.addOrDeleteReviewRequestOnFlight(); }, this ); this.userPratilipiMetaObserver = ko.computed( function() { self.ratingInput( self.userPratilipi.rating() ); self.reviewInput( self.userPratilipi.review() ); }, this ); this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() && getUrlParameter( 'action' ) == "openReviewModal" ) { if( getUrlParameter( "ratingInput" ) != null && getUrlParameter( "ratingInput" ) > 0 ) { self.ratingInput( parseInt( getUrlParameter( "ratingInput" ) ) ); } self.openReviewModal(); } }, this ); /* Share */ var getShareUrl = function( utm_source ) { return encodeURIComponent( window.location.origin + self.pratilipi.pageUrl() + ( self.pratilipi.pageUrl().indexOf( '?' ) == -1 ? "?" : "&" ) + "utm_language=english" + "&" + "utm_version=pwa" + "&" + "utm_device=" + ( isMobile() ? "mobile" : "desktop" ) + "&" + "utm_parent=reader" + "&" + "utm_action=share" + "&" + "utm_source=" + utm_source ); }; var getWhatsappText = function() { return '"' + self.pratilipi.title() + '", read it on Pratilipi : ' + getShareUrl() +" Read unlimited stories, poems, articles in Indian languages for FREE!"; }; this.shareOnFacebook = function() { window.open( "http://www.facebook.com/sharer.php?u=" + getShareUrl( "facebook" ), "share", "width=1100,height=500,left=70px,top=60px" ); }; this.shareOnTwitter = function( utm_location ) { window.open( "http://twitter.com/share?url=" + getShareUrl( "twitter" ), "share", "width=1100,height=500,left=70px,top=60px" ); }; this.shareOnGplus = function( utm_location ) { window.open( "https://plus.google.com/share?url=" + getShareUrl( "gplus" ), "share", "width=1100,height=500,left=70px,top=60px" ); }; this.shareOnWhatsapp = function() { window.open( "whatsapp://send?text=" + getWhatsappText() ); }; } , template: `<div class="pratilipi-reader-content"><span data-bind="visible: isLoading()" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><div data-bind="visible: !isLoading()"><div class="content js-content"data-bind="{ html: content(),css: readerContentClassObserver() }"></div><div data-bind="visible: chapterNo() != chapterCount()" class="next-chapter-container"><div class="next-chapter clickable-element" data-bind="click: goToNextChapter">Next Chapter</div></div><div data-bind="visible: chapterNo() == chapterCount()" class="last-page-review-container"><div class="social-icons-holder"><div class="sprites-icon facebook-icon clickable-element" data-bind="click: shareOnFacebook"></div><div class="sprites-icon twitter-icon clickable-element" data-bind="click: shareOnTwitter"></div><div class="sprites-icon google-plus-icon clickable-element" data-bind="click: shareOnGplus"></div><div class="sprites-icon whatsapp-icon clickable-element" data-bind="visible: isMobile(), click: shareOnWhatsapp"></div></div><div class="user-image-container"><hr/><img data-bind="visible: ! appViewModel.user.isGuest(), attr: { src: getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" /><i onclick="goToLoginPage()" class="material-icons clickable-element" data-bind="visible: appViewModel.user.isGuest()">account_circle</i></div><div class="rating-input-container"><div class="material-title">Your Rating</div><pratilipi-rating-input params="{ rating: ratingInput }" data-bind="click: openReviewModal"></pratilipi-rating-input></div><!-- ko if: pratilipi.state() == 'PUBLISHED' --><!-- ko component: {name: "pratilipi-recommendation-carousel",params: { pratilipiId: pratilipi.pratilipiId, context: 'readPage' }} --><!-- /ko --><!-- /ko --></div></div></div><div class="modal common-modal fade" id="pratilipi-reader-review-input-dialog" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button data-bind="click: closeReviewModal" class="mdl-button mdl-js-button mdl-button--icon close"><i class="material-icons">close</i></button><h6 class="modal-title">Rate and review</h6></div><div class="modal-body"><pratilipi-rating-input style="color: rgba(0,0,0,0.54);" params="{ rating: ratingInput }"></pratilipi-rating-input><textarea data-bind="{ mdlFloatingInput: { label: 'Write a Review', value: reviewInput, id: 'pratilipi_reader_review_list_review_input' }, valueUpdate: ['input'], transliterate: true }" rows= "3"></textarea></div><div class="modal-footer"><button onclick="ga_CA( 'Review', 'Cancel Rating' )"data-bind="click: closeReviewModal"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">Cancel</button><button onclick="ga_CA( 'Review', 'Add Rating' )"data-bind="click: submitReview, enable: canSubmitReview"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">SUBMIT</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-event-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultEvent = { "eventId": null, "name": null, "nameEn": null, "language": null, "description": null, "pageUrl": null, "bannerImageUrl": null, "hasAccessToUpdate": false }; this.event = ko.mapping.fromJS( defaultEvent, {}, self.event ); this.updateEvent = function( event ) { if( event == null ) event = defaultEvent; ko.mapping.fromJS( event, {}, self.event ); MetaTagUtil.setMetaTagsForEvent( ko.mapping.toJS( self.event ) ); }; this.initialDataLoaded = ko.observable( false ); this.fetchEvent = function() { dataAccessor.getEventByUri( window.location.pathname, function( event ) { if( event == null ) { /* Invalid Uri */ appViewModel.currentView( LOCATION.PAGE_NOT_FOUND[ "ko_element" ] ); return; } self.updateEvent( event ); if( ! self.initialDataLoaded() ) self.initialDataLoaded( true ); }); }; /* Event Entries -> Pratilipi List */ var cursor = null; var resultCount = 20; this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); this.isLoading = ko.observable( false ); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchPratilipiList = function() { if( self.isLoading() || ! self.hasMoreContents() ) return; self.isLoading( true ); dataAccessor.getPratilipiListByEventId( self.event.eventId(), cursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.isLoading( false ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.isLoading( false ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { if( self.event.eventId() == null ) return; self.fetchPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.eventIdListener = ko.computed( function() { if( self.event.eventId() == null ) return; setTimeout( function() { self.fetchPratilipiList(); }, 0); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.EVENT.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); self.eventIdListener.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.pratilipiList( [] ); self.hasMoreContents( true ); self.isLoading( false ); self.initialDataLoaded( false ); self.fetchEvent(); }, 0 ); }, this ); } , template: `<div data-bind="visible: ! initialDataLoaded()" class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mdl-card-border mobile-card"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div class="pratilipi-event-page" data-bind="visible: initialDataLoaded()" style="flex-grow: 1; width: 100%;"><div class="mdl-card mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card image-holder"><img data-bind="attr: { src: event.bannerImageUrl() }" /></div><div class="mdl-card mdl-card-border mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card description-holder"><div class="event-title-holder"><div data-bind="text: event.name()" class="material-heading"></div><a data-bind="{ visible: event.hasAccessToUpdate(), attr: { 'href': '/edit-event?id=' + event.eventId() } }"class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect mdl-button-margin small-button pull-right"><i class="material-icons material-icons-16">create</i></a></div><div data-bind="html: event.description()" class="material-subtitle-1"></div></div><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card event-entries"><div data-bind="visible: pratilipiList().length > 0"class="load-more-container mdl-card-border material-heading"style="margin-top: 0; border-top: none;">Event Entries</div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: ! isLoading(), click: fetchPratilipiList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><div data-bind="visible: isLoading()" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-card', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.author = params.author; this.followRequestOnFlight = ko.observable( false ); this.followOrUnfollowAuthor = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "FOLLOW" } ); return; } if( self.followRequestOnFlight() ) return; self.followRequestOnFlight( true ); var getFollowingMessage = function( following, name ) { var text = following ? "You are following $authorName." : "You have unfollowed $authorName."; return text.replace( "$authorName", name ); }; var switchState = function() { self.author.following( ! self.author.following() ); }; switchState(); ToastUtil.toast( getFollowingMessage( self.author.following(), self.author.name() ) ); dataAccessor.followOrUnfollowAuthor( self.author.authorId(), self.author.following(), function( userAuthor ) { self.followRequestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); }, function( error ) { self.followRequestOnFlight( false ); switchState(); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "Some error Occurred! Please try again!", 3000, true ); }); }; } , template: `<div class="pratilipi-author-card"><div class="author-image-holder"><a data-bind="attr: { href: author.pageUrl() }" onclick="ga_CA( 'Author', 'Open' );"><img class="cover-image" data-bind="attr: { src: getImageUrl( author.profileImageUrl(), 80 ), alt: author.name() }" /></a></div><a class="author-name" data-bind="text: author.name(), attr: { href: author.pageUrl() }" onclick="ga_CA( 'Author', 'Open' );"></a><div class="follow-button-holder"><button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored mdl-js-ripple-effect"data-bind="{ text: author.following() ? 'Following' : 'Follow',click: followOrUnfollowAuthor,disable: author.following(),style: { 'visibility': author.authorId() != appViewModel.user.author.authorId() ? 'visible' : 'hidden' } }"></button></div></div>` }); </script> <script> ko.components.register( 'pratilipi-reader', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); var defaultPratilipi = { "pratilipiId": null, "title": null, "titleEn": null, "language": null, "author": { "authorId": null,"name": null, "pageUrl": null }, "summary": null, "pageUrl": null, "coverImageUrl": null, "readPageUrl": null, "writePageUrl": null, "type": null, "contentType": null, "oldContent": false, "index": null, "pageCount": null, "state": null, "listingDateMillis": null, "wordCount": null, "reviewCount": null, "ratingCount": null, "averageRating": null, "readCount": null, "fbLikeShareCount": null, "hasAccessToUpdate": false }; var defaultUserPratilipi = { "userPratilipiId": null, "userId": null, "pratilipiId": null, "userName": null, "userImageUrl": null, "userProfilePageUrl": null, "rating": 0, "review": null, "reviewState": null, "addedToLib": false, "hasAccessToReview": true, "isLiked": false, }; this.updatePratilipi = function( pratilipi, initialiseObject ) { var updatedPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultPratilipi : pratilipi ) ); if( initialiseObject && pratilipi != null ) { if( pratilipi.summary != null && pratilipi.summary.trim() == "" ) pratilipi.summary = null; for( var key in pratilipi ) if( pratilipi.hasOwnProperty( key ) ) updatedPratilipi[ key ] = pratilipi[ key ]; if( pratilipi.author != null ) { for( var key in pratilipi.author ) if( pratilipi.author.hasOwnProperty( key ) ) updatedPratilipi.author[ key ] = pratilipi.author[ key ]; } } ko.mapping.fromJS( updatedPratilipi, {}, self.pratilipi ); MetaTagUtil.setMetaTagsForPratilipi( ko.mapping.toJS( self.pratilipi ) ); }; this.updateUserPratilipi = function( userPratilipi, initialiseObject ) { var updatedUserPratilipi = JSON.parse( JSON.stringify( initialiseObject ? defaultUserPratilipi : userPratilipi ) ); if( initialiseObject && userPratilipi != null ) { if( userPratilipi.rating == null ) userPratilipi.rating = 0; if( userPratilipi.review != null && userPratilipi.review.trim() == "" ) userPratilipi.review = null; if( userPratilipi.reviewState != null && userPratilipi.reviewState != "PUBLISHED" ) userPratilipi.review = null; for( var key in userPratilipi ) if( userPratilipi.hasOwnProperty( key ) ) updatedUserPratilipi[ key ] = userPratilipi[ key ]; } ko.mapping.fromJS( updatedUserPratilipi, {}, self.userPratilipi ); }; this.setChapterNo = function( chapterNo ) { /* Backward Compatibility */ chapterNo = parseInt( chapterNo ); if( chapterNo < 1 || chapterNo > self.chapterCount() ) return; self.chapterNo( chapterNo ); if( self.scrollTop() > 100 ) { self.scrollToTop( 0 ); } setCookie( "reader_page_number_" + self.pratilipi.pratilipiId(), chapterNo, 30, "/read" ); }; /* Font Sizes */ var defaultFontSize = 18; this.minFontSize = 12; this.maxFontSize = 32; /* Image Size */ this.minImageSize = 300; this.maxImageSize = 1500; this.getFontSize = function() { if( getCookie( "fontSize" ) != null ) return parseInt( getCookie( "fontSize" ) ); return defaultFontSize; }; this.setFontSize = function( fontSize ) { fontSize = parseInt( fontSize ); if( fontSize > self.maxFontSize || fontSize < self.minFontSize ) return; appViewModel.readerFontSize( fontSize ); setTimeout( function() { setCookie( "fontSize", fontSize, 30, "/read" ) }, 0 ); }; this.getImageSize = function() { if( getCookie( "imageSize" ) != null ) return parseInt( getCookie( "imageSize" ) ); return -1; /* -1 for undetermined */ }; this.setImageSize = function( imageSize ) { imageSize = parseInt( imageSize ); if( imageSize > self.maxImageSize || imageSize < self.minImageSize ) return; appViewModel.readerImageSize( imageSize ); setTimeout( function() { setCookie( "imageSize", imageSize, 30, "/read" ) }, 0 ); }; this.getTheme = function() { /* Backward Compatibility */ if( getCookie( "PREFERRED_READING_MODE" ) == "NIGHT_MODE" ) return "NIGHT"; if( getCookie( "PREFERRED_READING_MODE" ) == "SEPIA_MODE" ) return "SEPIA"; return "NORMAL"; }; this.setTheme = function( theme ) { /* Backward Compatibility */ appViewModel.readerTheme( theme ); var mode = "NORMAL_MODE"; if( theme == "NIGHT" ) mode = "NIGHT_MODE"; if( theme == "SEPIA" ) mode = "SEPIA_MODE"; setTimeout( function() { setCookie( "PREFERRED_READING_MODE", mode, 30, "/read" ) }, 0 ); }; this.getLineHeight = function() { if( getCookie( "lineHeight" ) != null ) return getCookie( "lineHeight" ); return "MEDIUM"; }; this.setLineHeight = function( lineHeight ) { appViewModel.readerLineHeight( lineHeight ); setTimeout( function() { setCookie( "lineHeight", lineHeight, 30, "/read" ) }, 0 ); }; /* Variables */ this.dataLoadedState = ko.observable(); /* 3 Possible states: LOADING, LOADED and FAILED */ this.pratilipi = ko.mapping.fromJS( defaultPratilipi, {}, self.pratilipi ); this.userPratilipi = ko.mapping.fromJS( defaultUserPratilipi, {}, self.userPratilipi ); this.libraryRequestOnFlight = ko.observable( false ); this.chapterNo = ko.observable(); this.chapterCount = ko.observable(); this.index = ko.observableArray(); this.initialiseReader = function() { /* Setting up Reader */ if( appViewModel.readerFontSize() == null ) appViewModel.readerFontSize( self.getFontSize() ); if( appViewModel.readerImageSize() == null ) appViewModel.readerImageSize( self.getImageSize() ); if( appViewModel.readerTheme() == null ) appViewModel.readerTheme( self.getTheme() ); if( appViewModel.readerLineHeight() == null ) appViewModel.readerLineHeight( self.getLineHeight() ); /* Api call */ self.dataLoadedState( "LOADING" ); dataAccessor.getPratilipiAndIndex( getUrlParameter( "id" ), function( pratilipi, userPratilipi, indexResponse ) { if( pratilipi == null || indexResponse == null ) { /* No / Wrong / Drafted / Deleted pratilipiId */ self.dataLoadedState( "FAILED" ); return; } /* Updating properties */ self.updatePratilipi( pratilipi, true ); self.updateUserPratilipi( userPratilipi, true ); /* Setting index and chapterCount */ /* Two different versions of contents */ var index = []; if( pratilipi.oldContent ) { if( pratilipi.index != null ) { index = JSON.parse( pratilipi.index ); for( var i = 0; i < index.length; i++ ) { if( index[i].title == null ) index[i].title = "Chapter " + index[i].chapterNo; index[i].chapterNo = index[i].pageNo; } } self.chapterCount( pratilipi.pageCount > 0 ? pratilipi.pageCount : 1 ); } else { index = indexResponse.index; for( var i = 0; i < index.length; i++ ) if( index[i].title == null ) index[i].title = "Chapter " + index[i].chapterNo; self.chapterCount( index != null && index.length > 0 ? index.length : 1 ); } self.index( index ); /* set chapterNo */ var chapterNo = 1; if( getUrlParameter( "chapterNo" ) != null ) chapterNo = parseInt( getUrlParameter( "chapterNo" ) ); if( getCookie( "reader_page_number_" + pratilipi.pratilipiId ) != null ) chapterNo = parseInt( getCookie( "reader_page_number_" + pratilipi.pratilipiId ) ); if( chapterNo < 1 ) chapterNo = 1; if( chapterNo > self.chapterCount() ) chapterNo = self.chapterCount(); self.setChapterNo( chapterNo ); self.dataLoadedState( "LOADED" ); }); }; this.openSettings = function() { $( "#pratilipi-reader-settings" ).modal(); }; this.openNavigationModal = function() { if( !( typeof( componentHandler ) == 'undefined' ) ) { componentHandler.upgradeAllRegistered(); } document.querySelector( '.mdl-layout' ).MaterialLayout.toggleDrawer(); }; this.switchLibraryState = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( { "id": self.pratilipi.pratilipiId() }, { "message": "LIBRARY" } ); return; } if( self.libraryRequestOnFlight() ) return; self.libraryRequestOnFlight( true ); var getAddedToLibMessage = function( addedToLib ) { var text = addedToLib ? "You have added $pratilipiTitle to your library." : "You have removed $pratilipiTitle from your library."; var title = self.pratilipi.title().substring( 0, 10 ) + ( self.pratilipi.title().length > 10 ? "..." : "" ); return text.replace( "$pratilipiTitle", title ); }; var addedToLib = ! self.userPratilipi.addedToLib(); if( addedToLib ) /* Toast only for remove action */ ToastUtil.toast( getAddedToLibMessage( addedToLib ), 3000 ); else ToastUtil.toastCallBack( getAddedToLibMessage( addedToLib ), 4000, "UNDO", self.switchLibraryState ); self.updateUserPratilipi( { "addedToLib": addedToLib } ); dataAccessor.addOrRemoveFromLibrary( self.pratilipi.pratilipiId(), addedToLib, function( userPratilipi ) { self.libraryRequestOnFlight( false ); }, function( error ) { self.libraryRequestOnFlight( false ); self.updateUserPratilipi( { "addedToLib": ! addedToLib } ); var message = "Some error Occurred! Please try again!"; if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }; this.sharePratilipi = function() { ShareUtil.sharePratilipi( ko.mapping.toJS( self.pratilipi ) ); }; /* Settings */ this.increaseFontSize = function() { self.setFontSize( appViewModel.readerFontSize() + 2 ); }; this.decreaseFontSize = function() { self.setFontSize( appViewModel.readerFontSize() - 2 ); }; this.increaseImageSize = function() { self.setImageSize( appViewModel.readerImageSize() + 50 ); }; this.decreaseImageSize = function() { self.setImageSize( appViewModel.readerImageSize() - 50 ); }; this.setNormalTheme = function() { self.setTheme( "NORMAL" );}; this.setNightTheme = function() { self.setTheme( "NIGHT" ); }; this.setSepiaTheme = function() { self.setTheme( "SEPIA" ); }; this.setSmallLineHeight = function() { self.setLineHeight( "SMALL" ) }; this.setMediumLineHeight = function() { self.setLineHeight( "MEDIUM" ) }; this.setLargeLineHeight = function() { self.setLineHeight( "LARGE" ) }; /* Report Content */ var reportContentModal = $( "#pratilipi-reader-report-content" ); this.reportContentText = ko.observable( "" ); this.reportContentRequestOnFlight = ko.observable( false ); this.reportContent = function() { if( appViewModel.user.isGuest() ) { goToLoginPage( { "id": self.pratilipi.pratilipiId(), "action": "reportContent" } ); return; } reportContentModal.modal( 'show' ); }; this.submitReportContent = function() { if( self.reportContentRequestOnFlight() ) return; self.reportContentRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.reportContent( self.reportContentText(), function( success ) { self.reportContentRequestOnFlight( false ); ToastUtil.toast( "Success!" ); self.closeReportContentModal(); }, function( error ) { self.reportContentRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); }); }; this.canReportContent = ko.computed( function() { return self.reportContentText().trim() != '' && ! self.reportContentRequestOnFlight(); }, this ); this.closeReportContentModal = function() { self.reportContentText( "" ); reportContentModal.modal( "hide" ); }; /* Clicking anywhere outside the screen */ reportContentModal.on( 'hidden.bs.modal', function(e) { self.closeReportContentModal(); }); /* Navigate on Reader */ this.keyupHandler = function( keyCode ) { /* Left => 37 ; Right => 39 */ if( keyCode == 37 ) self.setChapterNo( self.chapterNo() - 1 ); else if( keyCode == 39 ) self.setChapterNo( self.chapterNo() + 1 ); }; /* ProgressBar */ var progressBar = null; this.setProgressBar = function() { if( progressBar == null ) return; var documentHeight = $( ".js-body-layout-content .js-body-layout-content-grid" ).height() + 16; /* 16 => Padding of js-body-layout-content-grid */ var windowHeight = $(window).height() - 54; /* 54 => Hardcoded height of header + scrollbar */ var distanceToTop = self.scrollTop(); var percentScrolled = distanceToTop/(documentHeight - windowHeight) * 100; progressBar.setProgress( percentScrolled ); }; document.querySelector( '#reader-progress-bar' ).addEventListener( 'mdl-componentupgraded', function() { progressBar = this.MaterialProgress; progressBar.setProgress(0); }); /* ScrollTop Handlers */ this.scrollTop = ko.observable(); this.scrollToTop = function() { $( ".js-body-layout-content" ).animate({ scrollTop: 0 }, 200 ); }; this.notifyOfScrollEvent = function() { self.scrollTop( $( ".js-body-layout-content" ).scrollTop() ); }; this.scrollTopObserver = ko.computed( function() { self.scrollTop(); appViewModel.scrollTop( self.scrollTop() ); setTimeout( function() { self.setProgressBar(); }, 0 ); }, this ); /* Left and Right keys */ $(document).keyup( function(e) { self.keyupHandler( e.which ); }); this.userObserver = ko.computed( function() { if( ! appViewModel.user.isGuest() && getUrlParameter( 'action' ) == "reportContent" ) { self.reportContent(); } }, this ); this.locationObserver = ko.computed( function() { jQuery.fn.removeAttributes = function() { return this.each(function() { var attributes = $.map(this.attributes, function(item) { return item.name; }); var element = $(this); $.each(attributes, function(i, item) { element.removeAttr(item); }); }); }; if( appViewModel.currentView() != LOCATION.READER.ko_element ) { /* Dispose all observers */ $('body').removeAttributes(); self.scrollTopObserver.dispose(); self.userObserver.dispose(); self.locationObserver.dispose(); self.canReportContent.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.initialiseReader(); }, 0 ); }, this ); $( document ).ready( function() { $( document ).on( "contextmenu",function() { return false; }); $( document ).mousedown( function(e) { if( e.button == 2 ) return false; else return true; }); }); $(document).keyup(function(e){ if(e.keyCode == 44) return false; }); document.onkeydown = function(e) { var isCtrl = false; if(e.which == 17) isCtrl = true; if(( ( e.which == 67 ) || ( e.which == 80 ) ) && isCtrl == true) return false; }; function clickIE4(){ if (event.button==2){ return false; } } function clickNS4(e){ if (document.layers||document.getElementById&&!document.all){ if (e.which==2||e.which==3){ return false; } } } if (document.layers){ document.captureEvents(Event.MOUSEDOWN); document.onmousedown=clickNS4; } else if (document.all&&!document.getElementById){ document.onmousedown=clickIE4; } document.oncontextmenu=new Function( "return false" ); $('body').attr('ondragstart', 'return false'); $('body').attr('onselectstart', 'return false'); $('body').attr('onContextMenu', 'return false'); $('body').attr('onkeydown', 'if ((arguments[0] || window.event).ctrlKey) return false'); } , template: `<div data-bind="visible: dataLoadedState() == 'LOADING'" class="loading-state-reader"><!-- ko component: "pratilipi-loading-state" --><!-- /ko --></div><div data-bind="visible: dataLoadedState() == 'FAILED'" class="failed-state-reader"><div class="content"><div style="width: 180px; height: 200px; margin: auto;" class="page-not-found-icon"></div><div>Oops! This content is not available!</div><br/><a style="margin-left: -48px;" class="material-subtitle-1" href="/"><i class="material-icons">home</i><span style="position: absolute;">Home</span></a></div></div><div class="mdl-layout mdl-js-layout pratilipi-reader"data-bind="{ visible: dataLoadedState() == 'LOADED',css: { 'th-nor': appViewModel.readerTheme() == 'NORMAL', 'th-ngt': appViewModel.readerTheme() == 'NIGHT', 'th-sep': appViewModel.readerTheme() == 'SEPIA' } }"><!-- ko component: {name: "pratilipi-reader-header",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,openSettings: $data.openSettings,switchLibraryState: $data.switchLibraryState,sharePratilipi: $data.sharePratilipi,reportContent: $data.reportContent,openNavigationModal: $data.openNavigationModal,index: index,chapterNo: chapterNo,setChapterNo: $data.setChapterNo }} --><!-- /ko --><div id="reader-progress-bar" class="mdl-progress mdl-js-progress"></div><main class="mdl-layout__content"><div class="body-layout-row"><div class="body-layout-nav" data-bind="style: { visibility: chapterCount() == 1 ? 'hidden' : 'visible' }"><!-- ko component: {name: "pratilipi-reader-navigation",params: { pratilipi: pratilipi,index: index,chapterNo: chapterNo,setChapterNo: $data.setChapterNo }} --><!-- /ko --></div><div class="body-layout-content js-body-layout-content" data-bind="event: { scroll: notifyOfScrollEvent }"><div class="mdl-grid mobile-grid js-body-layout-content-grid"style="flex-grow: 1;"><div class="mdl-cell mdl-cell--12-col-tablet mdl-cell--9-col mobile-card" style="margin: 0;"><!-- ko component: {name: "pratilipi-reader-content",params: { pratilipi: pratilipi,updatePratilipi: $data.updatePratilipi,userPratilipi: userPratilipi,updateUserPratilipi: $data.updateUserPratilipi,chapterNo: chapterNo,chapterCount: chapterCount,fontSize: appViewModel.readerFontSize,imageSize: appViewModel.readerImageSize,lineHeight: appViewModel.readerLineHeight,setImageSize: $data.setImageSize,setChapterNo: $data.setChapterNo }} --><!-- /ko --></div></div></div></div></main><!-- ko component: {name: "pratilipi-reader-footer",params: { pratilipi: pratilipi,userPratilipi: userPratilipi,openSettings: $data.openSettings,switchLibraryState: $data.switchLibraryState,sharePratilipi: $data.sharePratilipi,canOpenNavigationModal: index().length > 0,openNavigationModal: $data.openNavigationModal }} --><!-- /ko --></div><!-- Settings Modal --><div class="modal common-modal fade settings-modal" id="pratilipi-reader-settings" tabindex="-1" role="dialog" aria-labelledby="pratilipi-reader-settings"><div class="modal-dialog modal-sm" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button></div><div class="modal-body"><div class="option" data-bind="visible: pratilipi.contentType() == 'PRATILIPI'"><div class="option-heading material-subtitle-1">Font Size</div><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'IncreaseFontSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerFontSize() == maxFontSize, click: increaseFontSize"><i class="material-icons">add</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'DecreaseFontSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerFontSize() == minFontSize, click: decreaseFontSize"><i class="material-icons">remove</i></button></div><div class="option" data-bind="visible: pratilipi.contentType() == 'IMAGE'"><div class="option-heading material-subtitle-1">Image Size</div><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'IncreaseImageSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerImageSize() >= maxImageSize, click: increaseImageSize"><i class="material-icons">add</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'DecreaseImageSize', 'ReaderSettings' );"data-bind="disable: appViewModel.readerImageSize() <= minImageSize, click: decreaseImageSize"><i class="material-icons">remove</i></button></div><div class="option"><div class="option-heading material-subtitle-1">Background</div><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'WhiteBkg', 'ReaderSettings' );"data-bind="click: setNormalTheme, enable: appViewModel.readerTheme() != 'NORMAL'"><i class="material-icons th-nor-config">check_box_outline_blank</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'BlackBkg', 'ReaderSettings' );"data-bind="click: setNightTheme, enable: appViewModel.readerTheme() != 'NIGHT'"><i class="material-icons th-ngt-config">check_box_outline_blank</i></button><button class="mdl-button mdl-js-button mdl-button--icon"onclick="ga_CAL( 'Pratilipi', 'SepiaBkg', 'ReaderSettings' );"data-bind="click: setSepiaTheme, enable: appViewModel.readerTheme() != 'SEPIA'"><i class="material-icons th-sep-config">check_box_outline_blank</i></button></div><div class="option" data-bind="visible: pratilipi.contentType() == 'PRATILIPI'"><div class="option-heading material-subtitle-1">Line Spacing</div><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: setSmallLineHeight, enable: appViewModel.readerLineHeight() != 'SMALL'"><span class="lh-icon lh-sm-icon"onclick="ga_CAL( 'Pratilipi', 'MinLineSpacing', 'ReaderSettings' );"data-bind="css: { 'lh-icon-inactive': appViewModel.readerLineHeight() == 'SMALL' }"></span></button><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: setMediumLineHeight, enable: appViewModel.readerLineHeight() != 'MEDIUM'"><span class="lh-icon lh-md-icon"onclick="ga_CAL( 'Pratilipi', 'BasicLineSpacing', 'ReaderSettings' );"data-bind="css: { 'lh-icon-inactive': appViewModel.readerLineHeight() == 'MEDIUM' }"></span></button><button class="mdl-button mdl-js-button mdl-button--icon" data-bind="click: setLargeLineHeight, enable: appViewModel.readerLineHeight() != 'LARGE'"><span class="lh-icon lh-lg-icon"onclick="ga_CAL( 'Pratilipi', 'MaxLineSpacing', 'ReaderSettings' );"data-bind="css: { 'lh-icon-inactive': appViewModel.readerLineHeight() == 'LARGE' }"></span></button></div></div></div></div></div><!-- Report Content Modal --><div class="modal common-modal fade" id="pratilipi-reader-report-content" tabindex="-1" role="dialog" aria-labelledby="pratilipi-reader-report-content"><div class="modal-dialog" role="document"><div class="modal-content" style="width: 90%;"><div class="modal-header"><span class="material-title">Report Content</span><button class="mdl-button mdl-js-button mdl-button--icon close" data-bind="click: closeReportContentModal"><i class="material-icons">close</i></button></div><div class="modal-body"><textarea data-bind="{ mdlFloatingInput: { label: 'Whats wrong with the content?', value: reportContentText, id: 'pratilipi_reader_report_content' }, valueUpdate: ['input'], transliterate: true }"></textarea></div><div class="modal-footer"><button data-bind="click: closeReportContentModal"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">Cancel</button><button data-bind="click: submitReportContent, enable: canReportContent"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">Submit Report</button></div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-recommendation-carousel', { viewModel: function( params ) { var self = this; var pratilipiId = params.pratilipiId; /* ko observable */ var context = params.context; var resultCount = 6; var dataAccessor = new DataAccessor(); this.title = ko.observable(); this.pratilipiList = ko.observableArray(); this.isLoading = ko.observable( false ); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { pratilipiList[i]["ga_index"] = i; self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); } }; this.fetchPratilipiList = function() { if( self.isLoading() ) return; self.isLoading( true ); /* var context = null; if( getLocation() == LOCATION.PRATILIPI ) context = "pratilipiPage"; else if( getLocation() == LOCATION.READ ) context = "readPage"; */ dataAccessor.getPratilipiRecommendation( pratilipiId(), context, resultCount, function( response ) { if( response == null ) { self.isLoading( false ); return; } self.title( response.title ); self.updatePratilipiList( response.pratilipiList ); self.isLoading( false ); }); }; this.pratilipiIdObserver = ko.computed( function() { if( pratilipiId() == null ) return; setTimeout( function() { self.title( null ); self.pratilipiList( [] ); self.isLoading( false ); self.fetchPratilipiList(); }, 0 ); }, this ); } , template: `<div data-bind="visible: isLoading()"style="margin: 25px auto;"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div><div class="mdl-grid" style="margin: 0;" data-bind="visible: ! isLoading()"><div class="mdl-cell mdl-cell--12-col material-title" data-bind="text: title()"></div><ul class="pratilipi-recommendation-carousel mdl-grid"data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"><li class="mdl-cell mdl-cell--2-col"data-bind="component: { name: 'pratilipi-pratilipi-card-mini',params: { pratilipi: pratilipi } }"></li></ul></div>` }); </script> <script> ko.components.register( 'pratilipi-see-more', { viewModel: function( params ) { var self = this; /* Pass originalText as ko.observable() */ this.originalText = params.originalText; /* Booleans */ this.isViewMoreVisible = ko.observable( false ); this.isViewMoreShown = ko.observable( true ); this.maxHeightPx = ko.observable( "initial" ); this.toggleViewMore = function( vm, e ) { self.isViewMoreShown( ! self.isViewMoreShown() ); if( self.isViewMoreShown() ) { var pos = e.currentTarget.parentElement.parentElement.offsetTop; /* Not adding header padding */ appViewModel.scrollToTop( pos ); } }; } , template: `<div data-bind="seeMore: true"><p data-bind="style: { 'max-height': isViewMoreShown() ? maxHeightPx() : 'initial' }"style="white-space:pre-wrap; min-width: 100%; overflow: hidden; position: relative;"class="material-subtitle-1"></p><div class="text-center" data-bind="visible: isViewMoreVisible"><button data-bind="{ click: toggleViewMore,text: isViewMoreShown() ? 'show more' : 'show less' }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect"></button></div></div>` }); </script> <script> ko.components.register( 'pratilipi-library-page', { viewModel: function() { var self = this; var cursor = null; var resultCount = 20; var dataAccessor = new DataAccessor(); this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchUserLibraryList = function() { if( self.loadingState() == "LOADING" || ! self.hasMoreContents() ) return; self.loadingState( "LOADING" ); dataAccessor.getUserLibraryList( cursor, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingState( "FAILED" ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.loadingState( self.pratilipiList().length > 0 || pratilipiList.length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; this.userObserver = ko.computed( function() { if( appViewModel.user.isGuest() && appViewModel.user.userId() == 0 ) { goToLoginPage( null, { "message": "LIBRARY" } ); } }, this ); this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchUserLibraryList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.LIBRARY.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); self.userObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.fetchUserLibraryList(); }, 0 ); }, this ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div class="load-more-container mdl-card-border material-heading" style="margin-top: 0;">My Library</div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div data-bind="visible: pratilipi.addedToLib()"class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi, canRemoveFromLibrary: true, redirectToReaderOnClick: true }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border material-subtitle-1 text-center" data-bind="visible: loadingState() == 'LOADED_EMPTY'"><div style="width: 200px; height: 200px; margin: auto;" class="empty-library-icon"></div>You've not added any book to your library yet. Check out the most popular books on Pratilipi and read them offline!</div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: loadingState() != 'LOADING', click: fetchUserLibraryList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><div class="text-center" data-bind="visible: loadingState() == 'LOADING'"><span data-bind="visible: pratilipiList().length > 0" class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: pratilipiList().length == 0"></pratilipi-loading-state></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-contents', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.author = params.author; this.publishedPratilipiList = ko.observableArray(); this.draftedPratilipiList = ko.observableArray(); this.updatePublishedPratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { var pratilipi = pratilipiList[i]; pratilipi[ "author" ] = { "authorId": self.author.authorId(), "name": "" }; if (!pratilipi.hasOwnProperty('tags')) pratilipi["tags"] = null; if (!pratilipi.hasOwnProperty('suggestedTags')) pratilipi["suggestedTags"] = null; self.publishedPratilipiList.push( ko.mapping.fromJS( pratilipi ) ); } }; this.updateDraftedPratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) { var pratilipi = pratilipiList[i]; if( pratilipi[ "title" ] == null ) pratilipi[ "title" ] = " "; if( pratilipi[ "pageUrl" ] == null ) continue; /* Hack: Fix for Deleted entitites from backend */ pratilipi[ "author" ] = { "authorId": self.author.authorId(), "name": "" }; self.draftedPratilipiList.push( ko.mapping.fromJS( pratilipi ) ); } }; /* Load Drafted and Published Contents */ var publishedCursor = null; var draftedCursor = null; /* Loading state */ /* * 4 Possible values * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingStatePublished = ko.observable(); this.loadingStateDrafted = ko.observable(); this.hasMorePublishedContents = ko.observable( true ); this.hasMoreDraftedContents = ko.observable( true ); this._loadPublishedContents = function( resultCount ) { if( self.loadingStatePublished() == "LOADING" ) return; self.loadingStatePublished( "LOADING" ); dataAccessor.getPratilipiListByAuthor( self.author.authorId(), "PUBLISHED", publishedCursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingStatePublished( "FAILED" ); return; } var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePublishedPratilipiList( pratilipiList ); publishedCursor = pratilipiListResponse.cursor; self.loadingStatePublished( self.publishedPratilipiList().length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMorePublishedContents( pratilipiList.length == resultCount && publishedCursor != null ); }); }; this._loadDraftedContents = function( resultCount ) { if( self.loadingStateDrafted() == "LOADING" ) return; self.loadingStateDrafted( "LOADING" ); dataAccessor.getPratilipiListByAuthor( self.author.authorId(), "DRAFTED", draftedCursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingStateDrafted( "FAILED" ); return; } var pratilipiList = pratilipiListResponse.pratilipiList; self.updateDraftedPratilipiList( pratilipiList ); draftedCursor = pratilipiListResponse.cursor; self.loadingStateDrafted( self.draftedPratilipiList().length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMoreDraftedContents( pratilipiList.length == resultCount && draftedCursor != null ); }); }; /* Constants */ var initialPublishedResultCount = 6; var subsequentPublishedResultCount = 6; var initialDraftedResultCount = 5; var subsequentDraftedResultCount = 6; this.loadInitialPublishedContents = function() { self.publishedPratilipiList( [] ); publishedCursor = null; self.loadingStatePublished( null ); self.hasMorePublishedContents( true ); self._loadPublishedContents( initialPublishedResultCount ); }; this.loadMorePublishedContents = function() { self._loadPublishedContents( subsequentPublishedResultCount ); }; this.loadInitialDraftedContents = function() { self.draftedPratilipiList( [] ); draftedCursor = null; self.loadingStateDrafted( null ); self.hasMoreDraftedContents( true ); self._loadDraftedContents( initialDraftedResultCount ); }; this.loadMoreDraftedContents = function() { self._loadDraftedContents( subsequentDraftedResultCount ); }; /* Create new Draft */ this.createNewPratilipi = function() { if( isMobile() ) { ToastUtil.toast( "Please login to write content on desktop website!", 5000 ); return; } appViewModel.pratilipiWriteAuthorId( self.author.authorId() ); $( "#pratilipiWrite" ).modal(); }; /* Computed Observables */ this.authorIdObserver = ko.computed( function() { if( self.author.authorId() == null ) return; setTimeout( function() { if( self.author.hasAccessToUpdate() ) { self.loadInitialDraftedContents(); } self.loadInitialPublishedContents(); }, 0 ); }, this ); } , template: `<div class="pratilipi-author-contents"><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card" style=" margin-top: 0px;"><div class="author-drafted-contents" data-bind="visible: author.hasAccessToUpdate()"><div class="load-more-container mdl-card-border material-title" style="padding: 14px 8px; background-color: #fff;">Drafts</div><div data-bind="visible: draftedPratilipiList().length > 0 || loadingStateDrafted() == 'LOADED_EMPTY'"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div data-bind="visible: loadingStateDrafted() != 'LOADING' || draftedPratilipiList().length != 0"class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- Add New Content Card --><a class="pratilipi-pratilipi-card mdl-card clickable-element create-pratilipi" data-bind="click: createNewPratilipi"><span class="create-pratilipi-icon-holder"><i class="material-icons">note_add</i></span><span class="create-pratilipi-text-holder"><span class="font-m">Add New Content</span></span></a></div><!-- ko foreach: { data: draftedPratilipiList, as: 'pratilipi' } --><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card drafted-card"><a onclick="ga_CA( 'Pratilipi', 'OpenDraft' )"class="pratilipi-pratilipi-card mdl-card" data-bind="attr: { href: pratilipi.pageUrl() }"><span class="pratilipi-cover-image-holder"><img data-bind="attr: { src: getImageUrl( pratilipi.coverImageUrl(), 32 ), title: pratilipi.title(), alt: pratilipi.title() }" /></span><span class="pratilipi-meta-holder"><span class="pratilipi-title mdl-card__title"><span class="font-m" data-bind="text: pratilipi.title()"></span></span></span></a></div><!--/ko--></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreDraftedContents()"><button onclick="ga_CA( 'Pratilipi', 'LoadMoreDrafts' )"data-bind="{ visible: loadingStateDrafted() != 'LOADING', click: loadMoreDraftedContents }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><div data-bind="visible: loadingStateDrafted() == 'LOADING'" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div><div class="author-published-contents js-author-published-contents" data-bind="css: { 'margin-top--1': !author.hasAccessToUpdate() }"><div class="load-more-container mdl-card-border material-title"style="padding: 14px 8px; background-color: #fff;"data-bind="visible: author.hasAccessToUpdate()">Published Works</div><div data-bind="foreach: { data: publishedPratilipiList, as: 'pratilipi' }, visible: publishedPratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi, showCategoryButton: true }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMorePublishedContents()"><button onclick="ga_CA( 'Pratilipi', 'LoadMore' )"data-bind="{ visible: loadingStatePublished() != 'LOADING', click: loadMorePublishedContents }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><div data-bind="visible: loadingStatePublished() == 'LOADING'" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div><div class="load-more-container mdl-card-border material-subtitle-1" data-bind="visible: loadingStatePublished() == 'LOADED_EMPTY'">Sorry! This Author doesn't have any books published!</div></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-home-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.bannerList = ko.observableArray(); this.sectionList = ko.observableArray(); this.fetchHomePageBanners = function() { dataAccessor.getHomePageBanners( function( response ) { if( response == null ) return; self.bannerList( response.bannerList ); $( '#carousel' ).carousel({ interval: 6000, pause: "hover" }).on( "touchstart", function( event ) { var xClick = event.originalEvent.touches[0].pageX; $(this).one( "touchmove", function( event ) { var xMove = event.originalEvent.touches[0].pageX; if( Math.floor( xClick - xMove ) > 5 ) { $(this).carousel( 'next' ); $(this).carousel( 'pause' ); } else if( Math.floor( xClick - xMove ) < -5 ) { $(this).carousel( 'prev' ); $(this).carousel( 'pause' ); } }); $(this).on( "touchend", function() { $(this).off( "touchmove" ); }); }); }); }; this.fetchHomePageSections = function() { dataAccessor.getHomePageSections( function( response ) { var newPratilipiList = function( pList ) { var pratilipiList = ko.observableArray(); for( var i = 0; i < pList.length; i++ ) pratilipiList.push( ko.mapping.fromJS( pList[i] ) ); return pratilipiList; }; var sectionList = response.sections; for( var i = 0; i < sectionList.length; i++ ) { var section = sectionList[i]; section.pratilipiList = newPratilipiList( section.pratilipiList ); self.sectionList.push( section ); } }); }; this.initialDataLoaded = ko.computed( function() { return self.bannerList().length > 0 || self.sectionList().length > 0; }, this ); this.dataLoaded = ko.computed( function() { return self.bannerList().length > 0 && self.sectionList().length > 0; }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.HOME.ko_element ) { self.locationObserver.dispose(); self.dataLoaded.dispose(); return; } setTimeout( function() { if( getUrlParameter( "email" ) != null && getUrlParameter( "token" ) != null ) { if( getUrlParameter( "passwordReset" ) == "true" ) redirect( "/reset-password?e=" + getUrlParameter( "email" ) + "&t=" + getUrlParameter( "token" ) ); else if( getUrlParameter( "verifyUser" ) == "true" ) redirect( "/verify-user?e=" + getUrlParameter( "email" ) + "&t=" + getUrlParameter( "token" ) ); } self.fetchHomePageBanners(); self.fetchHomePageSections(); }, 0 ); }, this ); } , template: `<!-- ko component: "pratilipi-author-leaderboard" --><!-- /ko --><!-- ko if: bannerList().length > 0 --><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><div id="carousel" class="carousel slide" data-ride="carousel"><ol data-bind="foreach: bannerList" class="carousel-indicators"><li data-target="#carousel"data-bind="attr: { 'data-slide-to': $index }, css: { 'active': $index() == 0 }"></li></ol><div class="carousel-inner" data-bind="foreach: bannerList"><div class="item" data-bind="css: { 'active': $index() == 0 }"><a data-bind="attr: { 'href': $data.actionUrl }"><img style="width: 100%; height: 100%;" data-bind="attr: { 'src': $data.imageUrl, 'alt': $data.title }" /></a></div></div></div></div><!-- /ko --><div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card section-list"data-bind="foreach: sectionList, as: section"><div class="section-container"><div class="section-title mdl-card-border mobile-card"><a style="color: #000;" class="material-heading" data-bind="attr: { 'href': listPageUrl }, text: title"></a></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }" class="mdl-grid pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="section-title view-more-holder material-subtitle-1 mdl-card-border mobile-card" style="margin-top: -1px;"><a class="material-subheading-1" style="opacity: 0.8;" data-bind="attr: { 'href': listPageUrl }">View More...<i class="material-icons pull-right mdl-layout--small-screen-only">navigate_next</i></a><a data-bind="attr: { 'href': listPageUrl }"><i class="material-icons pull-right mdl-layout--large-screen-only">navigate_next</i></a></div></div></div><div data-bind="visible: ! dataLoaded(), css: { 'mdl-card-border': ! initialDataLoaded() }"class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card"><span data-bind="visible: initialDataLoaded()" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: ! initialDataLoaded()"></pratilipi-loading-state></div>` }); </script> <script> ko.components.register( 'pratilipi-reset-password-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.newPassword = ko.observable(); this.confirmPassword = ko.observable(); this.requestOnFlight = ko.observable( false ); this.resetPassword = function() { if( self.newPassword() != this.confirmPassword() ) { ToastUtil.toast( "Passwords doesn't match!" ); return; } self.requestOnFlight( true ); dataAccessor.resetUserPassword( getUrlParameter( "e" ), getUrlParameter( "t" ), self.newPassword(), function( user ) { ToastUtil.toastUp( "Success!" ); setTimeout( function() { window.location.href = "/"; }, 4000 ); }, function( error ) { var message = "Some error Occurred! Please try again!"; if( error.email != null ) message = error.email; if( error.message != null ) message = error.message; ToastUtil.toast( message, 4000 ); self.requestOnFlight( false ); }); }; this.resetPasswordButtonEnabled = ko.computed( function() { return self.newPassword() != null && self.newPassword().trim() != "" && self.confirmPassword() != null && self.confirmPassword().trim() != "" && ! self.requestOnFlight(); }, this ); } , template: `<div class="pratilipi-login-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">Reset Password</div><form id="reset_password_form" class="pratilipi-content-container margin-zero"><input type="password" data-bind="mdlFloatingInput: { label: 'New Password', value: newPassword, id: 'pratilipi_reset_password_page_user_new_password' }, valueUpdate: ['input']" /><input type="password" data-bind="mdlFloatingInput: { label: 'Confirm Password', value: confirmPassword, id: 'pratilipi_reset_password_page_user_confirm_password' }, valueUpdate: ['input']" /><button data-bind="{ click: resetPassword, enable: resetPasswordButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">Update</button></form></div></div>` }); </script> <script> ko.components.register( 'pratilipi-review', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.review = params.review; this.isLiked = ko.observable( self.review.isLiked ? self.review.isLiked() : false ); this.likeCount = ko.observable( self.review.likeCount ? self.review.likeCount() : 0 ); this.totalCommentCount = ko.observable( self.review.commentCount ? self.review.commentCount() : 0 ); /* Like / Dislike Review */ this.voteRequestOnFlight = ko.observable( false ); this.likeOrDislikeReview = function() { if( appViewModel.user.isGuest() ) { goToLoginPage(); return; } if( self.voteRequestOnFlight() ) return; self.voteRequestOnFlight( true ); var toggleIsLiked = function() { self.likeCount( self.isLiked() ? self.likeCount() - 1 : self.likeCount() + 1 ); self.isLiked( ! self.isLiked() ); }; toggleIsLiked(); dataAccessor.likeOrDislikeReview( self.review.userPratilipiId(), self.isLiked(), function( vote ) { self.voteRequestOnFlight( false ); ga_CA( 'Review', vote.isLiked ? 'Review Like' : 'Review UnLike' ); }, function( error ) { toggleIsLiked(); self.voteRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); }); }; /* CommentList */ this.commentList = ko.observableArray(); this.addToCommentsList = function( comment ) { self.commentList.push( ko.mapping.fromJS( comment ) ); }; this.updateCommentList = function( commentList ) { for( var i = 0; i < commentList.length; i++ ) self.commentList.push( ko.mapping.fromJS( commentList[i] ) ); }; var cursor = null; this.isCommentsLoading = ko.observable(); this.hasMoreContents = ko.observable( false ); /* Constants */ var firstLoadCommentCount = 5; var subsequentLoadCommentCount = 10; this._fetchCommentList = function( resultCount ) { if( self.isCommentsLoading() ) return; self.isCommentsLoading( true ); dataAccessor.getReviewCommentList( self.review.userPratilipiId(), cursor, resultCount, function( commentListResponse ) { if( commentListResponse == null ) { self.hasMoreContents( true ); self.isCommentsLoading( false ); return; } var commentList = commentListResponse.commentList; cursor = commentListResponse.cursor; self.updateCommentList( commentList ); self.isCommentsLoading( false ); self.hasMoreContents( resultCount == commentList.length ); setTimeout( function() { componentHandler.upgradeDom(); }, 0 ); }); }; this.loadMoreComments = function() { self._fetchCommentList( subsequentLoadCommentCount ); }; /* Show / Hide Comments */ this.commentSectionVisible = ko.observable( false ); this.showCommentSection = function() { self.commentSectionVisible( true ); if( self.commentList().length == 0 && self.totalCommentCount() > 0 ) self._fetchCommentList( firstLoadCommentCount ); }; this.hideCommentSection = function() { self.commentSectionVisible( false ); }; this.toggleCommentSection = function() { self.commentSectionVisible() ? self.hideCommentSection() : self.showCommentSection(); }; /* Comment Input */ this.addCommentInput = ko.observable(); this.addCommentInputVisible = ko.observable( false ); this.openAddCommentInput = function() { if( appViewModel.user.isGuest() ) { goToLoginPage(); return; } self.addCommentInput( null ); self.showCommentSection(); self.addCommentInputVisible( true ); }; this.closeAddCommentInput = function() { self.addCommentInputVisible( false ); }; this.toggleAddCommentInput = function() { self.addCommentInputVisible() ? self.closeAddCommentInput() : self.openAddCommentInput(); }; /* Add Comment */ this.addCommentRequestOnFlight = ko.observable( false ); this.submitAddComment = function() { if( self.addCommentRequestOnFlight() ) return; self.addCommentRequestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.createOrUpdateReviewComment( self.review.userPratilipiId(), null, self.addCommentInput(), function( comment ) { self.addToCommentsList( comment ); self.closeAddCommentInput(); self.addCommentRequestOnFlight( false ); ToastUtil.toast( "Success!" ); }, function( error ) { self.addCommentRequestOnFlight( false ); ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); }); }; /* Delete Comment */ this.deleteComment = function( viewModel ) { var commentId = viewModel.comment.commentId(); ToastUtil.toastUp( "Working ..." ); dataAccessor.deleteComment( commentId, function( comment ) { ToastUtil.toast( "Success!" ); /* Hack remove delete modal forcibly */ $( '.modal' ).modal( 'hide' ); $( 'body' ).removeClass( 'modal-open' ); $( '.modal-backdrop' ).remove(); self.commentList.remove( function( item ) { return item.commentId() == comment.commentId; }); self.totalCommentCount( self.totalCommentCount() - 1 ) }, function( error ) { ToastUtil.toast( error.message != null ? error.message : "Some error Occurred! Please try again!" ); }); }; /* Computed observables */ this.canSubmitAddComment = ko.computed( function() { return self.addCommentInputVisible() && self.addCommentInput() != null && self.addCommentInput().trim() != "" && ! self.addCommentRequestOnFlight(); }, this ); } , template: `<div class="pratilipi-review"><div class="review-holder"><div class="review-header"><div class="user-info"><img data-bind="attr: { src: getImageUrl( review.userImageUrl(), 48 ) }" class="mdl-list__item-avatar"><div style="padding: 0 8px;"><a class="reviewer-name material-subtitle-1" data-bind="attr: { href: review.userProfilePageUrl() }, text: review.user.displayName()"></a><br/><span class="font-xs review-date" data-bind="text: convertDate( review.reviewDateMillis() )"></span></div></div><span class="user-rating"><pratilipi-rating class="pratilipi-red" params="rating: review.rating"></pratilipi-rating></span></div><div class="review-container material-subtitle-1" data-bind="text: review.review()"></div><div class="review-footer"><span class="like-holder"><span class="font-s" data-bind="visible: likeCount() > 0, text: likeCount()"></span><button data-bind="click: likeOrDislikeReview, disable: voteRequestOnFlight" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16" data-bind="css: { 'mdl-color-text--primary': isLiked() }">thumb_up</i></button></span><span class="separator"></span><span class="comment-holder"><span class="font-s" data-bind="visible: totalCommentCount() > 0, text: totalCommentCount()"></span><button onclick="ga_CA( 'Review', 'Add Comment' )"data-bind="click: toggleAddCommentInput"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"><i class="material-icons material-icons-16">message</i></button></span><span class="separator" data-bind="visible: totalCommentCount() > 0"></span><span class="view-comments-holder"><span class="font-s clickable-element"data-bind="visible: totalCommentCount() > 0,click: toggleCommentSection,text: commentSectionVisible() ? 'Hide Comments' : 'See All Reviews'"></span></span></div></div><div class="pratilipi-comment-list" data-bind="visible: commentSectionVisible()"><ul class="mdl-list comment-list-ul"><!-- ko foreach: commentList --><li data-bind="component: {name: 'pratilipi-review-comment',params: { comment: $data, deleteComment: $parent.deleteComment, toggleCommentInput: $parent.toggleAddCommentInput } }"class="mdl-list__item display-block"></li><!-- /ko --><li data-bind="visible: isCommentsLoading()" class="mdl-list__item left-padding display-block-unimportant text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></li><li data-bind="visible: addCommentInputVisible()" class="mdl-list__item left-padding display-block-unimportant"><div class="user-info"><img data-bind="attr: { src: getImageUrl( appViewModel.user.profileImageUrl(), 48 ) }" class="mdl-list__item-avatar"><div style="padding: 0 8px;"><a class="reviewer-name material-subtitle-1" data-bind="attr: { href: appViewModel.user.profilePageUrl() }, text: appViewModel.user.displayName()"></a><br/><span class="font-xs review-date" data-bind="text: convertDate( new Date() )"></span></div></div><textarea data-bind="{ mdlFloatingInput: { label: 'Type here to reply',value: addCommentInput, id: 'pratilipi-comment-input-' + review.userPratilipiId() },valueUpdate: ['input'],transliterate: true }"></textarea><div style="height: 36px;"><div class="pull-right"><button onclick="ga_CA( 'Review', 'Cancel Comment' )"data-bind="click: closeAddCommentInput"class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button-margin">Cancel</button><button onclick="ga_CA( 'Review', 'Submit Comment' )"data-bind="enable: canSubmitAddComment, click: submitAddComment"class="mdl-button mdl-js-button mdl-button--colored mdl-js-ripple-effect mdl-button--raised">Submit</button></div></div></li><li class="show-more"data-bind="visible: ! isCommentsLoading() && hasMoreContents()"style="padding-left: 16px;"><button style="padding: 0;" data-bind="click: loadMoreComments" class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">show more</button></li></ul></div><div data-bind="visible: $index() != ( $parents[1].totalReviewCount() - 1 ) "><hr /></div></div>` }); </script> <script> ko.components.register( 'pratilipi-google-login', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = params.requestOnFlight; this.isRegister = params.isRegister; this.googleLogin = function() { if( self.requestOnFlight() ) return; var GoogleAuth = gapi.auth2.getAuthInstance(); GoogleAuth.signIn().then( function( googleUser ) { self.requestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.loginGoogleUser( googleUser.getAuthResponse().id_token, function( user ) { ToastUtil.toast( "Success !" ); window.location.href = self.isRegister ? user[ "profilePageUrl" ] : getRetUrl( true ); }, function( error ) { self.requestOnFlight( false ); var message = "Some error Occurred! Please try again!"; if( error[ "googleIdToken" ] != null ) message = error[ "googleIdToken" ]; else if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }, function( error ) { console.log( JSON.stringify( error, undefined, 2 ) ); self.requestOnFlight( false ); }); }; /* Initialise Google Client App */ var domId = "pratilipi-google-login"; if( document.getElementById( domId ) == null ) { var googleAuth2 = document.createElement( 'script' ); googleAuth2.setAttribute( "src", "https://apis.google.com/js/api:client.js" ); googleAuth2.setAttribute( "id", domId ); googleAuth2.onload = function() { gapi.load( 'auth2', function() { auth2 = gapi.auth2.init({ client_id: '659873510744-kfim969enh181h4gbctffrjg5j47tfuq.apps.googleusercontent.com', cookiepolicy: 'single_host_origin', }); }); }; document.body.appendChild( googleAuth2 ); } } , template: `<button onclick="ga_CA( 'Login', 'G-Login' )"data-bind="{ click: googleLogin, disable: requestOnFlight }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect pratilipi-white-button pratilipi-fb-blue-button login-button"><div class="sprites-icon login-sprite-icon-24 google-login-icon"></div>Sign In with Google</button>` }); </script> <script> ko.components.register( 'pratilipi-pratilipi-card-mini', { viewModel: function( params ) { var self = this; this.pratilipi = params.pratilipi; this.openPratilipi = function( vm ) { if( this.pratilipi.meta.recommendationType() ) ga_CAV( 'Pratilipi', 'OpenRecommendation-' + this.pratilipi.meta.recommendationType(), vm.pratilipi.ga_index() ); else ga_CA( 'Pratilipi', 'Open' ); return true; }; this.titleDisplay = ko.computed( function() { return self.pratilipi.displayTitle ? self.pratilipi.displayTitle() : self.pratilipi.title(); }, this ); } , template: `<div class="pratilipi-pratilipi-card-mini"><a data-bind="attr: { href: pratilipi.pageUrl() }, event: { click: openPratilipi }"><div class="pratilipi-cover-image-holder"><pratilipi-image params="{ src: pratilipi.coverImageUrl,width: 100,height: 150,alt: titleDisplay(),mobWidth: 70,mobHeight: 105 }"></pratilipi-image></div><div class="pratilipi-meta-holder"><div class="pratilipi-title font-m" data-bind="text: titleDisplay()"></div><div class="reads-holder" data-bind="visible: pratilipi.readCount() > 0"><span class="font-xs" data-bind="text: abbrNum( pratilipi.readCount(), 0 )"></span><i class="material-icons font-xs" style="margin-left: 2px;">remove_red_eye</i></div></div></a></div>` }); </script> <script> ko.components.register( 'pratilipi-image', { viewModel: function( params ) { var self = this; this.src = typeof( params.src ) == "string" ? ko.observable( params.src ) : params.src; this.width = params.width; this.mobWidth = params.mobWidth != null ? params.mobWidth : self.width; this.height = params.height != null ? params.height : params.width; this.mobHeight = params.mobHeight != null ? params.mobHeight : self.height; this.imageCircle = params.imageCircle != null ? params.imageCircle : false; this.alt = params.alt != null ? params.alt : "Pratilipi"; this.isSmallImageLoaded = ko.observable(); this.isLargeImageLoaded = ko.observable(); this._onSmallImageLoad = function() { self.isSmallImageLoaded( true ); }; this._onLargeImageLoad = function() { self.isLargeImageLoaded( true ); }; this.wt = ko.observable(); this.ht = ko.observable(); this.setDimension = function() { self.wt( $(window).width() < 480 ? self.mobWidth : self.width ); self.ht( $(window).width() < 480 ? self.mobHeight : self.height ); }; /* Hack for mozilla - setTimeout executes after image is loaded. need to call this method only after first time */ var firstTime = true; this.srcObserver = ko.computed( function() { if( self.src() == null ) return; if( firstTime ) { firstTime = false; return; } setTimeout( function() { self.isSmallImageLoaded( false ); self.isLargeImageLoaded( false ); }, 0 ); }, this ); self.setDimension(); $(window).on( 'resize', function() { self.setDimension(); } ); } , template: `<div class="pratilipi-image" data-bind="style: { 'width': wt() + 'px', 'height': ht() + 'px', 'borderRadius': imageCircle ? '999px' : '0' }"><img class="img-small" data-bind="attr: { 'src': getImageUrl( src(), wt(), true ) },event: { load: _onSmallImageLoad }, css: { 'loaded': isSmallImageLoaded() }"><!-- ko if: isSmallImageLoaded() --><img class="img-large" data-bind="lazyload: getImageUrl( src(), wt(), false ),event: { load: _onLargeImageLoad }, css: { 'loaded': isLargeImageLoaded() }, attr: { 'alt': alt }"><!-- /ko --></div>` }); </script> <script> ko.components.register( 'pratilipi-search-page', { viewModel: function() { var self = this; var cursor = null; var resultCount = 20; var dataAccessor = new DataAccessor(); this.searchTitle = ko.observable(); this.isListPage = ko.observable(); /* TODO: Remove this once we are rid of search pages in navigation */ this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); /* Loading state */ /* * 4 Possible values for 'loadingState' * LOADING * LOADED_EMPTY * LOADED * FAILED * * */ this.loadingState = ko.observable(); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchPratilipiList = function() { if( self.loadingState() == "LOADING" || ! self.hasMoreContents() ) return; self.loadingState( "LOADING" ); dataAccessor.getPratilipiListBySearchQuery( appViewModel.searchQuery(), cursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.loadingState( "FAILED" ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.loadingState( self.pratilipiList().length > 0 || pratilipiList.length > 0 ? "LOADED" : "LOADED_EMPTY" ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; var listsearchTitleMap = { }; this.searchQueryUpdated = function() { /* Setting searchTitle for search pages coming from navigation */ self.searchTitle( listsearchTitleMap[ "/search?q=" + appViewModel.searchQuery() ] != null ? listsearchTitleMap[ "/search?q=" + appViewModel.searchQuery() ] : "Search Results" ); self.isListPage( listsearchTitleMap[ "/search?q=" + appViewModel.searchQuery() ] != null ); self.pratilipiList( [] ); cursor = null; self.loadingState( null ); self.hasMoreContents( true ); self.fetchPratilipiList(); }; this.searchQueryObserver = ko.computed( function() { if( appViewModel.searchQuery() == null ) return; setTimeout( function() { self.searchQueryUpdated(); ga_CAV( 'Header', 'Search', appViewModel.searchQuery() ); }, 0 ); }, this ); this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.getLoadingStateText = ko.computed( function() { return "Searching for $query".replace( "$query", appViewModel.searchQuery() ); }); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.SEARCH.ko_element ) { /* Dispose all observers */ self.getLoadingStateText.dispose(); self.locationObserver.dispose(); self.pageScrollObserver.dispose(); self.searchQueryObserver.dispose(); return; } }, this ); } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div data-bind="html: searchTitle()"class="load-more-container mdl-card-border material-heading"style="margin-top: 0;"></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: loadingState() == 'LOADING'"><div class="search-loading-state" data-bind="visible: pratilipiList().length == 0"><!-- ko component: {name: "pratilipi-loading-state",params: { customText: isListPage() ? null : getLoadingStateText() }} --><!-- /ko --></div><span data-bind="visible: pratilipiList().length > 0" class="initial-data-loading-spinner mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div><div class="load-more-container mdl-card-border material-subtitle-1" data-bind="visible: loadingState() == 'FAILED' && pratilipiList().length == 0"><a style="cursor: pointer; color: #555;" data-bind="click: fetchPratilipiList">Failed to load search results! Please click here to try again!</a></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents() && ( loadingState() == 'LOADED' || loadingState() == 'FAILED' ) && pratilipiList().length > 0"><button data-bind="{ click: fetchPratilipiList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button></div><div class="load-more-container mdl-card-border material-subtitle-1" data-bind="visible: loadingState() == 'LOADED_EMPTY'">Sorry! No Search Results found for your search query. Try searching for different search query!</div></div>` }); </script> <script> ko.components.register( 'pratilipi-forgot-password-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.userEmail = ko.observable(); this.requestOnFlight = ko.observable( false ); this.forgotPassword = function() { if( self.requestOnFlight() ) return; if( self.userEmail() == null || self.userEmail().trim() == "" ) { ToastUtil.toast( "Please Enter your Email" ); return; } if( ! validateEmail( self.userEmail() ) ) { ToastUtil.toast( "Please Enter a valid Email" ); return; } self.requestOnFlight( true ); dataAccessor.forgotPassword( self.userEmail(), function() { ToastUtil.toastUp( "A mail has been sent to your email Id!" ); setTimeout( function() { window.location.href = getRetUrl( true ); }, 5000 ); } , function( error ) { var message = "Some error Occurred! Please try again!"; if( error[ "email" ] != null ) message = error[ "email" ]; else if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 2000, true ); } ); }; this.forgotPasswordButtonEnabled = ko.computed( function() { return self.userEmail() != null && self.userEmail().trim() != "" && ! self.requestOnFlight(); }, self ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.FORGOT_PASSWORD.ko_element ) { /* Clear All Fields */ self.userEmail( null ); /* Dispose all observers */ self.locationObserver.dispose(); return; } appViewModel.currentLocation(); }, this ); } , template: `<div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">Forgot Password ?</div><div class="pratilipi-content-container"><p class="material-body-1" style="margin: 15px 0;">Please enter the email address you signed up with. We will send you a link to reset your password.</p><form id="reset_password_form" class="pratilipi-content-container margin-zero"><input type="email" data-bind="mdlFloatingInput: { label: 'Email', value: userEmail, id: 'pratilipi_forgot_password_page_user_email' }, valueUpdate: ['input']" /><button data-bind="{ click: forgotPassword, enable: forgotPasswordButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">Reset Password</button><div data-bind="visible: requestOnFlight"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; margin: auto;"></div><div class="member-login material-body-2"><a data-bind="attr: { href: '/login?retUrl=' + getRetUrl() }" class="pratilipi-blue">To Sign In</a></div></form></div></div>` }); </script> <script> ko.components.register( 'pratilipi-list-page', { viewModel: function() { var self = this; var cursor = null; var resultCount = 20; var dataAccessor = new DataAccessor(); this.listTitle = ko.observable(); this.pratilipiList = ko.observableArray(); this.hasMoreContents = ko.observable( true ); this.isLoading = ko.observable( false ); this.updatePratilipiList = function( pratilipiList ) { for( var i = 0; i < pratilipiList.length; i++ ) self.pratilipiList.push( ko.mapping.fromJS( pratilipiList[i] ) ); }; this.fetchPratilipiList = function() { if( self.isLoading() || ! self.hasMoreContents() ) return; self.isLoading( true ); dataAccessor.getPratilipiListByListName( window.location.pathname.substring(1), cursor, null, resultCount, function( pratilipiListResponse ) { if( pratilipiListResponse == null ) { self.isLoading( false ); return; } var loadMore = self.pratilipiList().length != 0; var pratilipiList = pratilipiListResponse.pratilipiList; self.updatePratilipiList( pratilipiList ); cursor = pratilipiListResponse.cursor; self.isLoading( false ); self.hasMoreContents( pratilipiList.length == resultCount && cursor != null ); if( loadMore ) ga_CA( 'Pratilipi', 'LoadMore' ); }); }; this.listUpdated = function() { self.listTitle( getListTitle() ); self.pratilipiList( [] ); cursor = null; self.hasMoreContents( true ); self.isLoading( false ); self.fetchPratilipiList(); }; this.pageScrollObserver = ko.computed( function() { if( ( appViewModel.scrollTop() / $( ".js-pratilipi-list-grid" ).height() ) > 0.6 ) { setTimeout( function() { self.fetchPratilipiList(); }, 100 ); /* locationObserver and pageScrollObserver will be triggered at once. */ } }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.LIST.ko_element ) { /* Dispose all observers */ self.locationObserver.dispose(); self.pageScrollObserver.dispose(); return; } appViewModel.currentLocation(); setTimeout( function() { self.listUpdated(); }, 0 ); }, this ); /* Hack: Setting listTitle */ var getListTitle = function() { var listListTitleMap = { '/featured': 'Featured', }; return listListTitleMap[ window.location.pathname ] != null ? listListTitleMap[ window.location.pathname ] : null; }; } , template: `<div class="mdl-cell mdl-cell--8-col-tablet mdl-cell--9-col mobile-card generic-list-page"><div data-bind="visible: listTitle() != null, html: listTitle()"class="load-more-container mdl-card-border material-heading"style="margin-top: 0;"></div><div data-bind="foreach: { data: pratilipiList, as: 'pratilipi' }, visible: pratilipiList().length > 0"class="mdl-grid pratilipi-list-grid js-pratilipi-list-grid mobile-card"><div class="mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--12-col-desktop mobile-card pratilipi-list-card"><!-- ko component: {name: "pratilipi-pratilipi-card",params: { pratilipi: pratilipi }} --><!-- /ko --></div></div><div class="load-more-container mdl-card-border" data-bind="visible: hasMoreContents()"><button data-bind="{ visible: ! isLoading(), click: fetchPratilipiList }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">Load More Contents</button><div data-bind="visible: isLoading()" class="text-center"><span data-bind="visible: pratilipiList().length > 0"class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span><pratilipi-loading-state data-bind="visible: pratilipiList().length == 0"></pratilipi-loading-state></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-login-page', { viewModel: function() { var self = this; var dataAccessor = new DataAccessor(); this.requestOnFlight = ko.observable( false ); this.userEmail = ko.observable(); this.userPassword = ko.observable(); this.login = function() { if( self.requestOnFlight() ) return; if( self.userEmail() == null || self.userEmail().trim() == "" ) { ToastUtil.toast( "Please Enter your Email." ); return; } if( self.userPassword() == null || self.userPassword().trim() == "" ) { ToastUtil.toast( "Please Enter your Password" ); return; } if( ! validateEmail( self.userEmail() ) ) { ToastUtil.toast( "Please Enter a valid Email" ); return; } self.requestOnFlight( true ); ToastUtil.toastUp( "Working ..." ); dataAccessor.loginUser( self.userEmail(), self.userPassword(), function( user ) { ToastUtil.toast( "Success !" ); window.location.href = getRetUrl( true ); }, function( error ) { self.requestOnFlight( false ); var message = "Some error Occurred! Please try again!"; if( error[ "email" ] != null ) message = error[ "email" ]; else if( error[ "password" ] != null ) message = error[ "password" ]; else if( error[ "message" ] != null ) message = error[ "message" ]; ToastUtil.toast( message, 3000, true ); }); }; this.loginButtonEnabled = ko.computed( function() { return self.userEmail() != null && self.userEmail().trim() != "" && self.userPassword() != null && self.userPassword().trim() != "" && ! self.requestOnFlight(); }, this ); this.userObservser = ko.computed( function() { if( appViewModel.user.userId() == null || appViewModel.user.userId() == 0 ) return; setTimeout( function() { ToastUtil.toastUp( "<a href='" + getRetUrl( true ) + "'>You are already logged in, please click here to go back!</a>" ); }, 0 ); }, this ); this.locationObserver = ko.computed( function() { if( appViewModel.currentView() != LOCATION.LOGIN.ko_element ) { /* Clear All Fields */ self.userEmail( null ); self.userPassword( null ); /* Dispose all observers */ self.locationObserver.dispose(); self.userObservser.dispose(); return; } appViewModel.currentLocation(); }, this ); if( getUrlParameter( "message" ) != null ) { var type = getUrlParameter( "message" ); var message = null; if( type == "NOTIFICATIONS" ) message = "Please login to get Notifications from people you Follow!"; else if( type == "LIBRARY" ) message = "Please login to save unlimited books to your Library!"; else if( type == "WRITE" ) message = "Please login to write content on desktop website!"; else if( type == "FOLLOW" ) message = "Please login to follow this author"; if( message != null ) ToastUtil.toast( message, 4000 ); } } , template: `<div class="pratilipi-login-page"><div class="pratilipi-login-container"><span class="sprites-icon pratilipi-logo-icon"></span><div class="pratilipi-heading material-title">Sign In</div><div class="pratilipi-content-container"><!-- ko component: {name: "pratilipi-facebook-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: false }} --><!-- /ko --><!-- ko component: {name: "pratilipi-google-login",params: { requestOnFlight: $data.requestOnFlight,isRegister: false }} --><!-- /ko --></div><p class="login-or margin-zero">or</p><form id="login_form" class="pratilipi-content-container margin-zero"><input type="email" data-bind="mdlFloatingInput: { label: 'Email', value: userEmail, id: 'pratilipi_login_page_user_email' }, valueUpdate: ['input']" /><input type="password" data-bind="mdlFloatingInput: { label: 'Password', value: userPassword, id: 'pratilipi_login_page_user_password' }, valueUpdate: ['input']" /><div class="forgot-password-holder"><a data-bind="attr: { href: '/forgot-password?retUrl=' + getRetUrl() }" class="forgot-password-link pull-right material-body-2">Forgot Password ?</a></div><div class="clearfix"></div><button onclick="ga_CA( 'Login', 'Email-Login' )"data-bind="{ click: login, enable: loginButtonEnabled }"type="submit"class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored pratilipi-red-button login-button">To Sign In</button></form><div class="sign-up-link material-body-1">New?&nbsp;&nbsp;<a data-bind="attr: { href: '/register?retUrl=' + getRetUrl() }" class="pratilipi-red">Sign Up for Pratilipi</a></div></div></div>` }); </script> <script> ko.components.register( 'pratilipi-author-follows', { viewModel: function( params ) { var self = this; var dataAccessor = new DataAccessor(); this.author = params.author; var processUserList = function( userList ) { if( userList == null ) return []; var followList = []; for( var i = 0; i < userList.length; i++ ) { var user = userList[i]; var follow = { authorId: user.author.authorId, name: user.author.name, pageUrl: user.profilePageUrl, followCount: user.author.followCount, imageUrl: user.profileImageUrl, following: user.author.following, canFollow: user.userId != appViewModel.user.userId(), requestOnFlight: false /* Hack: To manipulate */ }; followList.push( follow ); } return followList; }; var processAuthorList = function( authorList ) { if( authorList == null ) return []; var followList = []; for( var i = 0; i < authorList.length; i++ ) { var author = authorList[i]; var follow = { authorId: author.authorId, name: author.name, pageUrl: author.pageUrl, followCount: author.followCount, imageUrl: author.imageUrl, following: author.following, canFollow: author.user == null || author.user.userId != appViewModel.user.userId(), requestOnFlight: false /* Hack: To manipulate */ }; followList.push( follow ); } return followList; }; /* Followers and Following List */ this.followersList = ko.observableArray(); this.followingList = ko.observableArray(); this.updateFollowersList = function( userList ) { var processedUserList = processUserList( userList ); for( var i = 0; i < processedUserList.length; i++ ) self.followersList.push( ko.mapping.fromJS( processedUserList[i] ) ); }; this.updateFollowingList = function( authorList ) { var processedAuthorList = processAuthorList( authorList ); for( var i = 0; i < processedAuthorList.length; i++ ) self.followingList.push( ko.mapping.fromJS( processedAuthorList[i] ) ); }; /* Fetching followers and following list */ var followersCursor = null; var followingCursor = null; this.isLoadingFollowers = ko.observable( false ); this.isLoadingFollowing = ko.observable( false ); this.hasMoreFollowers = ko.observable( true ); this.hasMoreFollowing = ko.observable( true ); this.numberFoundFollowers = ko.observable(); this.numberFoundFollowing = ko.observable(); this._loadFollowersList = function( resultCount ) { if( self.isLoadingFollowers() ) return; self.isLoadingFollowers( true ); dataAccessor.getAuthorFollowers( self.author.authorId(), followersCursor, null, resultCount, function( followersListResponse ) { if( followersListResponse == null ) { self.isLoadingFollowers( false ); return; } var userList = followersListResponse.userList; self.updateFollowersList( userList ); followersCursor = followersListResponse.cursor; self.numberFoundFollowers( followersListResponse.numberFound ); self.isLoadingFollowers( false ); self.hasMoreFollowers( userList.length == resultCount ); }); }; this._loadFollowingList = function( resultCount ) { if( self.isLoadingFollowing() ) return; self.isLoadingFollowing( true ); dataAccessor.getUserFollowing( self.author.user.userId(), followingCursor, null, resultCount, function( followingListResponse ) { if( followingListResponse == null ) { self.isLoadingFollowing( false ); return; } var authorList = followingListResponse.authorList; self.updateFollowingList( authorList ); followingCursor = followingListResponse.cursor; self.numberFoundFollowing( followingListResponse.numberFound ); self.isLoadingFollowing( false ); self.hasMoreFollowing( authorList.length == resultCount ); }); }; /* Constants */ var initialFollowersResultCount = 10; var subsequentFollowersResultCount = 15; var initialFollowingResultCount = 10; var subsequentFollowingResultCount = 15; this.loadInitialFollowers = function() { self.followersList( [] ); followersCursor = null; self.isLoadingFollowers( false ); self.hasMoreFollowers( true ); self.numberFoundFollowers( 0 ); self._loadFollowersList( initialFollowersResultCount ); }; this.loadMoreFollowers = function() { self._loadFollowersList( subsequentFollowersResultCount ); }; this.loadInitialFollowing = function() { self.followingList( [] ); followingCursor = null; self.isLoadingFollowing( false ); self.hasMoreFollowing( true ); self.numberFoundFollowing( 0 ); self._loadFollowingList( initialFollowingResultCount ); }; this.loadMoreFollowing = function() { self._loadFollowingList( subsequentFollowingResultCount ); }; /* Follow / UnFollow Author */ this.followOrUnfollowAuthor = function( vm ) { if( appViewModel.user.isGuest() ) { goToLoginPage( null, { "message": "FOLLOW" } ); return; } if( ! vm.canFollow() ) return; if( vm.requestOnFlight() ) return; vm.requestOnFlight( true ); var getFollowingMessage = function( following, name ) { var text = following ? "You are following $authorName." : "You have unfollowed $authorName."; return text.replace( "$authorName", name ); }; var switchState = function() { vm.followCount( vm.following() ? vm.followCount() - 1 : vm.followCount() + 1 ); vm.following( ! vm.following() ); }; switchState(); ToastUtil.toast( getFollowingMessage( vm.following(), vm.name() ) ); dataAccessor.followOrUnfollowAuthor( vm.authorId(), vm.following(), function( userAuthor ) { vm.requestOnFlight( false ); ga_CA( 'Author', userAuthor.following ? 'Follow' : 'UnFollow' ); }, function( error ) { vm.requestOnFlight( false ); switchState(); ToastUtil.toast( error[ "message" ] != null ? error[ "message" ] : "Some error Occurred! Please try again!", 3000, true ); }); }; /* Computed Observables */ this.authorIdObserver = ko.computed( function() { if( self.author.authorId() == null ) return; setTimeout( function() { self.loadInitialFollowers(); }, 0 ); }, this ); this.authorUserIdObserver = ko.computed( function() { if( self.author.user.userId() == null ) return; setTimeout( function() { self.loadInitialFollowing(); }, 0 ); }, this ); } , template: `<div class="pratilipi-author-follows"><div class="modal common-modal fade" id="pratilipi-author-follows-followers" tabindex="-1" role="dialog" aria-labelledby="pratilipi-author-follows-followers"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 style="margin: 0;" class="material-title">Followers</h6></div><div class="modal-body" style="padding: 0;"><ul class="mdl-list author-follow-ul" data-bind="foreach: { data: followersList, as: 'follow' }"><li class="mdl-list__item"><div><a data-bind="attr: { 'href': follow.pageUrl(), 'alt': follow.name() }"><img class="mdl-list__item-avatar" data-bind="attr: { 'src': getImageUrl( follow.imageUrl(), 48 ) }"/></a></div><div class="author-name"><a class="font-m" data-bind="text: follow.name(), attr: { 'href': follow.pageUrl() }"></a></div><div data-bind="visible: follow.canFollow()"><button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin small-button"data-bind="{ click: $parent.followOrUnfollowAuthor,disable: follow.requestOnFlight(),css: { 'mdl-button--colored': ! follow.following() } }"><i data-bind="text: follow.following() ? 'done' : 'person_add'" class="material-icons"></i></button></div></li></ul><div class="load-more-container" data-bind="visible: hasMoreFollowers()"><button data-bind="{ visible: ! isLoadingFollowers(), click: loadMoreFollowers }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">show more</button><div data-bind="visible: isLoadingFollowers()" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div></div></div></div><div class="modal common-modal fade" id="pratilipi-author-follows-following" tabindex="-1" role="dialog" aria-labelledby="pratilipi-author-follows-following"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 style="margin: 0;" class="material-title">Following</h6></div><div class="modal-body" style="padding: 0;"><ul class="mdl-list author-follow-ul" data-bind="foreach: { data: followingList, as: 'follow' }"><li class="mdl-list__item"><div><a data-bind="attr: { 'href': follow.pageUrl(), 'alt': follow.name() }"><img class="mdl-list__item-avatar" data-bind="attr: { 'src': getImageUrl( follow.imageUrl(), 48 ) }"/></a></div><div class="author-name"><a class="font-m" data-bind="text: follow.name(), attr: { 'href': follow.pageUrl() }"></a></div><div data-bind="visible: follow.canFollow()"><button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button-margin small-button"data-bind="{ click: $parent.followOrUnfollowAuthor,disable: follow.requestOnFlight(),css: { 'mdl-button--colored': ! follow.following() } }"><i data-bind="text: follow.following() ? 'done' : 'person_add'" class="material-icons"></i></button></div></li></ul><div class="load-more-container" data-bind="visible: hasMoreFollowing()"><button data-bind="{ visible: ! isLoadingFollowing(), click: loadMoreFollowing }"class="mdl-button mdl-js-button mdl-button--accent mdl-js-ripple-effect">show more</button><div data-bind="visible: isLoadingFollowing()" class="text-center"><span class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></span></div></div></div></div></div></div></div>` }); </script> <link rel="stylesheet" href="https://www.ptlp.co/resource-all/pwa/css/bmmg.css"/> <link rel="stylesheet" href="/pwa-stylesheets/css/style.css?201120171710" /> <script> var Suggester = function(selectorOrElem, onResolve, content_holder, isInputElement, lang) { if(selectorOrElem) { this.elem = $(selectorOrElem); this.setMode( false ); } else { throw 'Coding karni nahi aati.'; } if(typeof onResolve == 'function') { this.resolveCallback = onResolve; } else { throw 'Coding karni nahi aati.'; } if( content_holder ) { this.content_holder = content_holder; this.isInputTypeElement = isInputElement; } else { throw 'Coding karni nahi aati.'; } this.lang = lang; this.url = "https://www.google.com/inputtools/request?ime=transliteration_en_" + this.lang + "&num=5&cp=0&cs=0&ie=utf-8&oe=utf-8&app=jsapi"; this.text = ''; this.savedSelection = null; this.words_map = {}; }; var suggesterMethods = { init: function() { var self = this; this.content_holder.on("blur", function() { if( self.getMode() ) { if (this.savedSelection) { rangy.removeMarkers(this.savedSelection); } this.savedSelection = rangy.saveSelection(); } }); this.elem.on('click', 'div.suggestion', function(e) { self.elem.find(".highlight-suggestion").removeClass("highlight-suggestion"); $(this).addClass("highlight-suggestion"); if (this.savedSelection) { rangy.restoreSelection(savedSel, true); this.savedSelection = null; } self.handleWordSelection(); } ); }, type: function( translation ) { /* var translation = new Translation(keycode); */ if( translation.action == 'typing' ) { if( !this.getMode() ) { /* add a span tag there and set the relative position of the dropdown */ if( this.isInputTypeElement == false ) { this.curSpan = insertNodeAtRange(); } this.setSuggesterPosition(); this.showSuggester(); this.setMode( true ); } this.setText(this.text + translation.text); } else if(translation.action == 'space' || translation.action == 'enter') { this.handleWordSelection(); } else if( translation.action == 'special_char' ) { this.text += translation.text; this.handleWordSelection( translation.text ); } else if(translation.action == 'backspace') { this.backspace(); } else if(translation.action == 'up') { this.goUp(); } else if( translation.action == 'down') { this.goDown(); } else if( translation.action == 'escape' || translation.action == 'tab' ) { this.clear(); } }, backspace: function() { if( this.text.length == 1 ) { this.clear(); } else { this.setText(this.text.substr(0, this.text.length -1)); } }, goUp: function() { var $suggestions = this.elem.find('.suggestions'); var $currently_highlighted_suggestion = $suggestions.find('.highlight-suggestion'); var $prev_suggestion = $currently_highlighted_suggestion.prev(); $currently_highlighted_suggestion.removeClass("highlight-suggestion"); if( $prev_suggestion.length ) { $prev_suggestion.addClass("highlight-suggestion"); } else { $suggestions.find(".suggestion:last").addClass("highlight-suggestion"); } }, goDown: function() { var $suggestions = this.elem.find('.suggestions'); var $currently_highlighted_suggestion = $suggestions.find('.highlight-suggestion'); var $next_suggestion = $currently_highlighted_suggestion.next(); $currently_highlighted_suggestion.removeClass("highlight-suggestion"); if( $next_suggestion.length ) { $next_suggestion.addClass("highlight-suggestion"); } else { $suggestions.find(".suggestion:first").addClass("highlight-suggestion"); } }, getSuggestions: function() { this.suggestFromGoogleApi(); }, suggestFromWordsMap: function() { this.suggestions = this.words_map[this.text]; this.suggest(); }, suggestFromGoogleApi: function() { var self = this; $.ajax({ url: self.url, data: { text: self.text }, type: "GET", dataType : "json", }) .done(function( json ) { self.suggestions = json[1][0][1]; self.suggestions.push( self.text ); self.suggest(); }); }, clearSuggestions: function() { this.suggestions = []; this.suggest(); }, suggest: function() { var $suggestions = this.elem.find('.suggestions'); $suggestions.empty(); this.suggestions.forEach(function(suggestion) { var $suggestion = $("<div class='suggestion'></div>"); $suggestion.text(suggestion); $suggestions.append($suggestion); }); $suggestions.find(".suggestion:first").addClass("highlight-suggestion"); }, clear: function() { this.setText(''); this.hideSuggester(); this.clearSpanTags(); this.setMode(false); }, setText: function(text) { /* this.addSpanElement(); */ this.text = text; this.getInputElem().text(this.text); if(text) { this.getSuggestions(); } else { this.clearSuggestions(); } }, getInputElem: function() { if (!this.inputElem) { this.inputElem = this.elem.find('.word-input'); } return this.inputElem; }, resolve: function(withSuggestion) { this.resolveCallback && this.resolveCallback(withSuggestion, this.text); this.clear(); }, setMode: function( val ) { this.mode = val; }, getMode: function() { return this.mode; }, getCaretPosition: function() { var coordinates = {}; if( this.isInputTypeElement ) { var caret_coordinates = getCaretCoordinates( this.content_holder.get(0), this.content_holder.get(0).selectionEnd ); coordinates["top"] = caret_coordinates.top + this.content_holder.offset().top; coordinates["left"] = caret_coordinates.left + this.content_holder.offset().left; } else { var doc_height = $(document).height(); /* var client_height = document.body.clientHeight; */ coordinates["top"] = this.curSpan.offsetTop + this.curSpan.offsetHeight + this.content_holder.get(0).offsetTop; coordinates["left"] = this.curSpan.offsetLeft + this.content_holder.get(0).offsetLeft; /* var visibleTop = coordinates["top"] - $(window).scrollTop(); console.log( doc_height, coordinates["top"], doc_height - coordinates["top"] ); console.log( client_height, visibleTop, client_height - visibleTop ); */ var last_usable_value = doc_height - coordinates["top"]; if( doc_height - coordinates["top"] < 200 ) { /* this.content_holder.height( this.content_holder.height() + 200 ); */ coordinates["top"] -= 180; window.scrollTo( 0, document.body.scrollHeight + 200 ); } } return coordinates; }, setSuggesterPosition: function() { var coordinates = this.getCaretPosition(); var self = this; this.elem.css({ top: coordinates.top, left: coordinates.left, }); /* this.elem.css({ top: self.curSpan.offsetTop + self.curSpan.offsetHeight + self.content_holder.get(0).offsetTop, left: self.curSpan.offsetLeft + self.content_holder.get(0).offsetLeft, }); */ }, showSuggester: function() { this.elem.show(); }, hideSuggester: function() { this.elem.hide(); }, clearSpanTags: function() { $("span.curWord").remove(); }, handleWordSelection: function( special_char ) { var selected_word; var $highlighted_word = this.elem.find(".highlight-suggestion"); selected_word = $highlighted_word.length ? $highlighted_word.text() : this.text; if( special_char ) { selected_word += special_char; } this.resolve( selected_word ); } }; for(var method in suggesterMethods) { Suggester.prototype[method] = suggesterMethods[method]; } var Translation = function(keycode, isShiftKey) { if( keycode == 13 ) { this.action = 'enter' } else if( keycode == 32 ) { this.action = 'space'; } else if( keycode == 8 ) { this.action = 'backspace'; } else if( keycode == 9 ) { this.action = 'tab'; } else if( keycode == 38 && !isShiftKey ) { this.action = 'up'; } else if( keycode == 40 && !isShiftKey ) { this.action = 'down'; } else if( keycode == 37 && !isShiftKey ) { this.action = 'left'; } else if( keycode == 39 && !isShiftKey ) { this.action = 'right'; } else if( keycode == '27') { this.action = 'escape'; } else if(keycode > 32 && keycode < 127) { if( keycode.between(33, 47) || keycode.between(58, 64) || keycode.between(91, 96) || keycode.between(123, 126) ) { this.action = 'special_char'; } else { this.action = 'typing'; } this.text = String.fromCharCode(keycode).toLowerCase(); } }; Number.prototype.between = function (min, max) { return this >= min && this <= max; }; </script> <script> (function () { var properties = [ 'direction', /* RTL support */ 'boxSizing', 'width', /* on Chrome and IE, exclude the scrollbar, so the mirror div wraps exactly as the textarea does */ 'height', 'overflowX', 'overflowY', /* copy the scrollbar for IE */ 'borderTopWidth', 'borderRightWidth', 'borderBottomWidth', 'borderLeftWidth', 'borderStyle', 'paddingTop', 'paddingRight', 'paddingBottom', 'paddingLeft', /* https://developer.mozilla.org/en-US/docs/Web/CSS/font */ 'fontStyle', 'fontVariant', 'fontWeight', 'fontStretch', 'fontSize', 'fontSizeAdjust', 'lineHeight', 'fontFamily', 'textAlign', 'textTransform', 'textIndent', 'textDecoration', /* might not make a difference, but better be safe */ 'letterSpacing', 'wordSpacing', 'tabSize', 'MozTabSize' ]; var isBrowser = (typeof window !== 'undefined'); var isFirefox = (isBrowser && window.mozInnerScreenX != null); function getCaretCoordinates(element, position, options) { if(!isBrowser) { throw new Error('textarea-caret-position#getCaretCoordinates should only be called in a browser'); } var debug = options && options.debug || false; if (debug) { var el = document.querySelector('#input-textarea-caret-position-mirror-div'); if ( el ) { el.parentNode.removeChild(el); } } /* mirrored div */ var div = document.createElement('div'); div.id = 'input-textarea-caret-position-mirror-div'; document.body.appendChild(div); var style = div.style; var computed = window.getComputedStyle? getComputedStyle(element) : element.currentStyle; /* currentStyle for IE < 9 */ /* default textarea styles */ style.whiteSpace = 'pre-wrap'; if (element.nodeName !== 'INPUT') style.wordWrap = 'break-word'; /* only for textarea-s */ /* position off-screen */ style.position = 'absolute'; /* required to return coordinates properly */ if (!debug) style.visibility = 'hidden'; /* not 'display: none' because we want rendering */ /* transfer the element's properties to the div */ properties.forEach(function (prop) { style[prop] = computed[prop]; }); if (isFirefox) { /* Firefox lies about the overflow property for textareas: https://bugzilla.mozilla.org/show_bug.cgi?id=984275 */ if (element.scrollHeight > parseInt(computed.height)) style.overflowY = 'scroll'; } else { style.overflow = 'hidden'; /* for Chrome to not render a scrollbar; IE keeps overflowY = 'scroll' */ } div.textContent = element.value.substring(0, position); /* the second special handling for input type="text" vs textarea: spaces need to be replaced with non-breaking spaces - http://stackoverflow.com/a/13402035/1269037 */ if (element.nodeName === 'INPUT') div.textContent = div.textContent.replace(/\s/g, '\u00a0'); var span = document.createElement('span'); span.textContent = element.value.substring(position) || '.'; /* || because a completely empty faux span doesn't render at all */ div.appendChild(span); var coordinates = { top: span.offsetTop + parseInt(computed['borderTopWidth']), left: span.offsetLeft + parseInt(computed['borderLeftWidth']) }; if (debug) { span.style.backgroundColor = '#aaa'; } else { document.body.removeChild(div); } return coordinates; } if (typeof module != 'undefined' && typeof module.exports != 'undefined') { module.exports = getCaretCoordinates; } else if(isBrowser){ window.getCaretCoordinates = getCaretCoordinates; } }()); var transliterationApp = function( $transliterable_elem, lang ) { this.$transliterable_elem = $transliterable_elem; this.lang = lang; }; transliterationApp.prototype.init = function() { var _this = this; this.setTransliterationElementType(); this.setSuggestionResolveFunction(); if( $( ".word-suggester" ).length == 0 ) { var suggesDiv = document.createElement( 'div' ); suggesDiv.className = "word-suggester"; suggesDiv.innerHTML = "<div class='word-input'></div><div class='suggestions'><div class='suggestion'></div></div>"; document.body.appendChild( suggesDiv ); } var $suggester_div = $( ".word-suggester" ); document.body.appendChild( $suggester_div.get(0) ); this.suggester = new Suggester( $suggester_div.get(0), _this.onSuggestionPicked, _this.$transliterable_elem, _this.isTransliterationInputType(), _this.lang ); this.suggester.init(); this.$transliterable_elem.on('keypress', _this.suppressKeypress.bind( _this )); this.$transliterable_elem.on('keydown', _this.suppressKeydown.bind( _this )); this.$transliterable_elem.on("click", function(event) { if( _this.suggester.getMode() && ( !$(event.target).closest('.word-suggester').length ) ) { _this.suggester.clear(); } }); }; function getFirstRange() { var sel = rangy.getSelection(); return sel.rangeCount ? sel.getRangeAt(0) : null; }; transliterationApp.prototype.onSuggestionPickedInsideDiv = function( word, eng_word ) { if (window.getSelection) { var text = ( word ? word : eng_word ) + "\u00A0"; sel = rangy.getSelection(); var range = getFirstRange(); if (range) { var text_node = document.createTextNode(text); range.insertNode( text_node ); range.setStartAfter( text_node ); /* sel.collapseToEnd(); */ sel.setSingleRange(range); } } }; transliterationApp.prototype.onSuggestionPickedInsideInput = function(word, eng_word) { /* console.log(':::::::Resolved with word ' + word + '::::::::') */ var text = ( word ? word : eng_word ) + " "; var startPos = this.content_holder.get(0).selectionStart; var endPos = this.content_holder.get(0).selectionEnd; var positon_after_selection = startPos + text.length ; var word = this.content_holder.get(0).value.substring(0, startPos) + text + this.content_holder.get(0).value.substring(endPos, this.content_holder.get(0).value.length); $( this.content_holder.get(0)).val( word ).change(); this.content_holder.get(0).selectionStart = this.content_holder.get(0).selectionEnd = positon_after_selection; }; function insertNodeAtRange() { var range = getFirstRange(); if (range) { var el = document.createElement("span"); el.className = "curWord"; range.insertNode(el); rangy.getSelection().setSingleRange(range); return el; } }; transliterationApp.prototype.setTransliterationElementType = function() { this.isInputTypeElement = this.$transliterable_elem.is("input,textarea") ? true : false; }; transliterationApp.prototype.setSuggestionResolveFunction = function() { this.onSuggestionPicked = this.isTransliterationInputType() ? this.onSuggestionPickedInsideInput : this.onSuggestionPickedInsideDiv; }; transliterationApp.prototype.isTransliterationInputType = function() { return this.isInputTypeElement; }; transliterationApp.prototype.suppressKeypress = function(e) { var keycode = e.keycode || e.which; var isShiftKey = e.shiftKey; var translation = new Translation( keycode, isShiftKey ); if( this.shouldPreventKeypress( translation ) ) { e.preventDefault(); this.sendKeyToSuggester( translation ); } }; transliterationApp.prototype.sendKeyToSuggester = function( translation ) { this.suggester.type( translation ); }; transliterationApp.prototype.shouldPreventKeypress = function( translation ) { /* var translation = new Translation( keycode ); */ return ( this.isNotBackspaceKey(translation) && !this.isKeydownActionKey(translation) && ( this.isNotKeypressActionKey(translation) || this.suggester.getMode() ) ); }; transliterationApp.prototype.isNotKeypressActionKey = function( translation ) { return ( translation.action != 'space' && translation.action != 'special_char' ); }; transliterationApp.prototype.isNotBackspaceKey = function( translation ) { return translation.action != 'backspace'; }; transliterationApp.prototype.suppressKeydown = function(e) { var keycode = e.keycode || e.which; var isShiftKey = e.shiftKey; var translation = new Translation( keycode, isShiftKey ); if( this.shouldPreventKeydown( translation ) ) { e.preventDefault(); this.sendKeyToSuggester( translation ); } }; transliterationApp.prototype.shouldPreventKeydown = function( translation ) { /* var translation = new Translation( keycode ); */ return ( this.isKeydownActionKey(translation) && this.suggester.getMode() ); }; transliterationApp.prototype.isKeydownActionKey = function( translation ) { if( this.isTransliterationInputType() ) { return ( translation.action == 'up' || translation.action == 'down' || translation.action == 'left' || translation.action == 'right' || translation.action == 'escape' || translation.action == 'tab' || translation.action == 'backspace'); } else { return ( translation.action == 'up' || translation.action == 'down' || translation.action == 'left' || translation.action == 'right' || translation.action == 'escape' ); } }; window.onload = function() { if(screen.width > 480) { rangy.init(); } }; </script> <script> /* Helper functions not specific to Pratilipi */ function isMobile() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test( navigator.userAgent ); } function isAndroid() { return /Android/i.test( navigator.userAgent ); } function getUrlParameter( variable ) { var query = window.location.search.substring(1); var vars = query.split( "&" ); for( var i=0; i<vars.length; i++ ) { var pair = vars[i].split( "=" ); if( pair[0] == variable ) { return pair[1]; } } return null; } function getUrlParameters() { var str = decodeURI( location.search.substring(1) ), res = str.split("&"), retObj = {}; for( var i = 0; i < res.length; i++ ){ var key = res[i].substring( 0, res[i].indexOf( '=' ) ); var value = res[i].substring( res[i].indexOf( '=' ) + 1 ); retObj[ key ] = value; } if( retObj[""] != null ) delete retObj[""]; return retObj; } function setCookie( name, value, days, path ) { if( days ) { var date = new Date(); date.setTime( date.getTime() + ( days * 24 * 60 * 60 * 1000 ) ); } var expires = days ? "; expires=" + date.toGMTString() : ""; document.cookie = name + "=" + value + "; path=" + path + expires; } function getCookie( cname ) { var name = cname + "="; var ca = document.cookie.split( ';' ); for( var i = 0; i < ca.length; i++ ) { var c = ca[i]; while( c.charAt(0) == ' ' ) c = c.substring( 1 ); if( c.indexOf( name ) == 0 ) return c.substring( name.length, c.length ); } return null; } function validateEmail( email ) { if( email == null ) return false; var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/; return re.test( email ); } function validatePhone( phone ) { if( phone == null ) return false; var pattern = /^[0-9]{10}$/; return pattern.test( phone ); } function isEmpty( obj ) { for( var prop in obj ) { if( obj.hasOwnProperty( prop ) ) return false; } return JSON.stringify( obj ) === JSON.stringify( {} ); } function roundOffToOneDecimal( number ) { return Math.round( number * 10 ) / 10; } /* https://stackoverflow.com/questions/10599933/convert-long-number-into-abbreviated-string-in-javascript-with-a-special-shortn */ function abbrNum( num, fixed ) { if( num === null ) { return null; } if( num === 0 ) { return '0'; } fixed = (!fixed || fixed < 0) ? 0 : fixed; var b = (num).toPrecision(2).split("e"), k = b.length === 1 ? 0 : Math.floor(Math.min(b[1].slice(1), 14) / 3), c = k < 1 ? num.toFixed(0 + fixed) : (num / Math.pow(10, k * 3) ).toFixed(1 + fixed), d = c < 0 ? c : Math.abs(c), e = d + ['', 'K', 'M', 'B', 'T'][k]; return e; } function commaSeparatedNumber(x) { return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); } function capitalizeFirstLetter( string ) { return string.charAt(0).toUpperCase() + string.slice(1).toLowerCase(); }/* HttpUtil */ var HttpUtil = function() { function processResponseText( repsonseText ) { var res = {}; try { res = JSON.parse( repsonseText ); } catch( err ) { res[ "message" ] = "Some error Occurred! Please try again!"; } return res; }; this.formatParams = function( params ) { if( params == null ) return ""; if( typeof( params ) === "string" ) return params; return Object.keys( params ).map( function(key) { return key + "=" + params[key] }).join("&"); }; this.get = function( aUrl, headers, params, aCallback ) { var anHttpRequest = new XMLHttpRequest(); anHttpRequest.onreadystatechange = function() { if( anHttpRequest.readyState == 4 && aCallback != null ) aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.open( "GET", aUrl + ( aUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + this.formatParams( params ), true ); anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.send( null ); }; this.post = function( aUrl, headers, params, aCallback ) { if( 'onLine' in navigator ) { if( ! navigator[ 'onLine' ] ) { aCallback( { "message": "Could not connect to server !" }, 0 ); return; } } var anHttpRequest = new XMLHttpRequest(); anHttpRequest.onreadystatechange = function() { if( anHttpRequest.readyState == 4 && aCallback != null ) aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.open( "POST", aUrl, true ); anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.send( this.formatParams( params ) ); }; this.getCORS = function( aUrl, headers, params, aCallback ) { function createCORSRequest( method, url ) { var anHttpRequest = new XMLHttpRequest(); /* anHttpRequest.withCredentials = true; */ if( "withCredentials" in anHttpRequest ) { anHttpRequest.open( method, url, true ); } else if( typeof XDomainRequest != "undefined" ) { anHttpRequest = new XDomainRequest(); anHttpRequest.open( method, url ); } else { anHttpRequest = null; } return anHttpRequest; } var anHttpRequest = createCORSRequest( 'GET', aUrl + ( aUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + this.formatParams( params ) ); if( !anHttpRequest ) { console.log( 'CORS not supported by browser.' ); return; } anHttpRequest.setRequestHeader( "Content-type", "application/x-www-form-urlencoded" ); if( headers != null ) { for( var key in headers ) if( headers.hasOwnProperty(key) ) anHttpRequest.setRequestHeader( key, headers[key] ); } anHttpRequest.onload = function() { aCallback( processResponseText( anHttpRequest.responseText ), anHttpRequest.status ); }; anHttpRequest.onerror = function( e ) { console.log( 'Error making the request: ', e ); }; anHttpRequest.send(); }; }; /* Toaster & SnackBar */ var snackbarContainer = document.createElement( 'div' ); snackbarContainer.id = "pratilipi-toast"; snackbarContainer.style.zIndex = "1051"; snackbarContainer.className = "mdl-js-snackbar mdl-snackbar"; snackbarContainer.innerHTML = '<div class="mdl-snackbar__text"></div><button class="mdl-snackbar__action" type="button"></button>'; document.body.appendChild( snackbarContainer ); var ToastUtil = (function() { return { toastCallBack: function( message, timeout, actionText, actionHandler ) { if( message == null || timeout == null ) return; var data = { message: message, timeout: timeout }; if( actionText ) { data[ "actionHandler" ] = actionHandler; data[ "actionText" ] = actionText; } setTimeout( function() { snackbarContainer.MaterialSnackbar.showSnackbar( data ); }, 1 ); }, toast: function( message, timeout, includeCloseButton ) { if( includeCloseButton ) this.toastCallBack( message, timeout == null ? 2000 : timeout, "x", this.toastDown ); else this.toastCallBack( message, timeout == null ? 2000 : timeout, null, null ); }, toastUp: function( message ) { var snackbarText = document.querySelector( '.mdl-snackbar__text' ); snackbarText.innerHTML = message; setTimeout( function() { snackbarContainer.classList.add( "mdl-snackbar--active" ); }, 1 ); }, toastDown: function( count ) { /* snackbarContainer.MaterialSnackbar.cleanup_(); */ /* As cleanup_ is not part of the public api and buggy, we are not using it. */ /* Removing "mdl-snackbar--active" woduln't allow additional toasts to display until that long timeout is completed */ setTimeout( function() { snackbarContainer.classList.remove( "mdl-snackbar--active" ); }, 1 ); } }; })();var metaTag = function( property, content ) { return { "property": property, "content": content }; }; var MetaTagUtil = (function() { return { setMetaTagsForPratilipi: function( pratilipi ) { var metaTagArray = []; metaTagArray.push( new metaTag( "fb:app_id", "293990794105516" ) ); metaTagArray.push( new metaTag( "og:title", pratilipi.title ) ); metaTagArray.push( new metaTag( "og:type", "books.book" ) ); metaTagArray.push( new metaTag( "og:description", pratilipi.summary != null ? pratilipi.summary : "Read Books, Stories, Poems and Articles in your language." ) ); metaTagArray.push( new metaTag( "og:locale", "en_IN" ) ); metaTagArray.push( new metaTag( "og:url", "https://" + ( pratilipi.language != null ? pratilipi.language.toLowerCase() : "english" ) + ".pratilipi.com" + pratilipi.pageUrl ) ); metaTagArray.push( new metaTag( "og:image", getImageUrl( pratilipi.coverImageUrl, 256 ) ) ); metaTagArray.push( new metaTag( "books:isbn", pratilipi.pratilipiId ) ); metaTagArray.push( new metaTag( "books:author", "https://" + ( pratilipi.language != null ? pratilipi.language.toLowerCase() : "english" ) + ".pratilipi.com" + pratilipi.author.pageUrl ) ); appViewModel.metaTags( metaTagArray ); }, setMetaTagsForAuthor: function( author ) { var metaTagArray = []; metaTagArray.push( new metaTag( "fb:app_id", "293990794105516" ) ); appViewModel.metaTags( metaTagArray ); }, setMetaTagsForEvent: function( event ) { var metaTagArray = []; metaTagArray.push( new metaTag( "fb:app_id", "293990794105516" ) ); appViewModel.metaTags( metaTagArray ); } }; })();/* Global Variables */ var ga_category = null; var shareUrl = null; var shareWhatsappText = null; var pratilipiForEvent = null; var authorForEvent = null; var fbEventParams = null; /* Share Modal */ function viewModel() { var self = this; self.shareOnFacebook = function() { ga_CA( ga_category, 'FB-Share' ); self.sendFBEvent(ga_category, 'FB'); window.open( "http://www.facebook.com/sharer.php?u=" + shareUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; self.shareOnTwitter = function() { ga_CA( ga_category, 'Twitter-Share' ); self.sendFBEvent(ga_category, 'TWITTER'); window.open( "http://twitter.com/share?url=" + shareUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; self.shareOnGplus = function() { ga_CA( ga_category, 'G+-Share' ); self.sendFBEvent(ga_category, 'G+'); window.open( "https://plus.google.com/share?url=" + shareUrl, "share", "width=1100,height=500,left=70px,top=60px" ); }; self.shareOnWhatsapp = function() { ga_CA( ga_category, 'Whatsapp-Share' ); window.open( "whatsapp://send?text=" + shareWhatsappText ); }; self.sendFBEvent = function(ga_category, entity_value) { /* FB Event for Pratilipi Share from pratilipi page only */ if (getLocation().ga_value == "PratilipiPage" && ga_category == "Pratilipi") { fbEvent('SHARE_CONTENT', entity_value); } else if (getLocation().fb_value && ga_category == 'Author') { fbAuthorEvent('SHARE_AUTHOR', entity_value); } }; } ko.components.register( 'pratilipi-share-dialog', { viewModel: viewModel, template: `<div class="modal common-modal fade" id="pratilipi-share-dialog" tabindex="-1" role="dialog" aria-labelledby="pratilipi-share-dialog"><div class="modal-dialog" style="max-width: 350px;" role="document"><div class="modal-content"><div class="modal-header"><button class="mdl-button mdl-js-button mdl-button--icon close" class="close" data-dismiss="modal" aria-label="Close"><i class="material-icons">close</i></button><h6 style="margin: 0;" class="material-title">Share</h6></div><div class="modal-body" style="padding: 15px;"><ul class="mdl-list"><li data-bind="click: shareOnFacebook" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon facebook-icon"></span><span class="font-m">Facebook</span></span></li><li data-bind="click: shareOnTwitter" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon twitter-icon"></span><span class="font-m">Twitter</span></span></li><li data-bind="click: shareOnGplus" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon google-plus-icon"></span><span class="font-m">Google Plus</span></span></li><li onclick="ga_CA( 'Pratilipi', 'Whatsapp-Share' )"data-bind="{ click: shareOnWhatsapp, visible: isMobile() }" class="mdl-list__item clickable-element"><span class="mdl-list__item-primary-content"><span class="sprites-icon mdl-list__item-icon whatsapp-icon"></span><span class="font-m">Whatsapp</span></span></li></ul></div></div></div></div>` }); var shareDialog = document.createElement( 'pratilipi-share-dialog' ); shareDialog.style.zIndex = "1051"; shareDialog.style.display = "none"; document.body.appendChild( shareDialog ); var ShareUtil = (function() { return { sharePratilipi: function( pratilipi, utmParams ) { pratilipiForEvent = pratilipi; var getShareUrl = function() { return window.location.origin + pratilipi.pageUrl; }; var getWhatsappText = function() { return '"' + pratilipi.title + '", read it on Pratilipi : ' + getShareUrl() +" Read unlimited stories, poems, articles in Indian languages for FREE!"; }; MetaTagUtil.setMetaTagsForPratilipi( pratilipi ); ga_category = "Pratilipi"; if (getLocation().ga_value == "PratilipiPage") { fbEvent("LANDED_SHARE_CONTENT", null); } this.share( getShareUrl(), getWhatsappText(), utmParams ); }, shareAuthor: function( author, utmParams, eventParams ) { var getShareUrl = function() { return window.location.origin + author.pageUrl; }; var getWhatsappText = function() { return '"' + author.name + '", read it on Pratilipi : ' + getShareUrl() +" Read unlimited stories, poems, articles in Indian languages for FREE!"; }; MetaTagUtil.setMetaTagsForAuthor( author ); ga_category = "Author"; authorForEvent = author; fbEventParams = eventParams; if (getLocation().fb_value) fbAuthorEvent("LANDED_SHARE_AUTHOR", null); this.share( getShareUrl(), getWhatsappText(), utmParams ); }, share: function( url, whatsappText, utmParams ) { shareDialog.style.display = "block"; shareUrl = encodeURIComponent( url + ( utmParams != null ? "?" + new HttpUtil().formatParams( utmParams ) : "" ) ); shareWhatsappText = whatsappText != null ? encodeURIComponent( whatsappText ) : null; $( "#pratilipi-share-dialog" ).modal(); } }; })(); fbEvent = function(event_name, entity_value) { var params = {}; params['ENVIRONMENT'] = 'PROD'; params['CONTENT_LANGUAGE'] = pratilipiForEvent.language; params['SCREEN_NAME'] = getLocation().fb_value; params['LOCATION'] = 'MAIN_SHARE_POPUP'; params['USERID'] = appViewModel.user.userId(); params['PRATILIPI_TYPE'] = pratilipiForEvent.type; params['CONTENT_ID'] = pratilipiForEvent.pratilipiId; params['AUTHOR_ID'] = pratilipiForEvent.author.authorId; params['ACCESS_LEVEL'] = appViewModel.user.author.authorId() == pratilipiForEvent.author.authorId ? 'SELF' : 'OTHER'; if (entity_value != null) params['ENTITY_VALUE'] = entity_value; FB.AppEvents.logEvent(event_name, null, params); }; fbAuthorEvent = function(event_name, entity_value) { var params = {}; params['ENVIRONMENT'] = 'PROD'; params['CONTENT_LANGUAGE'] = appViewModel.language; params['SCREEN_NAME'] = getLocation().fb_value; params['LOCATION'] = 'MAIN_SHARE_POPUP'; params['USERID'] = appViewModel.user.userId(); params['AUTHOR_ID'] = authorForEvent.authorId; params['ACCESS_LEVEL'] = appViewModel.user.author.authorId() == authorForEvent.authorId ? 'SELF' : 'OTHER'; if (entity_value != null) params['ENTITY_VALUE'] = entity_value; if (fbEventParams) { var keys = Object.keys(fbEventParams); for (var i=0; i<keys.length; ++i) { var key = keys[i]; params[key] = fbEventParams[key]; } } FB.AppEvents.logEvent(event_name, null, params); }; /* Helper functions specific to Pratilipi */ function getRetUrl( decoded ) { return getUrlParameter( "retUrl" ) == null ? "/" : ( decoded ? decodeURIComponent( getUrlParameter( "retUrl" ) ) : getUrlParameter( "retUrl" ) ); } function convertDate( date ) { var d = new Date( date ); function day(d) { return (d < 10) ? '0' + d : d; } function month(m) { var months = ['January','February','March', 'April','May','June', 'July','August','September', 'October','November','December']; return months[m]; } return [ day( d.getDate() ), month( d.getMonth() ), d.getFullYear() ].join(' '); } function convertDateWithMinutes( date ) { var d = new Date( date ); function weekday(d) { var days= [ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" ]; return days[d]; } function day(d) { return (d < 10) ? '0' + d : d; } function getHoursMin( h, m ) { var suffix = ( h >= 12 ) ? 'PM' : 'AM'; var hours = h; hours = ( hours > 12 ) ? hours - 12 : hours; hours = ( hours == '00' ) ? 12 : hours; return ( hours + ":" + ( (m < 10) ? '0' + m : m ) + " " + suffix ); } function month(m) { var months = ['January','February','March', 'April','May','June', 'July','August','September', 'October','November','December']; return months[m]; } return [ weekday( d.getDay() ), day( d.getDate() ), month( d.getMonth() ), d.getFullYear(), getHoursMin( d.getHours(), d.getMinutes() ) ].join(' '); } function goToLoginPage( params, loginParams, retUrl ) { var redirectUrl; if( params == null || isEmpty( params ) ) redirectUrl= "/login?retUrl=" + encodeURIComponent( retUrl != null ? retUrl : window.location.pathname ); else redirectUrl= "/login?retUrl=" + encodeURIComponent( ( retUrl != null ? retUrl : window.location.pathname ) + "?" + new HttpUtil().formatParams( params ) ); if( loginParams != null && ! isEmpty( loginParams ) ) { redirectUrl += "&" + new HttpUtil().formatParams( loginParams ); } redirect( redirectUrl ); } function redirect( url, includeCurrentUrlParams ) { if( url == null ) return; if( includeCurrentUrlParams ) url = url + "?" + new HttpUtil().formatParams( getUrlParameters() ); if( sammy != null ) sammy.setLocation( url ); else window.location.href = url; } function sharePratilipiOnFacebook( url ) { window.open( "http://www.facebook.com/sharer.php?u=" + url, "share", "width=1100,height=500,left=70px,top=60px" ); } function sharePratilipiOnTwitter( url ) { window.open( "http://twitter.com/share?url=" + url, "share", "width=1100,height=500,left=70px,top=60px" ); } function sharePratilipiOnGplus( url ) { window.open( "https://plus.google.com/share?url=" + url, "share", "width=1100,height=500,left=70px,top=60px" ); } function sharePratilipiOnWhatsapp( text ) { window.open( "whatsapp://send?text=" + text ); } function getSupportedImageType() { function canUseWebP() { var elem = document.createElement( 'canvas' ); if( !!(elem.getContext && elem.getContext('2d')) ) { return elem.toDataURL( 'image/webp' ).indexOf( 'data:image/webp' ) == 0; } return false; } if( window.canUseWebp == null ) window.canUseWebp = canUseWebP(); return window.canUseWebp ? "webp" : "jpg"; } function getImageUrl( imageUrl, width, compressed ) { if( imageUrl == null ) return null; if( width != null ) imageUrl = imageUrl + ( imageUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + "width=" + width; if( compressed != null ) imageUrl = imageUrl + ( imageUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + "quality=" + ( compressed ? "low" : "high" ); imageUrl = imageUrl + ( imageUrl.indexOf( "?" ) > -1 ? "&" : "?" ) + "type=" + getSupportedImageType(); return imageUrl; } function getPratilipiTypeVernacular( pratilipiType ) { if( pratilipiType == null ) return null; var pratilipiTypes = { "BOOK": "Book", "POEM": "Poem", "STORY": "Story", "ARTICLE": "Article", "MAGAZINE": "Magazine", }; return pratilipiTypes[ pratilipiType ]; } function getLanguageVernacular( language ) { if( language == null ) return null; var languages = { "HINDI": "हिंदी", "GUJARATI": "ગુજરાતી", "TAMIL": "தமிழ்", "MARATHI": "मराठी", "MALAYALAM": "മലയാളം", "BENGALI": "বাংলা", "TELUGU": "తెలుగు", "KANNADA": "ಕನ್ನಡ", }; return languages[ language ]; } function formatReadCount( readCount ) { if( readCount == null ) return null; if( isMobile() ) return readCount > 999 ? (readCount/1000).toFixed(1) + 'k' : readCount; else return readCount.toLocaleString( 'en-US' ); } function getRandomQuote() { var arr = []; function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; } return arr[ getRandomInt( 0, arr.length - 1 ) ]; } /* DataAccessor */ var DataAccessor = function() { var httpUtil = new HttpUtil(); var API_PREFIX = window.location.origin.indexOf( "localhost:8080" ) > -1 ? "https://hindi-gamma.pratilipi.com/api" : "/api"; /* Search */ var SEARCH_PREFIX = "/search"; var SEARCH_TRENDING_API = "/trending_search"; var SEARCH_CORE_API = "/search"; /* Recommendation Api */ var RECOMMENDATION_PREFIX = "/recommendation"; var RECOMMENDATION_PRATILIPI_API = "/pratilipis"; var PAGE_API = "/page"; var PAGE_CONTENT_API = "/page/content"; var PRATILIPI_API = "/pratilipi?_apiVer=2"; var PRATILIPI_LIST_API = "/pratilipi/list?_apiVer=3"; var PRATILIPI_CONTENT_API = "/pratilipi/content"; var PRATILIPI_CONTENT_INDEX_API = "/pratilipi/content/index"; var PRATILIPI_TAGS_UPDATE_API = "/pratilipi/tags/update"; var USER_PRATILIPI_API = "/userpratilipi"; var USER_PRATILIPI_LIBRARY_LIST_API = "/userpratilipi/library/list"; var AUTHOR_API = "/author"; var USER_AUTHOR_FOLLOW_API = "/userauthor/follow?_apiVer=2"; var USER_API = "/user?_apiVer=2"; var USER_LOGIN_API = "/user/login"; var USER_LOGIN_FACEBOOK_API = "/user/login/facebook"; var USER_LOGIN_GOOGLE_API = "/user/login/google"; var USER_REGISTER_API = "/user/register"; var USER_PASSWORD_UPDATE_API = "/user/passwordupdate"; var USER_LOGOUT_API = "/user/logout"; var NOTIFICATION_API = "/notification"; var NOTIFICATION_LIST_API = "/notification/list"; var NAVIGATION_LIST_API = "/navigation/list"; var USER_PRATILIPI_REVIEW_LIST_API = "/userpratilipi/review/list"; var COMMENT_LIST_API = "/comment/list"; var USER_PRATILIPI_REVIEW_API = "/userpratilipi/review"; var USER_AUTHOR_FOLLOW_API = "/userauthor/follow?_apiVer=2"; var USER_PRATILIPI_LIBRARY_API = "/userpratilipi/library"; var COMMENT_API = "/comment"; var VOTE_API = "/vote"; var INIT_API = "/init?_apiVer=2"; var INIT_BANNER_LIST_API = "/init/banner/list"; var USER_AUTHOR_FOLLOW_LIST_API = "/userauthor/follow/list"; var EVENT_API = "/event"; var EVENT_LIST_API = "/event/list"; var BLOG_POST_API = "/blogpost"; var BLOG_POST_LIST_API = "/blogpost/list"; var CONTACT_API = "/contact"; var TAGS_API = "/pratilipi/tags"; var USER_EMAIL_API = "/user/email"; var TOP_AUTHORS_API = "/author/list/readcount"; var request = function( name, api, params ) { return { "name": name, "api": api, "params": params != null ? encodeURIComponent( httpUtil.formatParams( params ) ) : null }; }; var processRequests = function( requests ) { var params = {}; for( var i = 0; i < requests.length; i++ ) { var request = requests[i]; params[ request.name ] = request.api; if( request.params != null ) params[ request.name ] += encodeURIComponent( request.api.indexOf( "?" ) > -1 ? "&" : "?" ) + request.params; } return JSON.stringify( params ); }; var processGetResponse = function( response, status, aCallBack ) { if( aCallBack != null ) aCallBack( status == 200 ? response : null ); }; var processPostResponse = function( response, status, successCallBack, errorCallBack ) { if( status == 200 && successCallBack != null ) successCallBack( response ); else if( status != 200 && errorCallBack != null ) errorCallBack( response ); }; /* GET Methods */ this.getPratilipiByUri = function( pageUri, includeUserPratilipi, aCallBack ) { var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", PRATILIPI_API, { "pratilipiId": "$req1.primaryContentId" } ) ); if( includeUserPratilipi ) requests.push( new request( "req3", USER_PRATILIPI_API, { "pratilipiId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var pratilipi = response.req2 && response.req2.status == 200 ? response.req2.response : null; var userpratilipi = includeUserPratilipi && response.req3 && response.req3.status == 200 ? response.req3.response : null; aCallBack( pratilipi, userpratilipi ); } }); }; this.getPratilipiById = function( pratilipiId, includeUserPratilipi, aCallBack ) { var requests = []; requests.push( new request( "req1", PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); if( includeUserPratilipi ) requests.push( new request( "req2", USER_PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var pratilipi = response.req1 && response.req1.status == 200 ? response.req1.response : null; var userpratilipi = includeUserPratilipi && response.req2 && response.req2.status == 200 ? response.req2.response : null; aCallBack( pratilipi, userpratilipi ); } }); }; this.getPratilipiAndIndex = function( pratilipiId, aCallBack ) { if( pratilipiId == null ) return; var requests = []; requests.push( new request( "req1", PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); requests.push( new request( "req2", USER_PRATILIPI_API, { "pratilipiId": pratilipiId } ) ); requests.push( new request( "req3", PRATILIPI_CONTENT_INDEX_API, { "pratilipiId": pratilipiId } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var pratilipi = response.req1.status == 200 ? response.req1.response : null; var userpratilipi = response.req2.status == 200 ? response.req2.response : null; var index = response.req3.status == 200 ? response.req3.response : null; aCallBack( pratilipi, userpratilipi, index ); } }); }; this.getAuthorByUri = function( pageUri, includeUserAuthor, aCallBack ) { var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", AUTHOR_API, { "authorId": "$req1.primaryContentId" } ) ); if( includeUserAuthor ) requests.push( new request( "req3", USER_AUTHOR_FOLLOW_API, { "authorId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var author = response.req2 && response.req2.status == 200 ? response.req2.response : null; var userauthor = includeUserAuthor && response.req3 && response.req3.status == 200 ? response.req3.response : null; aCallBack( author, userauthor ); } }); }; this.getAuthorById = function( authorId, includeUserAuthor, aCallBack ) { var requests = []; requests.push( new request( "req1", AUTHOR_API, { "authorId": authorId } ) ); if( includeUserAuthor ) requests.push( new request( "req2", USER_AUTHOR_FOLLOW_API, { "authorId": authorId } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var author = response.req1 && response.req1.status == 200 ? response.req1.response : null; var userauthor = includeUserAuthor && response.req2 && response.req2.status == 200 ? response.req2.response : null; aCallBack( author, userauthor ); } }); }; this.getEventByUri = function( pageUri, aCallBack ) { var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", EVENT_API, { "eventId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var event = response.req2.status == 200 ? response.req2.response : null; aCallBack( event ); } }); }; this.getEventById = function( eventId, aCallBack ) { if( eventId == null ) return; httpUtil.get( API_PREFIX + EVENT_API, null, { "eventId": eventId }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getEventList = function( aCallBack ) { httpUtil.get( API_PREFIX + EVENT_LIST_API, null, { "language": "ENGLISH" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getBlogPostByUri = function( pageUri, aCallBack ) { var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); requests.push( new request( "req2", BLOG_POST_API, { "blogPostId": "$req1.primaryContentId" } ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var blogpost = response.req2.status == 200 ? response.req2.response : null; aCallBack( blogpost ); } }); }; this.getBlogPostListByUri = function( pageUri, state, cursor, resultCount, aCallBack ) { var requests = []; requests.push( new request( "req1", PAGE_API, { "uri": pageUri } ) ); var params = { "blogId": "$req1.primaryContentId", "language": "ENGLISH" }; params[ "state" ] = state != null ? state : "PUBLISHED"; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; requests.push( new request( "req2", BLOG_POST_LIST_API, params ) ); httpUtil.get( API_PREFIX, null, { "requests": processRequests( requests ) }, function( response, status ) { if( aCallBack != null ) { var blogpost = response.req2.status == 200 ? response.req2.response : null; aCallBack( blogpost ); } }); }; this.getUser = function( aCallBack ) { httpUtil.get( API_PREFIX + USER_API, null, null, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getUserById = function( userId, aCallBack ) { if( userId == null ) return; httpUtil.get( API_PREFIX + USER_API, null, { "userId": userId }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getNotificationList = function( cursor, resultCount, aCallBack ) { var params = {}; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + NOTIFICATION_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getNavigationList = function( aCallBack ) { httpUtil.get( API_PREFIX + NAVIGATION_LIST_API, null, { "language": "ENGLISH" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getReviewList = function( pratilipiId, cursor, offset, resultCount, aCallBack ) { if( pratilipiId == null ) return; var params = { "pratilipiId": pratilipiId }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_PRATILIPI_REVIEW_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getReviewCommentList = function( userPratilipiId, cursor, resultCount, aCallBack ) { if( userPratilipiId == null ) return; var params = { "parentType": "REVIEW", "parentId": userPratilipiId }; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + COMMENT_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListByListName = function( listName, cursor, offset, resultCount, aCallBack ) { if( listName == null ) return; var params = { "listName": listName, "state": "PUBLISHED", "language": "ENGLISH" }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListBySearchQuery = function( searchQuery, cursor, offset, resultCount, aCallBack ) { if( searchQuery == null ) return; var params = { "searchQuery": searchQuery, "state": "PUBLISHED", "language": "ENGLISH" }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListByAuthor = function( authorId, state, cursor, offset, resultCount, aCallBack ) { if( authorId == null ) return; var params = { "authorId": authorId, "state": state != null ? state : "PUBLISHED" }; if( state == "DRAFTED" ) params[ "orderByListingDate" ] = false; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiListByEventId = function( eventId, cursor, offset, resultCount, aCallBack ) { if( eventId == null ) return; var params = { "eventId": eventId, "state": "PUBLISHED" }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + PRATILIPI_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getUserLibraryList = function( cursor, resultCount, aCallBack ) { var params = {}; if( cursor != null ) params[ "cursor" ] = cursor; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_PRATILIPI_LIBRARY_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getHomePageSections = function( aCallBack ) { httpUtil.get( API_PREFIX + INIT_API, null, { "language": "ENGLISH" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getHomePageBanners = function( aCallBack ) { httpUtil.get( API_PREFIX + INIT_BANNER_LIST_API, null, { "language": "ENGLISH" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getAuthorFollowers = function( authorId, cursor, offset, resultCount, aCallBack ) { if( authorId == null ) return; var params = { "authorId": authorId }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_AUTHOR_FOLLOW_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getUserFollowing = function( userId, cursor, offset, resultCount, aCallBack ) { if( userId == null ) return; var params = { "userId": userId }; if( cursor != null ) params[ "cursor" ] = cursor; if( offset != null ) params[ "offset" ] = offset; if( resultCount != null ) params[ "resultCount" ] = resultCount; httpUtil.get( API_PREFIX + USER_AUTHOR_FOLLOW_LIST_API, null, params, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPageContent = function( pageName, aCallBack ) { if( pageName == null ) return; httpUtil.get( API_PREFIX + PAGE_CONTENT_API, null, { "pageName": pageName, "language": "ENGLISH" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiContent = function( pratilipiId, chapterNo, oldContent, aCallBack ) { if( pratilipiId == null ) return; /* chapterNo can be null for IMAGE contents */ httpUtil.get( API_PREFIX + PRATILIPI_CONTENT_API, null, { "pratilipiId": pratilipiId, "chapterNo": chapterNo, "_apiVer": oldContent ? 1 : 3 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; /* Recommendation Service */ function getRecommendationHeaders() { return { "AccessToken": getCookie( "access_token" ), "Version": "1.0" }; }; this.getPratilipiRecommendation = function( contextId, context, resultCount, aCallBack ) { if( contextId == null ) return; httpUtil.get( API_PREFIX + RECOMMENDATION_PREFIX + RECOMMENDATION_PRATILIPI_API, getRecommendationHeaders(), { "contextId": contextId, "context": context, "resultCount": resultCount }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; /* Search Service */ function getSearchHeaders() { return { "AccessToken": getCookie( "access_token" ), "Version": "1.0" }; }; this.getTrendingSearchKeywords = function( aCallBack ) { httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_TRENDING_API, getSearchHeaders(), { "language": "ENGLISH" }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getInitialSearchResults = function( searchQuery, aCallBack ) { if( searchQuery == null ) return; httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_CORE_API, getSearchHeaders(), { "language": "ENGLISH", "text": searchQuery.trim() }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getPratilipiSearchResults = function( searchQuery, cursor, resultCount, aCallBack ) { if( searchQuery == null || cursor == null ) return; httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_CORE_API, getSearchHeaders(), { "language": "ENGLISH", "text": searchQuery.trim(), "pratilipiCursor": cursor, "pratilipiResultCount": resultCount != null ? resultCount : 20, "authorResultCount": 0 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; this.getAuthorSearchResults = function( searchQuery, cursor, resultCount, aCallBack ) { if( searchQuery == null || cursor == null ) return; httpUtil.get( API_PREFIX + SEARCH_PREFIX + SEARCH_CORE_API, getSearchHeaders(), { "language": "ENGLISH", "text": searchQuery.trim(), "authorCursor": cursor, "authorResultCount": resultCount != null ? resultCount : 10, "pratilipiResultCount": 0 }, function( response, status ) { processGetResponse( response, status, aCallBack ) } ); }; /* POST Methods */ this.createOrUpdateUser = function( userId, email, phone, successCallBack, errorCallBack ) { if( userId == null ) return; var params = { "userId": userId }; if( email != null ) params[ "email" ] = email; if( phone != null ) params[ "phone" ] = phone; httpUtil.post( API_PREFIX + USER_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateAuthor = function( author, successCallBack, errorCallBack ) { if( author == null || isEmpty( author ) || author.authorId == null ) return; httpUtil.post( API_PREFIX + AUTHOR_API, null, author, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateReview = function( pratilipiId, rating, review, successCallBack, errorCallBack ) { if( pratilipiId == null ) return; var params = { "pratilipiId": pratilipiId }; if( rating != null ) params[ "rating" ] = rating; if( review != null ) { params[ "review" ] = review; params[ "reviewState" ]= "PUBLISHED"; } httpUtil.post( API_PREFIX + USER_PRATILIPI_REVIEW_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdateReviewComment = function( userPratilipiId, commentId, content, successCallBack, errorCallBack ) { if( userPratilipiId == null && commentId == null ) return; var params = { "state": "ACTIVE" }; if( userPratilipiId != null ) { params[ "parentId" ] = userPratilipiId; params[ "parentType" ] = "REVIEW"; } if( commentId != null ) params[ "commentId" ] = commentId; if( content != null ) params[ "content" ] = content; httpUtil.post( API_PREFIX + COMMENT_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }, this.followOrUnfollowAuthor = function( authorId, following, successCallBack, errorCallBack ) { if( authorId == null || following == null ) return; httpUtil.post( API_PREFIX + USER_AUTHOR_FOLLOW_API, null, { "authorId": authorId, "state": following ? "FOLLOWING" : "UNFOLLOWED" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.addOrRemoveFromLibrary = function( pratilipiId, addedToLib, successCallBack, errorCallBack ) { if( pratilipiId == null || addedToLib == null ) return; httpUtil.post( API_PREFIX + USER_PRATILIPI_LIBRARY_API, null, { "pratilipiId": pratilipiId, "addedToLib": addedToLib }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.likeOrDislikeReview = function( userPratilipiId, isLiked, successCallBack, errorCallBack ) { if( userPratilipiId == null || isLiked == null ) return; httpUtil.post( API_PREFIX + VOTE_API, null, { "parentId": userPratilipiId, "parentType": "REVIEW", "type": isLiked ? "LIKE" : "NONE" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.likeOrDislikeComment = function( commentId, isLiked, successCallBack, errorCallBack ) { if( commentId == null || isLiked == null ) return; httpUtil.post( API_PREFIX + VOTE_API, null, { "parentId": commentId, "parentType": "COMMENT", "type": isLiked ? "LIKE" : "NONE" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.deleteReview = function( pratilipiId, successCallBack, errorCallBack ) { if( pratilipiId == null ) return; var params = { "pratilipiId": pratilipiId, "reviewState": "DELETED" }; httpUtil.post( API_PREFIX + USER_PRATILIPI_REVIEW_API, null, params, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.deleteComment = function( commentId, successCallBack, errorCallBack ) { if( commentId == null ) return; httpUtil.post( API_PREFIX + COMMENT_API, null, { "commentId": commentId, "state": "DELETED" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.createOrUpdatePratilipi = function( pratilipi, successCallBack, errorCallBack ) { if( pratilipi == null ) return; if( pratilipi[ "pratilipiId" ] == null ) pratilipi[ "oldContent" ] = false; httpUtil.post( API_PREFIX + PRATILIPI_API, null, pratilipi, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginUser = function( email, password, successCallBack, errorCallBack ) { if( email == null || password == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_API, null, { "email": email, "password": password }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginGoogleUser = function( googleIdToken, successCallBack, errorCallBack ) { if( googleIdToken == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_GOOGLE_API, null, { "googleIdToken": googleIdToken }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.loginFacebookUser = function( fbUserAccessToken, successCallBack, errorCallBack ) { if( fbUserAccessToken == null ) return; httpUtil.post( API_PREFIX + USER_LOGIN_FACEBOOK_API, null, { "fbUserAccessToken": fbUserAccessToken }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.registerUser = function( name, email, password, successCallBack, errorCallBack ) { if( name == null || email == null || password == null ) return; httpUtil.post( API_PREFIX + USER_REGISTER_API, null, { "name": name, "email": email, "password": password, "language": "ENGLISH" }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.updateUserPassword = function( password, newPassword, successCallBack, errorCallBack ) { if( password == null || newPassword == null ) return; httpUtil.post( API_PREFIX + USER_PASSWORD_UPDATE_API, null, { "password": password, "newPassword": newPassword }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.forgotPassword = function( email, successCallBack, errorCallBack ) { if( email == null ) return; httpUtil.post( API_PREFIX + USER_EMAIL_API, null, { "email": email, "sendPasswordResetMail": true }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.resetUserPassword = function( email, verificationToken, newPassword, successCallBack, errorCallBack ) { if( email == null || verificationToken == null || newPassword == null ) return; httpUtil.post( API_PREFIX + USER_PASSWORD_UPDATE_API, null, { "email": email, "verificationToken": verificationToken, "newPassword": newPassword }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.logoutUser = function( successCallBack, errorCallBack ) { httpUtil.get( API_PREFIX + USER_LOGOUT_API, null, null, function( response, status ) { status == 200 ? successCallBack( response ) : errorCallBack( response ); /* Logout is different from all other cases */ }); }; this.updateNotificationState = function( notificationId, state, successCallBack, errorCallBack ) { if( notificationId == null || state == null ) return; httpUtil.post( API_PREFIX + NOTIFICATION_API, null, { "notificationId": notificationId, "state": state }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.getTags = function( language, type, aCallBack ) { if( language == null || type == null ) return; httpUtil.get( API_PREFIX + TAGS_API, null, { "type": type, "language": language }, function( response, status ) { processGetResponse(response, status, aCallBack) }); }; this.updatePratilipiTags = function( pratilipiId, type, tagIds, suggestedTags, successCallBack, errorCallBack ) { if( pratilipiId == null ) return; httpUtil.post( API_PREFIX + PRATILIPI_TAGS_UPDATE_API, null, { "pratilipiId": pratilipiId, "type": type, "tagIds": JSON.stringify( tagIds ), "suggestedTags": JSON.stringify( suggestedTags ) }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.reportContent = function( message, successCallBack, errorCallBack ) { if( message == null || message.trim() == "" ) return; httpUtil.post( API_PREFIX + CONTACT_API, null, { "team": "AEE_ENGLISH", "message": message }, function( response, status ) { processPostResponse( response, status, successCallBack, errorCallBack ) } ); }; this.getYesterdayTopAuthors = function(language, resultCount, aCallBack) { httpUtil.get(API_PREFIX + TOP_AUTHORS_API, null, {"language": language, "resultCount": resultCount}, function(response, status) { processGetResponse(response, status, aCallBack) }); }; }; ko.bindingHandlers.seeMore = { /* Used in summary page */ update: function( element, valueAccessor, allBindings, viewModel, bindingContext ) { var p = $( element ).find( "p" ); p.text( viewModel.originalText() ); setTimeout( function() { var pHeight = p.height(); var pAllowedLineHeight = parseFloat( p.css( "line-height" ) ) * 3; var isViewMoreVisible = pHeight > pAllowedLineHeight; viewModel.isViewMoreVisible( isViewMoreVisible ); viewModel.maxHeightPx( isViewMoreVisible ? pAllowedLineHeight + 'px' : 'initial' ); }, 0 ); } }; ko.bindingHandlers.seeMoreText = { /* Used in Author page */ update: function( element, valueAccessor, allBindings, viewModel, bindingContext ) { var text = valueAccessor().value; var numberOfLines = valueAccessor().lines != null ? valueAccessor().lines : 1; if( text == null ) { $( element ).css( "visibility", "hidden" ); return; } $( element ).css( "visibility", "visible" ); setTimeout( function() { var target_width = $( element ).parent().width(); var span = document.createElement( 'span' ); span.style.position = "absolute"; span.style.top = "-1000px"; span.style.whiteSpace = 'nowrap'; span.style.fontFamily = $( element ).css( "font-family" ); span.style.fontSize = $( element ).css( "font-size" ); span.innerHTML = " ... " + "(show more)"; document.body.appendChild( span ); var fit = text.length; for( var i = 0; i < fit; i++ ) { span.innerHTML += text[i]; if( span.clientWidth > target_width ) { fit = i - 1; break; } } document.body.removeChild( span ); var characterLimit = fit * numberOfLines; if( text.length <= characterLimit ) { $( element ).html( text ); $( element ).css( "white-space", "pre-wrap" ); return; } var observer = function() { $( element ).find( "a" ).click( function( e ) { var state = e.currentTarget.getAttribute( "data-shown" ); if( state == "less" ) showMore(); else if( state == "more" ) showLess( true ); }); }; var showMore = function() { var res = text + " " + "<a style='white-space: nowrap;' data-shown='more' href='#'>(show less)</a>"; $( element ).html( res ); $( element ).css( "white-space", "pre-wrap" ); observer(); }; var showLess = function( scrollToTop ) { var res = text.substring( 0, characterLimit ) + " ... " + "<a style='white-space: nowrap;' data-shown='less' href='#'>(show more)</a>"; $( element ).html( res ); $( element ).css( "white-space", "normal" ); observer(); if( scrollToTop ) { var pos = $( element ).position().top; if( pos < appViewModel.scrollTop() ) appViewModel.scrollToTop( pos ); } }; showLess( false ); }, 0 ); } }; ko.bindingHandlers.slideIn = { init: function( element, valueAccessor ) { var value = ko.utils.unwrapObservable( valueAccessor() ); $(element).toggle( value ); }, update: function( element, valueAccessor ) { var value = ko.utils.unwrapObservable( valueAccessor() ); value ? $(element).slideDown() : $(element).slideUp(); } }; ko.bindingHandlers.transliterate = { init: function( element, valueAccessor ) { var $content_object = $(element); var content_transliteration_object = new transliterationApp( $content_object, "en" ); content_transliteration_object.init(); }, }; /* http://stackoverflow.com/questions/32957407/material-design-lite-how-to-programatically-reset-a-floating-label-input-text#32958279 */ ko.bindingHandlers.mdlFloatingInput = { init: function( element, valueAccessor, allBindingsAccessor, data, context ) { var $el = $(element), $enclosingDiv = $( '<div>' ).insertAfter( $el ), $label = $( '<label>' ), params = valueAccessor(); $el.attr( 'id', params.id ); $label.attr( 'for', params.id ).text( params.label ); $el.addClass( 'mdl-textfield__input' ); $label.addClass( 'mdl-textfield__label' ); $enclosingDiv.addClass( "mdl-textfield mdl-js-textfield mdl-textfield--floating-label" ).append( $el ).append( $label ); ko.bindingHandlers.value.init( element, function () { return params.value; }, allBindingsAccessor, data, context ); }, update: function( element, valueAccessor, allBindingsAccessor, data, context ) { var params = valueAccessor(), value = params.value(); ko.bindingHandlers.value.update( element, function () { return params.value; }, allBindingsAccessor, data, context ); $(element).parent()[ value ? 'addClass' : 'removeClass' ]( 'is-dirty' ); } }; ko.bindingHandlers.mdlInput = { init: function( element, valueAccessor, allBindingsAccessor, data, context ) { var $el = $(element), $enclosingDiv = $( '<div>' ).insertAfter( $el ), $label = $( '<label>' ), params = valueAccessor(); $el.attr( 'id', params.id ); $label.attr( 'for', params.id ).text( params.label ); $el.addClass( 'mdl-textfield__input' ); $label.addClass( 'mdl-textfield__label' ); $enclosingDiv.addClass( "mdl-textfield mdl-js-textfield" ).append( $el ).append( $label ); ko.bindingHandlers.value.init( element, function () { return params.value; }, allBindingsAccessor, data, context ); }, update: function( element, valueAccessor, allBindingsAccessor, data, context ) { var params = valueAccessor(), value = params.value(); ko.bindingHandlers.value.update( element, function () { return params.value; }, allBindingsAccessor, data, context ); $(element).parent()[ value ? 'addClass' : 'removeClass' ]( 'is-dirty' ); } }; /* HammerJs */ var events = [ 'tap', 'doubletap', 'hold', 'rotate', 'drag', 'dragstart', 'dragend', 'dragleft', 'dragright', 'dragup', 'dragdown', 'transform', 'transformstart', 'transformend', 'swipe', 'swipeleft', 'swiperight', 'swipeup', 'swipedown', 'pinch', 'pinchin', 'pinchout' ]; ko.utils.arrayForEach( events, function( eventName ) { ko.bindingHandlers[eventName] = { init: function( element, valueAccessor ) { var hammer = new Hammer( element ); var value = valueAccessor(); hammer.on( eventName, function(e) { value(e); }); } } }); ko.bindingHandlers.carousel = { update: function( element, valueAccessor, allBindingsAccessor, data, context ) { if( ! valueAccessor() ) return; setTimeout( function() { var carousel_wrapper = $( element ).find( '.carousel-wrapper' ); var carousel = $( carousel_wrapper ).find( '.carousel' ); var ul = $( carousel ).find( 'ul' ); var li_width = ul.find( 'li' ).outerWidth(); var button = $( element ).find( 'button[action]' ); var scrollWidth = $( carousel_wrapper )[0].scrollWidth; var width = $( carousel_wrapper ).width(); var visible_elements = parseInt( width / li_width ); var translateX = 0; var setTranslate = function() { $( carousel ).css({ '-webkit-transform' : 'translateX(' + translateX + 'px)', '-moz-transform' : 'translateX(' + translateX + 'px)', '-ms-transform' : 'translateX(' + translateX + 'px)', '-o-transform' : 'translateX(' + translateX + 'px)', 'transform' : 'translateX(' + translateX + 'px)' }); }; var showPrev = function() { var threshold = 0; if( translateX == threshold ) { translateX = 30; setTranslate(); setTimeout( function() { translateX = threshold; setTranslate(); }, 200 ); } else { translateX = Math.min( 0, translateX + ( visible_elements * li_width ) ); setTranslate(); } }; var showNext = function() { var threshold = width - scrollWidth; if( translateX == threshold ) { translateX = threshold - 30; setTranslate(); setTimeout( function() { translateX = threshold; setTranslate(); }, 200 ); } else { translateX = Math.max( width - scrollWidth, translateX - ( visible_elements * li_width ) ); setTranslate(); } }; var hammer = new Hammer( element ); hammer.on( 'swipeleft', function(e) { showNext(); }); hammer.on( 'swiperight', function(e) { showPrev(); }); $( button ).click( function(e) { var action = $( e.currentTarget ).attr( 'action' ); if( action == "prev" ) showPrev(); else if( action == "next" ) showNext(); }); }, 0 ); } };/* Google Analytics */ /* * GA has 4 parameters to record: * Category, Action, Label, Value * * https://drive.google.com/drive/u/1/folders/0B1GuDK5-Y90aVE0zVldHRm95RU0 * Event Category => The entity being tracked - pratilipi, author, notification, review etc. * Event Action => The action the user is taking. * Event Label => The page / location from where it is taken. * Event Value => Search Keyword only * * * Function Names and Definition: * ga_CALV => category, action, location, value * ga_CAL => category, action, location * ga_CA => category, action * */ function ga_CALV( category, action, location, value ) { if( category == null || action == null || location == null || value == null ) { console.log( "ga_CALV". category, action, location, value ); return; } ga( 'send', 'event', category, action, location, value ); return true; } function ga_CAL( category, action, location ) { if( category == null || action == null || location == null ) { console.log( "ga_CAL", category, action, location ); return; } ga( 'send', 'event', category, action, location ); return true; } function ga_CA( category, action ) { if( category == null || action == null ) { console.log( "ga_CA", category, action ); return; } ga_CAL( category, action, getLocation().ga_value ); } function ga_CAV( category, action, value ) { if( category == null || action == null || value == null ) { console.log( "ga_CAV", category, action ); return; } ga_CALV( category, action, getLocation().ga_value, value ); }function Timer( fn, t ) { /* http://stackoverflow.com/questions/8126466/javascript-reset-setinterval-back-to-0 */ var timerObj = setInterval( fn, t ); this.stop = function() { if( timerObj ) { clearInterval( timerObj ); timerObj = null; } return this; }; /* start timer using current settings (if it's not already running) */ this.start = function() { if( !timerObj ) { this.stop(); timerObj = setInterval( fn, t ); } return this; }; /* start with new interval, stop current interval */ this.reset = function( newT ) { if( newT ) t = newT; return this.stop().start(); }; }(function($, ko) { /* https://github.com/seantimm/Knockout.LazyLoad/blob/master/ko.lazyload.js */ 'use strict'; function KoLazyLoad() { var self = this; var updatebit = ko.observable(true).extend({ throttle: 50 }); var handlers = { img: updateImage }; function flagForLoadCheck() { updatebit( !updatebit() ); } $(window).on( 'scroll', flagForLoadCheck ); $(window).on( 'resize', flagForLoadCheck ); function isInViewport(element) { var rect = element.getBoundingClientRect(); return rect.bottom > 0 && rect.right > 0 && rect.top < (window.innerHeight || document.documentElement.clientHeight) && rect.left < (window.innerWidth || document.documentElement.clientWidth); } function updateImage(element, valueAccessor, allBindings, viewModel, bindingContext) { var value = ko.unwrap( valueAccessor() ); if( isInViewport(element) ) { element.src = value; $(element).data('kolazy', true); } } function init(element, valueAccessor, allBindings, viewModel, bindingContext) { var initArgs = arguments; updatebit.subscribe(function() { update.apply(self, initArgs); }); } function update(element, valueAccessor, allBindings, viewModel, bindingContext) { var $element = $(element); if ($element.is(':hidden') || $element.css('visibility') == 'hidden' || $element.data('kolazy')) { return; } var handlerName = element.tagName.toLowerCase(); if (handlers.hasOwnProperty(handlerName)) { return handlers[handlerName].apply(this, arguments); } else { throw new Error('No lazy handler defined for "' + handlerName + '"'); } } return { handlers: handlers, init: init, update: update } } ko.bindingHandlers.lazyload = new KoLazyLoad(); })(jQuery, ko); </script> <script> /* Test Environment */ var isTestEnvironment = true; var aEEUserIdList = []; aEEUserIdList.push( 5644707593977856 );aEEUserIdList.push( 6243664397336576 );aEEUserIdList.push( 4900189601005568 );aEEUserIdList.push( 4790800105865216 );aEEUserIdList.push( 5664902681198592 );aEEUserIdList.push( 4900071594262528 );aEEUserIdList.push( 5694768648552448 );aEEUserIdList.push( 6264191547604992 );aEEUserIdList.push( 5187684625547264 );aEEUserIdList.push( 5715256422694912 );aEEUserIdList.push( 6311393362968576 );aEEUserIdList.push( 5373377891008512 );aEEUserIdList.push( 5743817900687360 );aEEUserIdList.push( 5666355716030464 );aEEUserIdList.push( 5124071978172416 );aEEUserIdList.push( 5013864096727040 );aEEUserIdList.push( 6046961763352576 );aEEUserIdList.push( 5991416564023296 );aEEUserIdList.push( 4908348089565184 );aEEUserIdList.push( 5073076857339904 ); /* Location */ var LOCATION = { HOME: { ga_value: "HomePage", ko_element: "pratilipi-home-page", fb_value: "HOME" }, LIST: { ga_value: "ListPage", ko_element: "pratilipi-list-page" }, LIBRARY: { ga_value: "LibraryPage", ko_element: "pratilipi-library-page" }, SEARCH : { ga_value: "SearchPage", ko_element: "pratilipi-search-page" }, SEARCH_V2: { ga_value: "SearchPage", ko_element: "pratilipi-search-page-v2", hide_appshell: true }, EVENTS: { ga_value: "AllEventsPage", ko_element: "pratilipi-event-list-page" }, EVENT: { ga_value: "EventPage", ko_element: "pratilipi-event-page" }, AUTHOR: { ga_value: "AuthorPage", ko_element: "pratilipi-author-page", fb_value: "AUTHOR_PAGE" }, USER: { ga_value: "UserPage", ko_element: "pratilipi-author-page" }, PRATILIPI: { ga_value: "PratilipiPage", ko_element: "pratilipi-pratilipi-page", fb_value: "PRATILIPI_PAGE" }, LOGIN: { ga_value: "LoginPage", ko_element: "pratilipi-login-page", hide_appshell: true }, REGISTER: { ga_value: "RegisterPage", ko_element: "pratilipi-register-page", hide_appshell: true }, FORGOT_PASSWORD: { ga_value: "ForgotPasswordPage", ko_element: "pratilipi-forgot-password-page", hide_appshell: true }, RESET_PASSWORD: { ga_value: "ResetPasswordPage", ko_element: "pratilipi-reset-password-page", hide_appshell: true }, VERIFY_USER: { ga_value: "VerifyUserPage", ko_element: "pratilipi-verify-user-page", hide_appshell: true }, NOTIFICATIONS: { ga_value: "NotificationsPage", ko_element: "pratilipi-notifications-page" }, SETTINGS: { ga_value: "UserSettings", ko_element: "pratilipi-settings-page" }, BLOG: { ga_value: "AllBlogsPage", ko_element: "pratilipi-blog-page" }, AUTHOR_INTERVIEWS: { ga_value: "AllAuthorInterviewsPage", ko_element: "pratilipi-blog-page" }, BLOG_POST: { ga_value: "BlogPage", ko_element: "pratilipi-blog-post-page" }, AUTHOR_INTERVIEW_POST: { ga_value: "AuthorInterviewPage", ko_element: "pratilipi-blog-post-page" }, PRATILIPI_2016: { ga_value: "Pratilipi2016Page", ko_element: "pratilipi-pratilipi2016-page" }, STATIC: { ga_value: "StaticPage", ko_element: "pratilipi-static-page" }, MY_PROFILE: { ga_value: "MyProfilePage", ko_element: "pratilipi-myprofile-page" }, PAGE_NOT_FOUND: { ga_value: "PageNotFound", ko_element: "pratilipi-pagenotfound-page" }, READER: { ga_value: "Reader", ko_element: "pratilipi-reader", hide_appshell: true }, WRITER: { ga_value: "Writer", ko_element: null, fb_value: "WRITER_PANEL" } }; function getLocation( location ) { String.prototype.count = function( s1 ) { return ( this.length - this.replace( new RegExp(s1,"g"), '' ).length ) / s1.length; }; if( location == null ) location = window.location.pathname; if( location == "/" ) return LOCATION.HOME; else if( location == "/library" ) return LOCATION.LIBRARY; else if( location == "/search" ) return LOCATION.SEARCH_V2; /* return appViewModel && appViewModel.isAEETestEnvironment() ? LOCATION.SEARCH_V2 : LOCATION.SEARCH; */ else if( location == "/login" ) return LOCATION.LOGIN; else if( location == "/register" ) return LOCATION.REGISTER; else if( location == "/forgot-password" ) return LOCATION.FORGOT_PASSWORD; else if( location == "/reset-password" ) return LOCATION.RESET_PASSWORD; else if( location == "/verify-user" ) return LOCATION.VERIFY_USER; else if( location == "/notifications" ) return LOCATION.NOTIFICATIONS; else if( location == "/settings" ) return LOCATION.SETTINGS; else if( location == "/events" ) return LOCATION.EVENTS; else if( location.startsWith( "/event/" ) && location.count( '/' ) == 2 ) return LOCATION.EVENT; else if( location == "/blog" ) return LOCATION.BLOG; else if( location == "/author-interviews" ) return LOCATION.AUTHOR_INTERVIEWS; else if( location.startsWith( "/blog/" ) && location.count( '/' ) == 2 ) return LOCATION.BLOG_POST; else if( location.startsWith( "/author-interviews/" ) && location.count( '/' ) == 2 ) return LOCATION.AUTHOR_INTERVIEW_POST; else if( location.startsWith( "/blogpost/" ) && location.count( '/' ) == 2 ) return LOCATION.BLOG_POST; else if( location == "/pratilipi-2016" ) return LOCATION.PRATILIPI_2016; else if( location == "/my-profile" ) return LOCATION.MY_PROFILE; /* List pages */ else if( location == "/featured" ) return LOCATION.LIST; /* Static pages */ else if( location == "/terms-of-service" ) return LOCATION.STATIC; else if( location == "/privacy-policy" ) return LOCATION.STATIC; else if( location == "/work-with-us" ) return LOCATION.STATIC; /* Reader */ else if( location == "/read" ) return LOCATION.READER; /* Writer */ else if( location == "/write" || location == "/pratilipi-write" ) return LOCATION.WRITER; /* Setting for the first time in case routing is not supported */ else if( location.startsWith( "/author/" ) && location.count( '/' ) == 2 ) return appViewModel == null ? LOCATION.AUTHOR : ( appViewModel.isUserPage() ? LOCATION.USER : LOCATION.AUTHOR ); else if( location.count( '/' ) == 1 ) return appViewModel == null ? LOCATION.AUTHOR : ( appViewModel.isUserPage() ? LOCATION.USER : LOCATION.AUTHOR ); else if( location.startsWith( "/pratilipi/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/book/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/story/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/article/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.startsWith( "/poem/" ) && location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else if( location.count( '/' ) == 2 ) return LOCATION.PRATILIPI; else return LOCATION.PAGE_NOT_FOUND; } var AppViewModel = function() { var defaultUser = { "userId": null, "author": { "authorId": null }, "displayName": null, "email": null, "phone": null, "state": null, "isGuest": true, "isEmailVerified": false, "profilePageUrl": null, "profileImageUrl": null, "firebaseToken": null }; var self = this; this.user = ko.mapping.fromJS( defaultUser, {}, this.user ); this.notificationCount = ko.observable( -1 ); this.searchQuery = ko.observable(); this.pratilipiWriteAuthorId = ko.observable(); this.userPreferences = ko.observable( {} ); this.metaTags = ko.observableArray(); this.pageTitle = ko.observable( "Pratilipi | Pratilipi" ); this.randomQuote = ko.observable( getRandomQuote() ); this.scrollTop = ko.observable(); this.scrollTopObserver = ko.computed( function() { self.scrollTop(); setTimeout( function() { $(window).scroll(); /* Trigger scroll event on window */ } ); }, this ); this.notifyOfScrollEvent = function() { self.scrollTop( Math.max( $( ".mdl-layout" ).scrollTop(), $( ".mdl-layout__content" ).scrollTop() ) ); }; this.scrollToTop = function( scrollTop ) { $( ".mdl-layout" ).animate({ scrollTop: scrollTop != null ? scrollTop : 0 }, 200 ); $( ".mdl-layout__content" ).animate({ scrollTop: scrollTop != null ? scrollTop : 0 }, 200 ); }; this.isUserPage = ko.observable(); /* Used for GA tracking -> When Author is visiting his/her own page. */ /* Routing */ this.hideAppShell = ko.observable( getLocation()[ "hide_appshell" ] != null ? getLocation()[ "hide_appshell" ] : false ); this.currentView = ko.observable( getLocation()[ "ko_element" ] ); this.currentLocation = ko.observable(); /* Reader - Persisting Settings as cookies alone might not work well */ this.readerFontSize = ko.observable(); /* Font Size: 12px - 32px */ this.readerImageSize = ko.observable(); /* Image Size: 300px - 1500px */ this.readerTheme = ko.observable(); /* 3 States: NORMAL, NIGHT, SEPIA */ this.readerLineHeight = ko.observable(); /* 3 States: SMALL, MEDIUM, LARGE */ /* Test Environment */ this.isTestEnvironment = isTestEnvironment; this.isAEETestEnvironment = ko.computed( function() { return this.isTestEnvironment || aEEUserIdList.indexOf( this.user.userId() ) !== -1; }, this ); /* Setting searchQuery */ this.locationObserver = ko.computed( function() { this.searchQuery( this.currentLocation() == "/search" && getUrlParameter( "q" ) != null ? decodeURI( getUrlParameter( "q" ) ) : null ); }, this ); /* Setting language */ this.language = "ENGLISH"; }; var appViewModel = new AppViewModel(); /* Random Quote */ var randomQuoteTimer = new Timer( function() { /* Refer TimerUtil.js */ appViewModel.randomQuote( getRandomQuote() ); }, 5000); var initFirebase = function() { if( appViewModel.user.isGuest() ) return; var firebaseLibrary = document.createElement( 'script' ); firebaseLibrary.setAttribute( "src", "https://www.gstatic.com/firebasejs/3.6.10/firebase.js" ); firebaseLibrary.onload = function() { var config = { apiKey: "AIzaSyAAnK0-vDmY1UEcrRRbCzXgdpF2oQn-E0w", authDomain: "prod-pratilipi.firebaseapp.com", databaseURL: "https://prod-pratilipi.firebaseio.com", projectId: "prod-pratilipi", storageBucket: "prod-pratilipi.appspot.com", }; firebase.initializeApp( config ); firebase.auth().onAuthStateChanged( function( fbUser ) { if( fbUser ) { var newNotificationCountNode = firebase.database().ref( "NOTIFICATION" ).child( fbUser.uid ).child( "newNotificationCount" ); newNotificationCountNode.on( 'value', function( snapshot ) { var newNotificationCount = snapshot.val() != null ? snapshot.val() : 0; appViewModel.notificationCount( newNotificationCount ); }); var userPreferencesNode = firebase.database().ref( "PREFERENCE" ).child( fbUser.uid ); userPreferencesNode.on( 'value', function( snapshot ) { var userPreferences = snapshot.val() != null ? snapshot.val() : {}; appViewModel.userPreferences( userPreferences ); }); } else { firebase.auth().signInWithCustomToken( appViewModel.user.firebaseToken() ); } }); }; document.body.appendChild( firebaseLibrary ); }; var setFbAnalyticsUser = function() { FB.AppEvents.setUserID(appViewModel.user.userId().toString()); }; var resetFbNotificationCount = function() { var node = firebase.database().ref( "NOTIFICATION" ).child( appViewModel.user.userId() ).child( "newNotificationCount" ); node.set( 0 ); }; var setUserPreferences = function( userPreferences ) { var node = firebase.database().ref( "PREFERENCE" ).child( appViewModel.user.userId() ); node.set({ "emailFrequency": userPreferences[ "emailFrequency" ], "notificationSubscriptions": userPreferences[ "notificationSubscriptions" ], "lastUpdated": firebase.database.ServerValue.TIMESTAMP }); }; var updateUser = function() { var dataAccessor = new DataAccessor(); dataAccessor.getUser( function( user ) { ko.mapping.fromJS( user, {}, appViewModel.user ); initFirebase(); setFbAnalyticsUser(); }); }; ko.applyBindings( appViewModel, document.getElementsByTagName("html")[0] ); updateUser(); var sammy = Sammy(function () { var regex = "^(?!\/pratilipi-write$|\/write$|\/admin$|\/admin\/.*|\/edit-event$|\/edit-blog$).*$"; this.get( regex, function () { /* Hack - Followers page not implemented yet */ if( window.location.pathname == "/followers" ) { redirect( "/my-profile", true ); } var location = getLocation(); appViewModel.currentView( location[ "ko_element" ] ); appViewModel.currentLocation( window.location.pathname ); appViewModel.hideAppShell( location.hide_appshell != null ? location.hide_appshell : false ); /* Scroll to Top */ appViewModel.scrollToTop(); /* Random Quote */ appViewModel.randomQuote( getRandomQuote() ); randomQuoteTimer.reset(); /* Mdl sucks */ setTimeout( function() { if( typeof( componentHandler ) !== 'undefined' ) componentHandler.upgradeDom(); }, 0 ); /* GoogleAnalytics Pageview */ if( ! appViewModel.user.isGuest() ) ga( 'set', 'userId', appViewModel.user.userId() ); ga( 'set', 'page', window.location.href ); ga( 'set', 'dimension1', appViewModel.user.userId() == null ? 0 : appViewModel.user.userId() ); ga( 'set', 'dimension2', 'PWA' ); ga( 'set', 'dimension3', 'Standard' ); ga( 'set', 'dimension4', 'Mark-7' ); ga( 'send', 'pageview' ); /* Notification Read */ if( getUrlParameter( "notifId" ) != null ) new DataAccessor().updateNotificationState( getUrlParameter( "notifId" ), "READ" ); } ); this.post( '.*', function() { return false; }); this._checkFormSubmission = function( form ) { return (false); }; }).run(); </script> <script src="https://www.ptlp.co/resource-all/pwa/js/bmg.js"></script> <script type="text/javascript"> if( 'serviceWorker' in navigator ) { navigator.serviceWorker.register( '/pwa-sw-GAMMA_ALL_LANGUAGE_GR.js' ); } </script> <style> .word-suggester { position: absolute; padding: 10px; border: whitesmoke 1px solid; display: inline-block; min-width: 100px; display: none; background: white; z-index: 65538; font-size: 16px; } .word-input { border: none; display: inline-block; border-right: 2px grey solid; } .suggestion { cursor: pointer; line-height: 24px; } .highlight-suggestion { background: lightgrey; font-weight: 700; } </style> </html>
