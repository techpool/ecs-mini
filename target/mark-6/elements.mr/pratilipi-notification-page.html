<dom-module id="pratilipi-notification-settings">

	<style>

		:host {
			display: block;
		}

		.pratilipi-logo {
			width: 64px;
			height: 64px;
			display: block;
			margin: auto;
			margin-bottom: 12px;
		}
		
		paper-dropdown-menu.pratilipi-blue {
			width: 100%;
			--paper-dropdown-menu-focus-color: #107fe5;
			--paper-dropdown-menu-input-color: #107fe5;
			--primary-text-color: #107fe5;
			--paper-input-container: {
				color: #107fe5;
			};
			--paper-input-container-input: {
				font-family: inherit;
				color: #333;
			};
			--paper-input-container-underline: {
				background: #333;
				color: #333;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: inherit;
				text-align: left;
				color: #333;
			};
			--paper-input-container-focus:{
				color: #333;
			};
		}
		
		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #333;
			};
			--paper-item-focused-before: {
				color: #333;
				background: #fff;
			};
		}
		
		paper-menu paper-item {
			font-size: 15px;
			font-family: inherit;
			color: #333;
			white-space: nowrap;
		}
		
		paper-checkbox.pratilipi-blue {
			align-self: center;
			--paper-checkbox-checked-color: #107fe5;
			--paper-checkbox-checked-ink-color: #333;
			--paper-checkbox-unchecked-color: #107fe5;
			--paper-checkbox-unchecked-ink-color: #333;
			--paper-checkbox-label-color: #333;
			--paper-checkbox-label-spacing: 0;
			--paper-checkbox-margin: 0 8px 8px 0;
			--paper-checkbox-vertical-align: top;
		}
		
		.settings-group {
			padding-top: 20px;
		}
		.settings-group h6 {
			color: #000;
		}
		paper-spinner.new-spinner {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			margin: auto;
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		
		.row {padding-left: 10px;padding-right: 10px;}
		.modal-body{padding-bottom: 0;}
		.modal-content {border-radius: 0;}
		.pull-center {display:block;margin-left:auto;margin-right:auto;text-align:center;}
		.modal-fullscreen .modal-dialog .modal-content {max-width: 768px;padding-top:16px;}

	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiNotificationSettings" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content">

					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>

					<iron-image class="pratilipi-logo" 
										style="background-color: #f5f5f5" 
										fade preload
										sizing="cover" 
										src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png"  
										alt="प्रतिलिपि"  
										title="प्रतिलिपि"></iron-image>

					<h6 class="text-center">सूचना सेटिंग</h6>

					<paper-spinner class="new-spinner" active="{{ spinnerActive }}"></paper-spinner>
						<paper-dropdown-menu id="selectEmailFrequency" noink label="ईमेल मिळवा" vertical-align="top" horizontal-align="right" class="pratilipi-blue">
							<paper-menu selected="{{ selectedEmailFrequency }}"  noink class="dropdown-content" style="white-space: nowrap; width: auto;">
								<paper-item value="IMMEDIATELY">लगेच</paper-item>
								<paper-item value="DAILY">दैनिक</paper-item>
								<paper-item value="WEEKLY">साप्ताहिक</paper-item>
								<paper-item value="MONTHLY">मासिक</paper-item>
								<paper-item value="NEVER">नाही</paper-item>
							</paper-menu>
						</paper-dropdown-menu>
					<div class="settings-group">
						<h6>साहित्य सामग्री बद्दल</h6>
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="USER_PRATILIPI_REVIEW" class="pratilipi-blue" noink>नवीन टिप्पणी</paper-checkbox>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="COMMENT_REVIEW_REVIEWER" class="pratilipi-blue" noink>नवीन उत्तर</paper-checkbox>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="VOTE_REVIEW_REVIEWER" class="pratilipi-blue" noink>टिप्पणी पसंत झाल्यावर</paper-checkbox>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="VOTE_COMMENT_REVIEW_COMMENTOR" class="pratilipi-blue" noink>उत्तर आवडल्यावर</paper-checkbox>
							</div>
						</div>
					</div>
					<div class="settings-group">
						<h6>मित्रमंडळां संबंधित</h6>
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="AUTHOR_FOLLOW" class="pratilipi-blue" noink>नवीन अनुयायी जोडण्याबाबत</paper-checkbox>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="PRATILIPI_PUBLISHED_FOLLOWER" class="pratilipi-blue" noink>अनुयायीद्वारा नवी साहित्य सामग्री प्रकाशित करण्यावर</paper-checkbox>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-checkbox value="GENERIC" class="pratilipi-blue" noink>प्रतिलिपिकडून माहिती आणि सूचना</paper-checkbox>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<div class="display-message-div"><p>{{ message }}</p></div>
				<button disabled="{{ !canSaveChanges }}" style="position: fixed; bottom: 15px; right: 15px;" class="pratilipi-new-blue-button" type="button" on-click="onSubmit" onclick="ga_CA( 'Notification', 'Update' )">बदल जतन करा</button>
			</div>
		</div>
	</template>

	<script>

		function firebaseCallback( preferences ) {
			document.querySelector( 'pratilipi-notification-settings' ).firebaseCallback( preferences );
		}

		Polymer({

			is: 'pratilipi-notification-settings',
			
			properties: {
				selectedEmailFrequency: { type: Number },
				message: { type: String },
				canSaveChanges: { type: Boolean }
			},

			stopUserInteraction: function() {
				// Enable spinner and disable button
				this.set( 'canSaveChanges', false );
				this.set( 'spinnerActive', true );
			},

			resumeUserInteration: function() {
				// Enable button and disable spinner
				this.set( 'canSaveChanges', true );
				this.set( 'spinnerActive', false );
			},

			open: function() {
				jQuery( "#pratilipiNotificationSettings" ).modal();
				this.stopUserInteraction();
				getNotificationPreferences( firebaseCallback );
			},

			close: function() {
				jQuery( "#pratilipiNotificationSettings" ).modal( 'hide' );
			},

			firebaseCallback: function( preferences ) {

				var emailFrequency = preferences[ "emailFrequency" ] != null ? preferences[ "emailFrequency" ] : "IMMEDIATELY";
				var i = 0;
				$( "pratilipi-notification-settings #selectEmailFrequency paper-menu paper-item" ).each( function() {
					if( $( this ).attr( "value" ) === emailFrequency ) {
						return false;
					} i++;
				});
				this.set( 'selectedEmailFrequency', i );

				var notificationSubscriptions = preferences[ "notificationSubscriptions" ] != null ? 
						preferences[ "notificationSubscriptions" ] : {};
				$( "pratilipi-notification-settings #pratilipiNotificationSettings paper-checkbox" ).each( function() {
					$( this ).prop( 'checked', notificationSubscriptions[ $( this ).val() ] != null ?
							notificationSubscriptions[ $( this ).val() ] : true );
				});

				this.resumeUserInteration();

			},

			onSubmit: function() {

				var preferences = {};
				preferences[ "emailFrequency" ] = this.$.selectEmailFrequency.selectedItem.getAttribute( "value" );
				preferences[ "notificationSubscriptions" ] = {};

				$( "pratilipi-notification-settings #pratilipiNotificationSettings paper-checkbox" ).each( function() {
					preferences[ "notificationSubscriptions" ][ $( this ).val() ] = this.checked;
				});

				this.stopUserInteraction();
				setNotificationPreferences( preferences );

				// Feedback here
				this.set( "message", "यशस्वी झालात!" );
				this.async( function() {
					this.resumeUserInteration();
					this.set( "message", null );
					this.close();
					ga_CA( 'User', 'SubmitNotification' );
				}, 1000 );
			}

		});

	</script>

</dom-module>
<dom-module id="pratilipi-notification-grid">

	<style>
		:host {
			display: block;
			width: 100%;
			margin-bottom: 4px;
		}
		paper-card.notifications-heading {
			width: 100%;
			margin-bottom: 6px;
			background: #fff;
			padding: 12px 16px;
			font-size: 15px;
			font-weight: 700;
		}
		paper-card.notifications-heading h5 {
			font-weight: 700;
		}
		.load-more-button {
			margin-top: 4px;
			background: #F1F8FB;
			padding: 18px;
			text-align: center;
			color: #0C68BD;
			cursor: pointer;
			font-size: 14px;
			font-weight: 700;
			line-height: 14px;
			text-shadow: 0px 1px 2px #FFFFFF;
			border: 1px solid #0C68BD;
			border-radius: 4px;
		}
		paper-spinner.pratilipi-spinner {
			line-height: 52px;
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		paper-card.alert-message {
			display: block;
			width: 100%;
			margin: 0;
			padding: 24px;
			text-align: center;
			font-weight: bold;
		}
		paper-card.alert-message iron-icon {
			width: 48px;
			height: 48px;
			margin-bottom: 12px;
		}
		paper-icon-button.settings-icon {
			--paper-fab-background: #333;
			margin-top: -38px;
		}
	</style>

	<template>
		<paper-card class="notifications-heading">
			<h5 class="pratilipi-red">सूचना</h5>
			<paper-icon-button hidden$="{{ isGuest }}" noink icon="icons:settings"
			                   class="settings-icon pull-right"
			                   on-click="openNotificationSettings" onclick="ga_CA( 'Notification', 'Settings' )"></paper-icon-button>
		</paper-card>
		<template is="dom-if" if="{{ isGuest }}">
			<paper-card class="alert-message">
				<iron-icon icon="icons:info-outline"></iron-icon>
				<div><a class="pratilipi-blue" on-click="_login">तुम्ही अनुसरण करीत असलेल्या लेखकांविषयी सूचना मिळविणायसाठी कृपया लॉग-इन करा</a></div>
			</paper-card>
		</template>
		<template is="dom-if" if="{{ emptyNotificationList }}">
			<paper-card class="alert-message">
				<iron-icon icon="icons:info-outline"></iron-icon>
				<div>क्षमस्व! सध्या आपल्याकरीता कोणत्याही सूचना नाही. कृपया नंतर पहा.</div>
			</paper-card>
		</template>
		<template is="dom-repeat" items="{{ notificationList }}" as="notification">
			<template is="dom-if" if="{{ notification.message }}">
				<pratilipi-notification-snippet notification="{{ notification }}"></pratilipi-notification-snippet>
			</template>
		</template>
		<template is="dom-if" if="{{ hasMore }}">
			<template is="dom-if" if="{{ !isLoading }}">
				<div class="load-more-button" on-click="_loadMore" onclick="ga_CA( 'Notification', 'Load More' )">सर्व मजकूर पहा...</div>
			</template>
		</template>
		<template is="dom-if" if="{{ isLoading }}">
			<paper-spinner class="pratilipi-spinner pratilipi-spinner-center" active></paper-spinner>
		</template>

		<iron-ajax
				id="NotificationListApi"
				url="/api/notification/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_notificationListApiResponse"
				on-error="_notificationListApiError"
				></iron-ajax>
	</template>
		

	<script>

		Polymer({

			is: 'pratilipi-notification-grid',

			properties: {
				notificationObject: { type: Object },
				notificationList: { type: Array, value: function() { return []; } },
				cursor: { type: String, value: null },
				isLoading: { type: Boolean, value: false },
				isGuest: { type: Boolean }
			},

			_processNotificationObject: function( notificationObject ) {
				var notificationList = notificationObject.notificationList;
				for( var i = 0; i < notificationList.length; i++ )
					this.push( 'notificationList', notificationList[i] );
				this.set( 'cursor', notificationObject.cursor );
				this.set( 'hasMore', notificationList.length == 20 && this.cursor != null );
			},

			_loadMore: function() {
				this.set( 'isLoading', true );
				this.$.NotificationListApi.params.cursor = this.cursor;
				this.$.NotificationListApi.generateRequest();
			},

			_notificationListApiResponse: function( response ) {
				this._processNotificationObject( response.detail.response );
				this.set( 'isLoading', false );
			},

			_notificationListApiError: function( response ) {
				this.set( 'isLoading', false );
			},

			ready: function() {
				this._processNotificationObject( this.notificationObject );
			},

			attached: function() {
				this.set( 'isGuest', document.querySelector( 'pratilipi-user' ).getCurrentUser().isGuest );
				this.set( 'emptyNotificationList', ! this.isGuest && this.notificationList.length == 0 )
			},

			_login: function() {
				document.querySelector( 'pratilipi-user' ).logIn( true, "तुम्ही अनुसरण करीत असलेल्या लेखकांविषयी सूचना मिळविणायसाठी कृपया लॉग-इन करा" );
			},

			openNotificationSettings: function() {
				this.domHost.openNotificationSettings();
			}

		});
	</script>

</dom-module>
<dom-module id="pratilipi-notification-page">

	<style>
		:host {
			display: block;
		}
		@media only screen and (max-width: 767px) {
			main {
				padding-top: 85px;
			}
		}
		@media only screen and (min-width: 768px) {
			main {
				padding-top: 52px;
			}
		}
		
	</style>

	<template>
		<pratilipi-user user='{{ user }}' user-data="[[ userData ]]"></pratilipi-user>
		<pratilipi-edit-account user='[[ user ]]'></pratilipi-edit-account>
		<pratilipi-write language-map="[[ languageMap ]]" pratilipi-types='[[ pratilipiTypes ]]'></pratilipi-write>
		<pratilipi-alert></pratilipi-alert>
		<pratilipi-notification-settings></pratilipi-notification-settings>

		<div class="header-pos">
<pratilipi-android-launch-test></pratilipi-android-launch-test>		   		</div>
   		<main>
   			<pratilipi-header language-map="[[ languageMap ]]" user='[[ user ]]'></pratilipi-header>
   			<div class="parent-container margin-top-bottom">
				<div class="container">
					<pratilipi-navigation
							class='pull-left hidden-xs hidden-sm'
							navigation-list='[[ navigationList ]]'
							></pratilipi-navigation>
					<pratilipi-navigation-drawer with-backdrop navigation-list='[[ navigationList ]]'></pratilipi-navigation-drawer>
					<div style="overflow:hidden; padding: 0 2px;">
						<div id="androidLaunchBottom">
							<pratilipi-notification-grid 
								notification-object="{{ notificationObject }}"></pratilipi-notification-grid>
						</div>
					</div>
				</div>
			</div>
   		</main>
		<footer>
   			<pratilipi-footer></pratilipi-footer>
		</footer>
		<div class="scroll-top-button">
			<a id="scrollToTop" on-click="scrollToTop"><paper-fab mini noink style="background: #c0c0c0;" icon="icons:arrow-upward"></paper-fab></a>
		</div>
	</template>

	<script>
		Polymer({

			is: 'pratilipi-notification-page',

			properties: {
				userData: { type: Object },
				user: { type: Object, observer: "_userObserver" },
				userLoaded: { type: Boolean },
				guestUser: { type: Boolean },
				notificationObject: { type: Object },
				navigationList: { type: Array },
				pratilipiTypes: { types: Object },
				languageMap: { type: Object },
				lastScrollTop: { type: Number, value: 0 }
			},

			_userObserver: function() {
				this.set( 'guestUser', this.user.isGuest );
				if( this.userLoaded == null ) {
					this.userLoaded = true;
					return;
				}
				window.location.reload();
			},

			_login: function() {
				document.querySelector( 'pratilipi-user' ).logIn( true, "तुम्ही अनुसरण करीत असलेल्या लेखकांविषयी सूचना मिळविणायसाठी कृपया लॉग-इन करा" );
			},

			openNotificationSettings: function() {
				if( this.guestUser ) {
					this._login();
					return;
				}
				this.querySelector( "pratilipi-notification-settings" ).open();
			},

			attached: function() {
				if( this.guestUser ) {
					this._login();
					return;
				}
				var action = getUrlParameter( "action" );
				if( action == "settings" ) {
					this.openNotificationSettings();
					return;
				}
			},

			scrollHandler: function( st ) {
				if( st > this.lastScrollTop || st < 100 )
					jQuery( '#scrollToTop' ).fadeOut();
				else
					jQuery( '#scrollToTop' ).fadeIn();
				this.lastScrollTop = st;
			}

		});
	</script>

</dom-module>