<dom-module id="pratilipi-review">

	<style>
		
		:host {
			display: block;
		}
		
		paper-card#reviewcard {
			width: 100%;
			margin-bottom: 5px;
			padding: 20px;
		}
		
		.user-name {
			color: #333; 
			text-transform: capitalize; 
			display: inline-block; 
			margin: 0px;
			font-size: 15px;
		}
		
		.user-dp {
			width: 64px; 
			height: 64px; 
			float: left; 
		}

		.reviewText {
			text-align: justify; 
			white-space:pre-wrap; 
			font-size: 15px;
			padding: 16px 0px 16px 8px;
			clear: both;
		}
		
		a.reply-text {
			margin-right: 16px;
			font-size: 15px;
			margin-left: 10px;
		}
		
		a.expand-comments {
			font-size: 13px;
		}
		
		a.expand-comments iron-icon {
			margin-left: -4px;
			width: 16px;
		}
		
		.reply-section {
		    margin-left: 10px;
			margin-bottom: 16px;
		}
		
		paper-menu-button {
			padding: 0px;
		}
		
		paper-menu {
			cursor: pointer;
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		paper-item {
			cursor: pointer;
			font-family: inherit;
			font-size: 13px;
		}

		.review-liked, .review-liked * {
			color: #de4d5f;
		}
		
		.review-none, .review-none * {
			color: grey;
		}
		
	</style>

	
	<template>
		<paper-card id="reviewcard">
			<div hidden$="{{ !hasAccessToUpdate }}" class="dropdown">
				<paper-icon-button style="color: #333;" class="dropdown-trigger pull-right" icon="icons:more-horiz" noink type="button" data-toggle="dropdown"></paper-icon-button>
				<ul style="margin-top: 0; margin-right: -12px;" class="dropdown-menu pull-right">
					<li>
						<a style="padding: 0; margin: 0;" on-click="showReviewInput">
							<paper-item>
								<paper-icon-item><iron-icon style="margin-right: 4px; width: 22px;" icon="editor:mode-edit"></iron-icon></paper-icon-item>
								<paper-item-body>റിവ്യൂ തിരുത്തുക</paper-item-body>
							</paper-item>
						</a>
					</li>
					<li>
						<a style="padding: 0; margin: 0;" on-click="openDeleteReview">
							<paper-item>
								<paper-icon-item><iron-icon style="margin-right: 4px; width: 22px;" icon="icons:delete"></iron-icon></paper-icon-item>
								<paper-item-body>റിവ്യൂ നീക്കം ചെയ്യുക</paper-item-body>
							</paper-item>
						</a>
					</li>
				</ul>
			</div>
			<div>
   				<a href="{{ review.userProfilePageUrl }}">
   					<img class="img-circle user-dp pratilipi-shadow" src="{{ reviewUserImageUrl }}" alt="{{ user.userName }}" title="{{ user.userName }}"/>
   				</a>
   				<div style="display: inline-block; margin-left: 16px;">
   					<a class="user-name" href="{{ review.userProfilePageUrl }}">{{ review.userName }}</a>
   					<template is="dom-if" if="{{ showRating }}">
   						<pratilipi-rating value="{{ review.rating }}" />
   					</template>
	   				<span style="display: block;">{{ reviewDateMillis }}</span>
   				</div>
			</div>
			<div class="reviewText">{{ reviewText }}</div>
			<div class="reply-section">
				<div id="review-like-{{ review.userPratilipiId }}" style="display: inline-block;">
					<a on-click="likeDislikeReview">
						<iron-icon style="width: 16px; height: 16px; margin-top: -2px;" icon="icons:thumb-up"></iron-icon>
					</a>
					<template is="dom-if" if="{{ showLikeCount }}">
						<span style="margin-left: 8px; font-size: 15px;">
							{{ likeCount }}
						</span>
					</template>
				</div>
				
				<iron-icon icon="icons:add-circle" style="width: 4px; height: 4px; margin-left: 8px; color: grey;"></iron-icon>
				<a class="reply-text" style="color: grey;" on-click="writeComment" onclick="ga_CA( 'Review', 'Add Comment' )">
					മറുപടി എഴുതൂ
				</a>
				<br/>
				<template is="dom-if" if="{{ showCommentCount }}">
					<a class="expand-comments pratilipi-red" on-click="showOrHideComments">
						<iron-icon icon="icons:unfold-more"></iron-icon>
						{{ commentCount }}&nbsp;{{ commentNumberText }}
					</a>
				</template>
			</div>
			
			<pratilipi-comment-list
				id="comment-{{ review.userPratilipiId }}"
				comment-count="{{ commentCount }}"
				user="{{ user }}"
				parent-id="{{ review.userPratilipiId }}"
				parent-type="REVIEW"></pratilipi-comment-list>
		</paper-card>
		<iron-ajax
				id="AjaxPost"
				url="/api/vote"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	

	<script>
	
		Polymer({

			is: 'pratilipi-review',
			
			properties: {
				user: { type: Object },
				review: { type: Object, observer: "ready" },
				reviewUserImageUrl: { type: String, value: "https://0.ptlp.co/author/image?width=64" },
				
				hasAccessToUpdate: { type: Boolean, value: false },
				
				commentCount: { type: Number, observer: "_commentCountObserver" },
				showCommentCount: { type: Boolean, value: false },

				likeCount: { type: Number, observer: "_likeCountObserver" },
				showLikeCount: { type: Boolean, value: false },
				isLiked: { type: Boolean, observer: "_isLikedObserver" }
			},
			
			ready: function() {
				
				if( this.review == null || jQuery.isEmptyObject( this.review ) )
					return;

				if( this.review.review == null || this.review.review.trim() == "" ) {
					this.$.reviewcard.style.display =  'none';
					return;
				}
				
				this.$.reviewcard.style.display =  'block';
				
				this.set( 'reviewText', this.review.review );

				if( this.review.userImageUrl ) {
					this.set( 'reviewUserImageUrl', this.review.userImageUrl 
										+ ( this.review.userImageUrl.indexOf( '?' ) == -1 ? "?" : "&" )
										+ "width=64" ); 
				}

				if( this.review.reviewDateMillis )
					this.reviewDateMillis = convertDate( this.review.reviewDateMillis );
				
				this.showRating = this.review.rating > 0;
				this.commentCount = this.review.commentCount;
				this.likeCount = this.review.likeCount;
				this.isLiked = this.review.isLiked != null ? this.review.isLiked : false;
			},
			
			_commentCountObserver: function() {
				this.showCommentCount = this.commentCount != null && this.commentCount > 0;
				this.commentNumberText = this.commentCount != null && this.commentCount > 1 ? 
										"മറുപടികള്‍" : "മറുപടി";  
			},
			
			_likeCountObserver: function() {
				this.showLikeCount = this.likeCount != null && this.likeCount > 0;
			},
			
			_isLikedObserver: function() {
				jQuery( this.querySelector( '#review-like-' + this.review.userPratilipiId ) ).removeClass( this.isLiked ? "review-none" : "review-liked" );
				jQuery( this.querySelector( '#review-like-' + this.review.userPratilipiId ) ).addClass( this.isLiked ? "review-liked" : "review-none" );
			},
			
			writeComment: function() {
				this.querySelector( 'pratilipi-comment-list#comment-' + this.review.userPratilipiId ).writeComment();
			},
			
			showOrHideComments: function() {
				this.querySelector( 'pratilipi-comment-list#comment-' + this.review.userPratilipiId ).showOrHideComments();
			},
			
			likeDislikeReview: function( event ) {
				if( this.user.isGuest ) {
					document.querySelector( 'pratilipi-user' ).logIn( true );
					return;
				}

				if( this.isLiked ) {
					this.isLiked = false;
					this.likeCount --;
				} else {
					this.isLiked = true;
					this.likeCount ++;
				}
				
				// When called from _handleAjaxPostError
				if( event == null )
					return;
				
				// Make Ajax call
				var body = {
						parentType: "REVIEW",
						parentId: this.review.userPratilipiId,
						type: this.isLiked ? "LIKE" : "NONE"
				};
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
				ga_CA( 'Review', this.isLiked ? 'Review Like' : 'Review UnLike' );
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					document.querySelector( 'pratilipi-alert' ).alert( "സെര്‍വറുമായി ബന്ധം സ്ഥാപിക്കാനാവുന്നില്ല!", false );
					this._handleAjaxPostError();
					return;
				}
			},
			
			_handleAjaxPostError: function( event ) {
				if( event != null && event.detail.request.xhr.response.message != null )
					document.querySelector( 'pratilipi-alert' ).alert( event.detail.request.xhr.response.message, false );
				else
					document.querySelector( 'pratilipi-alert' ).alert( "എന്തോ സാങ്കേതിക പ്രശ്നം സംഭവിച്ചിരിക്കുന്നു. വീണ്ടും ശ്രമിക്കൂ", false );
				// Reverting it
				this.likeDislikeReview();
			},
			
			
			showReviewInput: function() {
				this.domHost.showReviewInput();
			},
			
			openDeleteReview: function() {
				this.domHost.openDeleteReview();
			}

		});
		
	</script>

</dom-module>
<dom-module id="pratilipi-rating-input">

	<style>

		:host {
			display: inline-block;
		}
		
		div > div {
			direction: rtl;
			cursor: pointer;
		}

		.glyphicon {
			color: #278be7;
		}

		.glyphicon:hover ~ .glyphicon, .glyphicon:hover {
			color: #107FE5;
		}
		
		iron-icon {
			width: 32px;
			height: 32px;
		}

	</style>


	<template>
		<div>
			<div style="display: block; float: left; margin-top: 20px;">
				<strong class="pratilipi-blue" style="cursor: default; font-size: 20px; float: right; margin-top: 7px; margin-left: 12px;">{{ text }}</strong>
				<iron-icon icon="{{ icon5 }}" class="glyphicon" on-mouseover="showFiveStars"  on-mouseout="init" on-click="rateFiveStars"></iron-icon>
				<iron-icon icon="{{ icon4 }}" class="glyphicon" on-mouseover="showFourStars"  on-mouseout="init" on-click="rateFourStars"></iron-icon>
				<iron-icon icon="{{ icon3 }}" class="glyphicon" on-mouseover="showThreeStars" on-mouseout="init" on-click="rateThreeStars"></iron-icon>
				<iron-icon icon="{{ icon2 }}" class="glyphicon" on-mouseover="showTwoStars"   on-mouseout="init" on-click="rateTwoStars"></iron-icon>
				<iron-icon icon="{{ icon1 }}" class="glyphicon" on-mouseover="showOneStar"    on-mouseout="init" on-click="rateOneStar"></iron-icon>
			</div>
		</div>
	</template>


	<script>

		Polymer({

			is: 'pratilipi-rating-input',

			properties: {
				value: { type: Number, notify: true, observer: 'init' }
			},
			
			init: function() {

				this.setRating( this.value );

				switch( this.value ) {
					case 0:
						this.text = null;
						break;
					case 1:
						this.showOneStar();
						break;
					case 2:
						this.showTwoStars();
						break;
					case 3:
						this.showThreeStars();
						break;
					case 4:
						this.showFourStars();
						break;
					case 5:
						this.showFiveStars();
						break;
				}
			},
			
			setRating: function( value ) {
				this.set( 'value', value != null ? value : 0 );
				this.setStar( this.value );
			},
			
			setStar: function( n ) {
				for( var i = 1; i <= 5; i++ )
					this.set( "icon" + i, "star-border" );
				for( var i = 1; i <= n; i++ )
					this.set( "icon" + i, "star" );
				ga_CA( 'Review', 'Star Rating' );
			},
			
			showOneStar: function() {
				this.text = 'മോശം';
			},

			showTwoStars: function() {
				this.text = 'കൊള്ളാം';
			},
			
			showThreeStars: function() {
				this.text = 'നല്ലത്‌';
			},
			
			showFourStars: function() {
				this.text = 'വളരെ നല്ലത്‌';
			},
			
			showFiveStars: function() {
				this.text = 'മികച്ചത്';
			},
			
			
			rateOneStar: function() {
				this.set( 'value', 1 );
				this.setStar(1);
			},

			rateTwoStars: function() {
				this.set( 'value', 2 );
				this.setStar(2);
			},
			
			rateThreeStars: function() {
				this.set( 'value', 3 );
				this.setStar(3);
			},
			
			rateFourStars: function() {
				this.set( 'value', 4 );
				this.setStar(4);
			},
			
			rateFiveStars: function() {
				this.set( 'value', 5 );
				this.setStar(5);
			}

		});

	</script>

</dom-module>
<dom-module id="pratilipi-review-input">

	<style>
		
		:host {
			display: block;
		}
		
		paper-textarea.pratilipi-blue {
			display: block;
			--paper-input-container-color: #107FE5;
			--paper-input-container-focus-color: #107FE5;
			--paper-input-container-input-color: #333;
			--paper-input-container-input: {
				font-family: inherit;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: inherit;
				text-align: left;
			};
		}
		
		.modal-fullscreen .modal-dialog .modal-content {max-width: 900px;padding-top:5px;}
		.modal-fullscreen-heading{line-height: 2;}
		
	</style>

	
	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiReviewInput" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="പ്രതിലിപി" alt="പ്രതിലിപി" src="http://public.pratilipi.com/pratilipi-logo/png/Logo-2C-RGB-80px.png" />
					<h6 class="modal-fullscreen-heading">{{ pratilipi.title }} - ഒരു റിവ്യൂ എഴുതൂ</h6>
					<p class="text-muted text-center">താങ്കളുടെ അഭിപ്രായം പങ്കുവെയ്ക്കുക. എന്താണ് ഈ രചനയെ മികച്ചതാക്കിയത്? എന്താണ് ഇതിനെ വ്യത്യസ്തവും പ്രചോദനാത്മകവുമാക്കിയത്? മറ്റു വായനക്കാരെ നല്ലൊരു രചന തിരഞ്ഞെടുക്കാന്‍ സഹായിക്കൂ!</p>
					<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 20px; margin-bottom: 10px;"></div>
					<div id="pratilipi-review-row">
						<div id="pratilipi-review-col-left" style="max-width: 175px;">
							<img style="max-width: 175px;" class="pratilipi-shadow" src="{{ pratilipiCoverImageUrl }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.titleEn }}"/>
							<h6 style="font-weight: 700; text-align: center;" class="text-muted">{{ pratilipi.title }}</h6>
							<h6 style="font-weight: 400; text-align: center;" class="text-muted">{{ pratilipi.author.name }}</h6>
						</div>
						<div style="padding-left: 15px; padding-right: 15px;" id="pratilipi-review-col-right">
							<pratilipi-rating-input value="{{ rating }}"></pratilipi-rating-input>
							<div style="margin-top: 10px; margin-bottom: 5px; text-align: left;"><span style="font-size: 14px;">താങ്കളുടെ റിവ്യൂ</span></div>
							<textarea style="width: 100%; height: 185px;" id="reviewInput" value="{{ review::input }}"></textarea>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<div class="display-message-div"><p>{{ message }}</p></div>
				<button id="editReviewButton" style="position: fixed; bottom: 15px; right: 15px;" class="pratilipi-dark-blue-button" type="button" on-click="createOrEditReview">സമര്‍പ്പിക്കുക</button>
			</div>
		</div>
		
		<div class="modal fade" id="deleteReview">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h6 class="modal-heading">റിവ്യൂ നീക്കം ചെയ്യുക</h6>
						<span class="modal-close-button"><paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					<div class="modal-body">
						താങ്കളുടെ റിവ്യൂ ഉറപ്പായും നീക്കം ചെയ്യേണമോ?
					</div>
					<div class="modal-footer">
						<button id="deleteReviewButton" class="btn btn-danger pull-left" on-click="deleteReview">അതെ,റിവ്യൂ നീക്കം ചെയ്യുക!</button>
						<button class="btn btn-primary pull-right" on-click="closeDeleteReview">വേണ്ട!</button>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/userpratilipi/review"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	

	<script>
		Polymer({

			is: 'pratilipi-review-input',

			properties: {
				// Display Object
				pratilipi: { type: Object },
				
				// Userpratilipi
				pratilipiId: { type: String },
				rating: { type: Number },
				review: { type: String },
				reviewState: { type: String },
				
				// Specific to modal message.
				message: { type: String }
			},
			
			behaviors: [		
				Polymer.IronResizableBehavior		
			],
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			_onIronResize: function() {
				var windowsize = this.clientWidth;
				if( windowsize > 600 ) {
					jQuery( '#pratilipi-review-row' ).removeClass( 'row-mobile' );
					jQuery( '#pratilipi-review-col-left' ).removeClass( 'col-left-mobile' );
					jQuery( '#pratilipi-review-col-right' ).removeClass( 'col-right-mobile' );
					
					jQuery( '#pratilipi-review-row' ).addClass( 'row-widescreen' );
					jQuery( '#pratilipi-review-col-left' ).addClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-review-col-right' ).addClass( 'col-right-widescreen' );
				}
				else {
					jQuery( '#pratilipi-review-row' ).removeClass( 'row-widescreen' );
					jQuery( '#pratilipi-review-col-left' ).removeClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-review-col-right' ).removeClass( 'col-right-widescreen' );
					
					jQuery( '#pratilipi-review-row' ).addClass( 'row-mobile' );
					jQuery( '#pratilipi-review-col-left' ).addClass( 'col-left-mobile' );
					jQuery( '#pratilipi-review-col-right' ).addClass( 'col-right-mobile' );
				}
			},
			
			attached: function() {
				this.pratilipiCoverImageUrl = this.pratilipi.coverImageUrl 
											+ ( this.pratilipi.coverImageUrl.indexOf( "?" ) == -1 ? "?" :  "&" )
											+ "width=175";
			},
			
			process: function( userpratilipi ) {
				this.pratilipiId = userpratilipi.pratilipiId == null ? this.pratilipi.pratilipiId : userpratilipi.pratilipiId; 
				this.rating = userpratilipi.rating == null ? null : userpratilipi.rating;
				this.reviewState = userpratilipi.reviewState == "PUBLISHED" ? null : userpratilipi.reviewState;
				this.review = userpratilipi.review != null ? userpratilipi.review : null;
			},
			
			openReviewInput: function( userpratilipi ) {
				this.process( userpratilipi != null ? userpratilipi : {} );
				this.async( function() {
					jQuery( "#pratilipiReviewInput" ).modal();
				});
			},
			
			openDeleteReview: function( pratilipiId ) {
				this.pratilipiId = pratilipiId;
				this.async( function() {
					jQuery( "#deleteReview" ).modal();
				});
			},
			
			closeReviewInput: function() {
				jQuery( "#pratilipiReviewInput" ).modal( 'hide' );
			},
			
			closeDeleteReview: function() {
				jQuery( "#deleteReview" ).modal( 'hide' );
			},
			
			deleteReview: function() {
				// Change state and make Post call.
				jQuery( '#deleteReviewButton' ).prop( 'disabled', true );
				var body = { pratilipiId: this.pratilipiId, reviewState: "DELETED" };
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			createOrEditReview: function( event ) {

				if( this.rating == null || this.rating == 0 ) {
					this.message = "താങ്കളുടെ റേറ്റിംഗ് ചേര്‍ക്കൂ";
					var stars = jQuery( this.querySelector( 'pratilipi-rating-input' ) );
					for( var i = 0; i < 3; i ++ ) {
						stars.animate( { opacity: '0.4'}, 100 );
						stars.animate( { opacity: '1'}, 50 );
					}
					return;
				}

				this.message = "സേവ് ചെയ്തുകൊണ്ടിരിക്കുന്നു. . .";
				jQuery( '#editReviewButton' ).prop( 'disabled', true );

				var body = {
					pratilipiId : this.pratilipiId,
					rating: this.rating
			    };

				if( this.review != null )
					body.review = this.review;
				
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
				ga_CA( 'Review', 'Add Rating' );
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else if( document.querySelector( 'pratilipi-pratilipi-page' ) != null ) {
					this.message = "വിജയകരമായി പൂര്‍ത്തീകരിച്ചിരിക്കുന്നു !";
					document.querySelector( 'pratilipi-pratilipi' ).updateUserRating( event.detail.response );
					document.querySelector( 'pratilipi-userpratilipi' ).setUserPratilipi( event.detail.response );
					this.async( function() {
						this.message = null;
						jQuery( '#editReviewButton' ).prop( 'disabled', false );
						jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
						this.closeReviewInput();
						this.closeDeleteReview();
					}, 2000 );
				} else if( document.querySelector( 'pratilipi-reader-page' ) != null ) {
					this.message = "വിജയകരമായി പൂര്‍ത്തീകരിച്ചിരിക്കുന്നു !";
					document.querySelector( 'pratilipi-reader-page' ).updateUserPratilipi( event.detail.response );
					this.async( function() {
						this.message = null;
						jQuery( '#editReviewButton' ).prop( 'disabled', false );
						this.closeReviewInput();
					}, 2000 );
				}
					
			},

			_handleAjaxPostError: function( event ) {
				jQuery( '#editReviewButton' ).prop( 'disabled', false );
				jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					this.message = event.detail.request.xhr.response;
				} else if( event.detail.request.xhr.status == 401 ) {
					this.message = null;
					this.closeReviewInput();
					this.closeDeleteReview();
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					this.message = event.detail.request.xhr.response.message;
				}
			}

		});
		
	</script>

</dom-module>
<dom-module id="pratilipi-review-list">

	<style>
		
		:host {
			display: block;
		}
		
		.secondary-500 {
			width: 100%;
			padding: 10px;
			margin-bottom: 4px;
		}

		.secondary-500 h5 {
			margin: 0px;
			padding: 10px;
			display: inline-block;
		}

		.secondary-500 a {
			margin-bottom: 6px;
		}
		
		paper-spinner.pratilipi-spinner {
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		
		paper-card.zero-results {
			width: 100%; 
			text-align: center; 
			padding: 50px 15px; 
			margin-bottom: 10px;
		}
		
		iron-icon.zero-results-icon {
			color: #545454; 
			width: 64px; 
			height: 64px;
		}
		
		h5.zero-results-h5 {
			color: #545454;
			font-size: 18px;
			line-height: 32px;
			margin-top: 24px;
		}

	</style>

	
	<template>
		<div class="secondary-500 pratilipi-shadow">
			<h5 class="pratilipi-red">റിവ്യൂസ്</h5>

			<template is="dom-if" if="{{ user.isGuest }}">
				<a class="pratilipi-grey-button" role="button" on-click="showReviewInput">ഒരു റിവ്യൂ എഴുതൂ</a>
			</template>

			<template is="dom-if" if="{{ userpratilipi.hasAccessToReview }}">
				<template is="dom-if" if="{{ !reviewAvailable }}">
					<a class="pratilipi-grey-button" role="button" on-click="showReviewInput">ഒരു റിവ്യൂ എഴുതൂ</a>
				</template>
			</template>
		</div>
		
		<pratilipi-review-input
				id="ReviewInput"
				pratilipi="[[ pratilipi ]]"
				></pratilipi-review-input>

		<!-- No Reviews found in case of no results -->
		<template is="dom-if" if="[[ zeroReviewResults ]]">
			<paper-card class="zero-results">
				<iron-icon icon="icons:info-outline" class="zero-results-icon"></iron-icon>
				<h5 class="zero-results-h5">ഈ രചനയ്ക്ക് ഇത് വരെ റിവ്യൂസ് ഒന്നും ഇല്ല</h5>
			</paper-card>
		</template>

		<div>
			<template is="dom-if" if="{{ reviewAvailable }}">
				<pratilipi-review id="review-{{ userpratilipi.userPratilipiId }}" user="{{ user }}" review="{{ userpratilipi }}" has-access-to-update></pratilipi-review>
			</template>
			<template is="dom-repeat" id="repeatReviewList" items="[[reviewList]]" as="review">
				<pratilipi-review id="review-{{ review.userPratilipiId }}" user="{{ user }}" review="[[ review ]]"></pratilipi-review>
			</template>
		</div>

		<template is="dom-if" if="{{ isLoading }}">
			<paper-spinner class="pratilipi-spinner pratilipi-spinner-center" active></paper-spinner>
		</template>

		<iron-ajax
				id="AjaxGet"
				url="/api/userpratilipi/review/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>

	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-review-list',

			properties: {
				user: { type: Object, observer:"_userChanged" },
				pratilipi: { type: Object },
				userpratilipi: { type: Object, observer:"_userPratilipiChanged" },
				
				reviewList: { type: Array, value: [], notify: true },
				zeroReviewResults: { type: Boolean, value: false },
				cursor: { type: String, value: null },
				resultCount: { type: Number, value: 20 },

				isLoading: { type: Boolean, value: false },
				isFinished: { type: Boolean, value: false },
				
				reviewAvailable: { type: Boolean, value: false, observer: "checkForZeroResults" },
				reviewButtonClicked: { type: Boolean, value: false }
			},
			
			_userChanged: function() {
				// Called when user is set
				if( this.user == null || this.pratilipi == null )
					return;
				// To reload the page - to load comments	
				this.reset();
			},
			
			_userPratilipiChanged: function() {

				// Guest user clicked on "Write Review Button" and logged in.
				if( this.user != null && ! this.user.isGuest && this.reviewButtonClicked ) {
					this.reviewButtonClicked = false;
					this.showReviewInput();
				}

				// Checking if user has review
				this.set( 'reviewAvailable', this.userpratilipi != null && this.userpratilipi.reviewState != "BLOCKED" && this.userpratilipi.reviewState != "DELETED"
						&& this.userpratilipi.review != null && this.userpratilipi.review.trim() != "" )

				if( ! this.reviewAvailable )
					return;

				// Removing user's review from review list.
				var index = -1;
				for( var i = 0; i < this.reviewList.length; i++ ) {
					if( this.userpratilipi.userPratilipiId == this.reviewList[i].userPratilipiId ) {
						index = i;
						break;
					}
				}
				if( index != -1 )
					this.splice( 'reviewList', index, 1 );
				
			},
			
			showReviewInput: function() {
				if( this.user.isGuest ) {
					document.querySelector( 'pratilipi-user' ).logIn( true );
					this.reviewButtonClicked = true;
				} else if( this.userpratilipi != null && this.userpratilipi.hasAccessToReview ) {
					this.querySelector( 'pratilipi-review-input' ).openReviewInput( this.userpratilipi );
				} else {
					/* alert( "ക്ഷമിക്കണം! താങ്കള്‍ക്ക് ഈ രചനയ്ക്ക് റിവ്യൂ എഴുതാന്‍ സാധിക്കില്ല!" ); */
				}
			},
			
			openDeleteReview: function() {
				this.querySelector( 'pratilipi-review-input' ).openDeleteReview( this.userpratilipi.pratilipiId );
			},
			
			checkForZeroResults: function() {

				if( this.reviewAvailable || ! this.isFinished ) {
					this.set( 'zeroReviewResults', false );
					return;
				}
				var zeroReviewResults = true;
				for( var i = 0; i < this.reviewList.length; i ++ ) {
					if( this.reviewList[i].reviewState != "BLOCKED" && this.reviewList[i].reviewState != "DELETED" 
							&& this.reviewList[i].review != null && this.reviewList[i].review.trim() != ""
							&& this.reviewList[i].userPratilipiId != this.userpratilipi.userPratilipiId ) {
						zeroReviewResults = false;
						break;
					}
				}
				this.set( 'zeroReviewResults', zeroReviewResults );

			},
			
			reset: function() {

				this.set( 'reviewList', [] );
				// Setting the flags and clearing the cursor.
				this.cursor = null;
				// make ajax GET call.
				this._makeAjaxRequest();

			},
			
			loadMore: function( scrollTop ) {

				// Return if there is an active call or cursor = null.
				if( this.isLoading || this.isFinished || this.cursor == null || this.pratilipi == null )
					return;

				// Check for window height.
				var reqHeight = jQuery( window ).scrollTop()
						- jQuery( this ).position().top
						+ jQuery( window ).height()
						+ 3 * jQuery( window ).height();

				if( jQuery( this ).outerHeight( true ) >= reqHeight )
					return;

				// Set params and make ajax GET call.
				this._makeAjaxRequest();
				ga_CA( 'Review', 'Load Reviews' );

			},

			_makeAjaxRequest: function() {

				// Spinner Active
				this.set( 'isLoading', true );
				this.set( 'isFinished', false );
				this.set( 'zeroReviewResults', false );

				if( this.$.AjaxGet.lastRequest )
					this.$.AjaxGet.lastRequest.abort();

				this.$.AjaxGet.params.pratilipiId = this.pratilipi.pratilipiId;
				this.$.AjaxGet.params.resultCount = this.resultCount;

				if( this.cursor == null )
					delete this.$.AjaxGet.params.cursor;
				else
					this.$.AjaxGet.params.cursor = this.cursor;

				this.$.AjaxGet.generateRequest();

			},
			
			_handleAjaxGetResponse: function( event ) {
				
				// Disable spinner
				this.set( 'isLoading', false );

				// Call didn't succeed.
				if( event.detail.xhr.status == 0 )
					return;

				var reviewList = event.detail.response.reviewList;
				for( var i = 0; i < reviewList.length; i++ ) {
					if( reviewList[i].reviewState != "BLOCKED" && reviewList[i].reviewState != "DELETED" 
						&& reviewList[i].review != null && reviewList[i].review.trim() != ""
						&& reviewList[i].userPratilipiId != this.userpratilipi.userPratilipiId )
							this.push( 'reviewList', reviewList[i] );
				}

				this.set( 'cursor', event.detail.response.cursor );
				this.set( 'isFinished', event.detail.response.cursor == null || reviewList.length < this.resultCount );

				this.checkForZeroResults();

			},

			_handleAjaxGetError: function() {
				// Disable spinner
				this.set( 'isLoading', false );
			},
			
			attached: function() {
				this._makeAjaxRequest();
			}
			
		});

	</script>

</dom-module>